{% extends 'base.html' %}

{% block title %}Užduoties detalės - BTC Prekybos Sistema{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Užduoties detalės</h1>
        <div>
            <a href="{{ url_for('scheduler_bp.task_queue') }}" class="btn btn-secondary">
                <i class="fas fa-list"></i> Grįžti į sąrašą
            </a>
            {% if task.status != 'running' %}
                <a href="{{ url_for('scheduler_bp.run_task', task_id=task.id) }}" class="btn btn-primary">
                    <i class="fas fa-play"></i> Vykdyti dabar
                </a>
            {% endif %}
            <a href="{{ url_for('scheduler_bp.edit_task', task_id=task.id) }}" class="btn btn-warning">
                <i class="fas fa-edit"></i> Redaguoti
            </a>
            <a href="{{ url_for('scheduler_bp.delete_task', task_id=task.id) }}" 
               class="btn btn-danger"
               onclick="return confirm('Ar tikrai norite ištrinti šią užduotį?')">
                <i class="fas fa-trash"></i> Ištrinti
            </a>
        </div>
    </div>
    
    <!-- Pagrindinė informacija -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Pagrindinė informacija</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Pavadinimas:</strong> {{ task.name }}</p>
                    <p>
                        <strong>Būsena:</strong> 
                        {% if task.status == 'pending' %}
                            <span class="badge bg-secondary">Laukianti</span>
                        {% elif task.status == 'running' %}
                            <span class="badge bg-primary">Vykdoma</span>
                        {% elif task.status == 'completed' %}
                            <span class="badge bg-success">Baigta</span>
                        {% elif task.status == 'failed' %}
                            <span class="badge bg-danger">Nepavyko</span>
                        {% endif %}
                    </p>
                    <p>
                        <strong>Prioritetas:</strong> 
                        {% if task.priority == 1 %}
                            <span class="text-danger">Aukštas</span>
                        {% elif task.priority == 5 %}
                            <span class="text-warning">Vidutinis</span>
                        {% elif task.priority == 10 %}
                            <span class="text-success">Žemas</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6">
                    <p>
                        <strong>Dažnumas:</strong> 
                        {% if task.frequency == 'once' %}
                            Vieną kartą
                        {% elif task.frequency == 'daily' %}
                            Kasdien
                        {% elif task.frequency == 'weekly' %}
                            Kas savaitę
                        {% elif task.frequency == 'monthly' %}
                            Kas mėnesį
                        {% endif %}
                    </p>
                    <p><strong>Sukurta:</strong> {{ task.created_at }}</p>
                    <p><strong>Kitas vykdymas:</strong> {{ task.next_run_time or 'Nenurodyta' }}</p>
                </div>
            </div>
            
            {% if task.status == 'running' %}
                <div class="mt-3">
                    <h6>Vykdymo progresas:</h6>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ task.progress }}%;" 
                             aria-valuenow="{{ task.progress }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             data-task-id="{{ task.id }}">
                            {{ task.progress }}%
                        </div>
                    </div>
                </div>
            {% endif %}
            
            {% if task.last_result %}
                <div class="mt-3">
                    <h6>Paskutinio vykdymo rezultatas:</h6>
                    <div class="alert {% if task.last_result.success %}alert-success{% else %}alert-danger{% endif %}">
                        {% if task.last_result.success %}
                            <p class="mb-0">Užduotis sėkmingai įvykdyta (trukmė: {{ task.last_result.duration }} s)</p>
                        {% else %}
                            <p class="mb-0">Užduotis nepavyko: {{ task.last_result.error }}</p>
                            <p class="mb-0">Trukmė: {{ task.last_result.duration }} s</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Užduoties konfigūracija -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Treniravimo parametrai</h5>
        </div>
        <div class="card-body">
            {% if task.params %}
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>Modelio tipas:</strong> {{ task.params.model_type }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Epochų skaičius:</strong> {{ task.params.epochs }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Batch dydis:</strong> {{ task.params.batch_size }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p><strong>Papildomi parametrai:</strong></p>
                        <pre class="bg-light p-3 rounded">{{ task.params | tojson(indent=2) }}</pre>
                    </div>
                </div>
            {% else %}
                <p class="text-muted">Nėra papildomų parametrų.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Užduoties vykdymo istorija -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">Vykdymo istorija</h5>
        </div>
        <div class="card-body">
            {% if task.history %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data ir laikas</th>
                                <th>Būsena</th>
                                <th>Trukmė</th>
                                <th>Informacija</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in task.history %}
                                <tr>
                                    <td>{{ entry.timestamp }}</td>
                                    <td>
                                        {% if entry.status == 'started' %}
                                            <span class="badge bg-info">Pradėta</span>
                                        {% elif entry.status == 'completed' %}
                                            <span class="badge bg-success">Baigta</span>
                                        {% elif entry.status == 'failed' %}
                                            <span class="badge bg-danger">Nepavyko</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.duration %}
                                            {{ entry.duration }} s
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.error %}
                                            <span class="text-danger">{{ entry.error }}</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">Užduotis dar nebuvo vykdyta.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // WebSocket klausymasis užduoties progreso atnaujinimui
    document.addEventListener('DOMContentLoaded', function() {
        // Ieškome progreso juostos
        var progressBar = document.querySelector('.progress-bar[data-task-id="{{ task.id }}"]');
        
        // Jei užduotis vykdoma ir turime progreso juostą
        if (progressBar) {
            // Auto-refresh kas 10 sekundžių, jei vykdoma
            var refreshInterval = setInterval(function() {
                fetch('/api/scheduler/task/{{ task.id }}')
                    .then(response => response.json())
                    .then(data => {
                        // Jei užduotis nebevykdoma, perkrauname puslapį
                        if (data.status !== 'running') {
                            clearInterval(refreshInterval);
                            location.reload();
                        }
                        
                        // Atnaujiname progreso juostą
                        progressBar.style.width = data.progress + '%';
                        progressBar.setAttribute('aria-valuenow', data.progress);
                        progressBar.textContent = data.progress + '%';
                    })
                    .catch(error => console.error('Klaida gaunant užduoties būseną:', error));
            }, 10000);
        }
    });
</script>
{% endblock %}