{% extends 'base.html' %}

{% block title %}
{% if edit_mode %}Redaguoti{% else %}Sukurti{% endif %} užduotį - BTC Prekybos Sistema
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col">
            <h1 class="h3">{% if edit_mode %}Redaguoti{% else %}Sukurti{% endif %} užduotį</h1>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('scheduler.tasks') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Grįžti į sąrašą
            </a>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="POST" action="{% if edit_mode %}{{ url_for('scheduler.edit_task', task_id=task.id) }}{% else %}{{ url_for('scheduler.create_task') }}{% endif %}">
                <!-- Pagrindinė informacija -->
                <div class="mb-3">
                    <label for="name" class="form-label">Pavadinimas:</label>
                    <input type="text" class="form-control" id="name" name="name" value="{{ task.name if edit_mode else '' }}" required>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Aprašymas:</label>
                    <textarea class="form-control" id="description" name="description" rows="3">{{ task.description if edit_mode else '' }}</textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="frequency" class="form-label">Dažnumas:</label>
                        <select class="form-select" id="frequency" name="frequency" required>
                            <option value="once" {% if edit_mode and task.frequency == 'once' %}selected{% endif %}>Vieną kartą</option>
                            <option value="daily" {% if edit_mode and task.frequency == 'daily' %}selected{% endif %}>Kasdien</option>
                            <option value="weekly" {% if edit_mode and task.frequency == 'weekly' %}selected{% endif %}>Kas savaitę</option>
                            <option value="monthly" {% if edit_mode and task.frequency == 'monthly' %}selected{% endif %}>Kas mėnesį</option>
                            <option value="queue" {% if edit_mode and task.frequency == 'queue' %}selected{% endif %}>Įdėti į eilę</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="priority" class="form-label">Prioritetas:</label>
                        <select class="form-select" id="priority" name="priority" required>
                            <option value="1" {% if edit_mode and task.priority == 1 %}selected{% endif %}>Aukštas</option>
                            <option value="5" {% if edit_mode and task.priority == 5 or not edit_mode %}selected{% endif %}>Vidutinis</option>
                            <option value="10" {% if edit_mode and task.priority == 10 %}selected{% endif %}>Žemas</option>
                        </select>
                    </div>
                </div>
                
                <!-- Laiko nustatymai -->
                <div id="time-settings">
                    <div class="row" id="once-settings">
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">Data:</label>
                            <input type="date" class="form-control" id="date" name="date" 
                                   value="{{ task.date if edit_mode and task.date else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="time" class="form-label">Laikas:</label>
                            <input type="time" class="form-control" id="time" name="time" 
                                   value="{{ task.time if edit_mode and task.time else '12:00' }}">
                        </div>
                    </div>
                    
                    <div class="row" id="weekly-settings">
                        <div class="col-md-6 mb-3">
                            <label for="weekday" class="form-label">Savaitės diena:</label>
                            <select class="form-select" id="weekday" name="weekday">
                                <option value="0" {% if edit_mode and task.weekday == 0 %}selected{% endif %}>Pirmadienis</option>
                                <option value="1" {% if edit_mode and task.weekday == 1 %}selected{% endif %}>Antradienis</option>
                                <option value="2" {% if edit_mode and task.weekday == 2 %}selected{% endif %}>Trečiadienis</option>
                                <option value="3" {% if edit_mode and task.weekday == 3 %}selected{% endif %}>Ketvirtadienis</option>
                                <option value="4" {% if edit_mode and task.weekday == 4 %}selected{% endif %}>Penktadienis</option>
                                <option value="5" {% if edit_mode and task.weekday == 5 %}selected{% endif %}>Šeštadienis</option>
                                <option value="6" {% if edit_mode and task.weekday == 6 %}selected{% endif %}>Sekmadienis</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row" id="monthly-settings">
                        <div class="col-md-6 mb-3">
                            <label for="day" class="form-label">Mėnesio diena:</label>
                            <select class="form-select" id="day" name="day">
                                {% for i in range(1, 32) %}
                                <option value="{{ i }}" {% if edit_mode and task.day == i %}selected{% endif %}>{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Modelio parametrai -->
                <h5 class="mt-4 mb-3">Modelio parametrai</h5>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="model_type" class="form-label">Modelio tipas:</label>
                                <select class="form-select" id="model_type" name="model_type">
                                    <option value="lstm" {% if edit_mode and task.model_params and task.model_params.type == 'lstm' %}selected{% endif %}>LSTM</option>
                                    <option value="gru" {% if edit_mode and task.model_params and task.model_params.type == 'gru' %}selected{% endif %}>GRU</option>
                                    <option value="transformer" {% if edit_mode and task.model_params and task.model_params.type == 'transformer' %}selected{% endif %}>Transformer</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="epochs" class="form-label">Epochų skaičius:</label>
                                <input type="number" class="form-control" id="epochs" name="epochs" min="1" max="1000" 
                                       value="{{ task.model_params.epochs if edit_mode and task.model_params else '50' }}">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="batch_size" class="form-label">Batch dydis:</label>
                                <input type="number" class="form-control" id="batch_size" name="batch_size" min="1" max="512" 
                                       value="{{ task.model_params.batch_size if edit_mode and task.model_params else '64' }}">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end">
                    <a href="{{ url_for('scheduler.tasks') }}" class="btn btn-secondary me-2">Atšaukti</a>
                    <button type="submit" class="btn btn-primary">Išsaugoti</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Paprastas JavaScript kodas laiko nustatymų valdymui
    document.addEventListener('DOMContentLoaded', function() {
        const frequencySelect = document.getElementById('frequency');
        const onceSettings = document.getElementById('once-settings');
        const weeklySettings = document.getElementById('weekly-settings');
        const monthlySettings = document.getElementById('monthly-settings');
        const timeSettings = document.getElementById('time-settings');
        
        // Funkcija rodiniams atnaujinti pagal pasirinktą dažnumą
        function updateSettings() {
            const frequency = frequencySelect.value;
            
            // Paslepiame visus nustatymus
            onceSettings.style.display = 'none';
            weeklySettings.style.display = 'none';
            monthlySettings.style.display = 'none';
            
            // Jei dažnumas yra 'queue', paslepiame visus laiko nustatymus
            if (frequency === 'queue') {
                timeSettings.style.display = 'none';
                return;
            }
            
            // Kitu atveju rodome tinkamus nustatymus
            timeSettings.style.display = 'block';
            
            if (frequency === 'once') {
                onceSettings.style.display = 'flex';
            } else if (frequency === 'weekly') {
                onceSettings.style.display = 'flex';
                weeklySettings.style.display = 'flex';
            } else if (frequency === 'monthly') {
                onceSettings.style.display = 'flex';
                monthlySettings.style.display = 'flex';
            } else if (frequency === 'daily') {
                onceSettings.style.display = 'flex';
            }
        }
        
        // Pradinis nustatymų atnaujinimas
        updateSettings();
        
        // Klausomės pasikeitimų
        frequencySelect.addEventListener('change', updateSettings);
    });
</script>
{% endblock %}