<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSTM Modelio Prognozės - Bitcoin Kainų Analizė</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <!-- Chart.js biblioteka grafikams -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome ikonėlėms -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Pridėkite šiuos stilius head sekcijoje arba jūsų CSS faile -->
    <style>
        .chart-container {
            position: relative;
            height: 400px !important;
            width: 100% !important;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        /* Įsitikinkite, kad predictionsChart turi šį stilių */
        #predictionsChart {
            width: 100% !important;
            height: 400px !important;
            max-width: 100% !important;
            max-height: 400px !important;
        }
        
        #candlestick-chart {
            width: 100% !important;
            height: 400px !important;
            max-width: 100% !important;
            max-height: 400px !important;
        }
    </style>
</head>
<body>
    <script>
    // Fix the JavaScript syntax error by properly handling the data with safe JSON encoding
    (function() {
        try {
            {% if price_history is defined and price_history %}
                console.log("Setting priceHistory from template");
                var priceHistoryData = {{ price_history|tojson|safe }};
                window.priceHistory = priceHistoryData;
                console.log("priceHistory set successfully:", window.priceHistory);
            {% else %}
                console.log("No price_history from template, using empty object");
                window.priceHistory = {"dates":[], "prices":[], "close":[], "volumes":[]};
            {% endif %}
        } catch(e) {
            console.error("Error setting priceHistory:", e);
            window.priceHistory = {"dates":[], "prices":[], "close":[], "volumes":[]};
        }
        
        try {
            {% if predictions is defined and predictions %}
                console.log("Setting predictions from template: {{ predictions|length }} predictions");
                var predictionsData = {{ predictions|tojson|safe }};
                window.predictions = predictionsData;
                console.log("predictions set successfully:", window.predictions);
            {% else %}
                console.log("No predictions from template");
                window.predictions = [];
            {% endif %}
        } catch(e) {
            console.error("Error setting predictions:", e);
            window.predictions = [];
        }
    })();
    </script>
    <div class="container my-4">
        <h1 class="text-center mb-4">Bitcoin Kainų Prognozavimas su LSTM</h1>
        
        <!-- Grįžimo mygtukas -->
        <div class="mb-3">
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Grįžti į pagrindinį puslapį
            </a>
            <a href="/models" class="btn btn-outline-info ms-2">
                <i class="fas fa-brain"></i> Modelių Valdymas
            </a>
        </div>
        
        <!-- Flash pranešimai -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Dabartinė kaina -->
        <div class="alert alert-info">
            <h3>
                Dabartinė kaina: <span id="btc-price">
    {% if latest_price is defined %}
        ${{ "%.2f"|format(latest_price) }}
    {% else %}
        $-.--
    {% endif %}
</span>
                <!-- Kainos pokytis su ikona/rodykle -->
                {% if price_change %}
                    {% if price_change.direction == 'up' %}
                        <span class="text-success">
                            <i class="fas fa-arrow-up"></i> +{{ "%.2f"|format(price_change.percent) }}%
                        </span>
                    {% elif price_change.direction == 'down' %}
                        <span class="text-danger">
                            <i class="fas fa-arrow-down"></i> {{ "%.2f"|format(price_change.percent) }}%
                        </span>
                    {% else %}
                        <span class="text-secondary">
                            <i class="fas fa-minus"></i> {{ "%.2f"|format(price_change.percent) }}%
                        </span>
                    {% endif %}
                {% endif %}
            </h3>
            <small>Atnaujinta: <span id="price-update-time">Dabar</span></small>
        </div>
        
        <!-- Klaidos pranešimas - pridėkite į predict.html šabloną apie eilutę 65-70, prieš grafiką -->
        {% if error_message %}
        <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-triangle me-2"></i> {{ error_message }}
        </div>
        {% endif %}
        
        <!-- Bitcoin Historical Price Chart (Top Chart) -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Bitcoin Historical Price Chart</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="candlestick-chart"></canvas>
                </div>
                <div id="candlestickError" class="alert alert-warning mt-3" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Remove the old chart placement -->
        <!-- Grafikas ir modelio valdymas -->
        <!-- <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">Bitcoin žvakių (OHLC) grafikas</div>
                    <div class="card-body">
                        <canvas id="candlestick-chart" style="height:400px;"></canvas>
                        <div id="candlestickError" class="alert alert-warning mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div> -->
        
        <!-- Modelių pasirinkimo blokas -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Modelių pasirinkimas</h6>
            </div>
            <div class="card-body">
                <form action="/predict" method="GET" id="predictionForm">
                    <input type="hidden" name="predict" value="true">
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Pasirinkite modelius prognozavimui:</label>
                            
                            {% if active_models %}
                            <div class="model-selection">
                                {% for model in active_models %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="models" value="{{ model.type }}" 
                                        id="model-{{ model.type }}" {% if model.type in selected_models %}checked{% endif %}>
                                    <label class="form-check-label" for="model-{{ model.type }}">
                                        <span class="badge bg-primary">{{ model.name }}</span>
                                        {% if model.performance %}
                                        <small class="text-muted">{{ model.performance }}</small>
                                        {% endif %}
                                        <div class="mt-1 small">{{ model.description }}</div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Nėra aktyvių modelių!</strong> Eikite į 
                                <a href="/models" class="alert-link">Modelių valdymo</a> puslapį ir 
                                aktyvuokite bent vieną modelį.
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="forecastDays" class="form-label">Prognozės laikotarpis (dienomis):</label>
                                <select class="form-select" id="forecastDays" name="days">
                                    <option value="1" {% if forecast_days == 1 %}selected{% endif %}>1 diena</option>
                                    <option value="3" {% if forecast_days == 3 %}selected{% endif %}>3 dienos</option>
                                    <option value="7" {% if forecast_days == 7 %}selected{% endif %}>1 savaitė (7 dienos)</option>
                                    <option value="14" {% if forecast_days == 14 %}selected{% endif %}>2 savaitės (14 dienų)</option>
                                    <option value="30" {% if forecast_days == 30 %}selected{% endif %}>1 mėnuo (30 dienų)</option>
                                </select>
                            </div>
                            
                            {% if latest_price %}
                            <div class="current-price-info mb-3">
                                <p class="fw-bold">Dabartinė Bitcoin kaina:</p>
                                <h3 class="text-primary">${{ latest_price|round(2) }}</h3>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button type="submit" class="btn btn-primary" {% if not active_models %}disabled{% endif %}>
                            <i class="fas fa-chart-line me-2"></i>Generuoti prognozes
                        </button>
                        {% if predictions %}
                        <a href="/predict" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-2"></i>Atstatyti
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Predictions Chart (Always show this section) -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    {% if predictions %}
                        Prognozės rezultatai ({{ forecast_days }} dienų)
                    {% else %}
                        Bitcoin kainų prognozės
                    {% endif %}
                </h6>
            </div>
            <div class="card-body">
                <!-- Predictions Chart Container (Always present) -->
                <div class="chart-container">
                    <canvas id="predictionsChart"></canvas>
                </div>

                <!-- Predictions Table (Only show when predictions exist) -->
                {% if predictions %}
                <div class="table-responsive mt-4">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Data</th>
                                {% for prediction in predictions %}
                                <th>{{ prediction.model }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody id="prediction-table-body">
                            {% if predictions and predictions[0].dates %}
                            {% for i in range(forecast_days) %}
                            <tr>
                                <td>{{ predictions[0].dates[i] }}</td>
                                {% for prediction in predictions %}
                                <td>
{% if prediction.values is defined and prediction.values is not none and prediction.values is not mapping and prediction.values is not string and prediction.values is not callable and i < (prediction.values|list|length) %}
    ${{ (prediction.values|list)[i]|round(2) }}
{% else %}
    N/A
{% endif %}
</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Pasirinkite modelius ir spustelėkite "Generuoti prognozes" norėdami pamatyti Bitcoin kainų prognozes.
                </div>
                {% endif %}
            </div>
        </div>
        
    <!-- Bootstrap Bundle su Popper (reikalingas pranešimų uždarymui) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Įtraukiame naują JS failą vietoj seno -->
    <script src="{{ url_for('static', filename='js/bitcoin-charts.js') }}"></script>
</body>
</html>