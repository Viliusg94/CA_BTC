<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSTM Modelio Prognozės - Bitcoin Kainų Analizė</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <!-- Chart.js biblioteka grafikams -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome ikonėlėms -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Pridėkite šiuos stilius head sekcijoje arba jūsų CSS faile -->
    <style>
        .chart-container {
            position: relative;
            height: 400px !important;
            width: 100% !important;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        /* Įsitikinkite, kad predictionsChart turi šį stilių */
        #predictionsChart {
            width: 100% !important;
            height: 400px !important;
            max-width: 100% !important;
            max-height: 400px !important;
        }
        
        #candlestick-chart {
            width: 100% !important;
            height: 400px !important;
            max-width: 100% !important;
            max-height: 400px !important;
        }
    </style>
</head>
<body>
    <script>
    // Initialize global variables safely
    window.priceHistory = {"dates":[], "prices":[], "close":[], "volumes":[]};
    window.predictions = {values: [], dates: []};
    
    // Load data via AJAX to avoid JSON serialization issues
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Predict page loading...');
        
        // Load live Bitcoin price first
        fetchLiveBitcoinPrice();
        
        // Auto-refresh price every 30 seconds
        setInterval(fetchLiveBitcoinPrice, 30000);
        
        // Initialize prediction chart
        setTimeout(() => {
            initializePredictionChart();
        }, 1000);
    });
    
    // Fetch live Bitcoin price from Binance API
    function fetchLiveBitcoinPrice() {
        console.log('Fetching live Bitcoin price for predict page...');
        
        // Show loading state
        const priceElement = document.getElementById('current-btc-price');
        if (priceElement && priceElement.textContent.includes('Kraunama')) {
            priceElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kraunama...';
        }
        
        // Fetch current price from Binance
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Binance API response:', data);
                
                if (data && data.symbol === 'BTCUSDT') {
                    const currentPrice = parseFloat(data.lastPrice);
                    const priceChange = parseFloat(data.priceChange);
                    const priceChangePercent = parseFloat(data.priceChangePercent);
                    
                    console.log(`Price: ${currentPrice}, Change: ${priceChange}, Change%: ${priceChangePercent}`);
                    
                    // Update the main price display
                    const priceElement = document.getElementById('current-btc-price');
                    if (priceElement) {
                        priceElement.textContent = '$' + currentPrice.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        console.log('Updated price element:', priceElement.textContent);
                    }
                    
                    // Update timestamp
                    const timestampElement = document.getElementById('last-updated');
                    if (timestampElement) {
                        timestampElement.textContent = new Date().toLocaleTimeString('lt-LT');
                    }
                    
                    // Update price change in hero card
                    const heroCard = document.querySelector('.price-card .card-body');
                    if (heroCard) {
                        // Remove existing price change
                        const existingChange = heroCard.querySelector('.live-price-change');
                        if (existingChange) {
                            existingChange.remove();
                        }
                        
                        // Add new price change display
                        const changeElement = document.createElement('h5');
                        changeElement.className = 'live-price-change mt-2';
                        
                        if (priceChangePercent > 0) {
                            changeElement.innerHTML = `<span class="text-success"><i class="fas fa-arrow-up"></i> +$${priceChange.toFixed(2)} (+${priceChangePercent.toFixed(2)}%)</span>`;
                        } else if (priceChangePercent < 0) {
                            changeElement.innerHTML = `<span class="text-danger"><i class="fas fa-arrow-down"></i> $${priceChange.toFixed(2)} (${priceChangePercent.toFixed(2)}%)</span>`;
                        } else {
                            changeElement.innerHTML = `<span class="text-light"><i class="fas fa-minus"></i> $0.00 (0.00%)</span>`;
                        }
                        
                        // Insert after the main price
                        const heroPrice = heroCard.querySelector('#current-btc-price');
                        if (heroPrice && heroPrice.parentNode) {
                            heroPrice.parentNode.insertBefore(changeElement, heroPrice.nextSibling);
                        }
                    }
                    
                    console.log('Live Bitcoin price updated on predict page:', currentPrice);
                } else {
                    throw new Error('Invalid response format from Binance API');
                }
            })
            .catch(error => {
                console.error("Error fetching live Bitcoin price:", error);
                
                // Try fallback API
                fetch('/api/btc_price/current')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const priceElement = document.getElementById('current-btc-price');
                            if (priceElement) {
                                priceElement.textContent = '$' + data.price.toLocaleString('en-US', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                            }
                            
                            const timestampElement = document.getElementById('last-updated');
                            if (timestampElement) {
                                timestampElement.textContent = new Date().toLocaleTimeString('lt-LT');
                            }
                            
                            console.log('Used fallback API for Bitcoin price');
                        } else {
                            throw new Error('Fallback API also failed');
                        }
                    })
                    .catch(fallbackError => {
                        console.error("Fallback API also failed:", fallbackError);
                        
                        // Show error message in main price display
                        const priceElement = document.getElementById('current-btc-price');
                        if (priceElement) {
                            priceElement.innerHTML = '<span class="text-warning">Klaida kraunant kainą</span>';
                        }
                    });
            });
    }
    </script>

    {% extends "base.html" %}

{% block title %}Bitcoin Prognozės{% endblock %}

{% block content %}
<script>
// Initialize global variables
window.priceHistory = {"dates":[], "prices":[], "close":[], "volumes":[]};
window.predictions = {values: [], dates: []};

// Load data via AJAX when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('Predict page loading...');
    
    // Load live Bitcoin price first
    fetchLiveBitcoinPrice();
    
    // Auto-refresh price every 30 seconds
    setInterval(fetchLiveBitcoinPrice, 30000);
    
    // Initialize prediction chart
    setTimeout(() => {
        initializePredictionChart();
    }, 1000);
});

// Fetch live Bitcoin price from Binance API
function fetchLiveBitcoinPrice() {
    console.log('Fetching live Bitcoin price for predict page...');
    
    // Show loading state
    const priceElement = document.getElementById('current-btc-price');
    if (priceElement && priceElement.textContent.includes('Kraunama')) {
        priceElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kraunama...';
    }
    
    // Fetch current price from Binance
    fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Binance API response:', data);
            
            if (data && data.symbol === 'BTCUSDT') {
                const currentPrice = parseFloat(data.lastPrice);
                const priceChange = parseFloat(data.priceChange);
                const priceChangePercent = parseFloat(data.priceChangePercent);
                
                console.log(`Price: ${currentPrice}, Change: ${priceChange}, Change%: ${priceChangePercent}`);
                
                // Update the main price display
                const priceElement = document.getElementById('current-btc-price');
                if (priceElement) {
                    priceElement.textContent = '$' + currentPrice.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    console.log('Updated price element:', priceElement.textContent);
                }
                
                // Update timestamp
                const timestampElement = document.getElementById('last-updated');
                if (timestampElement) {
                    timestampElement.textContent = new Date().toLocaleTimeString('lt-LT');
                }
                
                // Update price change in hero card
                const heroCard = document.querySelector('.price-card .card-body');
                if (heroCard) {
                    // Remove existing price change
                    const existingChange = heroCard.querySelector('.live-price-change');
                    if (existingChange) {
                        existingChange.remove();
                    }
                    
                    // Add new price change display
                    const changeElement = document.createElement('h5');
                    changeElement.className = 'live-price-change mt-2';
                    
                    if (priceChangePercent > 0) {
                        changeElement.innerHTML = `<span class="text-success"><i class="fas fa-arrow-up"></i> +$${priceChange.toFixed(2)} (+${priceChangePercent.toFixed(2)}%)</span>`;
                    } else if (priceChangePercent < 0) {
                        changeElement.innerHTML = `<span class="text-danger"><i class="fas fa-arrow-down"></i> $${priceChange.toFixed(2)} (${priceChangePercent.toFixed(2)}%)</span>`;
                    } else {
                        changeElement.innerHTML = `<span class="text-light"><i class="fas fa-minus"></i> $0.00 (0.00%)</span>`;
                    }
                    
                    // Insert after the main price
                    const heroPrice = heroCard.querySelector('#current-btc-price');
                    if (heroPrice && heroPrice.parentNode) {
                        heroPrice.parentNode.insertBefore(changeElement, heroPrice.nextSibling);
                    }
                }
                
                console.log('Live Bitcoin price updated on predict page:', currentPrice);
            } else {
                throw new Error('Invalid response format from Binance API');
            }
        })
        .catch(error => {
            console.error("Error fetching live Bitcoin price:", error);
            
            // Try fallback API
            fetch('/api/btc_price/current')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const priceElement = document.getElementById('current-btc-price');
                        if (priceElement) {
                            priceElement.textContent = '$' + data.price.toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                        
                        const timestampElement = document.getElementById('last-updated');
                        if (timestampElement) {
                            timestampElement.textContent = new Date().toLocaleTimeString('lt-LT');
                        }
                        
                        console.log('Used fallback API for Bitcoin price');
                    } else {
                        throw new Error('Fallback API also failed');
                    }
                })
                .catch(fallbackError => {
                    console.error("Fallback API also failed:", fallbackError);
                    
                    // Show error message in main price display
                    const priceElement = document.getElementById('current-btc-price');
                    if (priceElement) {
                        priceElement.innerHTML = '<span class="text-warning">Klaida kraunant kainą</span>';
                    }
                });
        });
}
</script>

<h1 class="text-center mb-4">
    <i class="fas fa-crystal-ball text-primary"></i>
    Bitcoin Kainų Prognozės
</h1>

<!-- Navigation -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <a href="/" class="btn btn-secondary me-2">
            <i class="fas fa-home"></i> Pagrindinis
        </a>
        <a href="/predict" class="btn btn-primary me-2">
            <i class="fas fa-chart-line"></i> Prognozės
        </a>
        <a href="/models" class="btn btn-info me-2">
            <i class="fas fa-brain"></i> Modeliai
        </a>
        <a href="/history" class="btn btn-secondary me-2">
            <i class="fas fa-history"></i> Istorija
        </a>
        <a href="/training_status" class="btn btn-success">
            <i class="fas fa-tasks"></i> Apmokymas
        </a>
    </div>
</div>

<!-- Current Price Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card price-card shadow">
            <div class="card-body text-center">
                <h2 class="card-title">
                    <i class="fab fa-bitcoin"></i> Dabartinė Bitcoin Kaina
                </h2>
                <h1 class="display-4 fw-bold" id="current-btc-price">
                    Kraunama...
                </h1>
                <small class="text-light opacity-75">
                    Atnaujinta: <span id="last-updated">Kraunama...</span>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Prediction Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-sliders-h"></i> Prognozės Nustatymai
                </h5>
            </div>
            <div class="card-body">
                <form id="prediction-form">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="prediction-days" class="form-label">Prognozės Laikotarpis</label>
                            <select class="form-select" id="prediction-days">
                                <option value="7">7 dienos</option>
                                <option value="14">14 dienų</option>
                                <option value="30" selected>30 dienų</option>
                                <option value="60">60 dienų</option>
                                <option value="90">90 dienų</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="model-selection" class="form-label">AI Modelis</label>
                            <select class="form-select" id="model-selection">
                                <option value="lstm" selected>LSTM Neural Network</option>
                                <option value="gru">GRU Neural Network</option>
                                <option value="ensemble">Ensemble Model</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="confidence-level" class="form-label">Patikimumo Lygis</label>
                            <select class="form-select" id="confidence-level">
                                <option value="0.8">80%</option>
                                <option value="0.9" selected>90%</option>
                                <option value="0.95">95%</option>
                                <option value="0.99">99%</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-magic"></i> Generuoti Prognozes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Prediction Results Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-line"></i> Bitcoin Kainų Prognozės
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="prediction-chart"></canvas>
                </div>
                <div id="predictionError" class="alert alert-warning mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Prediction Statistics -->
<div class="row">
    <div class="col-md-3">
        <div class="card stats-card shadow border-left-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Prognozuojama Kaina (7d)
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="prediction-7d">
                            Generuokite prognozes
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-week fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card shadow border-left-success">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Prognozuojama Kaina (30d)
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="prediction-30d">
                            Generuokite prognozes
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card shadow border-left-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Modelio Tikslumas
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="model-accuracy">
                            85.7%
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-bullseye fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card shadow border-left-danger">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Prognozės Rizika
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="prediction-risk">
                            Vidutinė
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/bitcoin-charts.js') }}"></script>
<script>
    // JavaScript code for handling predictions and chart updates
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to UI elements
        const modelSelect = document.getElementById('model-select');
        const predictionDays = document.getElementById('prediction-days');
        const predictButton = document.getElementById('predict-button');
        const predictionResults = document.getElementById('prediction-results');
        
        // Set up model selection change handler
        modelSelect.addEventListener('change', function() {
            updateModelDescription(this.value);
        });
        
        // Initialize model description
        if (modelSelect.value) {
            updateModelDescription(modelSelect.value);
        }
        
        // Set up predict button click handler
        predictButton.addEventListener('click', function() {
            // Show loading state
            predictButton.disabled = true;
            predictButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Generuojama prognozė...';
            
            // Get selected model and days
            const modelId = modelSelect.value;
            const days = predictionDays.value;
            
            if (!modelId) {
                alert('Prašome pasirinkti modelį');
                resetPredictButton();
                return;
            }
            
            // Make API request to get prediction
            fetch(`/api/predict?model_id=${modelId}&days=${days}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Serverio klaida');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Process prediction data
                    processPrediction(data);
                    
                    // Show results
                    predictionResults.style.display = 'block';
                    
                    // Scroll to results
                    predictionResults.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('Prediction error:', error);
                    alert(`Klaida generuojant prognozę: ${error.message}`);
                })
                .finally(() => {
                    resetPredictButton();
                });
        });
        
        function resetPredictButton() {
            predictButton.disabled = false;
            predictButton.innerHTML = '<i class="fas fa-chart-line me-2"></i> Prognozuoti Bitcoin kainą';
        }
        
        function updateModelDescription(modelId) {
            // Update the model description based on selected model
            // This would typically fetch model details from the server
            // For now, just clear the description
            document.getElementById('model-description').textContent = '';
            
            // Optionally fetch model details if needed
            // fetch(`/api/models/${modelId}`)...
        }
        
        function processPrediction(data) {
            // Process and display prediction data
            if (data.predictions && data.predictions.values) {
                // Update prediction chart
                updatePredictionChart(data.predictions);
                
                // Update prediction table
                updatePredictionTable(data.predictions);
                
                // Update summary statistics
                updatePredictionSummary(data.predictions);
            }
        }
        
        function updatePredictionChart(predictions) {
            // Get the chart canvas
            const chartCanvas = document.getElementById('prediction-chart');
            if (!chartCanvas) return;
            
            // If a chart already exists, destroy it
            if (window.predictionChart) {
                window.predictionChart.destroy();
            }
            
            // Create the new chart
            const ctx = chartCanvas.getContext('2d');
            window.predictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: predictions.dates || [],
                    datasets: [{
                        label: 'Prognozuojama Bitcoin kaina (USD)',
                        data: predictions.values || [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        function updatePredictionTable(predictions) {
            // Update prediction table with values
            const tableBody = document.getElementById('prediction-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (predictions.values && predictions.dates) {
                for (let i = 0; i < predictions.values.length; i++) {
                    const row = document.createElement('tr');
                    
                    const dateCell = document.createElement('td');
                    dateCell.textContent = predictions.dates[i] || `Diena ${i+1}`;
                    
                    const valueCell = document.createElement('td');
                    valueCell.textContent = `$${predictions.values[i].toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    
                    row.appendChild(dateCell);
                    row.appendChild(valueCell);
                    tableBody.appendChild(row);
                }
            }
        }
        
        function updatePredictionSummary(predictions) {
            // Update prediction summary statistics
            if (!predictions.values || predictions.values.length === 0) return;
            
            const currentPrice = window.currentPrice || predictions.values[0];
            const latestPrediction = predictions.values[predictions.values.length - 1];
            
            // Calculate change and percentage
            const change = latestPrediction - currentPrice;
            const percentChange = (change / currentPrice) * 100;
            
            // Update summary elements if they exist
            const predictionValue = document.getElementById('prediction-value');
            if (predictionValue) {
                predictionValue.textContent = `$${latestPrediction.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            const predictionChange = document.getElementById('prediction-change');
            if (predictionChange) {
                predictionChange.textContent = `${change >= 0 ? '+' : ''}$${change.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                predictionChange.className = change >= 0 ? 'text-success' : 'text-danger';
            }
            
            const predictionPercent = document.getElementById('prediction-percent');
            if (predictionPercent) {
                predictionPercent.textContent = `${percentChange >= 0 ? '+' : ''}${percentChange.toFixed(2)}%`;
                predictionPercent.className = percentChange >= 0 ? 'text-success' : 'text-danger';
            }
        }
    });
</script>
{% endblock %}
</body>
</html>