<!-- Pranešimų centro šablonas -->
{% extends "base.html" %}

{% block head %}
<style>
    /* Pranešimų stiliaus aprašai */
    .notification-item {
        border-left: 4px solid #ccc;
        margin-bottom: 10px;
        transition: background-color 0.2s;
    }
    
    .notification-item:hover {
        background-color: #f8f9fa;
    }
    
    .notification-item.unread {
        background-color: #f0f7ff;
    }
    
    .notification-item.info {
        border-left-color: #17a2b8;
    }
    
    .notification-item.success {
        border-left-color: #28a745;
    }
    
    .notification-item.warning {
        border-left-color: #ffc107;
    }
    
    .notification-item.error {
        border-left-color: #dc3545;
    }
    
    .notification-item.process {
        border-left-color: #007bff;
    }
    
    .notification-progress {
        height: 5px;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Puslapio antraštė -->
    <h1>{{ title }}</h1>
    
    <!-- Valdymo mygtukai -->
    <div class="mb-4">
        <div class="btn-group" role="group">
            <a href="{{ url_for('notifications.notification_center') }}" class="btn btn-outline-primary">
                <i class="fas fa-list"></i> Visi pranešimai
            </a>
            <a href="{{ url_for('notifications.notification_center', type='info') }}" class="btn btn-outline-info">
                <i class="fas fa-info-circle"></i> Informacija
            </a>
            <a href="{{ url_for('notifications.notification_center', type='success') }}" class="btn btn-outline-success">
                <i class="fas fa-check-circle"></i> Sėkmė
            </a>
            <a href="{{ url_for('notifications.notification_center', type='warning') }}" class="btn btn-outline-warning">
                <i class="fas fa-exclamation-triangle"></i> Perspėjimai
            </a>
            <a href="{{ url_for('notifications.notification_center', type='error') }}" class="btn btn-outline-danger">
                <i class="fas fa-times-circle"></i> Klaidos
            </a>
            <a href="{{ url_for('notifications.notification_center', type='process') }}" class="btn btn-outline-primary">
                <i class="fas fa-cogs"></i> Procesai
            </a>
        </div>
        
        <div class="float-end">
            <button id="mark-all-read" class="btn btn-outline-secondary">
                <i class="fas fa-check-double"></i> Pažymėti visus kaip perskaitytus
            </button>
            <button id="delete-all" class="btn btn-outline-danger">
                <i class="fas fa-trash"></i> Išvalyti visus
            </button>
        </div>
    </div>
    
    <!-- Pranešimų sąrašas -->
    <div class="card">
        <div class="card-body">
            <div id="notification-list" class="list-group">
                {% if notifications %}
                    {% for notification in notifications %}
                    <div class="list-group-item notification-item {{ notification.type.value }} {{ 'unread' if notification.status.value == 'unread' else '' }}" 
                         data-id="{{ notification.id }}" data-status="{{ notification.status.value }}">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">
                                {% if notification.type.value == 'info' %}
                                <i class="fas fa-info-circle text-info"></i>
                                {% elif notification.type.value == 'success' %}
                                <i class="fas fa-check-circle text-success"></i>
                                {% elif notification.type.value == 'warning' %}
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                {% elif notification.type.value == 'error' %}
                                <i class="fas fa-times-circle text-danger"></i>
                                {% elif notification.type.value == 'process' %}
                                <i class="fas fa-cogs text-primary"></i>
                                {% endif %}
                                
                                {{ notification.title }}
                                
                                {% if notification.status.value == 'unread' %}
                                <span class="badge bg-danger rounded-pill ms-2">Naujas</span>
                                {% endif %}
                            </h5>
                            <small class="text-muted">{{ notification.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                        <p class="mb-1">{{ notification.message }}</p>
                        
                        {% if notification.target_url %}
                        <div class="mt-2">
                            <a href="{{ notification.target_url }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-external-link-alt"></i> Atidaryti
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if notification.type.value == 'process' and notification.progress is not none %}
                        <div class="progress notification-progress">
                            <div class="progress-bar" role="progressbar" style="width: {{ notification.progress }}%;" 
                                 aria-valuenow="{{ notification.progress }}" aria-valuemin="0" aria-valuemax="100">
                                {{ notification.progress }}%
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mt-2 d-flex justify-content-end">
                            {% if notification.status.value == 'unread' %}
                            <button class="btn btn-sm btn-outline-primary mark-read-btn" data-id="{{ notification.id }}">
                                <i class="fas fa-check"></i> Pažymėti kaip perskaitytą
                            </button>
                            {% endif %}
                            
                            <button class="btn btn-sm btn-outline-danger ms-2 delete-btn" data-id="{{ notification.id }}">
                                <i class="fas fa-trash"></i> Ištrinti
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Jūs neturite pranešimų.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Pažymėti pranešimą kaip perskaitytą
        const markReadButtons = document.querySelectorAll('.mark-read-btn');
        markReadButtons.forEach(button => {
            button.addEventListener('click', function() {
                const notificationId = this.getAttribute('data-id');
                markNotificationAsRead(notificationId);
            });
        });
        
        // Ištrinti pranešimą
        const deleteButtons = document.querySelectorAll('.delete-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const notificationId = this.getAttribute('data-id');
                deleteNotification(notificationId);
            });
        });
        
        // Pažymėti visus kaip perskaitytus
        document.getElementById('mark-all-read').addEventListener('click', markAllAsRead);
        
        // Ištrinti visus pranešimus
        document.getElementById('delete-all').addEventListener('click', deleteAllNotifications);
    });
    
    // Pažymi pranešimą kaip perskaitytą
    function markNotificationAsRead(notificationId) {
        fetch(`/notifications/${notificationId}/mark-read`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atnaujina UI
                const notificationItem = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
                if (notificationItem) {
                    notificationItem.classList.remove('unread');
                    notificationItem.setAttribute('data-status', 'read');
                    
                    // Pašalina "Naujas" ženkliuką
                    const badge = notificationItem.querySelector('.badge');
                    if (badge) badge.remove();
                    
                    // Pašalina "Pažymėti kaip perskaitytą" mygtuką
                    const markReadBtn = notificationItem.querySelector('.mark-read-btn');
                    if (markReadBtn) markReadBtn.remove();
                }
            }
        })
        .catch(error => {
            console.error('Klaida žymint pranešimą kaip perskaitytą:', error);
        });
    }
    
    // Ištrina pranešimą
    function deleteNotification(notificationId) {
        if (!confirm('Ar tikrai norite ištrinti šį pranešimą?')) {
            return;
        }
        
        fetch(`/notifications/${notificationId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Pašalina iš UI
                const notificationItem = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
                if (notificationItem) {
                    notificationItem.remove();
                }
                
                // Jei nebeliko pranešimų, rodo pranešimą
                const notificationList = document.getElementById('notification-list');
                if (notificationList.children.length === 0) {
                    notificationList.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Jūs neturite pranešimų.
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Klaida trinant pranešimą:', error);
        });
    }
    
    // Pažymi visus pranešimus kaip perskaitytus
    function markAllAsRead() {
        fetch('/notifications/mark-all-read', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atnaujina UI
                const unreadItems = document.querySelectorAll('.notification-item.unread');
                unreadItems.forEach(item => {
                    item.classList.remove('unread');
                    item.setAttribute('data-status', 'read');
                    
                    // Pašalina "Naujas" ženkliuką
                    const badge = item.querySelector('.badge');
                    if (badge) badge.remove();
                    
                    // Pašalina "Pažymėti kaip perskaitytą" mygtuką
                    const markReadBtn = item.querySelector('.mark-read-btn');
                    if (markReadBtn) markReadBtn.remove();
                });
            }
        })
        .catch(error => {
            console.error('Klaida žymint visus pranešimus kaip perskaitytus:', error);
        });
    }
    
    // Ištrina visus pranešimus
    function deleteAllNotifications() {
        if (!confirm('Ar tikrai norite ištrinti VISUS pranešimus?')) {
            return;
        }
        
        fetch('/notifications/delete-all', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Išvalo sąrašą
                const notificationList = document.getElementById('notification-list');
                notificationList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Jūs neturite pranešimų.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Klaida trinant visus pranešimus:', error);
        });
    }
</script>
{% endblock %}