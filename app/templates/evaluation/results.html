{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1>Vertinimo rezultatai</h1>
    
    {% if model %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Modelis: {{ model.name }}
        </div>
        <div class="card-body">
            <p><strong>Tipas:</strong> {{ model.type }}</p>
            <p><strong>Aprašymas:</strong> {{ model.description or 'Nėra aprašymo' }}</p>
            <p><strong>Sukurtas:</strong> {{ model.created_at }}</p>
        </div>
    </div>
    {% endif %}
    
    {% if dataset %}
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            Duomenų rinkinys: {{ dataset.name }}
        </div>
        <div class="card-body">
            <p><strong>Aprašymas:</strong> {{ dataset.description }}</p>
            <p><strong>Šaltinis:</strong> {{ dataset.source }}</p>
            <p><strong>Eilučių skaičius:</strong> {{ dataset.rows }}</p>
            <p><strong>Stulpelių skaičius:</strong> {{ dataset.columns }}</p>
        </div>
    </div>
    {% endif %}
    
    {% if results %}
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    Vertinimo metrikos
                </div>
                <div class="card-body">
                    <table class="table">
                        <tbody>
                            <tr>
                                <th>Tikslumas (Accuracy)</th>
                                <td>{{ "%.2f"|format((results.accuracy or 0) * 100) }}%</td>
                            </tr>
                            <tr>
                                <th>Precizija (Precision)</th>
                                <td>{{ "%.2f"|format((results.precision or 0) * 100) }}%</td>
                            </tr>
                            <tr>
                                <th>Jautrumas (Recall)</th>
                                <td>{{ "%.2f"|format((results.recall or 0) * 100) }}%</td>
                            </tr>
                            <tr>
                                <th>F1 įvertis</th>
                                <td>{{ "%.2f"|format((results.f1_score or 0) * 100) }}%</td>
                            </tr>
                            <tr>
                                <th>Vertinimo data</th>
                                <td>{{ results.timestamp or 'Nežinoma' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    Vertinimo vizualizacija
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <canvas id="metricsChart" width="400" height="300"></canvas>
                    </div>
                    <p class="text-muted">Modelio vertinimo metrikų vizualizacija</p>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <h4 class="alert-heading">Nėra rezultatų</h4>
        <p>Nepavyko rasti modelio vertinimo rezultatų. Bandykite atlikti vertinimą iš naujo.</p>
    </div>
    {% endif %}
    
    <div class="d-flex justify-content-between">
        {% if results and results.training_id %}
        <a href="{{ url_for('model_evaluation.evaluate_model', training_id=results.training_id) }}" class="btn btn-secondary">Grįžti į vertinimo puslapį</a>
        {% else %}
        <a href="{{ url_for('model_evaluation.index') }}" class="btn btn-secondary">Grįžti į vertinimų sąrašą</a>
        {% endif %}
        <a href="{{ url_for('model_evaluation.index') }}" class="btn btn-primary">Visi modeliai</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if results %}
        // Tikriname, ar elementas egzistuoja
        const chartElement = document.getElementById('metricsChart');
        if (chartElement) {
            const ctx = chartElement.getContext('2d');
            
            // Saugiai gauname reikšmes su apsauga nuo null
            const accuracy = {{ (results.accuracy or 0)|tojson }};
            const precision = {{ (results.precision or 0)|tojson }};
            const recall = {{ (results.recall or 0)|tojson }};
            const f1_score = {{ (results.f1_score or 0)|tojson }};
            
            const metricsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Tikslumas', 'Precizija', 'Jautrumas', 'F1 įvertis'],
                    datasets: [{
                        label: 'Vertinimo metrikos',
                        data: [
                            accuracy,
                            precision,
                            recall,
                            f1_score
                        ],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return (context.raw * 100).toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        {% endif %}
    });
</script>
{% endblock %}