{% extends "base.html" %}

{% block title %}Hiperparametrų optimizavimas - BTC Prekybos Sistema{% endblock %}

{% block styles %}
<style>
    .strategy-card {
        margin-bottom: 20px;
        height: 100%;
    }
    
    .strategy-card .card-header {
        font-weight: bold;
    }
    
    .param-section {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .param-row {
        margin-bottom: 10px;
    }
    
    .chart-container {
        height: 400px;
        margin-bottom: 20px;
    }
    
    .result-table th {
        font-size: 0.9rem;
    }
    
    .result-table td {
        font-size: 0.85rem;
    }
    
    .best-result {
        background-color: rgba(40, 167, 69, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Hiperparametrų optimizavimas</h1>
            <p class="text-muted">Atraskite optimaliausius parametrus modelio treniravimui</p>
        </div>
    </div>
    
    <div class="row mb-4">
        <!-- Optimizavimo strategijos -->
        <div class="col-md-6">
            <div class="card strategy-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Grid Search</h5>
                </div>
                <div class="card-body">
                    <p>Grid Search išbando visas galimas parametrų kombinacijas jūsų nurodytose ribose.</p>
                    <p><strong>Privalumai:</strong></p>
                    <ul>
                        <li>Garantuotai ras geriausią kombinaciją</li>
                        <li>Sistemingas ir nuoseklus</li>
                    </ul>
                    <p><strong>Trūkumai:</strong></p>
                    <ul>
                        <li>Gali užtrukti labai ilgai</li>
                        <li>Neefektyvus didelėse parametrų erdvėse</li>
                    </ul>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-primary" onclick="selectStrategy('grid')">Pasirinkti Grid Search</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card strategy-card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Random Search</h5>
                </div>
                <div class="card-body">
                    <p>Random Search atsitiktinai išbando parametrų kombinacijas jūsų nurodytose ribose.</p>
                    <p><strong>Privalumai:</strong></p>
                    <ul>
                        <li>Daug greitesnis nei Grid Search</li>
                        <li>Efektyvesnis didelėse parametrų erdvėse</li>
                    </ul>
                    <p><strong>Trūkumai:</strong></p>
                    <ul>
                        <li>Gali neaptikti geriausios kombinacijos</li>
                        <li>Atsitiktinis, mažiau sistemingas</li>
                    </ul>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-success" onclick="selectStrategy('random')">Pasirinkti Random Search</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Optimizavimo forma -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header" id="optimization-form-header">
                    <h5 class="card-title mb-0">Nustatykite optimizavimo parametrus</h5>
                </div>
                <div class="card-body">
                    <form id="optimizationForm" method="POST" action="{{ url_for('training.start_optimization') }}">
                        <!-- Paslėptas laukas strategijai -->
                        <input type="hidden" id="strategy" name="strategy" value="grid">
                        
                        <!-- Bendri parametrai -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="optimization_name" class="form-label">Optimizavimo pavadinimas</label>
                                    <input type="text" class="form-control" id="optimization_name" name="optimization_name" 
                                           placeholder="Pvz.: LSTM_Optimizacija_v1" required>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3" id="random-trials-container" style="display: none;">
                                    <label for="num_trials" class="form-label">Bandymų skaičius</label>
                                    <input type="number" class="form-control" id="num_trials" name="num_trials" 
                                           min="5" max="50" value="20">
                                    <div class="form-text">Pasirinkite, kiek skirtingų kombinacijų nori išbandyti</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modelių tipų parametrai -->
                        <div class="param-section">
                            <h5>Modelių tipai</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="model_types" id="model_type_lstm" value="LSTM" checked>
                                        <label class="form-check-label" for="model_type_lstm">LSTM</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="model_types" id="model_type_gru" value="GRU" checked>
                                        <label class="form-check-label" for="model_type_gru">GRU</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="model_types" id="model_type_cnn" value="CNN-LSTM">
                                        <label class="form-check-label" for="model_type_cnn">CNN-LSTM</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sluoksnių parametrai -->
                        <div class="param-section">
                            <h5>Sluoksnių parametrai</h5>
                            <div class="row param-row">
                                <div class="col-md-6">
                                    <label for="layers_min" class="form-label">Sluoksnių skaičius (min-max)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="layers_min" name="layers_min" min="1" max="5" value="1">
                                        <span class="input-group-text">-</span>
                                        <input type="number" class="form-control" id="layers_max" name="layers_max" min="1" max="5" value="3">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="units_min" class="form-label">Neuronų skaičius (min-max)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="units_min" name="units_min" min="16" max="256" step="16" value="32">
                                        <span class="input-group-text">-</span>
                                        <input type="number" class="form-control" id="units_max" name="units_max" min="16" max="256" step="16" value="128">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row param-row">
                                <div class="col-md-6">
                                    <label for="dropout_min" class="form-label">Dropout (min-max)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="dropout_min" name="dropout_min" min="0" max="0.5" step="0.1" value="0.1">
                                        <span class="input-group-text">-</span>
                                        <input type="number" class="form-control" id="dropout_max" name="dropout_max" min="0" max="0.5" step="0.1" value="0.3">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">Mokymosi greitis</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="learning_rates" id="lr_0_1" value="0.1">
                                            <label class="form-check-label" for="lr_0_1">0.1</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="learning_rates" id="lr_0_01" value="0.01">
                                            <label class="form-check-label" for="lr_0_01">0.01</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="learning_rates" id="lr_0_001" value="0.001" checked>
                                            <label class="form-check-label" for="lr_0_001">0.001</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="learning_rates" id="lr_0_0001" value="0.0001">
                                            <label class="form-check-label" for="lr_0_0001">0.0001</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Treniravimo parametrai -->
                        <div class="param-section">
                            <h5>Treniravimo parametrai</h5>
                            <div class="row param-row">
                                <div class="col-md-4">
                                    <label for="epochs" class="form-label">Epochų skaičius</label>
                                    <input type="number" class="form-control" id="epochs" name="epochs" min="10" max="100" value="30">
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="batch_size" class="form-label">Batch dydis</label>
                                    <input type="number" class="form-control" id="batch_size" name="batch_size" min="8" max="128" step="8" value="32">
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="sequence_length" class="form-label">Sekos ilgis</label>
                                    <input type="number" class="form-control" id="sequence_length" name="sequence_length" min="10" max="100" value="60">
                                </div>
                            </div>
                            
                            <div class="row param-row">
                                <div class="col-md-4">
                                    <label for="test_size" class="form-label">Testavimo imties dalis</label>
                                    <input type="number" class="form-control" id="test_size" name="test_size" min="0.1" max="0.5" step="0.05" value="0.2">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kombinacijų skaičiaus apskaičiavimas -->
                        <div class="alert alert-info mb-4 mt-4" id="combinations-info">
                            <div class="fw-bold">Kombinacijų skaičius: <span id="combinations-count">0</span></div>
                            <div id="grid-info">Grid Search išbandys visas įmanomas parametrų kombinacijas.</div>
                            <div id="random-info" style="display: none;">Random Search atsitiktinai pasirinks <span id="random-trials-count">20</span> kombinacijų.</div>
                            <div class="mt-2">
                                <small>Pastaba: Didelis kombinacijų skaičius gali užtrukti ilgą laiką.</small>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Pradėti optimizavimą</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pasirinkta strategija
    let selectedStrategy = 'grid';
    
    // Funkcija atnaujinti kombinacijų skaičių
    function updateCombinationsCount() {
        // Gauname pasirinktus modelių tipus
        const modelTypes = document.querySelectorAll('input[name="model_types"]:checked');
        const modelTypesCount = modelTypes.length;
        
        // Gauname sluoksnių ribas
        const layersMin = parseInt(document.getElementById('layers_min').value);
        const layersMax = parseInt(document.getElementById('layers_max').value);
        const layersCount = layersMax - layersMin + 1;
        
        // Gauname neuronų ribas
        const unitsMin = parseInt(document.getElementById('units_min').value);
        const unitsMax = parseInt(document.getElementById('units_max').value);
        const unitsStep = 16;
        const unitsCount = Math.floor((unitsMax - unitsMin) / unitsStep) + 1;
        
        // Gauname dropout ribas
        const dropoutMin = parseFloat(document.getElementById('dropout_min').value);
        const dropoutMax = parseFloat(document.getElementById('dropout_max').value);
        const dropoutStep = 0.1;
        const dropoutCount = Math.round((dropoutMax - dropoutMin) / dropoutStep) + 1;
        
        // Gauname mokymosi greičius
        const learningRates = document.querySelectorAll('input[name="learning_rates"]:checked');
        const learningRatesCount = learningRates.length;
        
        // Apskaičiuojame kombinacijų skaičių
        const totalCombinations = modelTypesCount * layersCount * unitsCount * dropoutCount * learningRatesCount;
        
        // Atnaujiname rezultatą
        document.getElementById('combinations-count').textContent = totalCombinations;
        
        // Atnaujiname Random Search bandymų skaičių
        document.getElementById('random-trials-count').textContent = document.getElementById('num_trials').value;
        
        return totalCombinations;
    }
    
    // Funkcija pasirinkti strategiją
    function selectStrategy(strategy) {
        selectedStrategy = strategy;
        
        // Atnaujiname strategijos lauką formoje
        document.getElementById('strategy').value = strategy;
        
        // Atnaujiname antraštę
        const headerElement = document.getElementById('optimization-form-header');
        headerElement.className = strategy === 'grid' ? 'card-header bg-primary text-white' : 'card-header bg-success text-white';
        headerElement.innerHTML = `<h5 class="card-title mb-0">${strategy === 'grid' ? 'Grid' : 'Random'} Search optimizavimo parametrai</h5>`;
        
        // Rodome/slepiame Random trials lauką
        const randomTrialsContainer = document.getElementById('random-trials-container');
        randomTrialsContainer.style.display = strategy === 'random' ? 'block' : 'none';
        
        // Rodome/slepiame atitinkamą informacinį tekstą
        document.getElementById('grid-info').style.display = strategy === 'grid' ? 'block' : 'none';
        document.getElementById('random-info').style.display = strategy === 'random' ? 'block' : 'none';
        
        // Atnaujiname kombinacijų skaičių
        updateCombinationsCount();
    }
    
    // Klausiame patvirtinimo prieš pradedant optimizavimą
    document.getElementById('optimizationForm').addEventListener('submit', function(event) {
        // Patikriname, ar yra pasirinkti modelių tipai
        const modelTypes = document.querySelectorAll('input[name="model_types"]:checked');
        if (modelTypes.length === 0) {
            alert('Prašome pasirinkti bent vieną modelio tipą!');
            event.preventDefault();
            return;
        }
        
        // Patikriname, ar yra pasirinkti mokymosi greičiai
        const learningRates = document.querySelectorAll('input[name="learning_rates"]:checked');
        if (learningRates.length === 0) {
            alert('Prašome pasirinkti bent vieną mokymosi greitį!');
            event.preventDefault();
            return;
        }
        
        // Patikriname, ar sluoksnių min <= max
        const layersMin = parseInt(document.getElementById('layers_min').value);
        const layersMax = parseInt(document.getElementById('layers_max').value);
        if (layersMin > layersMax) {
            alert('Minimalus sluoksnių skaičius negali būti didesnis už maksimalų!');
            event.preventDefault();
            return;
        }
        
        // Patikriname, ar neuronų min <= max
        const unitsMin = parseInt(document.getElementById('units_min').value);
        const unitsMax = parseInt(document.getElementById('units_max').value);
        if (unitsMin > unitsMax) {
            alert('Minimalus neuronų skaičius negali būti didesnis už maksimalų!');
            event.preventDefault();
            return;
        }
        
        // Patikriname, ar dropout min <= max
        const dropoutMin = parseFloat(document.getElementById('dropout_min').value);
        const dropoutMax = parseFloat(document.getElementById('dropout_max').value);
        if (dropoutMin > dropoutMax) {
            alert('Minimalus dropout negali būti didesnis už maksimalų!');
            event.preventDefault();
            return;
        }
        
        // Skaičiuojame kombinacijų skaičių
        const totalCombinations = updateCombinationsCount();
        
        // Jei per daug kombinacijų, prašome patvirtinimo
        if (selectedStrategy === 'grid' && totalCombinations > 50) {
            if (!confirm(`Jūs pasirinkote ${totalCombinations} parametrų kombinacijas, o tai gali užtrukti labai ilgai. Ar tikrai norite tęsti?`)) {
                event.preventDefault();
                return;
            }
        }
        
        // Paprašome patvirtinimo
        if (!confirm('Ar tikrai norite pradėti hiperparametrų optimizavimą? Tai gali užtrukti ilgą laiką, priklausomai nuo pasirinktų parametrų.')) {
            event.preventDefault();
        }
    });
    
    // Inicializuojame puslapį
    document.addEventListener('DOMContentLoaded', function() {
        // Nustatome pradinę strategiją
        selectStrategy('grid');
        
        // Pridedame įvykių klausytojus parametrų laukams
        const paramFields = [
            'layers_min', 'layers_max', 'units_min', 'units_max', 
            'dropout_min', 'dropout_max', 'num_trials'
        ];
        
        paramFields.forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('change', updateCombinationsCount);
        });
        
        // Pridedame įvykių klausytojus checkbox elementams
        document.querySelectorAll('input[name="model_types"], input[name="learning_rates"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateCombinationsCount);
        });
        
        // Pradinis kombinacijų skaičiaus atnaujinimas
        updateCombinationsCount();
    });
</script>
{% endblock %}