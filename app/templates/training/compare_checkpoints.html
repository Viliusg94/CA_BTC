{% extends 'base.html' %}

{% block title %}Išsaugojimų palyginimas{% endblock %}

{% block styles %}
<style>
    .comparison-chart {
        min-height: 300px;
    }
    
    .parameter-change {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .parameter-improved {
        background-color: #d4edda;
        color: #155724;
    }
    
    .parameter-worsened {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .parameter-unchanged {
        background-color: #e9ecef;
        color: #495057;
    }
    
    .checkpoint-select {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
    }
    
    .metric-card {
        transition: all 0.3s;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0,123,255,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Antraštė ir navigacija -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('model_training.index') }}">Pradžia</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_weights') }}">Modeliai</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_weights_details', model_name=model.filename) }}">{{ model.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_checkpoints', model_id=model.id) }}">Išsaugojimai</a></li>
                    <li class="breadcrumb-item active">Išsaugojimų palyginimas</li>
                </ol>
            </nav>
            
            <h1>Išsaugojimų palyginimas</h1>
            <p class="text-muted">Palyginkite skirtingus modelio išsaugojimus ir jų metrikas</p>
        </div>
    </div>
    
    <!-- Išsaugojimų pasirinkimas -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">Pasirinkite išsaugojimus palyginimui</h5>
        </div>
        <div class="card-body">
            <form id="comparisonForm" method="GET" action="{{ url_for('model_training.compare_checkpoints', model_id=model.id) }}">
                <div class="row">
                    <!-- Pirmasis išsaugojimas -->
                    <div class="col-md-5 checkpoint-select">
                        <h6>Pirmasis išsaugojimas</h6>
                        <select class="form-select" name="checkpoint1" id="checkpoint1">
                            <option value="">Pasirinkite išsaugojimą</option>
                            {% for checkpoint in checkpoints %}
                            <option value="{{ checkpoint.checkpoint_id }}" 
                                {% if checkpoint.checkpoint_id == selected_checkpoints[0].checkpoint_id %}selected{% endif %}>
                                Epocha {{ checkpoint.epoch }} 
                                {% if checkpoint.is_best %}(Geriausias){% endif %}
                                - Val Loss: {{ "%.4f"|format(checkpoint.metrics.val_loss or 0) }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Palyginimo ikona -->
                    <div class="col-md-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-exchange-alt fa-2x text-primary"></i>
                    </div>
                    
                    <!-- Antrasis išsaugojimas -->
                    <div class="col-md-5 checkpoint-select">
                        <h6>Antrasis išsaugojimas</h6>
                        <select class="form-select" name="checkpoint2" id="checkpoint2">
                            <option value="">Pasirinkite išsaugojimą</option>
                            {% for checkpoint in checkpoints %}
                            <option value="{{ checkpoint.checkpoint_id }}" 
                                {% if checkpoint.checkpoint_id == selected_checkpoints[1].checkpoint_id %}selected{% endif %}>
                                Epocha {{ checkpoint.epoch }} 
                                {% if checkpoint.is_best %}(Geriausias){% endif %}
                                - Val Loss: {{ "%.4f"|format(checkpoint.metrics.val_loss or 0) }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-2"></i>Atnaujinti palyginimą
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    {% if selected_checkpoints|length == 2 %}
    <!-- Pagrindinių metrikų palyginimas -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Pagrindinių metrikų palyginimas</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Epochos ir datos -->
                <div class="col-md-4">
                    <div class="card metric-card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Epochos</h5>
                            <div class="d-flex justify-content-around align-items-center mt-3">
                                <div>
                                    <span class="display-5">{{ selected_checkpoints[0].epoch }}</span>
                                    <p class="text-muted small mb-0">{{ selected_checkpoints[0].timestamp }}</p>
                                </div>
                                <div>
                                    <i class="fas fa-arrows-alt-h text-muted"></i>
                                </div>
                                <div>
                                    <span class="display-5">{{ selected_checkpoints[1].epoch }}</span>
                                    <p class="text-muted small mb-0">{{ selected_checkpoints[1].timestamp }}</p>
                                </div>
                            </div>
                            <div class="badge bg-secondary mt-2">
                                Skirtumas: {{ selected_checkpoints[1].epoch - selected_checkpoints[0].epoch }} epochos
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Validation Loss -->
                <div class="col-md-4">
                    <div class="card metric-card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Validation Loss</h5>
                            <div class="d-flex justify-content-around align-items-center mt-3">
                                <div>
                                    <span class="display-5">{{ "%.4f"|format(selected_checkpoints[0].metrics.val_loss or 0) }}</span>
                                </div>
                                <div>
                                    {% set val_loss_diff = (selected_checkpoints[1].metrics.val_loss or 0) - (selected_checkpoints[0].metrics.val_loss or 0) %}
                                    {% if val_loss_diff < 0 %}
                                    <i class="fas fa-arrow-down text-success"></i>
                                    {% elif val_loss_diff > 0 %}
                                    <i class="fas fa-arrow-up text-danger"></i>
                                    {% else %}
                                    <i class="fas fa-equals text-muted"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="display-5">{{ "%.4f"|format(selected_checkpoints[1].metrics.val_loss or 0) }}</span>
                                </div>
                            </div>
                            <div class="badge {% if val_loss_diff < 0 %}bg-success{% elif val_loss_diff > 0 %}bg-danger{% else %}bg-secondary{% endif %} mt-2">
                                {% if val_loss_diff < 0 %}
                                Pagerėjimas: {{ "%.4f"|format(val_loss_diff|abs) }}
                                {% elif val_loss_diff > 0 %}
                                Pablogėjimas: {{ "%.4f"|format(val_loss_diff) }}
                                {% else %}
                                Nepasikeitė
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Validation Accuracy -->
                <div class="col-md-4">
                    <div class="card metric-card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Validation Accuracy</h5>
                            <div class="d-flex justify-content-around align-items-center mt-3">
                                <div>
                                    <span class="display-5">{{ "%.2f"|format((selected_checkpoints[0].metrics.val_accuracy or 0) * 100) }}%</span>
                                </div>
                                <div>
                                    {% set val_acc_diff = (selected_checkpoints[1].metrics.val_accuracy or 0) - (selected_checkpoints[0].metrics.val_accuracy or 0) %}
                                    {% if val_acc_diff > 0 %}
                                    <i class="fas fa-arrow-up text-success"></i>
                                    {% elif val_acc_diff < 0 %}
                                    <i class="fas fa-arrow-down text-danger"></i>
                                    {% else %}
                                    <i class="fas fa-equals text-muted"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="display-5">{{ "%.2f"|format((selected_checkpoints[1].metrics.val_accuracy or 0) * 100) }}%</span>
                                </div>
                            </div>
                            <div class="badge {% if val_acc_diff > 0 %}bg-success{% elif val_acc_diff < 0 %}bg-danger{% else %}bg-secondary{% endif %} mt-2">
                                {% if val_acc_diff > 0 %}
                                Pagerėjimas: {{ "%.2f"|format(val_acc_diff * 100)|abs }}%
                                {% elif val_acc_diff < 0 %}
                                Pablogėjimas: {{ "%.2f"|format(val_acc_diff * 100)|abs }}%
                                {% else %}
                                Nepasikeitė
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Parametrų pokyčių analizė -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">Parametrų pokyčių analizė</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Šioje lentelėje pateikiami visų išmatuotų metrikų pokyčiai tarp pasirinktų išsaugojimų.
                Žalia spalva rodo pagerėjimą, raudona - pablogėjimą.
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Metrika</th>
                            <th>Pirmasis išsaugojimas<br><small>(Epocha {{ selected_checkpoints[0].epoch }})</small></th>
                            <th>Antrasis išsaugojimas<br><small>(Epocha {{ selected_checkpoints[1].epoch }})</small></th>
                            <th>Pokytis</th>
                            <th>Pokyčio procentas</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Loss -->
                        <tr>
                            <td><strong>Loss</strong></td>
                            <td>{{ "%.6f"|format(selected_checkpoints[0].metrics.loss or 0) }}</td>
                            <td>{{ "%.6f"|format(selected_checkpoints[1].metrics.loss or 0) }}</td>
                            {% set loss_diff = (selected_checkpoints[1].metrics.loss or 0) - (selected_checkpoints[0].metrics.loss or 0) %}
                            {% set loss_percent = 0 if (selected_checkpoints[0].metrics.loss or 0) == 0 else (loss_diff / (selected_checkpoints[0].metrics.loss or 0) * 100) %}
                            <td class="{% if loss_diff < 0 %}text-success{% elif loss_diff > 0 %}text-danger{% endif %}">
                                {% if loss_diff < 0 %}
                                <i class="fas fa-arrow-down me-1"></i>
                                {% elif loss_diff > 0 %}
                                <i class="fas fa-arrow-up me-1"></i>
                                {% endif %}
                                {{ "%.6f"|format(loss_diff|abs) }}
                            </td>
                            <td class="{% if loss_diff < 0 %}text-success{% elif loss_diff > 0 %}text-danger{% endif %}">
                                {% if loss_diff != 0 %}
                                {{ "%.2f"|format(loss_percent|abs) }}%
                                {% else %}
                                0%
                                {% endif %}
                            </td>
                        </tr>
                        
                        <!-- Validation Loss -->
                        <tr>
                            <td><strong>Validation Loss</strong></td>
                            <td>{{ "%.6f"|format(selected_checkpoints[0].metrics.val_loss or 0) }}</td>
                            <td>{{ "%.6f"|format(selected_checkpoints[1].metrics.val_loss or 0) }}</td>
                            {% set val_loss_diff = (selected_checkpoints[1].metrics.val_loss or 0) - (selected_checkpoints[0].metrics.val_loss or 0) %}
                            {% set val_loss_percent = 0 if (selected_checkpoints[0].metrics.val_loss or 0) == 0 else (val_loss_diff / (selected_checkpoints[0].metrics.val_loss or 0) * 100) %}
                            <td class="{% if val_loss_diff < 0 %}text-success{% elif val_loss_diff > 0 %}text-danger{% endif %}">
                                {% if val_loss_diff < 0 %}
                                <i class="fas fa-arrow-down me-1"></i>
                                {% elif val_loss_diff > 0 %}
                                <i class="fas fa-arrow-up me-1"></i>
                                {% endif %}
                                {{ "%.6f"|format(val_loss_diff|abs) }}
                            </td>
                            <td class="{% if val_loss_diff < 0 %}text-success{% elif val_loss_diff > 0 %}text-danger{% endif %}">
                                {% if val_loss_diff != 0 %}
                                {{ "%.2f"|format(val_loss_percent|abs) }}%
                                {% else %}
                                0%
                                {% endif %}
                            </td>
                        </tr>
                        
                        <!-- Accuracy -->
                        <tr>
                            <td><strong>Accuracy</strong></td>
                            <td>{{ "%.6f"|format(selected_checkpoints[0].metrics.accuracy or 0) }}</td>
                            <td>{{ "%.6f"|format(selected_checkpoints[1].metrics.accuracy or 0) }}</td>
                            {% set acc_diff = (selected_checkpoints[1].metrics.accuracy or 0) - (selected_checkpoints[0].metrics.accuracy or 0) %}
                            {% set acc_percent = 0 if (selected_checkpoints[0].metrics.accuracy or 0) == 0 else (acc_diff / (selected_checkpoints[0].metrics.accuracy or 0) * 100) %}
                            <td class="{% if acc_diff > 0 %}text-success{% elif acc_diff < 0 %}text-danger{% endif %}">
                                {% if acc_diff > 0 %}
                                <i class="fas fa-arrow-up me-1"></i>
                                {% elif acc_diff < 0 %}
                                <i class="fas fa-arrow-down me-1"></i>
                                {% endif %}
                                {{ "%.6f"|format(acc_diff|abs) }}
                            </td>
                            <td class="{% if acc_diff > 0 %}text-success{% elif acc_diff < 0 %}text-danger{% endif %}">
                                {% if acc_diff != 0 %}
                                {{ "%.2f"|format(acc_percent|abs) }}%
                                {% else %}
                                0%
                                {% endif %}
                            </td>
                        </tr>
                        
                        <!-- Validation Accuracy -->
                        <tr>
                            <td><strong>Validation Accuracy</strong></td>
                            <td>{{ "%.6f"|format(selected_checkpoints[0].metrics.val_accuracy or 0) }}</td>
                            <td>{{ "%.6f"|format(selected_checkpoints[1].metrics.val_accuracy or 0) }}</td>
                            {% set val_acc_diff = (selected_checkpoints[1].metrics.val_accuracy or 0) - (selected_checkpoints[0].metrics.val_accuracy or 0) %}
                            {% set val_acc_percent = 0 if (selected_checkpoints[0].metrics.val_accuracy or 0) == 0 else (val_acc_diff / (selected_checkpoints[0].metrics.val_accuracy or 0) * 100) %}
                            <td class="{% if val_acc_diff > 0 %}text-success{% elif val_acc_diff < 0 %}text-danger{% endif %}">
                                {% if val_acc_diff > 0 %}
                                <i class="fas fa-arrow-up me-1"></i>
                                {% elif val_acc_diff < 0 %}
                                <i class="fas fa-arrow-down me-1"></i>
                                {% endif %}
                                {{ "%.6f"|format(val_acc_diff|abs) }}
                            </td>
                            <td class="{% if val_acc_diff > 0 %}text-success{% elif val_acc_diff < 0 %}text-danger{% endif %}">
                                {% if val_acc_diff != 0 %}
                                {{ "%.2f"|format(val_acc_percent|abs) }}%
                                {% else %}
                                0%
                                {% endif %}
                            </td>
                        </tr>
                        
                        <!-- Kiti parametrai, jei yra -->
                        {% for metric_name, metric_value in selected_checkpoints[0].metrics.items() %}
                            {% if metric_name not in ['loss', 'val_loss', 'accuracy', 'val_accuracy'] and metric_value is not none %}
                                <tr>
                                    <td><strong>{{ metric_name|capitalize }}</strong></td>
                                    <td>{{ "%.6f"|format(metric_value) }}</td>
                                    <td>{{ "%.6f"|format(selected_checkpoints[1].metrics.get(metric_name, 0) or 0) }}</td>
                                    {% set metric_diff = (selected_checkpoints[1].metrics.get(metric_name, 0) or 0) - metric_value %}
                                    {% set metric_percent = 0 if metric_value == 0 else (metric_diff / metric_value * 100) %}
                                    
                                    <!-- Tikriname, ar didesnis skaičius yra geresnis (accuracy tipo metrikos) -->
                                    {% set is_higher_better = metric_name.endswith('accuracy') or metric_name.endswith('recall') or metric_name.endswith('precision') or metric_name.endswith('f1') %}
                                    
                                    <td class="{% if (is_higher_better and metric_diff > 0) or (not is_higher_better and metric_diff < 0) %}text-success{% elif (is_higher_better and metric_diff < 0) or (not is_higher_better and metric_diff > 0) %}text-danger{% endif %}">
                                        {% if metric_diff != 0 %}
                                            {% if metric_diff > 0 %}
                                                <i class="fas fa-arrow-up me-1"></i>
                                            {% else %}
                                                <i class="fas fa-arrow-down me-1"></i>
                                            {% endif %}
                                            {{ "%.6f"|format(metric_diff|abs) }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </td>
                                    <td class="{% if (is_higher_better and metric_diff > 0) or (not is_higher_better and metric_diff < 0) %}text-success{% elif (is_higher_better and metric_diff < 0) or (not is_higher_better and metric_diff > 0) %}text-danger{% endif %}">
                                        {% if metric_diff != 0 %}
                                            {{ "%.2f"|format(metric_percent|abs) }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Metrikų grafinis palyginimas -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">Metrikų grafinis palyginimas</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Loss palyginimo grafikas -->
                <div class="col-md-6 mb-4">
                    <h5 class="text-center mb-3">Loss funkcijos palyginimas</h5>
                    <div class="comparison-chart">
                        <canvas id="lossComparisonChart"></canvas>
                    </div>
                </div>
                
                <!-- Accuracy palyginimo grafikas -->
                <div class="col-md-6 mb-4">
                    <h5 class="text-center mb-3">Accuracy palyginimas</h5>
                    <div class="comparison-chart">
                        <canvas id="accuracyComparisonChart"></canvas>
                    </div>
                </div>
                
                <!-- Radar metrikų palyginimo grafikas -->
                <div class="col-md-12">
                    <h5 class="text-center mb-3">Visų metrikų palyginimas</h5>
                    <div class="comparison-chart" style="min-height: 400px;">
                        <canvas id="metricsRadarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pridėti trendo vizualizacijos elementus -->
    {% if trends and trends.has_enough_data %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Metrikų tendencijos per laiką</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-3">
                <i class="fas fa-chart-line me-2"></i>
                Šioje sekcijoje pateikiamos metrikų tendencijos nuo pirmojo iki paskutinio išsaugojimo, išryškinant reikšmingus pokyčius.
            </div>
            
            <!-- Tendencijų metrikų kortelės -->
            <div class="row">
                {% for metric_name, metric_trend in trends.trends.items() %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header {% if metric_trend.trend_direction == 'improved' %}bg-success text-white{% elif metric_trend.trend_direction == 'worsened' %}bg-danger text-white{% else %}bg-light{% endif %}">
                            <h6 class="card-title mb-0">{{ metric_name|capitalize }}</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <small class="text-muted">Pradžia</small>
                                    <h5>{{ "%.6f"|format(metric_trend.first_value) }}</h5>
                                </div>
                                
                                <div class="text-center">
                                    <small class="text-muted">Pokytis</small>
                                    <h5 class="{% if metric_trend.trend_direction == 'improved' %}text-success{% elif metric_trend.trend_direction == 'worsened' %}text-danger{% endif %}">
                                        {% if metric_trend.total_change > 0 %}+{% endif %}{{ "%.6f"|format(metric_trend.total_change) }}
                                        <small>({{ "%.2f"|format(metric_trend.percentage_change) }}%)</small>
                                    </h5>
                                    
                                    <div>
                                        {% if metric_trend.trend_direction == 'improved' %}
                                        <i class="fas fa-arrow-up text-success"></i>
                                        {% elif metric_trend.trend_direction == 'worsened' %}
                                        <i class="fas fa-arrow-down text-danger"></i>
                                        {% else %}
                                        <i class="fas fa-equals text-muted"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trendo grafikas -->
                            <div class="comparison-chart" style="height: 200px;">
                                <canvas id="trendChart{{ loop.index }}"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Išsaugojimų atkūrimo veiksmai -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">Veiksmai su pasirinktais išsaugojimais</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Pirmasis išsaugojimas (Epocha {{ selected_checkpoints[0].epoch }})</h5>
                            <p class="card-text">
                                <span class="badge {% if selected_checkpoints[0].is_best %}bg-success{% else %}bg-secondary{% endif %} mb-2">
                                    {% if selected_checkpoints[0].is_best %}Geriausias išsaugojimas{% else %}Standartinis išsaugojimas{% endif %}
                                </span>
                            </p>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('model_training.restore_checkpoint', model_id=model.id, checkpoint_id=selected_checkpoints[0].checkpoint_id) }}" class="btn btn-warning">
                                    <i class="fas fa-undo me-2"></i>Atstatyti modelį
                                </a>
                                <a href="{{ url_for('model_training.continue_training', model_id=model.id, checkpoint_id=selected_checkpoints[0].checkpoint_id) }}" class="btn btn-primary">
                                    <i class="fas fa-play me-2"></i>Tęsti treniravimą
                                </a>
                                <a href="{{ url_for('model_training.checkpoint_details', model_id=model.id, checkpoint_id=selected_checkpoints[0].checkpoint_id) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-search me-2"></i>Detaliau
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Antrasis išsaugojimas (Epocha {{ selected_checkpoints[1].epoch }})</h5>
                            <p class="card-text">
                                <span class="badge {% if selected_checkpoints[1].is_best %}bg-success{% else %}bg-secondary{% endif %} mb-2">
                                    {% if selected_checkpoints[1].is_best %}Geriausias išsaugojimas{% else %}Standartinis išsaugojimas{% endif %}
                                </span>
                            </p>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('model_training.restore_checkpoint', model_id=model.id, checkpoint_id=selected_checkpoints[1].checkpoint_id) }}" class="btn btn-warning">
                                    <i class="fas fa-undo me-2"></i>Atstatyti modelį
                                </a>
                                <a href="{{ url_for('model_training.continue_training', model_id=model.id, checkpoint_id=selected_checkpoints[1].checkpoint_id) }}" class="btn btn-primary">
                                    <i class="fas fa-play me-2"></i>Tęsti treniravimą
                                </a>
                                <a href="{{ url_for('model_training.checkpoint_details', model_id=model.id, checkpoint_id=selected_checkpoints[1].checkpoint_id) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-search me-2"></i>Detaliau
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Progreso kreivių komponentas -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Apmokymo progreso kreivės</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Šiame grafike vaizduojama, kaip kito pagrindinės metrikos tarp pasirinktų išsaugojimų. Tai leidžia vizualiai įvertinti modelio progresą bėgant laikui.
            </div>
            
            <div class="row">
                <!-- Tikslumo progreso kreivė -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Tikslumo progreso kreivė</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="accuracyProgressChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Nuostolių progreso kreivė -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Nuostolių progreso kreivė</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="lossProgressChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kreivių paaiškinimas -->
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6><i class="fas fa-lightbulb me-2 text-warning"></i>Kaip interpretuoti progreso kreives:</h6>
                            <ul class="mb-0">
                                <li><strong>Tikslumo kreivė</strong> - aukštyn einanti kreivė rodo gerėjantį modelio tikslumą. Lėkštėjanti kreivė gali reikšti, kad modelis pasiekia savo ribas.</li>
                                <li><strong>Nuostolių kreivė</strong> - žemyn einanti kreivė rodo mažėjančius nuostolius, t.y. gerėjantį modelį. Jei validacijos nuostoliai pradeda kilti, tai gali reikšti persimokymo (overfitting) pradžią.</li>
                                <li><strong>Svyravimai</strong> - nedideli svyravimai yra normalūs, tačiau dideli šuoliai gali rodyti per didelį mokymosi greitį arba nestabilų mokymą.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Skirtumų paryškinimo įrankiai -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">Skirtumų paryškinimo įrankiai</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <p>Šie įrankiai padeda geriau vizualizuoti reikšmingus skirtumus tarp išsaugojimų. Galite keisti paryškinimo slenksčius pagal savo poreikius.</p>
            </div>
            
            <!-- Paryškinimo valdikliai -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Tikslumo skirtumų paryškinimas</h6>
                        </div>
                        <div class="card-body">
                            <label for="accuracyThreshold" class="form-label">Tikslumo skirtumo slenkstis: <span id="accuracyThresholdValue">0.01</span></label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range" id="accuracyThreshold" min="0.001" max="0.1" step="0.001" value="0.01">
                                <button class="btn btn-sm btn-primary" id="applyAccuracyThreshold">
                                    <i class="fas fa-check me-1"></i>Pritaikyti
                                </button>
                            </div>
                            <div class="mt-2 small text-muted">
                                Reikšmės, kurių skirtumas viršija šį slenkstį, bus paryškintos lentelėje.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Nuostolių skirtumų paryškinimas</h6>
                        </div>
                        <div class="card-body">
                            <label for="lossThreshold" class="form-label">Nuostolių skirtumo slenkstis: <span id="lossThresholdValue">0.05</span></label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range" id="lossThreshold" min="0.01" max="0.5" step="0.01" value="0.05">
                                <button class="btn btn-sm btn-primary" id="applyLossThreshold">
                                    <i class="fas fa-check me-1"></i>Pritaikyti
                                </button>
                            </div>
                            <div class="mt-2 small text-muted">
                                Reikšmės, kurių skirtumas viršija šį slenkstį, bus paryškintos lentelėje.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Skirtumų lentelė -->
            <div class="table-responsive">
                <table class="table table-bordered" id="metricsComparisonTable">
                    <thead class="table-light">
                        <tr>
                            <th>Metrika</th>
                            <th>1-as išsaugojimas ({{ selected_checkpoints[0].epoch }} epocha)</th>
                            <th>2-as išsaugojimas ({{ selected_checkpoints[1].epoch }} epocha)</th>
                            <th>Pokytis</th>
                            <th>Procentinis pokytis</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for metric_name in selected_checkpoints[0].metrics %}
                        {% if metric_name in selected_checkpoints[1].metrics %}
                        <tr class="metric-row" data-metric="{{ metric_name }}">
                            <td>{{ metric_name }}</td>
                            <td class="first-value">{{ "%.6f"|format(selected_checkpoints[0].metrics[metric_name] or 0) }}</td>
                            <td class="second-value">{{ "%.6f"|format(selected_checkpoints[1].metrics[metric_name] or 0) }}</td>
                            {% set diff = (selected_checkpoints[1].metrics[metric_name] or 0) - (selected_checkpoints[0].metrics[metric_name] or 0) %}
                            {% set percent = ((diff / (selected_checkpoints[0].metrics[metric_name] or 1)) * 100) if selected_checkpoints[0].metrics[metric_name] else 0 %}
                            
                            <!-- Nurodome, ar padidėjo ar sumažėjo bei ar tai gerai ar blogai -->
                            {% set is_loss = 'loss' in metric_name %}
                            {% set is_good = (is_loss and diff < 0) or (not is_higher_better and diff > 0) %}
                            
                            <td class="diff-value {{ 'text-success' if is_good else 'text-danger' if diff != 0 else '' }}">
                                {% if diff > 0 %}+{% endif %}{{ "%.6f"|format(diff) }}
                                {% if diff != 0 %}
                                    <i class="fas fa-{{ 'arrow-down' if diff < 0 else 'arrow-up' }} ms-1"></i>
                                {% endif %}
                            </td>
                            <td class="percent-value {{ 'text-success' if is_good else 'text-danger' if diff != 0 else '' }}">
                                {% if percent > 0 %}+{% endif %}{{ "%.2f"|format(percent) }}%
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3 text-center">
                <button class="btn btn-outline-primary" id="highlightDifferences">
                    <i class="fas fa-highlighter me-1"></i>Paryškinti visus skirtumus
                </button>
                <button class="btn btn-outline-success ms-2" id="highlightImprovements">
                    <i class="fas fa-arrow-trend-up me-1"></i>Paryškinti tik pagerinimus
                </button>
                <button class="btn btn-outline-danger ms-2" id="highlightRegressions">
                    <i class="fas fa-arrow-trend-down me-1"></i>Paryškinti tik pablogėjimus
                </button>
                <button class="btn btn-outline-secondary ms-2" id="resetHighlights">
                    <i class="fas fa-undo me-1"></i>Atstatyti
                </button>
            </div>
        </div>
    </div>
    
    <!-- Pokyčių interpretacijos įrankis -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="card-title mb-0">Pokyčių interpretacijos įrankis</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-3">
                <i class="fas fa-lightbulb me-2"></i>
                Šis įrankis padeda interpretuoti pokyčius tarp išsaugojimų ir suprasti, kokius sprendimus galima priimti remiantis šiais duomenimis.
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Automatinė interpretacija</h6>
                        </div>
                        <div class="card-body">
                            <div id="interpretationResult">
                                <!-- JavaScript kodo sugeneruota interpretacija -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Kraunama...</span>
                                    </div>
                                    <p class="mt-2">Analizuojami pokyčiai...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Sprendimų pagalbininkas</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6>Ką daryti su modeliu?</h6>
                                <ul class="list-group" id="decisionHelperList">
                                    <!-- JavaScript kodo sugenerotos rekomendacijos -->
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Analizuojama...</span>
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-primary" id="generateInterpretation">
                                    <i class="fas fa-sync-alt me-1"></i> Atnaujinti analizę
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if selected_checkpoints|length == 2 %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Duomenų paruošimas
        const checkpoint1 = {{ selected_checkpoints[0]|tojson }};
        const checkpoint2 = {{ selected_checkpoints[1]|tojson }};
        
        // Loss palyginimo grafikas
        const lossCtx = document.getElementById('lossComparisonChart').getContext('2d');
        const lossChart = new Chart(lossCtx, {
            type: 'bar',
            data: {
                labels: ['Loss', 'Validation Loss'],
                datasets: [
                    {
                        label: `Epocha ${checkpoint1.epoch}`,
                        data: [
                            checkpoint1.metrics.loss || 0,
                            checkpoint1.metrics.val_loss || 0
                        ],
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    },
                    {
                        label: `Epocha ${checkpoint2.epoch}`,
                        data: [
                            checkpoint2.metrics.loss || 0,
                            checkpoint2.metrics.val_loss || 0
                        ],
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Loss palyginimas'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw.toFixed(6)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Loss reikšmė'
                        }
                    }
                }
            });
        
        // Accuracy palyginimo grafikas
        const accuracyCtx = document.getElementById('accuracyComparisonChart').getContext('2d');
        const accuracyChart = new Chart(accuracyCtx, {
            type: 'bar',
            data: {
                labels: ['Accuracy', 'Validation Accuracy'],
                datasets: [
                    {
                        label: `Epocha ${checkpoint1.epoch}`,
                        data: [
                            checkpoint1.metrics.accuracy || 0,
                            checkpoint1.metrics.val_accuracy || 0
                        ],
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    },
                    {
                        label: `Epocha ${checkpoint2.epoch}`,
                        data: [
                            checkpoint2.metrics.accuracy || 0,
                            checkpoint2.metrics.val_accuracy || 0
                        ],
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Accuracy palyginimas'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percent = (value * 100).toFixed(2);
                                return `${context.dataset.label}: ${percent}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        ticks: {
                            callback: function(value) {
                                return (value * 100) + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Accuracy reikšmė'
                        }
                    }
                }
            });
        
        // Radar metrikų palyginimo grafikas
        const metricsRadarCtx = document.getElementById('metricsRadarChart').getContext('2d');
        
        // Surenkame visas metrikas iš abiejų išsaugojimų
        const allMetrics = new Set();
        Object.keys(checkpoint1.metrics || {}).forEach(key => {
            if (checkpoint1.metrics[key] !== null) allMetrics.add(key);
        });
        Object.keys(checkpoint2.metrics || {}).forEach(key => {
            if (checkpoint2.metrics[key] !== null) allMetrics.add(key);
        });
        
        // Apdorojame metrikas, kad būtų tinkamos radaro grafikui
        // Normalizuojame reikšmes tarp 0 ir 1, invertuojant loss metrikas
        const prepareMetricValue = (value, metricName) => {
            if (value === null || value === undefined) return 0;
            
            // Jei tai loss metrika, invertuojame (1 - normalizuota reikšmė)
            const isLossMetric = metricName.includes('loss');
            
            // Normalizavimo koeficientas (paprastas skalėris)
            const normFactor = isLossMetric ? 10 : 1;
            
            // Normalizuojame
            let normalizedValue = isLossMetric ? 
                1 - Math.min(1, value / normFactor) : 
                value;
            
            return normalizedValue;
        };
        
        // Tvarkome metrikų pavadinimus vizualizacijai
        const formatMetricName = (name) => {
            return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        };
        
        // Paruošiame duomenis
        const radarLabels = [...allMetrics].map(formatMetricName);
        const radarData1 = [...allMetrics].map(metric => prepareMetricValue(checkpoint1.metrics[metric], metric));
        const radarData2 = [...allMetrics].map(metric => prepareMetricValue(checkpoint2.metrics[metric], metric));
        
        // Kuriame radar grafiką
        const metricsRadarChart = new Chart(metricsRadarCtx, {
            type: 'radar',
            data: {
                labels: radarLabels,
                datasets: [
                    {
                        label: `Epocha ${checkpoint1.epoch}`,
                        data: radarData1,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgb(54, 162, 235)',
                        pointBackgroundColor: 'rgb(54, 162, 235)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(54, 162, 235)'
                    },
                    {
                        label: `Epocha ${checkpoint2.epoch}`,
                        data: radarData2,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointBackgroundColor: 'rgb(255, 99, 132)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(255, 99, 132)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: {
                    line: {
                        borderWidth: 3
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Metrikų palyginimas (normalizuotos reikšmės)'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const datasetIndex = context.datasetIndex;
                                const index = context.dataIndex;
                                const metricName = [...allMetrics][index];
                                const cp = datasetIndex === 0 ? checkpoint1 : checkpoint2;
                                const actualValue = cp.metrics[metricName];
                                
                                if (actualValue === null || actualValue === undefined) {
                                    return `${context.dataset.label}: N/A`;
                                }
                                
                                const isLossMetric = metricName.includes('loss');
                                const isAccuracyMetric = metricName.includes('accuracy');
                                
                                // Formatuojame priklausomai nuo metrikos tipo
                                if (isAccuracyMetric) {
                                    return `${context.dataset.label}: ${(actualValue * 100).toFixed(2)}%`;
                                } else {
                                    return `${context.dataset.label}: ${actualValue.toFixed(6)}`;
                                }
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        angleLines: {
                            display: true
                        },
                        suggestedMin: 0,
                        suggestedMax: 1,
                        ticks: {
                            stepSize: 0.2
                        },
                        pointLabels: {
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            });
        
        // Trendo grafikų kūrimas kiekvienai metrikai
        {% for metric_name, metric_trend in trends.trends.items() %}
        const trendCtx{{ loop.index }} = document.getElementById('trendChart{{ loop.index }}').getContext('2d');
        const trendChart{{ loop.index }} = new Chart(trendCtx{{ loop.index }}, {
            type: 'line',
            data: {
                labels: [{{ checkpoint1.epoch }}, {{ checkpoint2.epoch }}],
                datasets: [
                    {
                        label: 'Reikšmė',
                        data: [{{ metric_trend.first_value }}, {{ metric_trend.last_value }}],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw.toFixed(6)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Epocha'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '{{ metric_name|capitalize }} reikšmė'
                        }
                    }
                }
            }
        });
        {% endfor %}
    });
    
    // Tikslumo progreso kreivės kūrimas
    const createAccuracyProgressChart = () => {
        // Gauname kontekstą
        const ctx = document.getElementById('accuracyProgressChart').getContext('2d');
        
        // Pasiruošiame duomenis
        const checkpoint1 = {
            epoch: {{ selected_checkpoints[0].epoch }},
            accuracy: {{ selected_checkpoints[0].metrics.accuracy or 0 }},
            val_accuracy: {{ selected_checkpoints[0].metrics.val_accuracy or 0 }}
        };
        
        const checkpoint2 = {
            epoch: {{ selected_checkpoints[1].epoch }},
            accuracy: {{ selected_checkpoints[1].metrics.accuracy or 0 }},
            val_accuracy: {{ selected_checkpoints[1].metrics.val_accuracy or 0 }}
        };
        
        // Jei epochos vienodos, pridedame mažą poslinkį, kad grafikas būtų aiškesnis
        if (checkpoint1.epoch === checkpoint2.epoch) {
            checkpoint2.epoch += 0.1;
        }
        
        // Sutvarkome duomenis į masyvo formatą x ašiai (epochos)
        const epochs = [checkpoint1.epoch, checkpoint2.epoch];
        
        // Sutvarkome duomenis į masyvo formatą y ašims (metrikos)
        const accuracyData = [checkpoint1.accuracy, checkpoint2.accuracy];
        const valAccuracyData = [checkpoint1.val_accuracy, checkpoint2.val_accuracy];
        
        // Sukuriame grafiką
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: epochs,
                datasets: [
                    {
                        label: 'Mokymo tikslumas',
                        data: accuracyData,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.3 // Švelnesnis kreivės lenkimas
                    },
                    {
                        label: 'Validavimo tikslumas',
                        data: valAccuracyData,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.3 // Švelnesnis kreivės lenkimas
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Epocha'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Tikslumas'
                        },
                        min: 0,
                        max: 1,
                        ticks: {
                            callback: function(value) {
                                return (value * 100) + '%';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + (context.raw * 100).toFixed(2) + '%';
                        }
                        }
                    },
                    annotation: {
                        annotations: {
                            changePoint: {
                                type: 'line',
                                xMin: (checkpoint1.epoch + checkpoint2.epoch) / 2,
                                xMax: (checkpoint1.epoch + checkpoint2.epoch) / 2,
                                borderColor: 'rgba(255, 159, 64, 0.7)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Pokyčio taškas',
                                    enabled: true,
                                    position: 'top'
                                }
                            }
                        }
                    }
                }
            });
    };

    // Nuostolių progreso kreivės kūrimas
    const createLossProgressChart = () => {
        // Gauname kontekstą
        const ctx = document.getElementById('lossProgressChart').getContext('2d');
        
        // Pasiruošiame duomenis
        const checkpoint1 = {
            epoch: {{ selected_checkpoints[0].epoch }},
            loss: {{ selected_checkpoints[0].metrics.loss or 0 }},
            val_loss: {{ selected_checkpoints[0].metrics.val_loss or 0 }}
        };
        
        const checkpoint2 = {
            epoch: {{ selected_checkpoints[1].epoch }},
            loss: {{ selected_checkpoints[1].metrics.loss or 0 }},
            val_loss: {{ selected_checkpoints[1].metrics.val_loss or 0 }}
        };
        
        // Jei epochos vienodos, pridedame mažą poslinkį, kad grafikas būtų aiškesnis
        if (checkpoint1.epoch === checkpoint2.epoch) {
            checkpoint2.epoch += 0.1;
        }
        
        // Sutvarkome duomenis į masyvo formatą x ašiai (epochos)
        const epochs = [checkpoint1.epoch, checkpoint2.epoch];
        
        // Sutvarkome duomenis į masyvo formatą y ašims (metrikos)
        const lossData = [checkpoint1.loss, checkpoint2.loss];
        const valLossData = [checkpoint1.val_loss, checkpoint2.val_loss];
        
        // Sukuriame grafiką
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: epochs,
                datasets: [
                    {
                        label: 'Mokymo nuostoliai',
                        data: lossData,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.3 // Švelnesnis kreivės lenkimas
                    },
                    {
                        label: 'Validavimo nuostoliai',
                        data: valLossData,
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.3 // Švelnesnis kreivės lenkimas
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Epocha'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Nuostoliai'
                        },
                        min: 0,
                        ticks: {
                            precision: 4
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.raw.toFixed(6);
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            changePoint: {
                                type: 'line',
                                xMin: (checkpoint1.epoch + checkpoint2.epoch) / 2,
                                xMax: (checkpoint1.epoch + checkpoint2.epoch) / 2,
                                borderColor: 'rgba(255, 159, 64, 0.7)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Pokyčio taškas',
                                    enabled: true,
                                    position: 'top'
                                }
                            }
                        }
                    }
                }
            });
    };

    // Pradinis grafikų sukūrimas, kai puslapis užkraunamas
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializuojame progreso grafikus
        createAccuracyProgressChart();
        createLossProgressChart();
        
        // Tikslumo slenksčio keitimo stebėjimas
        document.getElementById('accuracyThreshold').addEventListener('input', function() {
            document.getElementById('accuracyThresholdValue').textContent = this.value;
        });
        
        // Nuostolių slenksčio keitimo stebėjimas
        document.getElementById('lossThreshold').addEventListener('input', function() {
            document.getElementById('lossThresholdValue').textContent = this.value;
        });
        
        // Tikslumo slenksčio pritaikymo mygtukas
        document.getElementById('applyAccuracyThreshold').addEventListener('click', function() {
            const threshold = parseFloat(document.getElementById('accuracyThreshold').value);
            highlightDifferencesByThreshold('accuracy', threshold);
            highlightDifferencesByThreshold('val_accuracy', threshold);
        });
        
        // Nuostolių slenksčio pritaikymo mygtukas
        document.getElementById('applyLossThreshold').addEventListener('click', function() {
            const threshold = parseFloat(document.getElementById('lossThreshold').value);
            highlightDifferencesByThreshold('loss', threshold);
            highlightDifferencesByThreshold('val_loss', threshold);
        });
        
        // Visų skirtumų paryškinimo mygtukas
        document.getElementById('highlightDifferences').addEventListener('click', function() {
            // Atstatome visus paryškinimus
            resetHighlights();
            
            // Paryškiname visus skirtumus
            document.querySelectorAll('.metric-row').forEach(row => {
                const diff = parseFloat(row.querySelector('.diff-value').textContent);
                if (diff !== 0) {
                    row.classList.add('table-info');
                }
            });
        });
        
        // Pagerinimų paryškinimo mygtukas
        document.getElementById('highlightImprovements').addEventListener('click', function() {
            // Atstatome visus paryškinimus
            resetHighlights();
            
            // Paryškiname tik pagerinimus
            document.querySelectorAll('.metric-row').forEach(row => {
                const metricName = row.getAttribute('data-metric');
                const isLoss = metricName.includes('loss');
                const diff = parseFloat(row.querySelector('.diff-value').textContent);
                
                // Pagerinimas reiškia: sumažėjusį loss arba padidėjusį accuracy
                const isImprovement = (isLoss && diff < 0) || (!isLoss && diff > 0);
                
                if (isImprovement) {
                    row.classList.add('table-success');
                }
            });
        });
        
        // Pablogėjimų paryškinimo mygtukas
        document.getElementById('highlightRegressions').addEventListener('click', function() {
            // Atstatome visus paryškinimus
            resetHighlights();
            
            // Paryškiname tik pablogėjimus
            document.querySelectorAll('.metric-row').forEach(row => {
                const metricName = row.getAttribute('data-metric');
                const isLoss = metricName.includes('loss');
                const diff = parseFloat(row.querySelector('.diff-value').textContent);
                
                // Pablogėjimas reiškia: padidėjusį loss arba sumažėjusį accuracy
                const isRegression = (isLoss && diff > 0) || (!isLoss && diff < 0);
                
                if (isRegression) {
                    row.classList.add('table-danger');
                }
            });
        });
        
        // Paryškinimų atstatymo mygtukas
        document.getElementById('resetHighlights').addEventListener('click', resetHighlights);
    });

    // Funkcija paryškinimų atstatymui
    function resetHighlights() {
        document.querySelectorAll('.metric-row').forEach(row => {
            row.classList.remove('table-info', 'table-success', 'table-danger', 'table-warning');
        });
    }

    // Funkcija skirtumų paryškinimui pagal slenkstį
    function highlightDifferencesByThreshold(metricName, threshold) {
        document.querySelectorAll(`.metric-row[data-metric="${metricName}"]`).forEach(row => {
            // Gauname pirmą ir antrą reikšmę
            const firstValue = parseFloat(row.querySelector('.first-value').textContent);
            const secondValue = parseFloat(row.querySelector('.second-value').textContent);
            
            // Apskaičiuojame skirtumą
            const diff = Math.abs(secondValue - firstValue);
            
            // Paryškiname, jei skirtumas viršija slenkstį
            if (diff > threshold) {
                // Šaliname ankstesnius paryškinimus
                row.classList.remove('table-info', 'table-success', 'table-danger');
                
                // Nustatome, ar tai pagerėjimas, ar pablogėjimas
                const isLoss = metricName.includes('loss');
                const isImprovement = (isLoss && secondValue < firstValue) || (!isLoss && secondValue > firstValue);
                
                // Pritaikome atitinkamą paryškinimą
                if (isImprovement) {
                    row.classList.add('table-success');
                } else {
                    row.classList.add('table-danger');
                }
            } else {
                // Jei skirtumas mažesnis už slenkstį, pašaliname paryškinimą
                row.classList.remove('table-info', 'table-success', 'table-danger');
            }
        });
    }
    
    // Interpretacijos generavimo funkcija
    function generateInterpretation() {
        // Gaunami duomenys iš išsaugojimų
        const checkpoint1 = {
            epoch: {{ selected_checkpoints[0].epoch }},
            metrics: {
                accuracy: {{ selected_checkpoints[0].metrics.accuracy or 0 }},
                val_accuracy: {{ selected_checkpoints[0].metrics.val_accuracy or 0 }},
                loss: {{ selected_checkpoints[0].metrics.loss or 0 }},
                val_loss: {{ selected_checkpoints[0].metrics.val_loss or 0 }}
            }
        };
        
        const checkpoint2 = {
            epoch: {{ selected_checkpoints[1].epoch }},
            metrics: {
                accuracy: {{ selected_checkpoints[1].metrics.accuracy or 0 }},
                val_accuracy: {{ selected_checkpoints[1].metrics.val_accuracy or 0 }},
                loss: {{ selected_checkpoints[1].metrics.loss or 0 }},
                val_loss: {{ selected_checkpoints[1].metrics.val_loss or 0 }}
            }
        };
        
        // Apskaičiuojami pokyčiai
        const epochDiff = checkpoint2.epoch - checkpoint1.epoch;
        const accuracyDiff = checkpoint2.metrics.accuracy - checkpoint1.metrics.accuracy;
        const valAccuracyDiff = checkpoint2.metrics.val_accuracy - checkpoint1.metrics.val_accuracy;
        const lossDiff = checkpoint2.metrics.loss - checkpoint1.metrics.loss;
        const valLossDiff = checkpoint2.metrics.val_loss - checkpoint1.metrics.val_loss;
        
        // Duomenys interpretacijai
        const trainAccuracyIncreased = accuracyDiff > 0;
        const valAccuracyIncreased = valAccuracyDiff > 0;
        const trainLossDecreased = lossDiff < 0;
        const valLossDecreased = valLossDiff < 0;
        
        // Permokymo požymiai
        const overfittingSign = trainAccuracyIncreased && !valAccuracyIncreased && trainLossDecreased && !valLossDecreased;
        
        // Neprisitaikymo požymiai
        const underfittingSign = !trainAccuracyIncreased && !valAccuracyIncreased;
        
        // Sėkmingo mokymosi požymiai
        const successfulTraining = trainAccuracyIncreased && valAccuracyIncreased && trainLossDecreased && valLossDecreased;
        
        // Plataus masto interpretacija
        let interpretation = '';
        let recommendations = [];
        
        if (successfulTraining) {
            const trainToValAccGap = Math.abs(checkpoint2.metrics.accuracy - checkpoint2.metrics.val_accuracy);
            
            interpretation = `
                <div class="alert alert-success mb-3">
                    <h5><i class="fas fa-check-circle me-2"></i>Sėkmingas mokymasis</h5>
                    <p class="mb-0">
                        Tarp <strong>${checkpoint1.epoch}</strong> ir <strong>${checkpoint2.epoch}</strong> epochų stebimas sėkmingas modelio mokymasis.
                        Tiek mokymo, tiek validacijos metrikos rodo pagerėjimą.
                    </p>
                </div>
                
                <p>
                    <strong>Mokymo tikslumas:</strong> padidėjo ${(accuracyDiff * 100).toFixed(2)}% 
                    (nuo ${(checkpoint1.metrics.accuracy * 100).toFixed(2)}% iki ${(checkpoint2.metrics.accuracy * 100).toFixed(2)}%)
                </p>
                
                <p>
                    <strong>Validacijos tikslumas:</strong> padidėjo ${(valAccuracyDiff * 100).toFixed(2)}% 
                    (nuo ${(checkpoint1.metrics.val_accuracy * 100).toFixed(2)}% iki ${(checkpoint2.metrics.val_accuracy * 100).toFixed(2)}%)
                </p>
                
                <p>
                    <strong>Mokymo nuostoliai:</strong> sumažėjo ${Math.abs(lossDiff).toFixed(6)} 
                    (nuo ${checkpoint1.metrics.loss.toFixed(6)} iki ${checkpoint2.metrics.loss.toFixed(6)})
                </p>
                
                <p>
                    <strong>Validacijos nuostoliai:</strong> sumažėjo ${Math.abs(valLossDiff).toFixed(6)} 
                    (nuo ${checkpoint1.metrics.val_loss.toFixed(6)} iki ${checkpoint2.metrics.val_loss.toFixed(6)})
                </p>
            `;
            
            if (trainToValAccGap > 0.05) {
                interpretation += `
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Pastaba:</strong> Mokymo tikslumas yra žymiai didesnis už validacijos tikslumą 
                        (skirtumas: ${(trainToValAccGap * 100).toFixed(2)}%). 
                        Tai gali būti ankstyvojo permokymo (overfitting) požymis.
                    </div>
                `;
                
                recommendations.push({
                    text: 'Stebėti permokymo požymius tolimesniame mokyme',
                    type: 'warning'
                });
                
                recommendations.push({
                    text: 'Apsvarstyti dropout sluoksnių pridėjimą',
                    type: 'info'
                });
            } else {
                recommendations.push({
                    text: 'Tęsti mokymą su dabartiniais parametrais',
                    type: 'success'
                });
            }
            
        } else if (overfittingSign) {
            interpretation = `
                <div class="alert alert-danger mb-3">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Permokymo (overfitting) požymiai</h5>
                    <p class="mb-0">
                        Tarp <strong>${checkpoint1.epoch}</strong> ir <strong>${checkpoint2.epoch}</strong> epochų pastebimi permokymo požymiai.
                        Mokymo metrikos gerėja, tačiau validacijos metrikos blogėja.
                    </p>
                </div>
                
                <p>
                    <strong>Mokymo tikslumas:</strong> padidėjo ${(accuracyDiff * 100).toFixed(2)}% 
                    (nuo ${(checkpoint1.metrics.accuracy * 100).toFixed(2)}% iki ${(checkpoint2.metrics.accuracy * 100).toFixed(2)}%)
                </p>
                
                <p>
                    <strong>Validacijos tikslumas:</strong> ${valAccuracyDiff >= 0 ? 'padidėjo' : 'sumažėjo'} ${Math.abs(valAccuracyDiff * 100).toFixed(2)}% 
                    (nuo ${(checkpoint1.metrics.val_accuracy * 100).toFixed(2)}% iki ${(checkpoint2.metrics.val_accuracy * 100).toFixed(2)}%)
                </p>
                
                <p>
                    <strong>Mokymo nuostoliai:</strong> ${lossDiff <= 0 ? 'sumažėjo' : 'padidėjo'} ${Math.abs(lossDiff).toFixed(6)} 
                    (nuo ${checkpoint1.metrics.loss.toFixed(6)} iki ${checkpoint2.metrics.loss.toFixed(6)})
                </p>
                
                <p>
                    <strong>Validacijos nuostoliai:</strong> ${valLossDiff <= 0 ? 'sumažėjo' : 'padidėjo'} ${Math.abs(valLossDiff).toFixed(6)} 
                    (nuo ${checkpoint1.metrics.val_loss.toFixed(6)} iki ${checkpoint2.metrics.val_loss.toFixed(6)})
                </p>
            `;
            
            recommendations.push({
                text: 'Apsvarstyti grįžimą prie ankstesnio išsaugojimo',
                type: 'danger'
            });
            
            recommendations.push({
                text: 'Pridėti regularizacijos mechanizmus (dropout, L1/L2)',
                type: 'warning'
            });
            
            recommendations.push({
                text: 'Padidinti treniravimo duomenų kiekį',
                type: 'warning'
            });
            
        } else if (underfittingSign) {
            interpretation = `
                <div class="alert alert-warning mb-3">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Neprisitaikymo (underfitting) požymiai</h5>
                    <p class="mb-0">
                        Tarp <strong>${checkpoint1.epoch}</strong> ir <strong>${checkpoint2.epoch}</strong> epochų pastebimi neprisitaikymo požymiai.
                        Modelis negali pakankamai gerai mokytis iš turimų duomenų.
                    </p>
                </div>
                
                <p>
                    <strong>Mokymo tikslumas:</strong> ${accuracyDiff >= 0 ? 'padidėjo' : 'sumažėjo'} ${Math.abs(accuracyDiff * 100).toFixed(2)}% 
                    (nuo ${(checkpoint1.metrics.accuracy * 100).toFixed(2)}% iki ${(checkpoint2.metrics.accuracy * 100).toFixed(2)}%)
                </p>
                
                <p>
                    <strong>Validacijos tikslumas:</strong> ${valAccuracyDiff >= 0 ? 'padidėjo' : 'sumažėjo'} ${Math.abs(valAccuracyDiff * 100).toFixed(2)}% 
                    (nuo ${(checkpoint1.metrics.val_accuracy * 100).toFixed(2)}% iki ${(checkpoint2.metrics.val_accuracy * 100).toFixed(2)}%)
                </p>
                
                <p>
                    <strong>Mokymo nuostoliai:</strong> ${lossDiff <= 0 ? 'sumažėjo' : 'padidėjo'} ${Math.abs(lossDiff).toFixed(6)} 
                    (nuo ${checkpoint1.metrics.loss.toFixed(6)} iki ${checkpoint2.metrics.loss.toFixed(6)})
                </p>
                
                <p>
                    <strong>Validacijos nuostoliai:</strong> ${valLossDiff <= 0 ? 'sumažėjo' : 'padidėjo'} ${Math.abs(valLossDiff).toFixed(6)} 
                    (nuo ${checkpoint1.metrics.val_loss.toFixed(6)} iki ${checkpoint2.metrics.val_loss.toFixed(6)})
                </p>
            `;
            
            recommendations.push({
                text: 'Padidinti modelio sudėtingumą',
                type: 'warning'
            });
            
            recommendations.push({
                text: 'Padidinti mokymosi greitį (learning rate)',
                type: 'info'
            });
            
            recommendations.push({
                text: 'Apsvarstyti tolimesnį mokymą su didesniu epochų skaičiumi',
                type: 'info'
            });
            
        } else {
            interpretation = `
                <div class="alert alert-info mb-3">
                    <h5><i class="fas fa-info-circle me-2"></i>Mišrus mokymosi procesas</h5>
                    <p class="mb-0">
                        Tarp <strong>${checkpoint1.epoch}</strong> ir <strong>${checkpoint2.epoch}</strong> epochų stebimas mišrus mokymosi procesas.
                        Kai kurios metrikos gerėja, o kitos blogėja.
                    </p>
                </div>
                
                <p>
                    <strong>Mokymo tikslumas:</strong> ${accuracyDiff >= 0 ? 'padidėjo' : 'sumažėjo'} ${Math.abs(accuracyDiff * 100).toFixed(2)}% 
                    (nuo ${(checkpoint1.metrics.accuracy * 100).toFixed(2)}% iki ${(checkpoint2.metrics.accuracy * 100).toFixed(2)}%)
                </p>
                
                <p>
                    <strong>Validacijos tikslumas:</strong> ${valAccuracyDiff >= 0 ? 'padidėjo' : 'sumažėjo'} ${Math.abs(valAccuracyDiff * 100).toFixed(2)}% 
                    (nuo ${(checkpoint1.metrics.val_accuracy * 100).toFixed(2)}% iki ${(checkpoint2.metrics.val_accuracy * 100).toFixed(2)}%)
                </p>
                
                <p>
                    <strong>Mokymo nuostoliai:</strong> ${lossDiff <= 0 ? 'sumažėjo' : 'padidėjo'} ${Math.abs(lossDiff).toFixed(6)} 
                    (nuo ${checkpoint1.metrics.loss.toFixed(6)} iki ${checkpoint2.metrics.loss.toFixed(6)})
                </p>
                
                <p>
                    <strong>Validacijos nuostoliai:</strong> ${valLossDiff <= 0 ? 'sumažėjo' : 'padidėjo'} ${Math.abs(valLossDiff).toFixed(6)} 
                    (nuo ${checkpoint1.metrics.val_loss.toFixed(6)} iki ${checkpoint2.metrics.val_loss.toFixed(6)})
                </p>
            `;
            
            if (valAccuracyDiff > 0 || valLossDiff < 0) {
                recommendations.push({
                    text: 'Tęsti mokymą ir stebėti tendencijas',
                    type: 'info'
                });
            } else {
                recommendations.push({
                    text: 'Apsvarstyti mokymosi greičio mažinimą',
                    type: 'warning'
                });
            }
            
            recommendations.push({
                text: 'Eksperimentuoti su įvairiais hiperparametrais',
                type: 'info'
            });
        }
        
        // Atnaujinami UI elementai
        document.getElementById('interpretationResult').innerHTML = interpretation;
        
        // Atnaujinamas rekomendacijų sąrašas
        const decisionHelperList = document.getElementById('decisionHelperList');
        decisionHelperList.innerHTML = '';
        
        recommendations.forEach(rec => {
            const item = document.createElement('li');
            item.className = `list-group-item list-group-item-${rec.type}`;
            item.innerHTML = rec.text;
            decisionHelperList.appendChild(item);
        });
    }

    // Pridedame mygtuko įvykio klausytoją
    document.addEventListener('DOMContentLoaded', function() {
        // Įvykdome pradinę interpretaciją
        setTimeout(generateInterpretation, 500);
        
        // Pridedame mygtuko klausytoją
        document.getElementById('generateInterpretation').addEventListener('click', generateInterpretation);
    });
</script>
{% endif %}
{% endblock %}