{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Navigacija atgal -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.optimization_index') }}">Hiperparametrų optimizavimas</a></li>
            <li class="breadcrumb-item active">Grid Search konfigūracija</li>
        </ol>
    </nav>

    <!-- Antraštė -->
    <div class="mb-4">
        <h1>Grid Search optimizavimas</h1>
        <p class="text-muted">Sukonfigūruokite parametrų tinklelį išsamiam optimizavimui</p>
    </div>
    
    <!-- Informacinis blokas -->
    <div class="alert alert-info mb-4">
        <div class="d-flex">
            <div class="me-3">
                <i class="fas fa-info-circle fa-2x"></i>
            </div>
            <div>
                <h5>Apie Grid Search</h5>
                <p class="mb-0">Grid Search metodas išbando visas galimas parametrų kombinacijas nustatytame tinklelyje. Tai garantuoja, kad bus rasta geriausia parametrų kombinacija tarp nurodytų reikšmių, tačiau gali užtrukti ilgai, jei parametrų ir jų reikšmių daug.</p>
            </div>
        </div>
    </div>
    
    <!-- Grid Search konfigūracijos forma -->
    <div class="card mb-5">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Grid Search konfigūracija</h5>
        </div>
        <div class="card-body">
            <form id="gridSearchForm" method="post" action="{{ url_for('model_training.grid_search') }}">
                <!-- Pagrindiniai nustatymai -->
                <div class="row mb-4">
                    <!-- Sesijos pavadinimas -->
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Sesijos pavadinimas:</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="Grid Search {{ now.strftime('%Y-%m-%d %H:%M') }}" required>
                        <div class="form-text">Unikalus pavadinimas šiai optimizavimo sesijai</div>
                    </div>
                    
                    <!-- Modelio tipas -->
                    <div class="col-md-6 mb-3">
                        <label for="model_type" class="form-label">Modelio tipas:</label>
                        <select class="form-select" id="model_type" name="model_type" required>
                            <option value="">Pasirinkite modelio tipą</option>
                            <option value="lstm">LSTM</option>
                            <option value="gru">GRU</option>
                            <option value="cnn">CNN</option>
                            <option value="mlp">MLP</option>
                        </select>
                        <div class="form-text">Modelio architektūros tipas</div>
                    </div>
                </div>
                
                <!-- Parametrų tinklelio konfigūracija -->
                <h5 class="mb-3">Parametrų tinklelis</h5>
                <div class="alert alert-light border mb-3">
                    <p class="mb-2"><strong>Kaip naudoti:</strong></p>
                    <ul class="mb-0">
                        <li>Pridėkite naujus parametrus spausdami mygtuką "Pridėti parametrą"</li>
                        <li>Parametrų reikšmės turi būti atskirtos kableliais, pvz.: 10, 20, 30</li>
                        <li>Skaitinių parametrų reikšmės gali būti skaičiai (32, 64, 128)</li>
                        <li>Tekstinių parametrų reikšmės gali būti žodžiai (adam, sgd, rmsprop)</li>
                    </ul>
                </div>
                
                <!-- Dinaminis parametrų sąrašas -->
                <div id="parametersContainer">
                    <!-- Čia bus dinamiškai pridedami parametrai -->
                    <div class="parameter-row mb-3 border rounded p-3">
                        <div class="row align-items-center">
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Parametro pavadinimas:</label>
                                <input type="text" class="form-control param-name" name="param_names[]" 
                                       placeholder="Pvz.: learning_rate" required>
                            </div>
                            <div class="col-md-7 mb-2">
                                <label class="form-label">Parametro reikšmės (atskirtos kableliais):</label>
                                <input type="text" class="form-control param-values" name="param_values[]" 
                                       placeholder="Pvz.: 0.001, 0.01, 0.1" required>
                            </div>
                            <div class="col-md-2 mb-2 d-flex align-items-end">
                                <button type="button" class="btn btn-danger remove-param w-100">
                                    <i class="fas fa-trash me-1"></i>Pašalinti
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pridėti parametrą mygtukas -->
                <div class="mb-4">
                    <button type="button" id="addParameter" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>Pridėti parametrą
                    </button>
                </div>
                
                <hr>
                
                <!-- Optimizavimo apribojimai -->
                <h5 class="mb-3">Optimizavimo nustatymai</h5>
                <div class="row mb-4">
                    <!-- Maksimalus bandymų skaičius -->
                    <div class="col-md-4 mb-3">
                        <label for="max_trials" class="form-label">Maksimalus bandymų skaičius:</label>
                        <input type="number" class="form-control" id="max_trials" name="max_trials" 
                               value="20" min="1" max="100" required>
                        <div class="form-text">Maksimalus išbandomų kombinacijų skaičius</div>
                    </div>
                    
                    <!-- Kryžminio patikrinimo nustatymai -->
                    <div class="col-md-4 mb-3">
                        <label for="cv_folds" class="form-label">Kryžminio patikrinimo dalių skaičius:</label>
                        <input type="number" class="form-control" id="cv_folds" name="cv_folds" 
                               value="3" min="2" max="10" required>
                        <div class="form-text">Kryžminio patikrinimo dalių (fold) skaičius</div>
                    </div>
                    
                    <!-- Atsitiktinumo sėkla -->
                    <div class="col-md-4 mb-3">
                        <label for="random_seed" class="form-label">Atsitiktinumo sėkla:</label>
                        <input type="number" class="form-control" id="random_seed" name="random_seed" 
                               value="42" min="0">
                        <div class="form-text">Rezultatų atkartojamumui (palikite tuščią atsitiktinei)</div>
                    </div>
                </div>
                
                <!-- Duomenų šaltinio pasirinkimas -->
                <h5 class="mb-3">Duomenų šaltinis</h5>
                <div class="row mb-4">
                    <!-- Duomenų šaltinio tipas -->
                    <div class="col-md-6 mb-3">
                        <label for="data_source" class="form-label">Duomenų šaltinis:</label>
                        <select class="form-select" id="data_source" name="data_source" required>
                            <option value="latest">Naujausi duomenys</option>
                            <option value="local">Vietiniai duomenys</option>
                            <option value="custom">Pasirinktinis šaltinis</option>
                        </select>
                    </div>
                    
                    <!-- Duomenų periodo nustatymas -->
                    <div class="col-md-6 mb-3" id="dataPeriodContainer">
                        <label for="data_period" class="form-label">Duomenų periodas:</label>
                        <select class="form-select" id="data_period" name="data_period">
                            <option value="30d">Paskutinės 30 dienų</option>
                            <option value="90d">Paskutinės 90 dienų</option>
                            <option value="180d">Paskutinės 180 dienų</option>
                            <option value="1y">Paskutiniai metai</option>
                            <option value="all">Visi duomenys</option>
                        </select>
                    </div>
                    
                    <!-- Pasirinktinio duomenų šaltinio įvedimas -->
                    <div class="col-12 mb-3" id="customSourceContainer" style="display: none;">
                        <label for="custom_source" class="form-label">Pasirinktinio šaltinio kelias:</label>
                        <input type="text" class="form-control" id="custom_source" name="custom_source" 
                               placeholder="Pvz.: /data/btc_data_2023.csv">
                    </div>
                </div>
                
                <!-- Pateikimo mygtukai -->
                <div class="mt-4 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="window.history.back();">
                        <i class="fas fa-arrow-left me-1"></i>Atgal
                    </button>
                    <div>
                        <button type="reset" class="btn btn-outline-warning me-2">
                            <i class="fas fa-redo me-1"></i>Atstatyti
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-play me-1"></i>Pradėti optimizavimą
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript kodas dinamiškam parametrų pridėjimui -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Pradžioje pridedame 3 pavyzdinius parametrus
        addParameterRow('epochs', '10, 20, 30, 50');
        addParameterRow('batch_size', '16, 32, 64, 128');
        addParameterRow('learning_rate', '0.001, 0.01, 0.1');
        
        // Elemento, į kurį pridėsime parametrus, nuoroda
        const parametersContainer = document.getElementById('parametersContainer');
        const addParameterButton = document.getElementById('addParameter');
        
        // Pridėti naują parametrą mygtuko paspaudimu
        addParameterButton.addEventListener('click', function() {
            addParameterRow();
        });
        
        // Funkcija naujo parametro eilutei pridėti
        function addParameterRow(name = '', values = '') {
            // Kuriame naują parametro eilutę
            const paramRow = document.createElement('div');
            paramRow.className = 'parameter-row mb-3 border rounded p-3';
            
            // Parametro eilutės HTML
            paramRow.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Parametro pavadinimas:</label>
                        <input type="text" class="form-control param-name" name="param_names[]" 
                               placeholder="Pvz.: learning_rate" value="${name}" required>
                    </div>
                    <div class="col-md-7 mb-2">
                        <label class="form-label">Parametro reikšmės (atskirtos kableliais):</label>
                        <input type="text" class="form-control param-values" name="param_values[]" 
                               placeholder="Pvz.: 0.001, 0.01, 0.1" value="${values}" required>
                    </div>
                    <div class="col-md-2 mb-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-param w-100">
                            <i class="fas fa-trash me-1"></i>Pašalinti
                        </button>
                    </div>
                </div>
            `;
            
            // Pridedame eilutę į konteinerį
            parametersContainer.appendChild(paramRow);
            
            // Pridedame įvykio klausytoją parametro šalinimo mygtukui
            const removeButton = paramRow.querySelector('.remove-param');
            removeButton.addEventListener('click', function() {
                paramRow.remove();
            });
        }
        
        // Duomenų šaltinio pasirinkimo valdymas
        const dataSourceSelect = document.getElementById('data_source');
        const customSourceContainer = document.getElementById('customSourceContainer');
        const dataPeriodContainer = document.getElementById('dataPeriodContainer');
        
        dataSourceSelect.addEventListener('change', function() {
            if (dataSourceSelect.value === 'custom') {
                customSourceContainer.style.display = 'block';
                dataPeriodContainer.style.display = 'none';
            } else {
                customSourceContainer.style.display = 'none';
                dataPeriodContainer.style.display = 'block';
            }
        });
        
        // Apskaičiuojame galimų kombinacijų skaičių
        const form = document.getElementById('gridSearchForm');
        form.addEventListener('submit', function(event) {
            // Surenkame visus parametrų įvesties laukus
            const paramValues = document.querySelectorAll('.param-values');
            
            // Skaičiuojame bendrą kombinacijų skaičių
            let totalCombinations = 1;
            
            paramValues.forEach(function(input) {
                // Skaidome reikšmes pagal kablelius ir skaičiuojame
                const values = input.value.split(',').map(v => v.trim()).filter(v => v);
                totalCombinations *= values.length;
            });
            
            // Gauname maksimalų bandymų skaičių
            const maxTrials = parseInt(document.getElementById('max_trials').value);
            
            // Jei kombinacijų per daug, patvirtinimas
            if (totalCombinations > maxTrials) {
                const confirm = window.confirm(
                    `Visų parametrų kombinacijų skaičius (${totalCombinations}) viršija nustatytą maksimalų bandymų skaičių (${maxTrials}). 
                    Bus išbandytos tik ${maxTrials} atsitiktinai parinktos kombinacijos. 
                    Ar norite tęsti?`
                );
                
                if (!confirm) {
                    event.preventDefault();
                }
            } else if (totalCombinations > 50) {
                // Įspėjimas, jei daug kombinacijų
                const confirm = window.confirm(
                    `Pasirinkta ${totalCombinations} parametrų kombinacijų. 
                    Optimizavimas gali užtrukti ilgai. 
                    Ar norite tęsti?`
                );
                
                if (!confirm) {
                    event.preventDefault();
                }
            }
        });
    });
</script>
{% endblock %}