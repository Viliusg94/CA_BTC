{% extends "base.html" %}

{% block title %}Metrikų analizė{% endblock %}

{% block styles %}
<style>
    /* Grafikų konteinerio stilius */
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    
    /* Lentelės stiliai */
    .metrics-table {
        font-size: 0.9rem;
    }
    
    /* Maksimalios/minimalios reikšmės stilius */
    .max-value {
        color: #28a745;
        font-weight: bold;
    }
    
    .min-value {
        color: #dc3545;
        font-weight: bold;
    }
    
    /* Kortelių stilius */
    .metric-card {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 15px;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .metric-title {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    /* Analizės įrankių juostos stilius */
    .analysis-toolbar {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    
    /* Palyginimo lentelės stilius */
    .comparison-table td {
        text-align: center;
    }
    
    .comparison-table .better {
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    .comparison-table .worse {
        background-color: rgba(220, 53, 69, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-3">Modelio metrikų analizė</h1>
            
            <!-- Modelio informacija -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ model_config.name }}</h5>
                    <span class="badge bg-primary">{{ model_config.type|upper }}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Epochos:</strong> {{ model_config.parameters.epochs }}</p>
                            <p><strong>Batch dydis:</strong> {{ model_config.parameters.batch_size }}</p>
                            <p><strong>Mokymosi greitis:</strong> {{ model_config.parameters.learning_rate }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Sluoksniai:</strong> {{ model_config.parameters.layers }}</p>
                            <p><strong>Neuronai:</strong> {{ model_config.parameters.neurons }}</p>
                            <p><strong>Sukurtas:</strong> {{ model_config.parameters.created_at }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analizės įrankių juosta -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Analizės įrankiai</h5>
                </div>
                <div class="card-body">
                    <div class="analysis-toolbar">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show-train-data" checked>
                                    <label class="form-check-label" for="show-train-data">
                                        Rodyti treniravimo duomenis
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show-val-data" checked>
                                    <label class="form-check-label" for="show-val-data">
                                        Rodyti validacijos duomenis
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="highlight-min-max" checked>
                                    <label class="form-check-label" for="highlight-min-max">
                                        Išryškinti min/max reikšmes
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show-trend-line">
                                    <label class="form-check-label" for="show-trend-line">
                                        Rodyti tendencijos liniją
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">Epochų intervalas:</span>
                                    <select class="form-select" id="epoch-range">
                                        <option value="all">Visos epochos</option>
                                        <option value="first10">Pirmos 10 epochų</option>
                                        <option value="last10">Paskutinės 10 epochų</option>
                                        <option value="custom">Pasirinkti...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <button id="export-csv-btn" class="btn btn-outline-primary">
                                    <i class="fas fa-download me-2"></i>Eksportuoti CSV
                                </button>
                            </div>
                        </div>
                        
                        <!-- Pasirinkto intervalo įvestys (rodomos tik pasirinkus "custom") -->
                        <div id="custom-range" class="row mt-2" style="display: none;">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">Nuo epochos:</span>
                                    <input type="number" class="form-control" id="start-epoch" value="1" min="1" max="{{ metrics|length }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">Iki epochos:</span>
                                    <input type="number" class="form-control" id="end-epoch" value="{{ metrics|length }}" min="1" max="{{ metrics|length }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Palyginimo metrikos -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Treniravimo ir validacijos metrikų palyginimas</h5>
                </div>
                <div class="card-body">
                    <!-- Palyginimo grafikai -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <canvas id="loss-comparison-chart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <canvas id="accuracy-comparison-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Palyginimo lentelė -->
                    <div class="table-responsive mt-4">
                        <table class="table table-bordered comparison-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Metrika</th>
                                    <th>Treniravimo</th>
                                    <th>Validacijos</th>
                                    <th>Skirtumas</th>
                                    <th>Interpretacija</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Galutinis Loss</td>
                                    <td id="final-train-loss"></td>
                                    <td id="final-val-loss"></td>
                                    <td id="loss-diff"></td>
                                    <td id="loss-interpretation"></td>
                                </tr>
                                <tr>
                                    <td>Galutinis Accuracy</td>
                                    <td id="final-train-acc"></td>
                                    <td id="final-val-acc"></td>
                                    <td id="acc-diff"></td>
                                    <td id="acc-interpretation"></td>
                                </tr>
                                <tr>
                                    <td>Geriausias Loss</td>
                                    <td id="best-train-loss"></td>
                                    <td id="best-val-loss"></td>
                                    <td id="best-loss-diff"></td>
                                    <td id="best-loss-interpretation"></td>
                                </tr>
                                <tr>
                                    <td>Geriausias Accuracy</td>
                                    <td id="best-train-acc"></td>
                                    <td id="best-val-acc"></td>
                                    <td id="best-acc-diff"></td>
                                    <td id="best-acc-interpretation"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Maksimumų/minimumų išryškinimas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Geriausios ir blogiausios epochos</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-title">Žemiausias Loss</div>
                                <div class="metric-value min-value" id="min-loss-value"></div>
                                <div>Epocha: <span id="min-loss-epoch"></span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-title">Žemiausias Val Loss</div>
                                <div class="metric-value min-value" id="min-val-loss-value"></div>
                                <div>Epocha: <span id="min-val-loss-epoch"></span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-title">Aukščiausias Accuracy</div>
                                <div class="metric-value max-value" id="max-acc-value"></div>
                                <div>Epocha: <span id="max-acc-epoch"></span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-title">Aukščiausias Val Accuracy</div>
                                <div class="metric-value max-value" id="max-val-acc-value"></div>
                                <div>Epocha: <span id="max-val-acc-epoch"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metrikų lentelė -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Detalūs metrikų duomenys</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="highlight-table-minmax" checked>
                        <label class="form-check-label" for="highlight-table-minmax">
                            Išryškinti min/max reikšmes
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover metrics-table" id="metrics-table">
                            <thead>
                                <tr>
                                    <th>Epocha</th>
                                    <th>Loss</th>
                                    <th>Val Loss</th>
                                    <th>Accuracy</th>
                                    <th>Val Accuracy</th>
                                    <th>Loss pokytis</th>
                                    <th>Val Loss pokytis</th>
                                    <th>Acc pokytis</th>
                                    <th>Val Acc pokytis</th>
                                </tr>
                            </thead>
                            <tbody id="metrics-table-body">
                                <!-- Čia bus įkelti metrikų duomenys -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Grįžimo mygtukai -->
            <div class="mt-4 mb-4">
                <a href="{{ url_for('model_training.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Grįžti į modelių sąrašą
                </a>
                <a href="{{ url_for('model_training.view_metrics', training_id=training_id) }}" class="btn btn-primary ms-2">
                    <i class="fas fa-chart-line me-2"></i>Grįžti į metrikų peržiūrą
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js biblioteka -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js tendencijos linijų įskiepis -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-trendline"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Metrikų duomenys
        const metricsData = {{ metrics_json|safe }};
        
        // Paruošiame duomenis grafikams
        const epochs = metricsData.map(d => d.epoch);
        const trainLoss = metricsData.map(d => d.loss);
        const valLoss = metricsData.map(d => d.val_loss);
        const trainAccuracy = metricsData.map(d => d.accuracy);
        const valAccuracy = metricsData.map(d => d.val_accuracy);
        
        // Apskaičiuojame metrikų minimumą ir maksimumą
        const minTrainLoss = Math.min(...trainLoss);
        const minValLoss = Math.min(...valLoss);
        const maxTrainAcc = Math.max(...trainAccuracy);
        const maxValAcc = Math.max(...valAccuracy);
        
        // Randame epochas su min/max reikšmėmis
        const minTrainLossEpoch = epochs[trainLoss.indexOf(minTrainLoss)];
        const minValLossEpoch = epochs[valLoss.indexOf(minValLoss)];
        const maxTrainAccEpoch = epochs[trainAccuracy.indexOf(maxTrainAcc)];
        const maxValAccEpoch = epochs[valAccuracy.indexOf(maxValAcc)];
        
        // Užpildome min/max metrikų korteles
        document.getElementById('min-loss-value').textContent = minTrainLoss.toFixed(4);
        document.getElementById('min-loss-epoch').textContent = minTrainLossEpoch;
        document.getElementById('min-val-loss-value').textContent = minValLoss.toFixed(4);
        document.getElementById('min-val-loss-epoch').textContent = minValLossEpoch;
        document.getElementById('max-acc-value').textContent = (maxTrainAcc * 100).toFixed(2) + '%';
        document.getElementById('max-acc-epoch').textContent = maxTrainAccEpoch;
        document.getElementById('max-val-acc-value').textContent = (maxValAcc * 100).toFixed(2) + '%';
        document.getElementById('max-val-acc-epoch').textContent = maxValAccEpoch;
        
        // Užpildome palyginimo lentelę
        const lastEpoch = metricsData.length - 1;
        const finalTrainLoss = trainLoss[lastEpoch];
        const finalValLoss = valLoss[lastEpoch];
        const finalTrainAcc = trainAccuracy[lastEpoch];
        const finalValAcc = valAccuracy[lastEpoch];
        
        document.getElementById('final-train-loss').textContent = finalTrainLoss.toFixed(4);
        document.getElementById('final-val-loss').textContent = finalValLoss.toFixed(4);
        document.getElementById('final-train-acc').textContent = (finalTrainAcc * 100).toFixed(2) + '%';
        document.getElementById('final-val-acc').textContent = (finalValAcc * 100).toFixed(2) + '%';
        
        // Apskaičiuojame skirtumus ir interpretacijas
        const lossDiff = (finalValLoss - finalTrainLoss).toFixed(4);
        const accDiff = ((finalValAcc - finalTrainAcc) * 100).toFixed(2) + '%';
        const bestLossDiff = (minValLoss - minTrainLoss).toFixed(4);
        const bestAccDiff = ((maxValAcc - maxTrainAcc) * 100).toFixed(2) + '%';
        
        document.getElementById('loss-diff').textContent = lossDiff;
        document.getElementById('acc-diff').textContent = accDiff;
        document.getElementById('best-train-loss').textContent = minTrainLoss.toFixed(4);
        document.getElementById('best-val-loss').textContent = minValLoss.toFixed(4);
        document.getElementById('best-loss-diff').textContent = bestLossDiff;
        document.getElementById('best-train-acc').textContent = (maxTrainAcc * 100).toFixed(2) + '%';
        document.getElementById('best-val-acc').textContent = (maxValAcc * 100).toFixed(2) + '%';
        document.getElementById('best-acc-diff').textContent = bestAccDiff;
        
        // Interpretacijos
        const lossOverfit = finalValLoss > finalTrainLoss * 1.1;
        const accOverfit = finalValAcc < finalTrainAcc * 0.9;
        
        const lossInterpretation = lossOverfit ? 
            'Galimas overfitting: validacijos klaida žymiai didesnė už treniravimo' : 
            'Normalu: validacijos ir treniravimo klaidos panašios';
        
        const accInterpretation = accOverfit ? 
            'Galimas overfitting: validacijos tikslumas žymiai mažesnis už treniravimo' : 
            'Normalu: validacijos ir treniravimo tikslumas panašūs';
        
        document.getElementById('loss-interpretation').textContent = lossInterpretation;
        document.getElementById('acc-interpretation').textContent = accInterpretation;
        
        const bestLossInterpretation = minValLoss > minTrainLoss * 1.1 ? 
            'Galimas overfitting: geriausias validacijos loss didesnis už geriausią treniravimo' : 
            'Normalu: geriausi validacijos ir treniravimo loss panašūs';
        
        const bestAccInterpretation = maxValAcc < maxTrainAcc * 0.9 ? 
            'Galimas overfitting: geriausias validacijos tikslumas mažesnis už geriausią treniravimo' : 
            'Normalu: geriausi validacijos ir treniravimo tikslumai panašūs';
        
        document.getElementById('best-loss-interpretation').textContent = bestLossInterpretation;
        document.getElementById('best-acc-interpretation').textContent = bestAccInterpretation;
        
        // Pridedame klases pagal interpretacijas
        if (lossOverfit) {
            document.getElementById('loss-diff').classList.add('text-danger');
            document.getElementById('loss-interpretation').classList.add('text-danger');
        } else {
            document.getElementById('loss-diff').classList.add('text-success');
            document.getElementById('loss-interpretation').classList.add('text-success');
        }
        
        if (accOverfit) {
            document.getElementById('acc-diff').classList.add('text-danger');
            document.getElementById('acc-interpretation').classList.add('text-danger');
        } else {
            document.getElementById('acc-diff').classList.add('text-success');
            document.getElementById('acc-interpretation').classList.add('text-success');
        }
        
        // Palyginimo lentelės eilutės
        const lossRow = document.getElementById('loss-diff').parentNode.parentNode;
        const accRow = document.getElementById('acc-diff').parentNode.parentNode;
        
        if (lossOverfit) {
            lossRow.classList.add('worse');
        } else {
            lossRow.classList.add('better');
        }
        
        if (accOverfit) {
            accRow.classList.add('worse');
        } else {
            accRow.classList.add('better');
        }
        
        // Sukuriame Loss palyginimo grafiką
        const lossChartCanvas = document.getElementById('loss-comparison-chart');
        const lossChart = new Chart(lossChartCanvas, {
            type: 'line',
            data: {
                labels: epochs,
                datasets: [
                    {
                        label: 'Treniravimo klaida',
                        data: trainLoss,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 2,
                        fill: true
                    },
                    {
                        label: 'Validacijos klaida',
                        data: valLoss,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Loss reikšmių palyginimas',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    annotation: {
                        annotations: {
                            minTrainLossLine: {
                                type: 'line',
                                xMin: minTrainLossEpoch,
                                xMax: minTrainLossEpoch,
                                borderColor: 'rgba(75, 192, 192, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Min Train Loss',
                                    enabled: true,
                                    position: 'top'
                                }
                            },
                            minValLossLine: {
                                type: 'line',
                                xMin: minValLossEpoch,
                                xMax: minValLossEpoch,
                                borderColor: 'rgba(255, 99, 132, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Min Val Loss',
                                    enabled: true,
                                    position: 'bottom'
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Epocha'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Loss reikšmė'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Sukuriame Accuracy palyginimo grafiką
        const accuracyChartCanvas = document.getElementById('accuracy-comparison-chart');
        const accuracyChart = new Chart(accuracyChartCanvas, {
            type: 'line',
            data: {
                labels: epochs,
                datasets: [
                    {
                        label: 'Treniravimo tikslumas',
                        data: trainAccuracy,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        fill: true
                    },
                    {
                        label: 'Validacijos tikslumas',
                        data: valAccuracy,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Tikslumo reikšmių palyginimas',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    annotation: {
                        annotations: {
                            maxTrainAccLine: {
                                type: 'line',
                                xMin: maxTrainAccEpoch,
                                xMax: maxTrainAccEpoch,
                                borderColor: 'rgba(54, 162, 235, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Max Train Acc',
                                    enabled: true,
                                    position: 'top'
                                }
                            },
                            maxValAccLine: {
                                type: 'line',
                                xMin: maxValAccEpoch,
                                xMax: maxValAccEpoch,
                                borderColor: 'rgba(255, 159, 64, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Max Val Acc',
                                    enabled: true,
                                    position: 'bottom'
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Epocha'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Tikslumas'
                        },
                        min: 0,
                        max: 1,
                        ticks: {
                            callback: function(value) {
                                return (value * 100).toFixed(0) + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Užpildome metrikų lentelę
        const tableBody = document.getElementById('metrics-table-body');
        let prevTrainLoss = null;
        let prevValLoss = null;
        let prevTrainAcc = null;
        let prevValAcc = null;
        
        metricsData.forEach((metric, index) => {
            const row = document.createElement('tr');
            
            // Apskaičiuojame metrikų pokyčius
            let trainLossChange = '';
            let valLossChange = '';
            let trainAccChange = '';
            let valAccChange = '';
            
            if (index > 0) {
                const trainLossDiff = metric.loss - prevTrainLoss;
                const valLossDiff = metric.val_loss - prevValLoss;
                const trainAccDiff = metric.accuracy - prevTrainAcc;
                const valAccDiff = metric.val_accuracy - prevValAcc;
                
                // Formatuojame pokyčius
                trainLossChange = trainLossDiff >= 0 ? 
                    `<span class="text-danger">+${trainLossDiff.toFixed(4)}</span>` : 
                    `<span class="text-success">${trainLossDiff.toFixed(4)}</span>`;
                
                valLossChange = valLossDiff >= 0 ? 
                    `<span class="text-danger">+${valLossDiff.toFixed(4)}</span>` : 
                    `<span class="text-success">${valLossDiff.toFixed(4)}</span>`;
                
                trainAccChange = trainAccDiff >= 0 ? 
                    `<span class="text-success">+${(trainAccDiff * 100).toFixed(2)}%</span>` : 
                    `<span class="text-danger">${(trainAccDiff * 100).toFixed(2)}%</span>`;
                
                valAccChange = valAccDiff >= 0 ? 
                    `<span class="text-success">+${(valAccDiff * 100).toFixed(2)}%</span>` : 
                    `<span class="text-danger">${(valAccDiff * 100).toFixed(2)}%</span>`;
            }
            
            // Išsaugome dabartines reikšmes kaip ankstesnes kitam ciklui
            prevTrainLoss = metric.loss;
            prevValLoss = metric.val_loss;
            prevTrainAcc = metric.accuracy;
            prevValAcc = metric.val_accuracy;
            
            // Nustatome min/max stilius
            const isMinTrainLoss = metric.loss === minTrainLoss;
            const isMinValLoss = metric.val_loss === minValLoss;
            const isMaxTrainAcc = metric.accuracy === maxTrainAcc;
            const isMaxValAcc = metric.val_accuracy === maxValAcc;
            
            // Sukuriame eilutės turinį
            row.innerHTML = `
                <td>${metric.epoch}</td>
                <td class="${isMinTrainLoss ? 'min-value' : ''}">${metric.loss.toFixed(4)}</td>
                <td class="${isMinValLoss ? 'min-value' : ''}">${metric.val_loss.toFixed(4)}</td>
                <td class="${isMaxTrainAcc ? 'max-value' : ''}">${(metric.accuracy * 100).toFixed(2)}%</td>
                <td class="${isMaxValAcc ? 'max-value' : ''}">${(metric.val_accuracy * 100).toFixed(2)}%</td>
                <td>${trainLossChange}</td>
                <td>${valLossChange}</td>
                <td>${trainAccChange}</td>
                <td>${valAccChange}</td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Valdiklių funkcionalumas
        
        // Treniravimo ir validacijos duomenų rodymas/slėpimas
        document.getElementById('show-train-data').addEventListener('change', function(e) {
            lossChart.data.datasets[0].hidden = !e.target.checked;
            accuracyChart.data.datasets[0].hidden = !e.target.checked;
            lossChart.update();
            accuracyChart.update();
        });
        
        document.getElementById('show-val-data').addEventListener('change', function(e) {
            lossChart.data.datasets[1].hidden = !e.target.checked;
            accuracyChart.data.datasets[1].hidden = !e.target.checked;
            lossChart.update();
            accuracyChart.update();
        });
        
        // Min/Max reikšmių išryškinimas
        document.getElementById('highlight-min-max').addEventListener('change', function(e) {
            const visibility = e.target.checked;
            
            // Atnaujina grafikų anotacijas
            lossChart.options.plugins.annotation.annotations.minTrainLossLine.display = visibility;
            lossChart.options.plugins.annotation.annotations.minValLossLine.display = visibility;
            accuracyChart.options.plugins.annotation.annotations.maxTrainAccLine.display = visibility;
            accuracyChart.options.plugins.annotation.annotations.maxValAccLine.display = visibility;
            
            lossChart.update();
            accuracyChart.update();
        });
        
        // Tendencijos linijų rodymas
        document.getElementById('show-trend-line').addEventListener('change', function(e) {
            const showTrendline = e.target.checked;
            
            // Prideda arba pašalina tendencijos linijas
            lossChart.data.datasets.forEach(dataset => {
                dataset.trendlineLinear = showTrendline ? {
                    style: dataset.borderColor,
                    lineStyle: "dotted",
                    width: 2
                } : false;
            });
            
            accuracyChart.data.datasets.forEach(dataset => {
                dataset.trendlineLinear = showTrendline ? {
                    style: dataset.borderColor,
                    lineStyle: "dotted",
                    width: 2
                } : false;
            });
            
            lossChart.update();
            accuracyChart.update();
        });
        
        // Epochų intervalo pasirinkimas
        document.getElementById('epoch-range').addEventListener('change', function(e) {
            const rangeType = e.target.value;
            const customRangeDiv = document.getElementById('custom-range');
            
            // Rodyti/slėpti pasirinktinį intervalą
            if (rangeType === 'custom') {
                customRangeDiv.style.display = 'flex';
            } else {
                customRangeDiv.style.display = 'none';
            }
            
            let startEpoch = 0;
            let endEpoch = epochs.length - 1;
            
            if (rangeType === 'first10') {
                endEpoch = Math.min(9, epochs.length - 1);
            } else if (rangeType === 'last10') {
                startEpoch = Math.max(0, epochs.length - 10);
            } else if (rangeType === 'custom') {
                // Pasirinktinis intervalas bus atnaujintas vėliau
                return;
            }
            
            updateChartRange(startEpoch, endEpoch);
        });
        
        // Pasirinktinio intervalo valdikliai
        document.getElementById('start-epoch').addEventListener('change', function() {
            updateCustomRange();
        });
        
        document.getElementById('end-epoch').addEventListener('change', function() {
            updateCustomRange();
        });
        
        // Pasirinktinio intervalo atnaujinimas
        function updateCustomRange() {
            const startEpochInput = document.getElementById('start-epoch');
            const endEpochInput = document.getElementById('end-epoch');
            
            let startEpoch = parseInt(startEpochInput.value) - 1; // -1 nes rodome nuo 1, bet indeksai nuo 0
            let endEpoch = parseInt(endEpochInput.value) - 1;
            
            // Validacija
            if (startEpoch < 0) startEpoch = 0;
            if (endEpoch >= epochs.length) endEpoch = epochs.length - 1;
            if (startEpoch > endEpoch) {
                startEpoch = 0;
                startEpochInput.value = 1;
            }
            
            updateChartRange(startEpoch, endEpoch);
        }
        
        // Grafikų intervalo atnaujinimas
        function updateChartRange(startIndex, endIndex) {
            // Filtruojame duomenis pagal pasirinktą intervalą
            const filteredEpochs = epochs.slice(startIndex, endIndex + 1);
            const filteredTrainLoss = trainLoss.slice(startIndex, endIndex + 1);
            const filteredValLoss = valLoss.slice(startIndex, endIndex + 1);
            const filteredTrainAcc = trainAccuracy.slice(startIndex, endIndex + 1);
            const filteredValAcc = valAccuracy.slice(startIndex, endIndex + 1);
            
            // Atnaujina grafikų duomenis
            lossChart.data.labels = filteredEpochs;
            lossChart.data.datasets[0].data = filteredTrainLoss;
            lossChart.data.datasets[1].data = filteredValLoss;
            
            accuracyChart.data.labels = filteredEpochs;
            accuracyChart.data.datasets[0].data = filteredTrainAcc;
            accuracyChart.data.datasets[1].data = filteredValAcc;
            
            lossChart.update();
            accuracyChart.update();
        }
        
        // Lentelės min/max išryškinimas
        document.getElementById('highlight-table-minmax').addEventListener('change', function(e) {
            const shouldHighlight = e.target.checked;
            const minValues = document.querySelectorAll('.min-value');
            const maxValues = document.querySelectorAll('.max-value');
            
            minValues.forEach(el => {
                if (shouldHighlight) {
                    el.classList.add('min-value');
                } else {
                    el.classList.remove('min-value');
                }
            });
            
            maxValues.forEach(el => {
                if (shouldHighlight) {
                    el.classList.add('max-value');
                } else {
                    el.classList.remove('max-value');
                }
            });
        });
        
        // Metrikų eksportavimas į CSV
        document.getElementById('export-csv-btn').addEventListener('click', function() {
            // Sukuriame CSV eilutes
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Epocha,Loss,Val Loss,Accuracy,Val Accuracy,Loss pokytis,Val Loss pokytis,Acc pokytis,Val Acc pokytis\n";
            
            let prevTrainLoss = null;
            let prevValLoss = null;
            let prevTrainAcc = null;
            let prevValAcc = null;
            
            metricsData.forEach((metric, index) => {
                let trainLossChange = '';
                let valLossChange = '';
                let trainAccChange = '';
                let valAccChange = '';
                
                if (index > 0) {
                    trainLossChange = (metric.loss - prevTrainLoss).toFixed(4);
                    valLossChange = (metric.val_loss - prevValLoss).toFixed(4);
                    trainAccChange = (metric.accuracy - prevTrainAcc).toFixed(4);
                    valAccChange = (metric.val_accuracy - prevValAcc).toFixed(4);
                }
                
                prevTrainLoss = metric.loss;
                prevValLoss = metric.val_loss;
                prevTrainAcc = metric.accuracy;
                prevValAcc = metric.val_accuracy;
                
                csvContent += `${metric.epoch},${metric.loss.toFixed(4)},${metric.val_loss.toFixed(4)},${metric.accuracy.toFixed(4)},${metric.val_accuracy.toFixed(4)},${trainLossChange},${valLossChange},${trainAccChange},${valAccChange}\n`;
            });
            
            // Sukuriame atsisiuntimo nuorodą
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "modelio_metrikos.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });
</script>
{% endblock %}