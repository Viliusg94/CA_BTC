{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Antraštė -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Hiperparametrų optimizavimas</h1>
    </div>
    
    <!-- Informacinis blokas -->
    <div class="alert alert-info mb-4">
        <div class="d-flex">
            <div class="me-3">
                <i class="fas fa-info-circle fa-2x"></i>
            </div>
            <div>
                <h5>Apie hiperparametrų optimizavimą</h5>
                <p class="mb-0">Hiperparametrų optimizavimas yra procesas, kurio metu automatiškai išbandomi įvairūs modelio parametrai, siekiant rasti geriausią jų kombinaciją. Tai padeda sukurti efektyvesnius modelius, tačiau gali užtrukti laiko.</p>
            </div>
        </div>
    </div>
    
    <!-- Optimizavimo metodų kortelės -->
    <h2 class="mb-3">Optimizavimo metodai</h2>
    <div class="row mb-5">
        <!-- Grid Search kortelė -->
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Grid Search</h5>
                </div>
                <div class="card-body">
                    <p>Grid Search metodas išbando visas galimas parametrų kombinacijas nustatytame tinklelyje. Tinka kai parametrų nėra daug.</p>
                    <ul>
                        <li>Išsamus visų kombinacijų testavimas</li>
                        <li>Garantuotai randa geriausius parametrus apibrėžtoje erdvėje</li>
                        <li>Trunka ilgiau nei kiti metodai</li>
                    </ul>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('model_training.grid_search') }}" class="btn btn-primary d-block">Pradėti Grid Search</a>
                </div>
            </div>
        </div>
        
        <!-- Random Search kortelė -->
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Random Search</h5>
                </div>
                <div class="card-body">
                    <p>Random Search metodas atsitiktinai išbando parametrų kombinacijas. Efektyvesnis už Grid Search, kai parametrų daug.</p>
                    <ul>
                        <li>Atsitiktinis parametrų išbandymas</li>
                        <li>Geresnis efektyvumo/laiko santykis</li>
                        <li>Gali praleisti optimalias kombinacijas</li>
                    </ul>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('model_training.random_search') }}" class="btn btn-primary d-block">Pradėti Random Search</a>
                </div>
            </div>
        </div>
        
        <!-- Bayesian kortelė -->
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Bayesian Optimizavimas</h5>
                </div>
                <div class="card-body">
                    <p>Bayesian optimizavimas naudoja ankstesnių bandymų rezultatus efektyviai paieškai. Pažangiausias metodas.</p>
                    <ul>
                        <li>Efektyvus parametrų erdvės tyrinėjimas</li>
                        <li>Mažiau bandymų geresniam rezultatui</li>
                        <li>Sudėtingesnis, bet našesnis</li>
                    </ul>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('model_training.bayesian_optimization') }}" class="btn btn-primary d-block">Pradėti Bayesian optimizavimą</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sesijų filtravimas -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Filtrai</h5>
        </div>
        <div class="card-body">
            <form id="filterForm" method="get">
                <div class="row">
                    <!-- Algoritmo filtras -->
                    <div class="col-md-3 mb-3">
                        <label for="algorithm" class="form-label">Algoritmas:</label>
                        <select class="form-select" id="algorithm" name="algorithm">
                            <option value="">Visi algoritmai</option>
                            <option value="grid_search" {% if request.args.get('algorithm') == 'grid_search' %}selected{% endif %}>Grid Search</option>
                            <option value="random_search" {% if request.args.get('algorithm') == 'random_search' %}selected{% endif %}>Random Search</option>
                            <option value="bayesian_optimization" {% if request.args.get('algorithm') == 'bayesian_optimization' %}selected{% endif %}>Bayesian</option>
                        </select>
                    </div>
                    
                    <!-- Statuso filtras -->
                    <div class="col-md-3 mb-3">
                        <label for="status" class="form-label">Statusas:</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Visi statusai</option>
                            <option value="created" {% if request.args.get('status') == 'created' %}selected{% endif %}>Sukurta</option>
                            <option value="running" {% if request.args.get('status') == 'running' %}selected{% endif %}>Vykdoma</option>
                            <option value="completed" {% if request.args.get('status') == 'completed' %}selected{% endif %}>Užbaigta</option>
                            <option value="failed" {% if request.args.get('status') == 'failed' %}selected{% endif %}>Nepavyko</option>
                        </select>
                    </div>
                    
                    <!-- Laiko periodo filtras -->
                    <div class="col-md-3 mb-3">
                        <label for="period" class="form-label">Laikotarpis:</label>
                        <select class="form-select" id="period" name="period">
                            <option value="">Visas laikas</option>
                            <option value="today" {% if request.args.get('period') == 'today' %}selected{% endif %}>Šiandien</option>
                            <option value="week" {% if request.args.get('period') == 'week' %}selected{% endif %}>Paskutinė savaitė</option>
                            <option value="month" {% if request.args.get('period') == 'month' %}selected{% endif %}>Paskutinis mėnuo</option>
                        </select>
                    </div>
                    
                    <!-- Rikiavimo filtras -->
                    <div class="col-md-3 mb-3">
                        <label for="sort" class="form-label">Rikiuoti pagal:</label>
                        <select class="form-select" id="sort" name="sort">
                            <option value="date_desc" {% if request.args.get('sort') == 'date_desc' %}selected{% endif %}>Naujausios</option>
                            <option value="date_asc" {% if request.args.get('sort') == 'date_asc' %}selected{% endif %}>Seniausios</option>
                            <option value="score_desc" {% if request.args.get('sort') == 'score_desc' %}selected{% endif %}>Geriausias rezultatas</option>
                            <option value="trials_desc" {% if request.args.get('sort') == 'trials_desc' %}selected{% endif %}>Daugiausiai bandymų</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filtravimo mygtukai -->
                <div class="mt-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i>Filtruoti
                    </button>
                    <button type="button" id="resetFilters" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-sync me-2"></i>Atstatyti filtrus
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Sesijų sąrašas -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Optimizavimo sesijos</h5>
            <div>
                <button id="compareButton" class="btn btn-sm btn-outline-primary" disabled>
                    <i class="fas fa-chart-line me-1"></i>Palyginti pažymėtas
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            {% if sessions %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>Pavadinimas</th>
                            <th>Algoritmas</th>
                            <th>Sukurta</th>
                            <th>Statusas</th>
                            <th>Geriausia metrika</th>
                            <th>Bandymai</th>
                            <th>Veiksmai</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session in sessions %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input session-checkbox" type="checkbox" value="{{ session.session_id }}">
                                </div>
                            </td>
                            <td>{{ session.name }}</td>
                            <td>
                                {% if session.algorithm == 'grid_search' %}
                                <span class="badge bg-info">Grid Search</span>
                                {% elif session.algorithm == 'random_search' %}
                                <span class="badge bg-primary">Random Search</span>
                                {% elif session.algorithm == 'bayesian_optimization' %}
                                <span class="badge bg-success">Bayesian</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ session.algorithm }}</span>
                                {% endif %}
                            </td>
                            <td>{{ session.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if session.status == 'created' %}
                                <span class="badge bg-info">Sukurta</span>
                                {% elif session.status == 'running' %}
                                <span class="badge bg-primary">Vykdoma</span>
                                {% elif session.status == 'completed' %}
                                <span class="badge bg-success">Užbaigta</span>
                                {% elif session.status == 'failed' %}
                                <span class="badge bg-danger">Nepavyko</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ session.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if session.best_score is not none %}
                                {{ "%.4f"|format(session.best_score) }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ session.trials|length }}</td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('model_training.optimization_session', session_id=session.session_id) }}" 
                                       class="btn btn-sm btn-outline-primary" title="Peržiūrėti">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if session.status == 'completed' %}
                                    <a href="{{ url_for('model_training.apply_best_params', session_id=session.session_id) }}" 
                                       class="btn btn-sm btn-outline-success" title="Pritaikyti parametrus">
                                        <i class="fas fa-check"></i>
                                    </a>
                                    {% endif %}
                                    <a href="{{ url_for('model_training.delete_optimization_session', session_id=session.session_id) }}" 
                                       class="btn btn-sm btn-outline-danger" title="Ištrinti"
                                       onclick="return confirm('Ar tikrai norite ištrinti šią optimizavimo sesiją?');">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nėra optimizavimo sesijų</h5>
                <p class="text-muted">Pasirinkite vieną iš optimizavimo metodų aukščiau, kad pradėtumėte optimizavimą</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Palyginimo modalinis langas -->
    <div class="modal fade" id="compareModal" tabindex="-1" aria-labelledby="compareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="compareModalLabel">Sesijų palyginimas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="compareLoader" class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Kraunama...</span>
                        </div>
                        <p>Ruošiami palyginimo duomenys...</p>
                    </div>
                    <div id="compareContent" style="display: none;">
                        <ul class="nav nav-tabs" id="compareTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="chart-tab" data-bs-toggle="tab" 
                                        data-bs-target="#chart-content" type="button" role="tab">Grafikas</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="table-tab" data-bs-toggle="tab" 
                                        data-bs-target="#table-content" type="button" role="tab">Lentelė</button>
                            </li>
                        </ul>
                        <div class="tab-content mt-3" id="compareTabContent">
                            <div class="tab-pane fade show active" id="chart-content" role="tabpanel">
                                <canvas id="compareChart" width="700" height="400"></canvas>
                            </div>
                            <div class="tab-pane fade" id="table-content" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table" id="compareTable">
                                        <thead>
                                            <tr>
                                                <th>Sesija</th>
                                                <th>Algoritmas</th>
                                                <th>Statusas</th>
                                                <th>Geriausia metrika</th>
                                                <th>Bandymų skaičius</th>
                                            </tr>
                                        </thead>
                                        <tbody id="compareTableBody">
                                            <!-- Duomenys bus įtraukti dinamiškai -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Uždaryti</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript kodas filtravimui ir palyginimui -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filtravimo formos valdymas
        const resetButton = document.getElementById('resetFilters');
        resetButton.addEventListener('click', function() {
            // Nustatome visus filtrus į numatytąsias reikšmes
            document.getElementById('algorithm').value = '';
            document.getElementById('status').value = '';
            document.getElementById('period').value = '';
            document.getElementById('sort').value = 'date_desc';
            
            // Pateikiame formą
            document.getElementById('filterForm').submit();
        });
        
        // Sesijų žymėjimo valdymas
        const selectAllCheckbox = document.getElementById('selectAll');
        const sessionCheckboxes = document.querySelectorAll('.session-checkbox');
        const compareButton = document.getElementById('compareButton');
        
        // Pažymėti/atžymėti visas sesijas
        selectAllCheckbox.addEventListener('change', function() {
            sessionCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            // Atnaujiname palyginimo mygtuko būseną
            updateCompareButtonState();
        });
        
        // Atnaujina palyginimo mygtuko būseną
        function updateCompareButtonState() {
            // Skaičiuojame pažymėtas sesijas
            const checkedCount = Array.from(sessionCheckboxes).filter(checkbox => checkbox.checked).length;
            
            // Mygtuko būsena priklauso nuo pažymėtų sesijų skaičiaus
            if (checkedCount >= 2) {
                compareButton.disabled = false;
            } else {
                compareButton.disabled = true;
            }
        }
        
        // Priskirame įvykio klausytojus sesijų varnelėms
        sessionCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCompareButtonState();
                
                // Jei bent viena sesija atžymėta, atžymime "Pažymėti visus" varnelę
                if (!checkbox.checked) {
                    selectAllCheckbox.checked = false;
                } else {
                    // Tikriname, ar visos sesijos pažymėtos
                    const allChecked = Array.from(sessionCheckboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                }
            });
        });
        
        // Palyginimo mygtuko valdymas
        compareButton.addEventListener('click', function() {
            // Gauname pažymėtų sesijų ID
            const selectedIds = Array.from(sessionCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
            
            if (selectedIds.length < 2) {
                alert('Pasirinkite bent dvi sesijas palyginimui');
                return;
            }
            
            // Atidarome modalinį langą
            const compareModal = new bootstrap.Modal(document.getElementById('compareModal'));
            compareModal.show();
            
            // Rodome įkrovimo animaciją
            document.getElementById('compareLoader').style.display = 'block';
            document.getElementById('compareContent').style.display = 'none';
            
            // Čia būtų kreipimasis į serverį duomenims gauti
            // Šiame pavyzdyje tik simuliuojame duomenų gavimą
            setTimeout(function() {
                // Paslėpiame įkrovimo animaciją
                document.getElementById('compareLoader').style.display = 'none';
                document.getElementById('compareContent').style.display = 'block';
                
                // Šiame pavyzdyje tiesiog rodome pasirinktas sesijas
                // Realiame kode čia būtų serverio atsakymo apdorojimas
                
                // Pavyzdžiui, lentelės pildymas
                const compareTableBody = document.getElementById('compareTableBody');
                compareTableBody.innerHTML = '';
                
                // Čia būtų serverio grąžinti duomenys
                // Šiame pavyzdyje tiesiog simuliuojame sesijų palyginimą
                
                // Grafiko piešimas (pavyzdinis)
                const ctx = document.getElementById('compareChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Sesija 1', 'Sesija 2'],
                        datasets: [{
                            label: 'Geriausia metrika',
                            data: [0.85, 0.82],
                            backgroundColor: ['rgba(54, 162, 235, 0.5)', 'rgba(255, 99, 132, 0.5)'],
                            borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }, 1000);
        });
        
        // Iniciali palyginimo mygtuko būsena
        updateCompareButtonState();
    });
</script>
{% endblock %}