{% extends 'base.html' %}

{% block title %}Modelio architektūros detalės{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/model_visualization.css') }}">
<style>
    .architecture-image-container {
        text-align: center;
        margin: 30px 0;
        padding: 15px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        overflow-x: auto;
    }
    
    .architecture-image {
        max-width: 100%;
        height: auto;
    }
    
    .layers-table {
        margin-top: 30px;
    }
    
    .layer-row {
        transition: background-color 0.2s;
    }
    
    .layer-row:hover {
        background-color: #f8f9fa;
    }
    
    .parameter-count {
        font-weight: bold;
        color: #0d6efd;
    }
    
    .non-trainable {
        color: #6c757d;
    }
    
    .model-summary-card {
        margin-bottom: 30px;
    }
    
    .export-buttons {
        margin-top: 20px;
        margin-bottom: 30px;
    }
    
    .summary-stat {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
        margin-bottom: 15px;
    }
    
    .summary-value {
        font-size: 24px;
        font-weight: bold;
        color: #0d6efd;
    }
    
    .summary-label {
        color: #6c757d;
        font-size: 14px;
    }
    
    .view-selector {
        display: flex;
        margin-bottom: 20px;
    }
    
    .view-option {
        flex: 1;
        text-align: center;
        padding: 10px;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .view-option.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .view-option:first-child {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
    }
    
    .view-option:last-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center my-4">
        <h1>{{ model_name }} architektūra</h1>
        <a href="{{ url_for('model_training.model_architectures') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Grįžti į sąrašą
        </a>
    </div>
    
    {% if model_info and 'error' not in model_info %}
        <!-- Modelio santrauka -->
        <div class="card model-summary-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Modelio santrauka</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="summary-stat">
                            <div class="summary-value">{{ model_info.layers_count }}</div>
                            <div class="summary-label">Sluoksnių skaičius</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-stat">
                            <div class="summary-value">{{ "{:,}".format(model_info.total_params) }}</div>
                            <div class="summary-label">Bendras parametrų skaičius</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-stat">
                            <div class="summary-value">
                                {% set trainable = 0 %}
                                {% for layer in model_info.layers %}
                                    {% if layer.trainable %}
                                        {% set trainable = trainable + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ trainable }}
                            </div>
                            <div class="summary-label">Treniruojami sluoksniai</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Peržiūros tipo pasirinkimas -->
        <div class="view-selector">
            <div class="view-option active" id="option-interactive" onclick="switchView('interactive')">
                <i class="fas fa-project-diagram me-1"></i>Interaktyvi peržiūra
            </div>
            <div class="view-option" id="option-static" onclick="switchView('static')">
                <i class="fas fa-image me-1"></i>Statinis vaizdas
            </div>
            <div class="view-option" id="option-table" onclick="switchView('table')">
                <i class="fas fa-table me-1"></i>Lentelės vaizdas
            </div>
        </div>
        
        <!-- Interaktyvus topologijos peržiūros įrankis -->
        <div id="view-interactive" class="view-content">
            <h3 class="mt-4 mb-3">Interaktyvi modelio architektūra</h3>
            
            <!-- Sluoksnių paieška -->
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="layer-search" placeholder="Ieškoti sluoksnių...">
                    <button class="btn btn-outline-secondary" type="button" id="clear-search-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <small class="form-text text-muted">Galite ieškoti pagal sluoksnio pavadinimą arba tipą</small>
            </div>
            
            <!-- Kontrolės mygtukai -->
            <div class="controls-container">
                <button class="btn btn-outline-primary btn-sm" id="expand-all-btn">
                    <i class="fas fa-expand-arrows-alt me-1"></i>Išplėsti visus
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="collapse-all-btn">
                    <i class="fas fa-compress-arrows-alt me-1"></i>Sutraukti visus
                </button>
                <button class="btn btn-outline-info btn-sm" id="reset-view-btn">
                    <i class="fas fa-sync me-1"></i>Atstatyti vaizdą
                </button>
            </div>
            
            <!-- Interaktyvios vizualizacijos konteineris -->
            <div class="visualization-container">
                <div id="layers-visualization">
                    <!-- Čia bus sukurti sluoksniai JavaScript pagalba -->
                </div>
            </div>
            
            <!-- Detalios informacijos konteineris -->
            <div id="layer-details">
                <!-- Čia bus rodoma detali sluoksnio informacija -->
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    Pasirinkite sluoksnį, kad pamatytumėte detalią informaciją.
                </div>
            </div>
        </div>
        
        <!-- Statinis vaizdas (buvęs originalus) -->
        <div id="view-static" class="view-content" style="display: none;">
            <h3 class="mt-4 mb-3">Vizuali architektūra</h3>
            <div class="architecture-image-container">
                {% if model_visualization and 'error' not in model_visualization %}
                    <img src="data:image/png;base64,{{ model_visualization }}" alt="Modelio architektūra" class="architecture-image">
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Nepavyko sugeneruoti modelio vizualizacijos.
                        {% if model_visualization.error %}
                            Klaida: {{ model_visualization.error }}
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Eksporto mygtukai -->
            <div class="export-buttons text-center">
                <div class="dropdown d-inline-block me-2">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-download me-1"></i>Eksportuoti vaizdą
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                        <li>
                            <a class="dropdown-item" href="{{ url_for('model_training.export_model_architecture', model_name=model_name, format='png') }}">
                                <i class="fas fa-file-image me-1"></i>Atsisiųsti kaip PNG
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('model_training.export_model_architecture', model_name=model_name, format='svg') }}">
                                <i class="fas fa-file-image me-1"></i>Atsisiųsti kaip SVG
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="dropdown d-inline-block">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="exportDataDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-download me-1"></i>Eksportuoti duomenis
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="exportDataDropdown">
                        <li>
                            <a class="dropdown-item" href="{{ url_for('model_training.export_model_summary', model_name=model_name, format='json') }}">
                                <i class="fas fa-file-code me-1"></i>Atsisiųsti kaip JSON
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('model_training.export_model_summary', model_name=model_name, format='csv') }}">
                                <i class="fas fa-file-csv me-1"></i>Atsisiųsti kaip CSV
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Lentelės vaizdas -->
        <div id="view-table" class="view-content" style="display: none;">
            <h3 class="mt-4 mb-3">Sluoksnių informacija</h3>
            <div class="table-responsive layers-table">
                <table class="table table-striped table-bordered">
                    <thead class="table-primary">
                        <tr>
                            <th>#</th>
                            <th>Sluoksnio pavadinimas</th>
                            <th>Tipas</th>
                            <th>Išvesties forma</th>
                            <th>Parametrų skaičius</th>
                            <th>Aktyvacija</th>
                            <th>Treniruojamas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for layer in model_info.layers %}
                        <tr class="layer-row">
                            <td>{{ loop.index }}</td>
                            <td>{{ layer.name }}</td>
                            <td>{{ layer.type }}</td>
                            <td>{{ layer.output_shape }}</td>
                            <td class="parameter-count">{{ "{:,}".format(layer.params) }}</td>
                            <td>{{ layer.activation if 'activation' in layer else '-' }}</td>
                            <td>
                                {% if layer.trainable %}
                                    <span class="badge bg-success">Taip</span>
                                {% else %}
                                    <span class="badge bg-secondary non-trainable">Ne</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
    {% else %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Nepavyko įkelti modelio informacijos.
            {% if model_info.error %}
                Klaida: {{ model_info.error }}
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/model_visualization.js') }}"></script>
<script>
    // Paruošiame modelio sluoksnių informaciją JavaScript objektui
    const modelLayers = [
        {% for layer in model_info.layers %}
        {
            name: "{{ layer.name }}",
            type: "{{ layer.type }}",
            params: {{ layer.params }},
            output_shape: "{{ layer.output_shape }}",
            {% if 'activation' in layer %}
            activation: "{{ layer.activation }}",
            {% endif %}
            trainable: {{ 'true' if layer.trainable else 'false' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Inicializuojame vizualizacijos įrankį, kai dokumentas užkrautas
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializuojame modelio vizualizatorių
        initModelVisualizer(modelLayers);
        
        // Peržiūros tipo perjungimo funkcija
        window.switchView = function(viewType) {
            // Paslepiame visus rodinius
            document.querySelectorAll('.view-content').forEach(el => {
                el.style.display = 'none';
            });
            
            // Nuimame active klasę nuo visų pasirinkimų
            document.querySelectorAll('.view-option').forEach(el => {
                el.classList.remove('active');
            });
            
            // Rodome pasirinktą rodinį
            document.getElementById(`view-${viewType}`).style.display = 'block';
            
            // Pažymime aktyvų pasirinkimą
            document.getElementById(`option-${viewType}`).classList.add('active');
        };
        
        // Pridedame paieškos funkcionalumą
        document.getElementById('layer-search').addEventListener('input', function() {
            const keyword = this.value.trim();
            searchLayers(keyword);
        });
        
        document.getElementById('clear-search-btn').addEventListener('click', function() {
            document.getElementById('layer-search').value = '';
            searchLayers('');
        });
        
        // Pakeiskite mygtukų klausytojus
        document.getElementById('expand-all-btn').addEventListener('click', function() {
            expandAllLayers();
        });
        
        document.getElementById('collapse-all-btn').addEventListener('click', function() {
            collapseAllLayers();
        });
        
        document.getElementById('reset-view-btn').addEventListener('click', function() {
            // Atstatome vaizdą (perkrauname vizualizaciją)
            initModelVisualizer(modelLayers);
        });
    });
</script>
{% endblock %}