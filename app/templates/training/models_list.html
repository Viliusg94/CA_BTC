{% extends "base.html" %}

{% block title %}Modelių sąrašas{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Apmokyti modeliai</h1>
    
    <div class="row mb-3">
        <div class="col-md-6">
            <a href="{{ url_for('model_training.create_model') }}" class="btn btn-primary">Sukurti naują modelį</a>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="bi bi-funnel"></i> Filtruoti
            </button>
        </div>
    </div>
    
    <div class="row">
        {% if models %}
            {% for model in models %}
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ model.name }}</h5>
                            <span class="badge bg-{{ 'success' if model.status == 'active' else 'secondary' }}">
                                {{ model.status }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p><strong>Tipas:</strong> {{ model.type }}</p>
                            <p><strong>Tikslumas:</strong> {{ '%.2f'|format(model.accuracy * 100) }}%</p>
                            <p><strong>Sukurtas:</strong> {{ model.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p><strong>Paskutinį kartą apmokytas:</strong> {{ model.last_trained_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            
                            <div class="mt-3">
                                <button class="btn btn-success btn-sm update-model" data-model-id="{{ model.id }}">
                                    <i class="bi bi-arrow-clockwise"></i> Apmokyti su naujausiais duomenimis
                                </button>
                                <a href="{{ url_for('model_training.view_model', model_id=model.id) }}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-eye"></i> Peržiūrėti
                                </a>
                                <button class="btn btn-danger btn-sm delete-model" data-model-id="{{ model.id }}" data-model-name="{{ model.name }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    Nėra sukurtų modelių. <a href="{{ url_for('model_training.create_model') }}">Sukurkite naują modelį</a>.
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Filtravimo modalinis langas -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filtruoti modelius</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filter-form" method="get">
                    <div class="mb-3">
                        <label for="filter-type" class="form-label">Modelio tipas</label>
                        <select class="form-select" id="filter-type" name="type">
                            <option value="">Visi tipai</option>
                            <option value="lstm">LSTM</option>
                            <option value="gru">GRU</option>
                            <option value="cnn">CNN</option>
                            <option value="transformer">Transformer</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filter-status" class="form-label">Statusas</label>
                        <select class="form-select" id="filter-status" name="status">
                            <option value="">Visi statusai</option>
                            <option value="active">Aktyvus</option>
                            <option value="inactive">Neaktyvus</option>
                            <option value="training">Apmokomas</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filter-accuracy" class="form-label">Minimalus tikslumas (%)</label>
                        <input type="number" class="form-control" id="filter-accuracy" name="min_accuracy" min="0" max="100" step="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Atšaukti</button>
                <button type="button" class="btn btn-primary" id="apply-filter">Taikyti</button>
            </div>
        </div>
    </div>
</div>

<!-- Modalinis langas modelio trynimui patvirtinti -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Patvirtinkite trynimą</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Ar tikrai norite ištrinti modelį <span id="delete-model-name"></span>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Atšaukti</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Ištrinti</button>
            </div>
        </div>
    </div>
</div>

<!-- Modalinis langas apmokymo būsenai -->
<div class="modal fade" id="trainingModal" tabindex="-1" aria-labelledby="trainingModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trainingModalLabel">Modelio apmokymas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="training-progress-container">
                    <p>Apmokomas modelis su naujausiais duomenimis...</p>
                    <div class="progress mb-3">
                        <div id="training-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="training-status">Ruošiami duomenys...</p>
                </div>
                <div id="training-result" style="display: none;">
                    <div class="alert alert-success">
                        Modelis sėkmingai apmokytas su naujausiais duomenimis!
                    </div>
                    <div>
                        <p><strong>Naujas tikslumas:</strong> <span id="new-accuracy"></span>%</p>
                        <p><strong>Pokytis:</strong> <span id="accuracy-change"></span></p>
                        <p><strong>Apmokymo laikas:</strong> <span id="training-time"></span></p>
                    </div>
                </div>
                <div id="training-error" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Uždaryti</button>
                <button type="button" class="btn btn-primary" id="view-updated-model" style="display: none;">Peržiūrėti atnaujintą modelį</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filtravimo funkcionalumas
    document.getElementById('apply-filter').addEventListener('click', function() {
        document.getElementById('filter-form').submit();
    });
    
    // Modelio trynimo funkcionalumas
    let deleteModelId = null;
    
    document.querySelectorAll('.delete-model').forEach(button => {
        button.addEventListener('click', function() {
            const modelId = this.getAttribute('data-model-id');
            const modelName = this.getAttribute('data-model-name');
            
            deleteModelId = modelId;
            document.getElementById('delete-model-name').textContent = modelName;
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        });
    });
    
    document.getElementById('confirm-delete').addEventListener('click', function() {
        if (deleteModelId) {
            window.location.href = `/model-training/delete/${deleteModelId}`;
        }
    });
    
    // Modelio apmokymo su naujais duomenimis funkcionalumas
    document.querySelectorAll('.update-model').forEach(button => {
        button.addEventListener('click', function() {
            const modelId = this.getAttribute('data-model-id');
            
            // Atidaryti apmokymo modalinį langą
            const trainingModal = new bootstrap.Modal(document.getElementById('trainingModal'));
            trainingModal.show();
            
            // Atstatyti modalinį langą į pradinę būseną
            document.getElementById('training-progress-container').style.display = 'block';
            document.getElementById('training-result').style.display = 'none';
            document.getElementById('training-error').style.display = 'none';
            document.getElementById('view-updated-model').style.display = 'none';
            document.getElementById('training-progress-bar').style.width = '0%';
            document.getElementById('training-status').textContent = 'Ruošiami duomenys...';
            
            // Pradėti apmokymo procesą
            fetch(`/model-training/update/${modelId}`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Nepavyko apmokyti modelio');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Sėkmingas apmokymas
                document.getElementById('training-progress-container').style.display = 'none';
                document.getElementById('training-result').style.display = 'block';
                document.getElementById('new-accuracy').textContent = (data.new_accuracy * 100).toFixed(2);
                document.getElementById('accuracy-change').textContent = (data.accuracy_change > 0 ? '+' : '') + 
                    (data.accuracy_change * 100).toFixed(2) + '%';
                document.getElementById('accuracy-change').style.color = data.accuracy_change >= 0 ? 'green' : 'red';
                document.getElementById('training-time').textContent = data.training_time;
                document.getElementById('view-updated-model').style.display = 'block';
                document.getElementById('view-updated-model').setAttribute('data-model-id', modelId);
            })
            .catch(error => {
                // Klaida apmokymo metu
                document.getElementById('training-progress-container').style.display = 'none';
                document.getElementById('training-error').style.display = 'block';
                document.getElementById('training-error').textContent = error.message;
            });
            
            // Simuliuojame progreso juostos animaciją
            let progress = 0;
            const progressInterval = setInterval(function() {
                progress += 5;
                if (progress > 90) {
                    clearInterval(progressInterval);
                }
                document.getElementById('training-progress-bar').style.width = `${progress}%`;
                
                // Atnaujinti statusą pagal progresą
                if (progress <= 20) {
                    document.getElementById('training-status').textContent = 'Ruošiami duomenys...';
                } else if (progress <= 50) {
                    document.getElementById('training-status').textContent = 'Gaunami naujausi duomenys iš Binance...';
                } else if (progress <= 80) {
                    document.getElementById('training-status').textContent = 'Modelis apmokomas...';
                } else {
                    document.getElementById('training-status').textContent = 'Išsaugomi rezultatai...';
                }
            }, 500);
        });
    });
    
    // Peržiūrėti atnaujintą modelį
    document.getElementById('view-updated-model').addEventListener('click', function() {
        const modelId = this.getAttribute('data-model-id');
        window.location.href = `/model-training/view/${modelId}`;
    });
});
</script>
{% endblock %}