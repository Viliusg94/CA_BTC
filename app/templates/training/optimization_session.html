{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Navigacija atgal -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.optimization_index') }}">Hiperparametrų optimizavimas</a></li>
            <li class="breadcrumb-item active">{{ session.name }}</li>
        </ol>
    </nav>

    <!-- Sesijos antraštė -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ session.name }}</h1>
        <div>
            {% if session.status == 'completed' %}
            <div class="btn-group me-2">
                <!-- Pridedame rezultatų eksportavimo mygtuką -->
                <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-download me-2"></i>Eksportuoti
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('model_training.export_optimization_session', session_id=session.session_id, format='json') }}">
                        <i class="fas fa-file-code me-2"></i>JSON formatu
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('model_training.export_optimization_session', session_id=session.session_id, format='csv') }}">
                        <i class="fas fa-file-csv me-2"></i>CSV formatu
                    </a></li>
                </ul>
            </div>
            
            <a href="{{ url_for('model_training.apply_best_params', session_id=session.session_id) }}" class="btn btn-success me-2">
                <i class="fas fa-check me-2"></i>Pritaikyti geriausius parametrus
            </a>
            
            <!-- Pridedame palyginimo mygtuką -->
            <a href="{{ url_for('model_training.compare_sessions') }}?sessions={{ session.session_id }}" class="btn btn-outline-info me-2">
                <i class="fas fa-chart-line me-2"></i>Palyginti
            </a>
            {% endif %}
            
            <!-- Archyvavimo mygtukas -->
            {% if session.status == 'completed' and not session.archived %}
            <a href="{{ url_for('model_training.archive_session', session_id=session.session_id) }}" 
               class="btn btn-outline-secondary me-2"
               onclick="return confirm('Ar tikrai norite archyvuoti šią optimizavimo sesiją?');">
                <i class="fas fa-archive me-2"></i>Archyvuoti
            </a>
            {% elif session.archived %}
            <a href="{{ url_for('model_training.restore_session', session_id=session.session_id) }}" 
               class="btn btn-outline-warning me-2">
                <i class="fas fa-box-open me-2"></i>Atkurti
            </a>
            {% endif %}
            
            <a href="{{ url_for('model_training.delete_optimization_session', session_id=session.session_id) }}" 
               class="btn btn-outline-danger"
               onclick="return confirm('Ar tikrai norite ištrinti šią optimizavimo sesiją?');">
                <i class="fas fa-trash me-2"></i>Ištrinti sesiją
            </a>
        </div>
    </div>
    
    <!-- Sesijos būsenos kortelė -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Sesijos informacija</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">Algoritmas:</dt>
                        <dd class="col-sm-8">
                            {% if session.algorithm == 'grid_search' %}
                                <span class="badge bg-info">Grid Search</span>
                            {% elif session.algorithm == 'random_search' %}
                                <span class="badge bg-primary">Random Search</span>
                            {% elif session.algorithm == 'bayesian_optimization' %}
                                <span class="badge bg-success">Bayesian</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ session.algorithm }}</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Modelio tipas:</dt>
                        <dd class="col-sm-8">{{ session.model_type }}</dd>
                        
                        <dt class="col-sm-4">Sukurta:</dt>
                        <dd class="col-sm-8">{{ session.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                        
                        <dt class="col-sm-4">Atnaujinta:</dt>
                        <dd class="col-sm-8">{{ session.updated_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                        
                        <dt class="col-sm-4">Užbaigta:</dt>
                        <dd class="col-sm-8">
                            {% if session.completed_at %}
                                {{ session.completed_at.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                -
                            {% endif %}
                        </dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">Statusas:</dt>
                        <dd class="col-sm-8">
                            {% if session.status == 'created' %}
                                <span class="badge bg-info">Sukurta</span>
                            {% elif session.status == 'running' %}
                                <span class="badge bg-primary">Vykdoma</span>
                            {% elif session.status == 'completed' %}
                                <span class="badge bg-success">Užbaigta</span>
                            {% elif session.status == 'failed' %}
                                <span class="badge bg-danger">Nepavyko</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ session.status }}</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Bandymai:</dt>
                        <dd class="col-sm-8">{{ session.trials|length }}</dd>
                        
                        <dt class="col-sm-4">Geriausia metrika:</dt>
                        <dd class="col-sm-8">
                            {% if session.best_score is not none %}
                                <span class="text-success fw-bold">{{ "%.4f"|format(session.best_score) }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </dd>
                        
                        <!-- Pridedame unikalių metrikų skaičiavimą -->
                        <dt class="col-sm-4">Unikalių kombinacijų:</dt>
                        <dd class="col-sm-8">{{ session.trials|map(attribute='params')|list|unique|length }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progreso indikatorius, jei sesija dar vykdoma -->
    {% if session.status == 'running' %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Optimizavimo progresas</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <!-- Dinamiškai atsinaujinantis progreso indikatorius -->
                <div class="progress" style="height: 25px;">
                    {% set progress = (session.trials|length / session.parameters.n_iter * 100) if 'n_iter' in session.parameters else 0 %}
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: {{ progress }}%;" 
                         aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                        {{ "%.0f"|format(progress) }}%
                    </div>
                </div>
                <p class="text-center mt-2" id="progressInfo">
                    {{ session.trials|length }} iš {{ session.parameters.n_iter if 'n_iter' in session.parameters else '?' }} bandymų užbaigta
                </p>
            </div>
            
            <!-- Paskutinio bandymo informacija -->
            <div class="alert alert-info">
                <h6 class="mb-2">Paskutinis bandymas:</h6>
                {% if session.trials %}
                    <p class="mb-1"><strong>Bandymo ID:</strong> {{ session.trials[-1].trial_id }}</p>
                    <p class="mb-1"><strong>Rezultatas:</strong> {{ "%.4f"|format(session.trials[-1].score) }}</p>
                    <p class="mb-0"><strong>Laikas:</strong> {{ session.trials[-1].timestamp }}</p>
                {% else %}
                    <p class="mb-0">Dar nėra užbaigtų bandymų.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Geriausių parametrų kortelė -->
    {% if session.best_params %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Geriausi parametrai</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Parametrų reikšmės:</h6>
                    <ul class="list-group">
                        {% for param_name, param_value in session.best_params.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-bold">{{ param_name }}</span>
                            <span>{{ param_value }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Rezultatai:</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Geriausias rezultatas</span>
                            <span class="badge bg-success">{{ "%.4f"|format(session.best_score) }}</span>
                        </li>
                        {% if 'best_metrics' in session %}
                        {% for metric_name, metric_value in session.best_metrics.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-bold">{{ metric_name }}</span>
                            <span>{{ "%.4f"|format(metric_value) if metric_value is number else metric_value }}</span>
                        </li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Optimizavimo rezultatų vizualizacija -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Rezultatų vizualizacija</h5>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="vizTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="convergence-tab" data-bs-toggle="tab" 
                            data-bs-target="#convergence" type="button" role="tab">
                        Konvergavimo grafikas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="params-importance-tab" data-bs-toggle="tab" 
                            data-bs-target="#params-importance" type="button" role="tab">
                        Parametrų svarbumas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="parallel-coords-tab" data-bs-toggle="tab" 
                            data-bs-target="#parallel-coords" type="button" role="tab">
                        Lygiagrečios koordinatės
                    </button>
                </li>
            </ul>
            <div class="tab-content mt-3" id="vizTabContent">
                <!-- Konvergavimo grafikas -->
                <div class="tab-pane fade show active" id="convergence" role="tabpanel">
                    <div class="d-flex justify-content-center">
                        <canvas id="convergenceChart" width="800" height="400"></canvas>
                    </div>
                </div>
                
                <!-- Parametrų svarbumas -->
                <div class="tab-pane fade" id="params-importance" role="tabpanel">
                    <div class="d-flex justify-content-center">
                        <canvas id="importanceChart" width="800" height="400"></canvas>
                    </div>
                </div>
                
                <!-- Lygiagrečios koordinatės -->
                <div class="tab-pane fade" id="parallel-coords" role="tabpanel">
                    <div class="d-flex justify-content-center">
                        <canvas id="parallelCoordsChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bandymų lentelė -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Bandymų rezultatai</h5>
            <div class="input-group" style="width: 300px;">
                <input type="text" id="searchTrials" class="form-control" placeholder="Ieškoti parametrų...">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="trialsTable">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Rezultatas</th>
                            <th>Parametrai</th>
                            <th>Laikas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trial in session.trials|reverse %}
                        <tr {% if session.best_score is not none and trial.score == session.best_score %}class="table-success"{% endif %}>
                            <td>{{ trial.trial_id }}</td>
                            <td>{{ "%.4f"|format(trial.score) }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#params{{ trial.trial_id }}">
                                    Rodyti parametrus
                                </button>
                                <div class="collapse mt-2" id="params{{ trial.trial_id }}">
                                    <div class="card card-body">
                                        <ul class="list-unstyled mb-0">
                                            {% for param_name, param_value in trial.params.items() %}
                                            <li><strong>{{ param_name }}:</strong> {{ param_value }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </td>
                            <td>{{ trial.timestamp }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Automatinis atnaujinimas, kai sesija vis dar vykdoma -->
{% if session.status == 'running' %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Atnaujinimo intervalas milisekundėmis (10 sekundžių)
        const refreshInterval = 10000;
        
        // Funkcija realiu laiku atnaujinimui
        function refreshSession() {
            // Užklausa į serverį, kad gauti naujausius duomenis
            fetch('{{ url_for("model_training.optimization_session_data", session_id=session.session_id) }}')
                .then(response => response.json())
                .then(data => {
                    // Atnaujiname progreso indikatorių
                    const progress = data.trials_count / data.total_trials * 100;
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                    progressBar.textContent = Math.round(progress) + '%';
                    
                    // Atnaujiname progreso informaciją
                    document.getElementById('progressInfo').textContent = 
                        data.trials_count + ' iš ' + data.total_trials + ' bandymų užbaigta';
                    
                    // Tikriname, ar optimizavimas baigtas
                    if (data.status === 'completed') {
                        // Jei baigtas, parodome pranešimą ir perkrauname puslapį
                        showNotification('Optimizavimas baigtas!', 'Rasti geriausi parametrai.');
                        setTimeout(() => { location.reload(); }, 3000);
                    } else if (data.status === 'failed') {
                        // Jei nepavyko, parodome klaidos pranešimą
                        showNotification('Optimizavimas nepavyko!', 'Įvyko klaida vykdant optimizavimą.', 'error');
                        setTimeout(() => { location.reload(); }, 3000);
                    } else {
                        // Jei vis dar vykdoma, nustatome kitą atnaujinimą
                        setTimeout(refreshSession, refreshInterval);
                    }
                })
                .catch(error => {
                    console.error('Klaida atnaujinant duomenis:', error);
                    // Bandome dar kartą po intervalo
                    setTimeout(refreshSession, refreshInterval);
                });
        }
        
        // Funkcija pranešimams rodyti
        function showNotification(title, message, type = 'success') {
            // Sukuriame pranešimo elementą
            const notification = document.createElement('div');
            notification.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'}`;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'assertive');
            notification.setAttribute('aria-atomic', 'true');
            
            notification.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong><br>${message}
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Uždaryti"></button>
                </div>
            `;
            
            // Pridedame pranešimą į konteinerį
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.appendChild(notification);
            document.body.appendChild(container);
            
            // Rodome pranešimą
            const toast = new bootstrap.Toast(notification, { autohide: true, delay: 5000 });
            toast.show();
        }
        
        // Pradedame atnaujinimą
        setTimeout(refreshSession, refreshInterval);
    });
</script>
{% endif %}

<!-- Rezultatų vizualizacijos skriptai -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sesijos duomenys JSON formatu
        const sessionData = {{ session|tojson }};
        
        // Konvergavimo grafiko piešimas, jei yra bandymų
        if (sessionData.trials && sessionData.trials.length > 0) {
            const ctx = document.getElementById('convergenceChart').getContext('2d');
            
            // Paruošiame duomenis
            const trials = sessionData.trials.sort((a, b) => a.trial_id - b.trial_id);
            const trialIds = trials.map(trial => trial.trial_id);
            const scores = trials.map(trial => trial.score);
            
            // Apskaičiuojame geriausius rezultatus iki kiekvieno bandymo
            const bestScores = [];
            let bestScore = -Infinity;
            
            for (const score of scores) {
                if (score > bestScore) {
                    bestScore = score;
                }
                bestScores.push(bestScore);
            }
            
            // Sukuriame grafiką
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trialIds,
                    datasets: [
                        {
                            label: 'Bandymo rezultatas',
                            data: scores,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Geriausias rezultatas',
                            data: bestScores,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Optimizavimo konvergavimas'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bandymo ID'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Rezultatas'
                            }
                        }
                    }
                }
            });
            
            // Parametrų svarbos grafiko piešimas
            if (sessionData.trials.length > 5) {
                const importanceCtx = document.getElementById('importanceChart').getContext('2d');
                
                // Sukaupkime visus unikalius parametrus
                const allParams = new Set();
                for (const trial of trials) {
                    for (const param in trial.params) {
                        allParams.add(param);
                    }
                }
                
                // Apskaičiuojame koreliaciją tarp parametrų ir rezultatų
                // Tai yra supaprastintas parametrų svarbos apskaičiavimas
                const paramNames = [...allParams];
                const importance = [];
                
                for (const param of paramNames) {
                    // Sukaupkime parametrų reikšmes ir atitinkamus rezultatus
                    const paramValues = [];
                    const paramScores = [];
                    
                    for (const trial of trials) {
                        if (param in trial.params) {
                            // Verčiame į skaičių, jei reikšmė yra skaitinė
                            const value = isNaN(trial.params[param]) ? 0 : Number(trial.params[param]);
                            paramValues.push(value);
                            paramScores.push(trial.score);
                        }
                    }
                    
                    // Apskaičiuojame absoliutinę koreliaciją (supaprastintas būdas)
                    let correlation = 0;
                    if (paramValues.length > 1) {
                        // Supaprastintas koreliacijos apskaičiavimas - imama parametro reikšmių dispersija
                        const meanValue = paramValues.reduce((sum, val) => sum + val, 0) / paramValues.length;
                        const meanScore = paramScores.reduce((sum, val) => sum + val, 0) / paramScores.length;
                        
                        let numerator = 0;
                        let denom1 = 0;
                        let denom2 = 0;
                        
                        for (let i = 0; i < paramValues.length; i++) {
                            numerator += (paramValues[i] - meanValue) * (paramScores[i] - meanScore);
                            denom1 += Math.pow(paramValues[i] - meanValue, 2);
                            denom2 += Math.pow(paramScores[i] - meanScore, 2);
                        }
                        
                        if (denom1 > 0 && denom2 > 0) {
                            correlation = Math.abs(numerator / Math.sqrt(denom1 * denom2));
                        }
                    }
                    
                    importance.push(correlation);
                }
                
                // Sukuriame grafiką
                new Chart(importanceCtx, {
                    type: 'bar',
                    data: {
                        labels: paramNames,
                        datasets: [{
                            label: 'Parametrų svarbumas',
                            data: importance,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Parametrų svarbumas'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Svarbos įvertis'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Paieška bandymų lentelėje
        const searchInput = document.getElementById('searchTrials');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                const rows = document.querySelectorAll('#trialsTable tbody tr');
                
                rows.forEach(row => {
                    const paramTexts = row.querySelectorAll('.card-body ul li');
                    let found = false;
                    
                    paramTexts.forEach(param => {
                        if (param.textContent.toLowerCase().includes(searchText)) {
                            found = true;
                        }
                    });
                    
                    if (found || searchText === '') {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
    });
</script>
{% endblock %}

