{% extends "base.html" %}

{% block title %}Modelio validavimo grafikas - BTC Prekybos Sistema{% endblock %}

{% block styles %}
<style>
    /* Pagrindinės konteinerio stilius */
    .validation-container {
        margin-top: 20px;
    }
    
    /* Modelio pasirinkimo kortelės stilius */
    .model-selection-card {
        margin-bottom: 20px;
    }
    
    /* Grafiko konteinerio stilius */
    .chart-container {
        height: 400px;
        margin-bottom: 30px;
        position: relative;
    }
    
    /* Metrikų pasirinkimo mygtukai */
    .metric-button {
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    /* Metrikų lentelės stilius */
    .metrics-table th {
        width: 25%;
    }
    
    /* Modelių palyginimo konteineriui */
    .comparison-container {
        margin-top: 20px;
        border-top: 1px solid #dee2e6;
        padding-top: 20px;
    }
    
    /* Early stopping taško žymėjimas */
    .early-stopping-point {
        background-color: rgba(255, 99, 132, 0.3);
        border-left: 2px dashed #ff6384;
        padding-left: 10px;
        padding-right: 10px;
        margin-top: 10px;
    }
    
    /* Modelių spalvų legenda */
    .model-legend {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    
    .model-legend-item {
        display: flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 5px;
    }
    
    .color-box {
        width: 15px;
        height: 15px;
        margin-right: 5px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Modelio validavimo grafikas</h1>
            <p class="text-muted">Stebėkite ir analizuokite modelio mokymo ir validavimo metrikas</p>
        </div>
    </div>
    
    <!-- Modelio pasirinkimo forma -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card model-selection-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Pasirinkite modelį</h5>
                </div>
                <div class="card-body">
                    <form id="modelSelectForm" method="GET" action="{{ url_for('training.validation_graph') }}">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="model_id" class="form-label">Modelis:</label>
                                    <select class="form-select" id="model_id" name="model_id">
                                        <option value="">-- Pasirinkite modelį --</option>
                                        {% for model in models %}
                                            <option value="{{ model.filename }}" {% if selected_model and selected_model.filename == model.filename %}selected{% endif %}>
                                                {{ model.name }} ({{ model.created_at }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <div class="d-grid w-100">
                                    <button type="submit" class="btn btn-primary">Rodyti validavimo grafiką</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    {% if selected_model %}
    <div class="validation-container">
        <!-- Grafiko valdymo mygtukai -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Grafiko nustatymai</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Metrikų pasirinkimai -->
                            <div class="col-md-6">
                                <h6>Pasirinkite metrikas:</h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary metric-button active" data-metric="loss">
                                        Mokymo klaida (Loss)
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary metric-button active" data-metric="val_loss">
                                        Validavimo klaida (Val Loss)
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary metric-button" data-metric="mae">
                                        MAE
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary metric-button" data-metric="val_mae">
                                        Val MAE
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Grafiko tipas -->
                            <div class="col-md-6">
                                <h6>Grafiko tipas:</h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-dark active" id="linearScale">
                                        Tiesinė skalė
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-dark" id="logScale">
                                        Logaritminė skalė
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pagrindinis validavimo grafikas -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Modelio metrikos per epochas</h5>
                        <button class="btn btn-sm btn-outline-secondary" id="downloadChartBtn">
                            <i class="fas fa-download"></i> Atsisiųsti grafiką
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="validationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Metrikų lentelė -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Metrikų reikšmės</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered metrics-table">
                                <thead>
                                    <tr>
                                        <th>Metrika</th>
                                        <th>Pradinė reikšmė</th>
                                        <th>Galutinė reikšmė</th>
                                        <th>Pagerėjimas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Mokymo klaida (Loss)</td>
                                        <td>{{ "%.6f"|format(metrics.loss[0]) }}</td>
                                        <td>{{ "%.6f"|format(metrics.loss[-1]) }}</td>
                                        <td>
                                            {% set improvement = ((metrics.loss[0] - metrics.loss[-1]) / metrics.loss[0] * 100) %}
                                            <span class="{% if improvement > 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ "%.2f"|format(improvement) }}%
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Validavimo klaida (Val Loss)</td>
                                        <td>{{ "%.6f"|format(metrics.val_loss[0]) }}</td>
                                        <td>{{ "%.6f"|format(metrics.val_loss[-1]) }}</td>
                                        <td>
                                            {% set improvement = ((metrics.val_loss[0] - metrics.val_loss[-1]) / metrics.val_loss[0] * 100) %}
                                            <span class="{% if improvement > 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ "%.2f"|format(improvement) }}%
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>MAE</td>
                                        <td>{{ "%.6f"|format(metrics.mae[0]) }}</td>
                                        <td>{{ "%.6f"|format(metrics.mae[-1]) }}</td>
                                        <td>
                                            {% set improvement = ((metrics.mae[0] - metrics.mae[-1]) / metrics.mae[0] * 100) %}
                                            <span class="{% if improvement > 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ "%.2f"|format(improvement) }}%
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Validavimo MAE</td>
                                        <td>{{ "%.6f"|format(metrics.val_mae[0]) }}</td>
                                        <td>{{ "%.6f"|format(metrics.val_mae[-1]) }}</td>
                                        <td>
                                            {% set improvement = ((metrics.val_mae[0] - metrics.val_mae[-1]) / metrics.val_mae[0] * 100) %}
                                            <span class="{% if improvement > 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ "%.2f"|format(improvement) }}%
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Early stopping informacija, jei ji yra -->
                        {% if early_stopping %}
                        <div class="early-stopping-point mt-3">
                            <h6><i class="fas fa-hand-paper"></i> Ankstyvasis sustojimas</h6>
                            <p>Mokymas sustojo po {{ early_stopping.epoch }} epochų, nes validavimo metrika negerėjo per {{ early_stopping.patience }} epochas.</p>
                            <p>Geriausia validavimo reikšmė: <strong>{{ "%.6f"|format(early_stopping.best_value) }}</strong> (epocha {{ early_stopping.best_epoch }})</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modelių palyginimo dalis -->
    <div class="comparison-container">
        <div class="row mb-3">
            <div class="col-12">
                <h3>Modelių palyginimas</h3>
                <p class="text-muted">Palyginkite dabartinį modelį su kitais modeliais</p>
            </div>
        </div>
        
        <!-- Modelių pasirinkimas palyginimui -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Pasirinkite modelius palyginimui</h5>
                    </div>
                    <div class="card-body">
                        <form id="comparisonForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="compareModelSelect">
                                        <option value="">-- Pasirinkite modelį --</option>
                                        {% for model in models %}
                                            {% if selected_model and model.filename != selected_model.filename %}
                                            <option value="{{ model.filename }}">
                                                {{ model.name }} ({{ model.created_at }})
                                            </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-primary" id="addCompareModelBtn">
                                        <i class="fas fa-plus"></i> Pridėti modelį
                                    </button>
                                </div>
                            </div>
                            
                            <div id="selectedModelsContainer">
                                <!-- Čia bus rodomi pasirinkti modeliai -->
                                <div class="selected-model-item" data-model="{{ selected_model.filename }}">
                                    <span class="badge bg-primary">{{ selected_model.name }} (Dabartinis)</span>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                <button type="button" class="btn btn-success" id="compareModelsBtn" {% if models|length < 2 %}disabled{% endif %}>
                                    Palyginti metrikas
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Palyginimo grafikas -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Modelių palyginimas</h5>
                    </div>
                    <div class="card-body">
                        <!-- Modelių legenda -->
                        <div class="model-legend" id="modelLegend">
                            <!-- Legendos elementai bus pridėti per JavaScript -->
                        </div>
                        
                        <!-- Metrikos pasirinkimas palyginimui -->
                        <div class="mb-3">
                            <label for="compareMetricSelect" class="form-label">Pasirinkite metriką palyginimui:</label>
                            <select class="form-select" id="compareMetricSelect">
                                <option value="val_loss" selected>Validavimo klaida (Val Loss)</option>
                                <option value="loss">Mokymo klaida (Loss)</option>
                                <option value="val_mae">Validavimo MAE</option>
                                <option value="mae">MAE</option>
                            </select>
                        </div>
                        
                        <!-- Palyginimo grafikas -->
                        <div class="chart-container">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Automatiškai pateikti formą, kai pasirenkamas modelis
        document.getElementById('model_id').addEventListener('change', function() {
            if (this.value) {
                document.getElementById('modelSelectForm').submit();
            }
        });
        
        {% if selected_model %}
        // Metrikos duomenys iš serverio
        const metrics = {
            loss: {{ metrics.loss|tojson }},
            val_loss: {{ metrics.val_loss|tojson }},
            mae: {{ metrics.mae|tojson }},
            val_mae: {{ metrics.val_mae|tojson }}
        };
        
        // Spalvos metrikoms
        const metricColors = {
            loss: 'rgb(54, 162, 235)',        // mėlyna
            val_loss: 'rgb(255, 99, 132)',    // raudona
            mae: 'rgb(75, 192, 192)',         // žalia
            val_mae: 'rgb(255, 159, 64)'      // oranžinė
        };
        
        // Rodomos metrikos
        let visibleMetrics = ['loss', 'val_loss'];
        
        // Epochų numeriai X ašiai
        const epochs = Array.from({length: metrics.loss.length}, (_, i) => i + 1);
        
        // Kuriame validavimo grafiką
        const validationChart = new Chart(
            document.getElementById('validationChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: epochs,
                    datasets: [
                        {
                            label: 'Mokymo klaida (Loss)',
                            data: metrics.loss,
                            borderColor: metricColors.loss,
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Validavimo klaida (Val Loss)',
                            data: metrics.val_loss,
                            borderColor: metricColors.val_loss,
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Epocha'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Reikšmė'
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            }
        );
        
        // Pažymime early stopping tašką, jei jis yra
        {% if early_stopping %}
        const earlyStoppingLine = {
            id: 'earlyStoppingLine',
            beforeDraw: function(chart) {
                if (chart.tooltip._active && chart.tooltip._active.length) {
                    return;
                }
                
                const ctx = chart.ctx;
                const earlyStoppingEpoch = {{ early_stopping.best_epoch }};
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;
                const x = xAxis.getPixelForValue(earlyStoppingEpoch);
                
                // Braižome vertikalią liniją
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x, yAxis.top);
                ctx.lineTo(x, yAxis.bottom);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                
                // Pridedame tekstą
                ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
                ctx.fillText('Early stopping', x + 5, yAxis.top + 15);
                ctx.restore();
            }
        };
        
        validationChart.options.plugins.annotation = {
            annotations: {
                earlyStoppingLine: {
                    type: 'line',
                    xMin: {{ early_stopping.best_epoch }},
                    xMax: {{ early_stopping.best_epoch }},
                    borderColor: 'rgba(255, 0, 0, 0.5)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                        content: 'Ankstyvasis sustojimas',
                        enabled: true,
                        position: 'top'
                    }
                }
            }
        };
        
        validationChart.update();
        {% endif %}
        
        // Metrikų mygtukų valdymas
        document.querySelectorAll('.metric-button').forEach(button => {
            button.addEventListener('click', function() {
                const metric = this.getAttribute('data-metric');
                this.classList.toggle('active');
                
                if (this.classList.contains('active')) {
                    // Pridėti metriką
                    if (!visibleMetrics.includes(metric)) {
                        visibleMetrics.push(metric);
                        
                        // Pridėti naują duomenų rinkinį
                        validationChart.data.datasets.push({
                            label: getMetricLabel(metric),
                            data: metrics[metric],
                            borderColor: metricColors[metric],
                            backgroundColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        });
                    }
                } else {
                    // Pašalinti metriką
                    const index = visibleMetrics.indexOf(metric);
                    if (index > -1) {
                        visibleMetrics.splice(index, 1);
                        
                        // Pašalinti duomenų rinkinį
                        validationChart.data.datasets = validationChart.data.datasets.filter(
                            dataset => dataset.label !== getMetricLabel(metric)
                        );
                    }
                }
                
                validationChart.update();
            });
        });
        
        // Grafikų skalės keitimas
        document.getElementById('linearScale').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('logScale').classList.remove('active');
            
            validationChart.options.scales.y.type = 'linear';
            validationChart.update();
        });
        
        document.getElementById('logScale').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('linearScale').classList.remove('active');
            
            validationChart.options.scales.y.type = 'logarithmic';
            validationChart.update();
        });
        
        // Atsisiųsti grafiką
        document.getElementById('downloadChartBtn').addEventListener('click', function() {
            const canvas = document.getElementById('validationChart');
            const dataURL = canvas.toDataURL('image/png');
            
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = '{{ selected_model.name }}_validation_chart.png';
            link.click();
        });
        
        // Funkcija metrikos pavadinimui gauti
        function getMetricLabel(metric) {
            switch(metric) {
                case 'loss': return 'Mokymo klaida (Loss)';
                case 'val_loss': return 'Validavimo klaida (Val Loss)';
                case 'mae': return 'MAE';
                case 'val_mae': return 'Val MAE';
                default: return metric;
            }
        }
        
        // Modelių palyginimo dalis
        
        // Modelių spalvos
        const modelColors = [
            'rgb(54, 162, 235)',   // mėlyna
            'rgb(255, 99, 132)',   // raudona
            'rgb(75, 192, 192)',   // žalia
            'rgb(255, 159, 64)',   // oranžinė
            'rgb(153, 102, 255)',  // violetinė
            'rgb(255, 205, 86)',   // geltona
            'rgb(201, 203, 207)'   // pilka
        ];
        
        // Pasirinktų modelių sąrašas palyginimui (pradiniu momentu tik dabartinis modelis)
        let selectedModels = [{
            id: '{{ selected_model.filename }}',
            name: '{{ selected_model.name }}',
            color: modelColors[0],
            metrics: metrics
        }];
        
        // Atnaujinti pasirinktų modelių sąrašą
        function updateSelectedModelsList() {
            const container = document.getElementById('selectedModelsContainer');
            container.innerHTML = '';
            
            selectedModels.forEach((model, index) => {
                const modelElement = document.createElement('div');
                modelElement.className = 'badge bg-primary m-1 p-2';
                modelElement.style.backgroundColor = model.color;
                
                if (index === 0) {
                    modelElement.textContent = `${model.name} (Dabartinis)`;
                } else {
                    modelElement.textContent = model.name;
                    
                    // Pridedame šalinimo mygtuką
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn-close btn-close-white ms-2';
                    removeBtn.setAttribute('type', 'button');
                    removeBtn.setAttribute('aria-label', 'Close');
                    removeBtn.style.fontSize = '0.5rem';
                    
                    removeBtn.addEventListener('click', function() {
                        // Pašaliname modelį iš sąrašo
                        selectedModels = selectedModels.filter(m => m.id !== model.id);
                        updateSelectedModelsList();
                        updateComparisonChart();
                    });
                    
                    modelElement.appendChild(removeBtn);
                }
                
                container.appendChild(modelElement);
            });
            
            // Atnaujiname modelių legendą
            updateModelLegend();
        }
        
        // Pridėti naują modelį palyginimui
        document.getElementById('addCompareModelBtn').addEventListener('click', function() {
            const select = document.getElementById('compareModelSelect');
            const modelId = select.value;
            
            if (!modelId) {
                alert('Prašome pasirinkti modelį');
                return;
            }
            
            // Patikriname, ar šis modelis jau pridėtas
            if (selectedModels.some(model => model.id === modelId)) {
                alert('Šis modelis jau pridėtas palyginimui');
                return;
            }
            
            // Gauname modelio duomenis
            fetch(`/api/model/${modelId}/metrics`)
                .then(response => response.json())
                .then(data => {
                    // Pridedame modelį į sąrašą
                    selectedModels.push({
                        id: modelId,
                        name: data.name,
                        color: modelColors[selectedModels.length % modelColors.length],
                        metrics: data.metrics
                    });
                    
                    // Atnaujiname sąrašą
                    updateSelectedModelsList();
                    
                    // Atnaujiname grafiką
                    updateComparisonChart();
                    
                    // Išvalome pasirinkimą
                    select.value = '';
                })
                .catch(error => {
                    console.error('Klaida gaunant modelio duomenis:', error);
                    alert('Nepavyko gauti modelio duomenų');
                });
        });
        
        // Atnaujinti palyginimo grafiką
        function updateComparisonChart() {
            const metric = document.getElementById('compareMetricSelect').value;
            
            // Jei grafikas jau egzistuoja, sunaikinti jį
            if (window.comparisonChart) {
                window.comparisonChart.destroy();
            }
            
            // Sukuriame duomenų rinkinius kiekvienam modeliui
            const datasets = selectedModels.map((model, index) => {
                return {
                    label: model.name,
                    data: model.metrics[metric],
                    borderColor: model.color,
                    backgroundColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                };
            });
            
            // Sukuriame naują grafiką
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            window.comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: epochs,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Epocha'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: getMetricLabel(metric)
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }
        
        // Atnaujinti modelių legendą
        function updateModelLegend() {
            const legendContainer = document.getElementById('modelLegend');
            legendContainer.innerHTML = '';
            
            selectedModels.forEach(model => {
                const legendItem = document.createElement('div');
                legendItem.className = 'model-legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'color-box';
                colorBox.style.backgroundColor = model.color;
                
                const nameText = document.createElement('div');
                nameText.textContent = model.name;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(nameText);
                legendContainer.appendChild(legendItem);
            });
        }
        
        // Pasirinktos metrikos keitimas palyginimui
        document.getElementById('compareMetricSelect').addEventListener('change', function() {
            updateComparisonChart();
        });
        
        // Modelių palyginimo mygtuko valdymas
        document.getElementById('compareModelsBtn').addEventListener('click', function() {
            updateComparisonChart();
        });
        
        // Inicializuojame modelių sąrašą
        updateSelectedModelsList();
        
        // Inicializuojame palyginimo grafiką
        updateComparisonChart();
        {% endif %}
    });
</script>
{% endblock %}