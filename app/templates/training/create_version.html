{% extends "base.html" %}

{% block title %}Nauja modelio versija{% endblock %}

{% block styles %}
<style>
    .version-header {
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }
    
    .parent-model-info {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .parameter-section {
        margin-bottom: 30px;
    }
    
    .parameter-card {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .original-value {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Navigacijos kelias -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.index') }}">Pagrindinis</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_history') }}">Modelių istorija</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.view_model', training_id=model.training_id) }}">{{ model.name }}</a></li>
            <li class="breadcrumb-item active">Nauja versija</li>
        </ol>
    </nav>

    <!-- Puslapio antraštė -->
    <div class="version-header">
        <h1>Sukurti naują modelio versiją</h1>
        <p class="text-muted">Sukurkite naują modelio versiją su modifikuotais parametrais, išsaugant originalaus modelio architektūrą.</p>
    </div>

    <!-- Tėvinio modelio informacija -->
    <div class="parent-model-info">
        <h5>Tėvinis modelis: {{ model.name }}</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-2"><strong>Tipas:</strong> {{ model.type|upper }}</div>
                <div class="mb-2"><strong>Sukurtas:</strong> {{ model.created_at }}</div>
            </div>
            <div class="col-md-6">
                <div class="mb-2"><strong>ID:</strong> {{ model.training_id }}</div>
                {% if model.parent_id %}
                <div class="mb-2"><strong>Tėvinio modelio ID:</strong> {{ model.parent_id }}</div>
                {% endif %}
            </div>
        </div>
        {% if model.description %}
        <div class="mt-2"><strong>Aprašymas:</strong> {{ model.description }}</div>
        {% endif %}
    </div>

    <!-- Versijos kūrimo forma -->
    <form method="post" action="{{ url_for('model_training.create_model_version', training_id=model.training_id) }}">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Naujos versijos informacija</h5>
            </div>
            <div class="card-body">
                <!-- Versijos pavadinimas -->
                <div class="mb-3">
                    <label for="name" class="form-label">Versijos pavadinimas</label>
                    <input type="text" class="form-control" id="name" name="name" value="{{ model.name }} v2" required>
                    <div class="form-text">Palikite numatytąjį pavadinimą arba įveskite savo.</div>
                </div>

                <!-- Versijos aprašymas -->
                <div class="mb-3">
                    <label for="description" class="form-label">Aprašymas</label>
                    <textarea class="form-control" id="description" name="description" rows="3">{{ model.description }}</textarea>
                    <div class="form-text">Aprašykite, kuo ši versija skiriasi nuo tėvinio modelio.</div>
                </div>
            </div>
        </div>

        <!-- Modelio parametrai -->
        <div class="parameter-section">
            <h3>Modelio parametrai</h3>
            <p class="text-muted">Modifikuokite parametrus, kuriuos norite pakeisti naujoje versijoje.</p>

            <!-- Bendri parametrai -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Bendri parametrai</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Epochų skaičius -->
                        <div class="col-md-6 mb-3">
                            <label for="param_epochs" class="form-label">Epochų skaičius</label>
                            <input type="number" class="form-control" id="param_epochs" name="param_epochs" 
                                   value="{{ model.parameters.epochs }}" min="1" max="1000">
                            <div class="original-value">Originali reikšmė: {{ model.parameters.epochs }}</div>
                        </div>

                        <!-- Batch dydis -->
                        <div class="col-md-6 mb-3">
                            <label for="param_batch_size" class="form-label">Batch dydis</label>
                            <input type="number" class="form-control" id="param_batch_size" name="param_batch_size" 
                                   value="{{ model.parameters.batch_size }}" min="1" max="512">
                            <div class="original-value">Originali reikšmė: {{ model.parameters.batch_size }}</div>
                        </div>

                        <!-- Learning rate -->
                        <div class="col-md-6 mb-3">
                            <label for="param_learning_rate" class="form-label">Mokymosi sparta (Learning Rate)</label>
                            <input type="number" class="form-control" id="param_learning_rate" name="param_learning_rate" 
                                   value="{{ model.parameters.learning_rate }}" min="0.00001" max="1" step="0.0001">
                            <div class="original-value">Originali reikšmė: {{ model.parameters.learning_rate }}</div>
                        </div>

                        <!-- Dropout -->
                        <div class="col-md-6 mb-3">
                            <label for="param_dropout" class="form-label">Dropout</label>
                            <input type="number" class="form-control" id="param_dropout" name="param_dropout" 
                                   value="{{ model.parameters.dropout }}" min="0" max="0.9" step="0.1">
                            <div class="original-value">Originali reikšmė: {{ model.parameters.dropout }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Architektūros parametrai -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Architektūros parametrai</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Sluoksnių skaičius -->
                        <div class="col-md-6 mb-3">
                            <label for="param_layers" class="form-label">Sluoksnių skaičius</label>
                            <input type="number" class="form-control" id="param_layers" name="param_layers" 
                                   value="{{ model.parameters.layers }}" min="1" max="10">
                            <div class="original-value">Originali reikšmė: {{ model.parameters.layers }}</div>
                        </div>

                        <!-- Neuronų skaičius -->
                        <div class="col-md-6 mb-3">
                            <label for="param_neurons" class="form-label">Neuronų skaičius</label>
                            <input type="number" class="form-control" id="param_neurons" name="param_neurons" 
                                   value="{{ model.parameters.neurons }}" min="1" max="512">
                            <div class="original-value">Originali reikšmė: {{ model.parameters.neurons }}</div>
                        </div>

                        <!-- Modelio tipo specifiniai parametrai -->
                        {% if model.type == 'lstm' %}
                        <div class="col-md-6 mb-3">
                            <label for="param_bidirectional" class="form-label">Bidirectional</label>
                            <select class="form-select" id="param_bidirectional" name="param_bidirectional">
                                <option value="true" {% if model.parameters.specific.bidirectional %}selected{% endif %}>Taip</option>
                                <option value="false" {% if not model.parameters.specific.bidirectional %}selected{% endif %}>Ne</option>
                            </select>
                            <div class="original-value">Originali reikšmė: {% if model.parameters.specific.bidirectional %}Taip{% else %}Ne{% endif %}</div>
                        </div>
                        {% elif model.type == 'cnn' %}
                        <div class="col-md-6 mb-3">
                            <label for="param_kernel_size" class="form-label">Branduolio dydis</label>
                            <select class="form-select" id="param_kernel_size" name="param_kernel_size">
                                <option value="3" {% if model.parameters.specific.kernel_size == 3 %}selected{% endif %}>3</option>
                                <option value="5" {% if model.parameters.specific.kernel_size == 5 %}selected{% endif %}>5</option>
                                <option value="7" {% if model.parameters.specific.kernel_size == 7 %}selected{% endif %}>7</option>
                            </select>
                            <div class="original-value">Originali reikšmė: {{ model.parameters.specific.kernel_size }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Mygtukų sekcija -->
        <div class="row">
            <div class="col-12 text-end mb-5">
                <a href="{{ url_for('model_training.view_model', training_id=model.training_id) }}" class="btn btn-secondary me-2">Atšaukti</a>
                <button type="submit" class="btn btn-primary">Sukurti naują versiją</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Pažymime parametrų laukus, kurie buvo pakeisti
document.addEventListener('DOMContentLoaded', function() {
    // Funkcija, kuri įvertina, ar reikšmė buvo pakeista
    function highlightChanges(inputField, originalValue) {
        inputField.addEventListener('input', function() {
            const currentValue = inputField.value;
            
            // Jei reikšmė skiriasi nuo pradinės
            if (currentValue != originalValue) {
                inputField.classList.add('border-primary');
                inputField.parentElement.classList.add('bg-light');
            } else {
                inputField.classList.remove('border-primary');
                inputField.parentElement.classList.remove('bg-light');
            }
        });
    }
    
    // Gauname visus įvesties laukus su originalių reikšmių informacija
    const paramInputs = document.querySelectorAll('input[id^="param_"], select[id^="param_"]');
    
    paramInputs.forEach(function(input) {
        // Randame originalią reikšmę iš teksto elemento
        const originalValueText = input.parentElement.querySelector('.original-value');
        if (originalValueText) {
            const originalText = originalValueText.textContent;
            const originalValue = originalText.replace('Originali reikšmė: ', '');
            
            // Pažymime pakeitimus
            highlightChanges(input, originalValue);
        }
    });
});
</script>
{% endblock %}