{% extends "base.html" %}

{% block title %}Treniravimo sesijų istorija - BTC Prekybos Sistema{% endblock %}

{% block styles %}
<style>
    .filter-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .session-card {
        margin-bottom: 15px;
        transition: transform 0.2s;
    }
    
    .session-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .status-completed {
        background-color: #28a745;
    }
    
    .status-failed {
        background-color: #dc3545;
    }
    
    .status-running {
        background-color: #17a2b8;
    }
    
    .status-canceled {
        background-color: #6c757d;
    }
    
    .metrics-value {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .metrics-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .chart-container {
        height: 300px;
        margin-bottom: 20px;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    
    .session-date {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .model-badge {
        font-size: 0.8rem;
        padding: 3px 8px;
    }
    
    .clear-filters {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Treniravimo sesijų istorija</h1>
            <p class="text-muted">Peržiūrėkite ankstesnių treniravimo sesijų rezultatus ir tendencijas</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3">
            <!-- Filtravimo juosta -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Filtrai</h5>
                </div>
                <div class="card-body">
                    <form id="filterForm" method="get">
                        <div class="mb-3">
                            <label for="statusFilter" class="form-label">Statusas:</label>
                            <select class="form-select" id="statusFilter" name="status">
                                <option value="">Visi</option>
                                <option value="completed" {% if filters.status == 'completed' %}selected{% endif %}>Baigti</option>
                                <option value="running" {% if filters.status == 'running' %}selected{% endif %}>Vyksta</option>
                                <option value="failed" {% if filters.status == 'failed' %}selected{% endif %}>Nepavyko</option>
                                <option value="canceled" {% if filters.status == 'canceled' %}selected{% endif %}>Atšaukti</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modelTypeFilter" class="form-label">Modelio tipas:</label>
                            <select class="form-select" id="modelTypeFilter" name="model_type">
                                <option value="">Visi</option>
                                <option value="LSTM" {% if filters.model_type == 'LSTM' %}selected{% endif %}>LSTM</option>
                                <option value="GRU" {% if filters.model_type == 'GRU' %}selected{% endif %}>GRU</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateFilter" class="form-label">Laikotarpis:</label>
                            <select class="form-select" id="dateFilter" name="date_range">
                                <option value="">Visi</option>
                                <option value="today" {% if filters.date_range == 'today' %}selected{% endif %}>Šiandien</option>
                                <option value="week" {% if filters.date_range == 'week' %}selected{% endif %}>Šią savaitę</option>
                                <option value="month" {% if filters.date_range == 'month' %}selected{% endif %}>Šį mėnesį</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sortBy" class="form-label">Rikiuoti pagal:</label>
                            <select class="form-select" id="sortBy" name="sort_by">
                                <option value="date_desc" {% if filters.sort_by == 'date_desc' %}selected{% endif %}>Naujausi viršuje</option>
                                <option value="date_asc" {% if filters.sort_by == 'date_asc' %}selected{% endif %}>Seniausi viršuje</option>
                                <option value="val_loss" {% if filters.sort_by == 'val_loss' %}selected{% endif %}>Geriausias val. nuostolis</option>
                                <option value="val_mae" {% if filters.sort_by == 'val_mae' %}selected{% endif %}>Geriausias val. MAE</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Filtruoti</button>
                        <a href="{{ url_for('training.sessions') }}" class="btn btn-outline-secondary w-100 clear-filters mt-2">Išvalyti filtrus</a>
                    </form>
                </div>
            </div>
            
            <!-- Statistikos kortelė -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Bendra statistika</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="metrics-label">Iš viso sesijų</div>
                            <div class="metrics-value">{{ stats.total_sessions }}</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="metrics-label">Šiandien</div>
                            <div class="metrics-value">{{ stats.today_sessions }}</div>
                        </div>
                        <div class="col-6">
                            <div class="metrics-label">Sėkmingos</div>
                            <div class="metrics-value">{{ stats.completed_sessions }}</div>
                        </div>
                        <div class="col-6">
                            <div class="metrics-label">Nepavykusios</div>
                            <div class="metrics-value">{{ stats.failed_sessions }}</div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="metrics-label mb-2">Populiariausi modelių tipai:</div>
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: {{ stats.model_types.LSTM.percentage }}%;" 
                             aria-valuenow="{{ stats.model_types.LSTM.count }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ stats.total_sessions }}">
                            LSTM ({{ stats.model_types.LSTM.count }})
                        </div>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ stats.model_types.GRU.percentage }}%;" 
                             aria-valuenow="{{ stats.model_types.GRU.count }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ stats.total_sessions }}">
                            GRU ({{ stats.model_types.GRU.count }})
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <!-- Metrikų evoliucijos grafikas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Metrikų evoliucija per laiką</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="metricsEvolutionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Sesijų sąrašas -->
            <h5>Sesijų sąrašas ({{ sessions|length }} iš {{ total_sessions }})</h5>
            
            <div class="sessions-list">
                {% if sessions %}
                    {% for session in sessions %}
                    <div class="card session-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title">
                                        <span class="status-indicator status-{{ session.status|lower }}"></span>
                                        {{ session.model_name }}
                                    </h5>
                                    <p class="card-text session-date">
                                        Pradėta: {{ session.start_time }}
                                        {% if session.end_time %}
                                        | Baigta: {{ session.end_time }}
                                        {% endif %}
                                    </p>
                                    <p class="mb-2">
                                        <span class="badge bg-primary model-badge">{{ session.parameters.model_type }}</span>
                                        <span class="badge bg-secondary model-badge">{{ session.parameters.layers }} sluoksniai</span>
                                        <span class="badge bg-info model-badge">{{ session.parameters.units }} neuronai</span>
                                        <span class="badge bg-dark model-badge">{{ session.parameters.epochs }} epochos</span>
                                    </p>
                                    
                                    <a href="{{ url_for('training.session_details', session_id=session.training_id) }}" class="btn btn-sm btn-outline-primary">Peržiūrėti detales</a>
                                    
                                    {% if session.model_filename %}
                                    <a href="{{ url_for('training.model_details', filename=session.model_filename) }}" class="btn btn-sm btn-outline-success">Modelio detalės</a>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="metrics-label">Val. nuostolis</div>
                                            <div class="metrics-value {% if session.final_metrics.val_loss < 0.01 %}text-success{% endif %}">
                                                {{ '%.4f'|format(session.final_metrics.val_loss|default(0)) }}
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="metrics-label">Val. MAE</div>
                                            <div class="metrics-value {% if session.final_metrics.val_mae < 0.01 %}text-success{% endif %}">
                                                {{ '%.4f'|format(session.final_metrics.val_mae|default(0)) }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if session.status == 'Completed' %}
                                    <div class="progress mt-3" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="text-center mt-1">
                                        <small class="text-muted">Baigta ({{ session.epochs_completed }}/{{ session.parameters.epochs }})</small>
                                    </div>
                                    {% elif session.status == 'Running' %}
                                    <div class="progress mt-3" style="height: 5px;">
                                        <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" role="progressbar" 
                                             style="width: {{ (session.epochs_completed / session.parameters.epochs) * 100 }}%;" 
                                             aria-valuenow="{{ session.epochs_completed }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="{{ session.parameters.epochs }}"></div>
                                    </div>
                                    <div class="text-center mt-1">
                                        <small class="text-muted">Vykdoma ({{ session.epochs_completed }}/{{ session.parameters.epochs }})</small>
                                    </div>
                                    {% elif session.status == 'Failed' %}
                                    <div class="progress mt-3" style="height: 5px;">
                                        <div class="progress-bar bg-danger" role="progressbar" 
                                             style="width: {{ (session.epochs_completed / session.parameters.epochs) * 100 }}%;" 
                                             aria-valuenow="{{ session.epochs_completed }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="{{ session.parameters.epochs }}"></div>
                                    </div>
                                    <div class="text-center mt-1">
                                        <small class="text-muted">Nepavyko ({{ session.epochs_completed }}/{{ session.parameters.epochs }})</small>
                                    </div>
                                    {% elif session.status == 'Canceled' %}
                                    <div class="progress mt-3" style="height: 5px;">
                                        <div class="progress-bar bg-secondary" role="progressbar" 
                                             style="width: {{ (session.epochs_completed / session.parameters.epochs) * 100 }}%;" 
                                             aria-valuenow="{{ session.epochs_completed }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="{{ session.parameters.epochs }}"></div>
                                    </div>
                                    <div class="text-center mt-1">
                                        <small class="text-muted">Atšaukta ({{ session.epochs_completed }}/{{ session.parameters.epochs }})</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        Sesijų nerasta pagal pasirinktus filtrus.
                    </div>
                {% endif %}
            </div>
            
            <!-- Pusliapiavimas -->
            <div class="pagination-container">
                <nav aria-label="Pusliapiavimas">
                    <ul class="pagination">
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('training.sessions', page=page-1, **filters) }}" aria-label="Ankstesnis">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Ankstesnis">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                            <li class="page-item active"><a class="page-link" href="#">{{ p }}</a></li>
                            {% else %}
                            <li class="page-item"><a class="page-link" href="{{ url_for('training.sessions', page=p, **filters) }}">{{ p }}</a></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('training.sessions', page=page+1, **filters) }}" aria-label="Kitas">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Kitas">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gauname duomenis grafikui
        const evolutionData = {{ metrics_evolution|tojson }};
        
        // Inicializuojame metrikų evoliucijos grafiką
        const ctx = document.getElementById('metricsEvolutionChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Validavimo nuostolis',
                        data: evolutionData.map(item => ({
                            x: new Date(item.date),
                            y: item.val_loss
                        })),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    },
                    {
                        label: 'Validavimo MAE',
                        data: evolutionData.map(item => ({
                            x: new Date(item.date),
                            y: item.val_mae
                        })),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'yyyy-MM-dd'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Data'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Reikšmė'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const item = evolutionData[context[0].dataIndex];
                                return `${item.model_name} (${new Date(item.date).toLocaleDateString()})`;
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toFixed(4);
                                return label;
                            },
                            afterLabel: function(context) {
                                const item = evolutionData[context.dataIndex];
                                return `Modelio tipas: ${item.model_type}`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}