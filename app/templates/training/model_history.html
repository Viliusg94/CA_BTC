{% extends "base.html" %}

{% block title %}Modelių istorija{% endblock %}

{% block styles %}
<style>
    /* Stiliai modelių kortelėms */
    .model-card {
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    
    .model-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    /* Filtravimo skyriaus stiliai */
    .filter-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    /* Metrikų ženkliuko stiliai */
    .metric-badge {
        margin-right: 8px;
        margin-bottom: 5px;
    }

    /* Stilius aktyviam rūšiavimo laukui */
    .sorting-active {
        font-weight: bold;
        color: #0d6efd;
    }

    /* Rodyklės rūšiavimo tvarkos indikacijai */
    .sort-arrow {
        display: inline-block;
        margin-left: 5px;
    }

    /* Rūšiavimo informacijos juosta */
    .sorting-info {
        background-color: #e9ecef;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Puslapio antraštė -->
    <h1 class="mb-4">Modelių istorija</h1>
    <p class="lead">Peržiūrėkite visus sukurtus ir apmokytus modelius, palyginimo ir filtravimo galimybės.</p>
    
    <!-- Filtravimo skyrius -->
    <div class="filter-section mb-4">
        <form method="GET" action="{{ url_for('model_training.model_history') }}" id="filter-form">
            <div class="row g-3">
                <!-- Filtravimas pagal modelio tipą -->
                <div class="col-md-4">
                    <label for="type" class="form-label">Filtruoti pagal tipą:</label>
                    <select class="form-select" id="type" name="type">
                        <option value="">Visi modeliai</option>
                        <option value="lstm" {% if filter_type == 'lstm' %}selected{% endif %}>LSTM</option>
                        <option value="cnn" {% if filter_type == 'cnn' %}selected{% endif %}>CNN</option>
                        <option value="dnn" {% if filter_type == 'dnn' %}selected{% endif %}>DNN</option>
                    </select>
                </div>
                
                <!-- Rūšiavimas pagal lauką -->
                <div class="col-md-4">
                    <label for="sort_by" class="form-label">Rūšiuoti pagal:</label>
                    <select class="form-select" id="sort_by" name="sort_by">
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Sukūrimo data</option>
                        <option value="accuracy" {% if sort_by == 'accuracy' %}selected{% endif %}>Tikslumas</option>
                        <option value="loss" {% if sort_by == 'loss' %}selected{% endif %}>Klaidos funkcija</option>
                    </select>
                </div>
                
                <!-- Rūšiavimo tvarka -->
                <div class="col-md-4">
                    <label for="sort_order" class="form-label">Rūšiavimo tvarka:</label>
                    <select class="form-select" id="sort_order" name="sort_order">
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Mažėjančiai</option>
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Didėjančiai</option>
                    </select>
                </div>
                
                <!-- Mygtukai -->
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-1"></i>Filtruoti
                    </button>
                    <a href="{{ url_for('model_training.model_history') }}" class="btn btn-secondary ms-2">
                        <i class="fas fa-redo me-1"></i>Atstatyti
                    </a>
                    <!-- Palyginimo mygtukas, kuris bus aktyvuotas per JavaScript -->
                    <button type="button" id="compare-btn" class="btn btn-success float-end" disabled>
                        <i class="fas fa-chart-bar me-1"></i>Palyginti pasirinktus
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Rūšiavimo informacijos juosta -->
    <div class="sorting-info" id="sorting-info">
        <strong>Rūšiavimas:</strong> 
        <span id="sort-by-text">Sukūrimo data</span> 
        <span class="sort-arrow" id="sort-order-arrow">&#9660;</span>
        {% if models %}
        <span class="float-end">Rasta modelių: {{ models|length }}</span>
        {% endif %}
    </div>
    
    <!-- Modelių sąrašas -->
    <form id="compare-form" action="{{ url_for('model_training.compare_models') }}" method="GET">
        <div class="row">
            <!-- Jei yra modelių, juos atvaizduojame -->
            {% if models %}
                {% for model in models %}
                <div class="col-md-6 col-lg-4">
                    <div class="card model-card">
                        <!-- Kortelės antraštė su modelio pavadinimu ir palyginimo žymėjimu -->
                        <div class="card-header d-flex justify-content-between align-items-center
                                    {% if model.last_metrics and model.last_metrics.val_accuracy and model.last_metrics.val_accuracy > 0.8 %}
                                    bg-success text-white
                                    {% elif model.last_metrics and model.last_metrics.val_accuracy and model.last_metrics.val_accuracy > 0.6 %}
                                    bg-info text-white
                                    {% else %}
                                    bg-light
                                    {% endif %}">
                            <h5 class="mb-0">{{ model.name|default('Modelis #' ~ loop.index) }}</h5>
                            <div class="form-check">
                                <input class="form-check-input compare-checkbox" type="checkbox" 
                                       name="model_ids" value="{{ model.training_id }}" 
                                       id="compare-{{ model.training_id }}">
                                <label class="form-check-label" for="compare-{{ model.training_id }}">
                                    Palyginti
                                </label>
                            </div>
                        </div>
                        
                        <!-- Modelio informacija -->
                        <div class="card-body">
                            <!-- Modelio tipas ir sukūrimo data -->
                            <p class="mb-2"><strong>Tipas:</strong> {{ model.type|default('Nenurodyta')|upper }}</p>
                            <p class="mb-2"><strong>Sukurtas:</strong> {{ model.created_at|default('Nenurodyta') }}</p>
                            
                            <!-- Modelio aprašymas -->
                            {% if model.description %}
                            <p class="mb-3">{{ model.description|truncate(100) }}</p>
                            {% else %}
                            <p class="text-muted mb-3">Aprašymas nepateiktas</p>
                            {% endif %}
                            
                            <!-- Modelio metrikos (jei yra) -->
                            {% if model.last_metrics %}
                            <div class="mb-3">
                                {% if model.last_metrics.val_accuracy is defined %}
                                <span class="badge bg-info metric-badge">
                                    Tikslumas: {{ (model.last_metrics.val_accuracy * 100)|round(2) }}%
                                </span>
                                {% endif %}
                                
                                {% if model.last_metrics.val_loss is defined %}
                                <span class="badge bg-warning text-dark metric-badge">
                                    Val Loss: {{ model.last_metrics.val_loss|round(4) }}
                                </span>
                                {% endif %}
                                
                                {% if model.last_metrics.epoch is defined %}
                                <span class="badge bg-secondary metric-badge">
                                    Epochos: {{ model.last_metrics.epoch }}
                                </span>
                                {% endif %}
                            </div>
                            {% else %}
                            <p class="text-muted mb-3">Nėra metrikų duomenų</p>
                            {% endif %}
                            
                            <!-- Mygtukai veiksmams su modeliu -->
                            <div class="d-flex justify-content-between mt-auto">
                                <a href="{{ url_for('model_training.view_model', training_id=model.training_id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>Peržiūrėti
                                </a>
                                <a href="{{ url_for('model_training.metrics', training_id=model.training_id) }}" 
                                   class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-chart-line me-1"></i>Metrikos
                                </a>
                                <a href="{{ url_for('model_training.train_model', training_id=model.training_id) }}" 
                                   class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-play me-1"></i>Treniruoti
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Rodoma, kai nėra modelių -->
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Nerasta modelių pagal nurodytus kriterijus.
                        {% if filter_type %}
                        <a href="{{ url_for('model_training.model_history') }}" class="alert-link">Pašalinti filtrus</a>
                        {% else %}
                        <a href="{{ url_for('model_training.create_model') }}" class="alert-link">Sukurkite naują modelį</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </form>
    
    <!-- Naujo modelio sukūrimo mygtukas -->
    <div class="mt-4 text-center">
        <a href="{{ url_for('model_training.create_model') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Sukurti naują modelį
        </a>
    </div>

    <!-- Eksportavimo forma (paslėpta) -->
    <form id="export-form" action="{{ url_for('model_training.export_multiple_models') }}" method="post">
        <!-- Šis div laikys pasirinkimų elementus, kurie bus generuojami dinamiškai JavaScript -->
        <div id="export-model-ids"></div>
    </form>

    <!-- Eksportavimo mygtukas -->
    <div class="d-flex justify-content-between mb-4">
        <div>
            <button type="button" class="btn btn-success" id="export-selected-btn" disabled>
                <i class="fas fa-file-export me-1"></i>Eksportuoti pasirinktus
            </button>
            <span class="ms-2 text-muted" id="export-selected-info">
                Pasirinkite bent vieną modelį eksportavimui
            </span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Šis skriptas tvarko palyginimo funkcionalumą
document.addEventListener('DOMContentLoaded', function() {
    // Visos palyginimo žymimosios dėžutės
    const compareCheckboxes = document.querySelectorAll('.compare-checkbox');
    
    // Palyginimo mygtukas
    const compareBtn = document.getElementById('compare-btn');
    
    // Palyginimo forma
    const compareForm = document.getElementById('compare-form');
    
    // Filtro formos elementai
    const filterForm = document.getElementById('filter-form');
    const filterInputs = filterForm.querySelectorAll('select');
    
    // Funkcija palyginimo mygtuko būsenai atnaujinti
    function updateCompareButton() {
        // Suskaičiuojame, kiek modelių pažymėta palyginimui
        const checkedCount = Array.from(compareCheckboxes).filter(cb => cb.checked).length;
        
        // Mygtukas aktyvus tik jei bent 2 modeliai pažymėti
        compareBtn.disabled = checkedCount < 2;
        
        // Pakeičiame mygtuko tekstą pagal pažymėtų modelių skaičių
        if (checkedCount > 0) {
            compareBtn.innerHTML = `<i class="fas fa-chart-bar me-1"></i>Palyginti (${checkedCount})`;
        } else {
            compareBtn.innerHTML = `<i class="fas fa-chart-bar me-1"></i>Palyginti pasirinktus`;
        }
    }
    
    // Pridedame įvykių klausytojus žymimosioms dėžutėms
    compareCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCompareButton);
    });
    
    // Palyginimo mygtuko paspaudimas
    compareBtn.addEventListener('click', function() {
        compareForm.submit();
    });
    
    // Automatiškai pateikiame formą, kai pasikeičia filtro reikšmės
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            filterForm.submit();
        });
    });
    
    // Inicializuojame mygtuko būseną
    updateCompareButton();
});

// Atnaujinta palyginimo mygtuko funkcija
document.addEventListener('DOMContentLoaded', function() {
    // Palyginimo mygtukas
    const compareBtn = document.getElementById('compare-btn');
    
    // Palyginimo forma
    const compareForm = document.getElementById('compare-form');
    
    // Palyginimo žymimosios dėžutės
    const compareCheckboxes = document.querySelectorAll('.compare-checkbox');
    
    // Funkcija mygtuko būsenai atnaujinti
    function updateCompareButton() {
        // Skaičiuojame, kiek modelių pažymėta
        const checkedCount = Array.from(compareCheckboxes).filter(cb => cb.checked).length;
        
        // Mygtukas aktyvus tik jei bent 2 modeliai pažymėti
        compareBtn.disabled = checkedCount < 2;
        
        // Atnaujinamas mygtuko tekstas
        if (checkedCount > 0) {
            compareBtn.innerHTML = `<i class="fas fa-chart-bar me-1"></i>Palyginti (${checkedCount})`;
        } else {
            compareBtn.innerHTML = `<i class="fas fa-chart-bar me-1"></i>Palyginti pasirinktus`;
        }
    }
    
    // Pridedame įvykių klausytojus visoms žymimosioms dėžutėms
    compareCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCompareButton);
    });
    
    // Palyginimo mygtuko paspaudimo įvykis
    compareBtn.addEventListener('click', function() {
        compareForm.submit();
    });
    
    // Inicijuojame mygtuko būseną
    updateCompareButton();
});

// Pažymime aktyvius rūšiavimo laukus
document.addEventListener('DOMContentLoaded', function() {
    // Gauname visus rūšiavimo laukus
    const sortBySelect = document.getElementById('sort_by');
    const sortOrderSelect = document.getElementById('sort_order');
    
    // Pažymime aktyvų rūšiavimo lauką
    if (sortBySelect) {
        sortBySelect.addEventListener('change', function() {
            // Įsimename pasirinktą rūšiavimo lauką į localStorage
            localStorage.setItem('model_sort_by', this.value);
            
            // Iš karto pateikiame formą
            document.getElementById('filter-form').submit();
        });
        
        // Nustatome pasirinktą reikšmę iš localStorage, jei nėra URL parametro
        const urlSortBy = new URLSearchParams(window.location.search).get('sort_by');
        if (!urlSortBy && localStorage.getItem('model_sort_by')) {
            sortBySelect.value = localStorage.getItem('model_sort_by');
        }
    }
    
    // Pažymime aktyvią rūšiavimo tvarką
    if (sortOrderSelect) {
        sortOrderSelect.addEventListener('change', function() {
            // Įsimename pasirinktą rūšiavimo tvarką į localStorage
            localStorage.setItem('model_sort_order', this.value);
            
            // Iš karto pateikiame formą
            document.getElementById('filter-form').submit();
        });
        
        // Nustatome pasirinktą reikšmę iš localStorage, jei nėra URL parametro
        const urlSortOrder = new URLSearchParams(window.location.search).get('sort_order');
        if (!urlSortOrder && localStorage.getItem('model_sort_order')) {
            sortOrderSelect.value = localStorage.getItem('model_sort_order');
        }
    }
    
    // Pridedame žymėjimą aktyviam rūšiavimo laukui
    function updateSortingLabels() {
        // Gauname visus rūšiavimo laukų pavadinimus
        const sortLabels = document.querySelectorAll('.form-label[for="sort_by"], .form-label[for="sort_order"]');
        
        // Atnaujinome jų stilius
        sortLabels.forEach(label => {
            if (
                (label.getAttribute('for') === 'sort_by' && sortBySelect.value) ||
                (label.getAttribute('for') === 'sort_order' && sortOrderSelect.value)
            ) {
                label.style.fontWeight = 'bold';
                label.style.color = '#0d6efd'; // Bootstrap primary spalva
            } else {
                label.style.fontWeight = 'normal';
                label.style.color = '';
            }
        });
    }
    
    // Iškviečiame funkciją užkrovus puslapį
    updateSortingLabels();
    
    // Atnaujinkime pavadinimus keičiantis pasirinkimams
    sortBySelect.addEventListener('change', updateSortingLabels);
    sortOrderSelect.addEventListener('change', updateSortingLabels);
});

// Atnaujinti rūšiavimo informacijos juostą
function updateSortingInfo() {
    // Gauname elementus
    const sortByText = document.getElementById('sort-by-text');
    const sortOrderArrow = document.getElementById('sort-order-arrow');
    const sortBySelect = document.getElementById('sort_by');
    const sortOrderSelect = document.getElementById('sort_order');
    
    // Nustatome teksto reikšmę pagal pasirinktą lauką
    if (sortBySelect && sortByText) {
        const selectedOption = sortBySelect.options[sortBySelect.selectedIndex];
        sortByText.textContent = selectedOption.textContent;
    }
    
    // Nustatome rodyklės kryptį pagal pasirinktą tvarką
    if (sortOrderSelect && sortOrderArrow) {
        if (sortOrderSelect.value === 'asc') {
            sortOrderArrow.innerHTML = '&#9650;'; // Rodyklė į viršų
        } else {
            sortOrderArrow.innerHTML = '&#9660;'; // Rodyklė į apačią
        }
    }
}

// Iškviečiame funkciją užkrovus puslapį
document.addEventListener('DOMContentLoaded', function() {
    updateSortingInfo();
    
    // Atnaujinkime informaciją keičiantis pasirinkimams
    const sortBySelect = document.getElementById('sort_by');
    const sortOrderSelect = document.getElementById('sort_order');
    
    if (sortBySelect) {
        sortBySelect.addEventListener('change', updateSortingInfo);
    }
    
    if (sortOrderSelect) {
        sortOrderSelect.addEventListener('change', updateSortingInfo);
    }
});

// Modelių eksportavimo funkcionalumas
document.addEventListener('DOMContentLoaded', function() {
    // Elementai
    const selectAllCheckbox = document.getElementById('select-all-models');
    const modelCheckboxes = document.querySelectorAll('.model-checkbox');
    const exportSelectedBtn = document.getElementById('export-selected-btn');
    const exportModelIds = document.getElementById('export-model-ids');
    const exportForm = document.getElementById('export-form');
    const exportSelectedInfo = document.getElementById('export-selected-info');
    
    // "Pasirinkti visus" funkcionalumas
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            modelCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateExportButton();
        });
    }
    
    // Modelių pasirinkimo įvykiai
    modelCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateExportButton();
            
            // Tikriname, ar visi pažymėti, kad atnaujintume "Pasirinkti visus" būseną
            if (selectAllCheckbox) {
                const allChecked = Array.from(modelCheckboxes).every(c => c.checked);
                const anyChecked = Array.from(modelCheckboxes).some(c => c.checked);
                
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = anyChecked && !allChecked;
            }
        });
    });
    
    // Eksportavimo mygtuko paspaudimas
    if (exportSelectedBtn) {
        exportSelectedBtn.addEventListener('click', function() {
            // Išvalome ankstesnius pasirinkimus
            exportModelIds.innerHTML = '';
            
            // Pridedame pasirinktus modelius kaip formos laukus
            const selectedModelIds = Array.from(modelCheckboxes)
                .filter(c => c.checked)
                .map(c => c.value);
            
            // Sukuriame formos laukus kiekvienam pasirinktam modeliui
            selectedModelIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'model_ids';
                input.value = id;
                exportModelIds.appendChild(input);
            });
            
            // Pateikiame formą
            exportForm.submit();
        });
    }
    
    // Atnaujina eksportavimo mygtuko būseną
    function updateExportButton() {
        if (!exportSelectedBtn) return;
        
        const selectedCount = Array.from(modelCheckboxes).filter(c => c.checked).length;
        exportSelectedBtn.disabled = selectedCount === 0;
        
        if (exportSelectedInfo) {
            if (selectedCount === 0) {
                exportSelectedInfo.textContent = 'Pasirinkite bent vieną modelį eksportavimui';
            } else {
                exportSelectedInfo.textContent = `Pasirinkta modelių: ${selectedCount}`;
            }
        }
    }
    
    // Inicializuojame mygtuko būseną
    updateExportButton();
});
</script>
{% endblock %}