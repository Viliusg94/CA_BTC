{% extends "base.html" %}

{% block title %}Optimizavimo stebėjimas - BTC Prekybos Sistema{% endblock %}

{% block styles %}
<style>
    .status-badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    
    #elapsedTime {
        font-family: monospace;
        font-size: 1.25rem;
    }
    
    .trial-counter {
        font-size: 2rem;
        font-weight: bold;
    }
    
    .chart-container {
        height: 400px;
        margin-bottom: 20px;
    }
    
    .result-table th {
        font-size: 0.9rem;
    }
    
    .result-table td {
        font-size: 0.85rem;
    }
    
    .parameter-values {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .best-result {
        background-color: #d4edda;
    }
    
    .progress {
        height: 30px;
    }
    
    .progress-bar {
        line-height: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Optimizavimo stebėjimas</h1>
        </div>
    </div>
    
    <!-- Optimizavimo statusas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Statusas</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Statusas:</strong></p>
                            <div class="badge bg-primary status-badge" id="optimizationStatus">
                                {{ optimization.status }}
                            </div>
                        </div>
                        <div class="col-6">
                            <p><strong>Praėjo laiko:</strong></p>
                            <div id="elapsedTime">00:00:00</div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-6 text-center">
                            <p>Įvykdyta bandymų:</p>
                            <div class="trial-counter" id="completedTrials">
                                {{ optimization.completed_trials }}
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <p>Iš viso bandymų:</p>
                            <div class="trial-counter">
                                {{ optimization.max_trials }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <p><strong>Progresas:</strong></p>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" id="optimizationProgress"
                                     style="width: {{ (optimization.completed_trials / optimization.max_trials) * 100 }}%"
                                     aria-valuenow="{{ optimization.completed_trials }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="{{ optimization.max_trials }}">
                                    {{ ((optimization.completed_trials / optimization.max_trials) * 100)|round }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Optimizavimo parametrai</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Optimizavimo ID:</strong></p>
                            <div>{{ optimization.optimization_id }}</div>
                        </div>
                        <div class="col-6">
                            <p><strong>Pradėtas:</strong></p>
                            <div>{{ optimization.start_time }}</div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-6">
                            <p><strong>Metodas:</strong></p>
                            <div>{{ 'Grid search' if optimization.optimization_method == 'grid' else 'Random search' }}</div>
                        </div>
                        <div class="col-6">
                            <p><strong>Metrika:</strong></p>
                            <div>{{ 'Validavimo nuostolis' if optimization.optimization_metric == 'val_loss' else 'Validavimo MAE' }}</div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <p><strong>Modelio bazinis pavadinimas:</strong></p>
                            <div>{{ optimization.model_name }}</div>
                        </div>
                    </div>
                    
                    <!-- Veiksmai -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <button class="btn btn-danger" id="cancelOptimizationBtn" 
                                    {% if optimization.status not in ['Running', 'Initializing'] %}disabled{% endif %}>
                                Nutraukti optimizavimą
                            </button>
                            
                            <a href="{{ url_for('training.models') }}" class="btn btn-secondary ml-2">
                                Grįžti į modelių sąrašą
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rezultatų grafikas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Optimizavimo rezultatai</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="resultsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Parametrų reikšmės ir rezultatai -->
    <div class="row">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Parametrų reikšmės</h5>
                </div>
                <div class="card-body">
                    <div class="parameter-values">
                        <div class="row">
                            <div class="col-12">
                                <h6>Kintantys parametrai:</h6>
                                
                                {% for param, values in optimization.parameter_values.items() %}
                                <div class="mb-3">
                                    <strong>{{ param }}:</strong>
                                    <div>
                                        {% for value in values %}
                                        <span class="badge bg-light text-dark me-1">{{ value }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                                
                                <h6 class="mt-4">Fiksuoti parametrai:</h6>
                                
                                {% for param, value in optimization.fixed_parameters.items() %}
                                <div class="mb-2">
                                    <strong>{{ param }}:</strong> {{ value }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-7">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Bandymų rezultatai</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover result-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Modelio tipas</th>
                                    <th>Sluoksniai</th>
                                    <th>Neuronai</th>
                                    <th>Dropout</th>
                                    <th>Batch</th>
                                    <th>Mokymosi greitis</th>
                                    <th>Val. nuostolis</th>
                                    <th>Val. MAE</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                {% if optimization.trials %}
                                    {% for trial in optimization.trials %}
                                        <tr class="{{ 'best-result' if trial.is_best else '' }}">
                                            <td>{{ loop.index }}</td>
                                            <td>{{ trial.parameters.model_type }}</td>
                                            <td>{{ trial.parameters.layers }}</td>
                                            <td>{{ trial.parameters.units }}</td>
                                            <td>{{ trial.parameters.dropout }}</td>
                                            <td>{{ trial.parameters.batch_size }}</td>
                                            <td>{{ trial.parameters.learning_rate }}</td>
                                            <td>{{ '%.4f'|format(trial.metrics.val_loss) }}</td>
                                            <td>{{ '%.4f'|format(trial.metrics.val_mae) }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="9" class="text-center">Dar nėra baigtų bandymų.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Optimizavimo ID
    const optimizationId = "{{ optimization.optimization_id }}";
    
    // Kintamieji
    let chart;
    let updateInterval;
    let startTime = new Date("{{ optimization.start_time }}");
    
    // Funkcija atnaujinti praėjusį laiką
    function updateElapsedTime() {
        const now = new Date();
        const elapsedMs = now - startTime;
        
        // Konvertuojame į valandas, minutes, sekundes
        const hours = Math.floor(elapsedMs / (1000 * 60 * 60));
        const minutes = Math.floor((elapsedMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((elapsedMs % (1000 * 60)) / 1000);
        
        // Formatuojame laiką
        const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Atnaujiname UI
        document.getElementById('elapsedTime').textContent = formattedTime;
    }
    
    // Funkcija inicializuoti grafiką
    function initializeChart() {
        const ctx = document.getElementById('resultsChart').getContext('2d');
        
        chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Bandymų rezultatai',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgb(54, 162, 235)',
                        pointRadius: 8,
                        pointHoverRadius: 12
                    },
                    {
                        label: 'Geriausias rezultatas',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointRadius: 10,
                        pointHoverRadius: 14
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.raw;
                                let label = `Bandymas ${point.trialNum}`;
                                label += ` (${point.modelType}, ${point.layers} sluoksniai)`;
                                label += `\nValidavimo nuostolis: ${point.valLoss.toFixed(4)}`;
                                label += `\nValidavimo MAE: ${point.valMae.toFixed(4)}`;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Bandymo numeris'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '{{ "Validavimo nuostolis" if optimization.optimization_metric == "val_loss" else "Validavimo MAE" }}'
                        }
                    }
                }
            }
        });
    }
    
    // Funkcija atnaujinti duomenis iš serverio
    function updateOptimizationData() {
        fetch(`/training/api/optimization_status/${optimizationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atnaujiname UI elementus
                    document.getElementById('optimizationStatus').textContent = data.optimization.status;
                    document.getElementById('completedTrials').textContent = data.optimization.completed_trials;
                    
                    // Atnaujiname progreso juostą
                    const progress = (data.optimization.completed_trials / data.optimization.max_trials) * 100;
                    const progressBar = document.getElementById('optimizationProgress');
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', data.optimization.completed_trials);
                    progressBar.textContent = `${Math.round(progress)}%`;
                    
                    // Atnaujiname lentelę
                    const tableBody = document.getElementById('resultsTableBody');
                    tableBody.innerHTML = '';
                    
                    let chartData = [];
                    let bestData = [];
                    let bestValue = data.optimization.optimization_metric === 'val_loss' ? Infinity : -Infinity;
                    let bestIndex = -1;
                    
                    // Pildom rezultatų lentelę
                    data.optimization.trials.forEach((trial, index) => {
                        // Pridedam eilutę į lentelę
                        const row = document.createElement('tr');
                        
                        // Tikrinam, ar tai geriausias rezultatas
                        let isBest = false;
                        const metricValue = trial.metrics[data.optimization.optimization_metric];
                        
                        if (data.optimization.optimization_metric === 'val_loss') {
                            if (metricValue < bestValue) {
                                bestValue = metricValue;
                                bestIndex = index;
                                isBest = true;
                            }
                        } else {
                            if (metricValue > bestValue) {
                                bestValue = metricValue;
                                bestIndex = index;
                                isBest = true;
                            }
                        }
                        
                        if (isBest) {
                            row.className = 'best-result';
                        }
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${trial.parameters.model_type}</td>
                            <td>${trial.parameters.layers}</td>
                            <td>${trial.parameters.units}</td>
                            <td>${trial.parameters.dropout}</td>
                            <td>${trial.parameters.batch_size}</td>
                            <td>${trial.parameters.learning_rate}</td>
                            <td>${trial.metrics.val_loss.toFixed(4)}</td>
                            <td>${trial.metrics.val_mae.toFixed(4)}</td>
                        `;
                        
                        tableBody.appendChild(row);
                        
                        // Pridedam tašką į grafiko duomenis
                        const pointData = {
                            x: index + 1,
                            y: trial.metrics[data.optimization.optimization_metric],
                            trialNum: index + 1,
                            modelType: trial.parameters.model_type,
                            layers: trial.parameters.layers,
                            valLoss: trial.metrics.val_loss,
                            valMae: trial.metrics.val_mae
                        };
                        
                        chartData.push(pointData);
                    });
                    
                    // Atnaujinam grafiko duomenis
                    chart.data.datasets[0].data = chartData;
                    
                    // Jei turime geriausią rezultatą, pažymime jį atskirai
                    if (bestIndex !== -1) {
                        bestData = [chartData[bestIndex]];
                    }
                    
                    chart.data.datasets[1].data = bestData;
                    chart.update();
                    
                    // Jei optimizavimas baigtas, stabdome atnaujinimus
                    if (data.optimization.status === 'Completed' || 
                        data.optimization.status === 'Failed' || 
                        data.optimization.status === 'Canceled') {
                        if (updateInterval) {
                            clearInterval(updateInterval);
                        }
                        
                        // Išjungiame atšaukimo mygtuką
                        document.getElementById('cancelOptimizationBtn').disabled = true;
                    }
                } else {
                    console.error('Klaida gaunant optimizavimo duomenis:', data.message);
                }
            })
            .catch(error => {
                console.error('Klaida:', error);
            });
    }
    
    // Nutraukti optimizavimą
    function cancelOptimization() {
        if (confirm('Ar tikrai norite nutraukti optimizavimą?')) {
            fetch('/training/api/cancel_optimization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    optimization_id: optimizationId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atnaujiname statusą
                    document.getElementById('optimizationStatus').textContent = 'Canceled';
                    
                    // Išjungiame mygtuką
                    document.getElementById('cancelOptimizationBtn').disabled = true;
                    
                    // Stabdome atnaujinimus
                    if (updateInterval) {
                        clearInterval(updateInterval);
                    }
                    
                    alert('Optimizavimas sėkmingai nutrauktas.');
                } else {
                    alert('Klaida nutraukiant optimizavimą: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Klaida:', error);
                alert('Įvyko klaida bandant nutraukti optimizavimą.');
            });
        }
    }
    
    // Kai puslapis užkrautas
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializuojame grafiką
        initializeChart();
        
        // Pradedame atnaujinti laiką
        setInterval(updateElapsedTime, 1000);
        
        // Pradedame atnaujinti optimizavimo duomenis
        updateOptimizationData();
        updateInterval = setInterval(updateOptimizationData, 5000);
        
        // Nutraukimo mygtuko evento klausytojas
        document.getElementById('cancelOptimizationBtn').addEventListener('click', cancelOptimization);
    });
</script>
{% endblock %}