{% extends "base.html" %}

{% block title %}Modelio treniravimas{% endblock %}

{% block styles %}
<style>
    /* Progreso juostos stiliai */
    .progress {
        height: 25px;
        margin-bottom: 15px;
    }
    
    .status-badge {
        font-size: 1rem;
        padding: 0.5rem 0.75rem;
        margin-bottom: 15px;
    }
    
    .time-info {
        font-size: 0.9rem;
        color: #666;
    }
    
    .log-container {
        max-height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        font-family: monospace;
        margin-top: 20px;
    }
    
    .log-entry {
        margin-bottom: 5px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    
    .log-entry:last-child {
        border-bottom: none;
    }
    
    .log-time {
        color: #666;
        margin-right: 10px;
    }
    
    .log-info {
        color: #0d6efd;
    }
    
    .log-success {
        color: #198754;
    }
    
    .log-warning {
        color: #ffc107;
    }
    
    .log-error {
        color: #dc3545;
    }
    
    .control-buttons {
        display: flex;
        gap: 10px;
    }
    
    /* Grafikų konteinerio stiliai */
    .metrics-container {
        margin-bottom: 20px;
    }
    
    .chart-container {
        position: relative;
        height: 250px;
        margin-bottom: 15px;
    }
    
    /* Metrikos kortelės stiliai */
    .metric-card {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .metric-title {
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-3">Modelio treniravimas</h1>
            
            <!-- Modelio informacija -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ model_config.name }}</h5>
                    <span class="badge bg-primary">{{ model_config.type|upper }}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Epochos:</strong> {{ model_config.parameters.epochs }}</p>
                            <p><strong>Batch dydis:</strong> {{ model_config.parameters.batch_size }}</p>
                            <p><strong>Mokymosi greitis:</strong> {{ model_config.parameters.learning_rate }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Sluoksniai:</strong> {{ model_config.parameters.layers }}</p>
                            <p><strong>Neuronai:</strong> {{ model_config.parameters.neurons }}</p>
                            <p><strong>Sukurtas:</strong> {{ model_config.parameters.created_at }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Treniravimo būsena -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Treniravimo būsena</h5>
                </div>
                <div class="card-body">
                    <!-- Būsenos indikatorius -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span id="status-badge" class="badge status-badge bg-secondary">Nepradėta</span>
                        </div>
                        <div class="control-buttons">
                            <!-- Treniravimo kontrolės mygtukai -->
                            <button id="start-training-btn" class="btn btn-primary">
                                <i class="fas fa-play me-2"></i>Pradėti treniravimą
                            </button>
                            <button id="resume-training-btn" class="btn btn-success" disabled>
                                <i class="fas fa-redo me-2"></i>Tęsti treniravimą
                            </button>
                            <button id="stop-training-btn" class="btn btn-danger" disabled>
                                <i class="fas fa-stop me-2"></i>Nutraukti
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progreso juosta -->
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    
                    <!-- Informacija apie likusį laiką -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="time-info">
                            <span id="elapsed-time">Laikas: 00:00:00</span>
                        </div>
                        <div class="time-info">
                            <span id="progress-text">0% (0/{{ model_config.parameters.epochs }} epochų)</span>
                        </div>
                        <div class="time-info">
                            <span id="remaining-time">Likęs laikas: --:--:--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modelio metrikos -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Treniravimo metrikos</h5>
                    <div>
                        <button id="toggle-charts-btn" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-chart-line me-1"></i>Grafikai
                        </button>
                        <button id="toggle-metrics-btn" class="btn btn-sm btn-outline-secondary ms-2">
                            <i class="fas fa-table me-1"></i>Lentelė
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Metrikos kortelės -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="current-loss">-</div>
                                <div class="metric-title">Klaidos funkcija (Loss)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="current-val-loss">-</div>
                                <div class="metric-title">Validacijos klaida (Val Loss)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="current-accuracy">-</div>
                                <div class="metric-title">Tikslumas (Accuracy)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="current-val-accuracy">-</div>
                                <div class="metric-title">Validacijos tikslumas (Val Acc)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Grafikai -->
                    <div id="charts-container" class="metrics-container">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <canvas id="loss-chart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <canvas id="accuracy-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metrikų lentelė -->
                    <div id="metrics-table-container" class="metrics-container" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Epocha</th>
                                        <th>Loss</th>
                                        <th>Val Loss</th>
                                        <th>Accuracy</th>
                                        <th>Val Accuracy</th>
                                    </tr>
                                </thead>
                                <tbody id="metrics-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center">Dar nėra metrikų duomenų</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Treniravimo žurnalas -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Treniravimo žurnalas</h5>
                    <div>
                        <button id="clear-log-btn" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-eraser me-1"></i>Išvalyti
                        </button>
                        <button id="download-log-btn" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="fas fa-download me-1"></i>Atsisiųsti
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="log-container" class="log-container">
                        <div class="log-entry">
                            <span class="log-time">[{{ current_time }}]</span>
                            <span class="log-info">Treniravimo sesija paruošta. Spauskite "Pradėti treniravimą" mygtuką.</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Grįžimo mygtukas -->
            <div class="mt-4">
                <a href="{{ url_for('model_training.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Grįžti į modelių sąrašą
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.IO biblioteka -->
<script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>

<!-- Chart.js biblioteka -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Treniravimo sesijos ID
    const trainingId = "{{ training_id }}";
    
    // Pagrindiniai elementai
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const statusBadge = document.getElementById('status-badge');
    const elapsedTime = document.getElementById('elapsed-time');
    const remainingTime = document.getElementById('remaining-time');
    const logContainer = document.getElementById('log-container');
    const startTrainingBtn = document.getElementById('start-training-btn');
    const resumeTrainingBtn = document.getElementById('resume-training-btn');
    const stopTrainingBtn = document.getElementById('stop-training-btn');
    const clearLogBtn = document.getElementById('clear-log-btn');
    const downloadLogBtn = document.getElementById('download-log-btn');
    
    // Metrikų duomenų kintamieji
    let trainingLoss = [];
    let validationLoss = [];
    let trainingAccuracy = [];
    let validationAccuracy = [];
    let epochs = [];
    
    // Grafikų objektai
    let lossChart = null;
    let accuracyChart = null;
    
    // Būsenos tekstai ir spalvos
    const statusConfig = {
        'not_started': { text: 'Nepradėta', color: 'secondary' },
        'preparing': { text: 'Ruošiama', color: 'info' },
        'in_progress': { text: 'Vykdoma', color: 'primary' },
        'completed': { text: 'Baigta', color: 'success' },
        'failed': { text: 'Nepavyko', color: 'danger' },
        'stopped': { text: 'Nutraukta', color: 'warning' }
    };
    
    // Laiko formatavimo pagalbinė funkcija
    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        return [
            hours.toString().padStart(2, '0'),
            minutes.toString().padStart(2, '0'),
            secs.toString().padStart(2, '0')
        ].join(':');
    }
    
    // Laiko skaičiavimo kintamieji
    let startTime = null;
    let timerInterval = null;
    
    // Funkcija, atnaujinanti praėjusį laiką
    function updateElapsedTime() {
        if (!startTime) return;
        
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        elapsedTime.textContent = `Laikas: ${formatTime(elapsedSeconds)}`;
    }
    
    // Funkcija, atnaujinanti likusį laiką
    function updateRemainingTime(currentEpoch, totalEpochs) {
        if (!startTime || currentEpoch === 0) {
            remainingTime.textContent = 'Likęs laikas: --:--:--';
            return;
        }
        
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        const secondsPerEpoch = elapsedSeconds / currentEpoch;
        const remainingEpochs = totalEpochs - currentEpoch;
        const remainingSeconds = Math.floor(secondsPerEpoch * remainingEpochs);
        
        remainingTime.textContent = `Likęs laikas: ${formatTime(remainingSeconds)}`;
    }
    
    // Funkcija, pridedanti įrašą į žurnalą
    function addLogEntry(message, type = 'info') {
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        const timeSpan = document.createElement('span');
        timeSpan.className = 'log-time';
        timeSpan.textContent = `[${timeStr}]`;
        
        const messageSpan = document.createElement('span');
        messageSpan.className = `log-${type}`;
        messageSpan.textContent = message;
        
        logEntry.appendChild(timeSpan);
        logEntry.appendChild(document.createTextNode(' '));
        logEntry.appendChild(messageSpan);
        
        logContainer.appendChild(logEntry);
        
        // Automatinis slinkimas į apačią
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // Funkcija, atnaujinanti būsenos indikatorių
    function updateStatus(status) {
        const config = statusConfig[status] || statusConfig.not_started;
        
        statusBadge.textContent = config.text;
        statusBadge.className = `badge status-badge bg-${config.color}`;
        
        // Atnaujinama mygtukų būsena
        if (status === 'in_progress') {
            startTrainingBtn.disabled = true;
            resumeTrainingBtn.disabled = true;
            stopTrainingBtn.disabled = false;
        } else if (status === 'completed' || status === 'failed') {
            startTrainingBtn.disabled = true;
            resumeTrainingBtn.disabled = true;
            stopTrainingBtn.disabled = true;
        } else if (status === 'stopped') {
            startTrainingBtn.disabled = true;
            resumeTrainingBtn.disabled = false;
            stopTrainingBtn.disabled = true;
        } else {
            startTrainingBtn.disabled = false;
            resumeTrainingBtn.disabled = true;
            stopTrainingBtn.disabled = true;
        }
        
        // Įrašas į žurnalą
        addLogEntry(`Būsena pasikeitė į: ${config.text}`, status === 'failed' ? 'error' : status === 'completed' ? 'success' : 'info');
    }
    
    // Funkcija, atnaujinanti progreso juostą
    function updateProgress(progress, currentEpoch, totalEpochs) {
        // Atnaujinama progreso juosta
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = `${progress}%`;
        
        // Atnaujinamas progreso tekstas
        progressText.textContent = `${progress}% (${currentEpoch}/${totalEpochs} epochų)`;
        
        // Atnaujinamas likęs laikas
        updateRemainingTime(currentEpoch, totalEpochs);
    }
    
    // Funkcija žurnalo atsiuntimui
    function downloadLog() {
        // Surenkame visus žurnalo įrašus
        const logEntries = logContainer.querySelectorAll('.log-entry');
        let logText = '=== Treniravimo žurnalas ===\n';
        logText += `Treniravimo ID: ${trainingId}\n`;
        logText += `Data: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}\n\n`;
        
        logEntries.forEach((entry) => {
            const timeEl = entry.querySelector('.log-time');
            const messageEl = entry.querySelector('[class^="log-"]');
            
            if (timeEl && messageEl) {
                logText += `${timeEl.textContent} ${messageEl.textContent}\n`;
            }
        });
        
        // Sukuriame failą atsiuntimui
        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        // Sukuriame atsiuntimo nuorodą
        const a = document.createElement('a');
        a.href = url;
        a.download = `training_log_${trainingId}.txt`;
        document.body.appendChild(a);
        a.click();
        
        // Išvalome
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // Funkcija grafikų inicializavimui
    function initializeCharts() {
        // Klaidos funkcijos (Loss) grafikas
        const lossChartCanvas = document.getElementById('loss-chart');
        lossChart = new Chart(lossChartCanvas, {
            type: 'line',
            data: {
                labels: epochs,
                datasets: [{
                    label: 'Treniravimo klaida',
                    data: trainingLoss,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }, {
                    label: 'Validacijos klaida',
                    data: validationLoss,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Klaidos funkcijos kitimas',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Epochos'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Klaidos reikšmė'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Tikslumo (Accuracy) grafikas
        const accuracyChartCanvas = document.getElementById('accuracy-chart');
        accuracyChart = new Chart(accuracyChartCanvas, {
            type: 'line',
            data: {
                labels: epochs,
                datasets: [{
                    label: 'Treniravimo tikslumas',
                    data: trainingAccuracy,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }, {
                    label: 'Validacijos tikslumas',
                    data: validationAccuracy,
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Tikslumo kitimas',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Epochos'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Tikslumas'
                        },
                        min: 0,
                        max: 1,
                        ticks: {
                            callback: function(value) {
                                return (value * 100).toFixed(0) + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Funkcija metrikų atnaujinimui
    function updateMetrics(data) {
        // Patikriname, ar gauti duomenys teisingi
        if (!data || !data.epoch) return;
        
        // Pridedame naują epochą
        if (!epochs.includes(data.epoch)) {
            epochs.push(data.epoch);
        }
        
        // Pridedame naujas metrikos
        trainingLoss.push(data.loss);
        validationLoss.push(data.val_loss);
        trainingAccuracy.push(data.accuracy);
        validationAccuracy.push(data.val_accuracy);
        
        // Atnaujiname grafikus
        if (lossChart && accuracyChart) {
            lossChart.update();
            accuracyChart.update();
        }
        
        // Atnaujiname metrikų korteles
        document.getElementById('current-loss').textContent = data.loss.toFixed(4);
        document.getElementById('current-val-loss').textContent = data.val_loss.toFixed(4);
        document.getElementById('current-accuracy').textContent = (data.accuracy * 100).toFixed(2) + '%';
        document.getElementById('current-val-accuracy').textContent = (data.val_accuracy * 100).toFixed(2) + '%';
        
        // Atnaujiname metrikų lentelę
        updateMetricsTable(data);
    }
    
    // Funkcija metrikų lentelės atnaujinimui
    function updateMetricsTable(data) {
        const tableBody = document.getElementById('metrics-table-body');
        
        // Išvalome "nėra duomenų" eilutę, jei ji yra
        if (tableBody.children.length === 1 && tableBody.children[0].children.length === 1) {
            tableBody.innerHTML = '';
        }
        
        // Tikriname, ar eilutė šiai epochai jau egzistuoja
        const existingRow = Array.from(tableBody.children).find(row => {
            return row.children[0].textContent === data.epoch.toString();
        });
        
        if (existingRow) {
            // Atnaujiname egzistuojančią eilutę
            existingRow.children[1].textContent = data.loss.toFixed(4);
            existingRow.children[2].textContent = data.val_loss.toFixed(4);
            existingRow.children[3].textContent = (data.accuracy * 100).toFixed(2) + '%';
            existingRow.children[4].textContent = (data.val_accuracy * 100).toFixed(2) + '%';
        } else {
            // Sukuriame naują eilutę
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${data.epoch}</td>
                <td>${data.loss.toFixed(4)}</td>
                <td>${data.val_loss.toFixed(4)}</td>
                <td>${(data.accuracy * 100).toFixed(2)}%</td>
                <td>${(data.val_accuracy * 100).toFixed(2)}%</td>
            `;
            tableBody.appendChild(newRow);
        }
    }
    
    // Perjungti tarp grafikų ir lentelės
    document.getElementById('toggle-charts-btn').addEventListener('click', function() {
        document.getElementById('charts-container').style.display = 'block';
        document.getElementById('metrics-table-container').style.display = 'none';
    });
    
    document.getElementById('toggle-metrics-btn').addEventListener('click', function() {
        document.getElementById('charts-container').style.display = 'none';
        document.getElementById('metrics-table-container').style.display = 'block';
    });
    
    // Metrikų gavimo įvykis per Socket.IO
    socket.on('training_metrics', function(data) {
        console.log('Gautos metrikos:', data);
        updateMetrics(data);
    });
    
    // Inicializuojame Socket.IO
    const socket = io();
    
    // Prisijungimas prie treniravimo kanalo
    socket.on('connect', () => {
        addLogEntry('Prisijungta prie treniravimo serverio');
        
        // Prisijungiame prie specifinio treniravimo kanalo
        socket.emit('join_training', { training_id: trainingId });
    });
    
    // Apdorojame treniravimo būsenos atnaujinimus
    socket.on('training_status', (data) => {
        console.log('Gauta būsena:', data);
        
        // Atnaujinama būsena
        updateStatus(data.status);
        
        // Jei treniravimas prasidėjo, pradedame skaičiuoti laiką
        if (data.status === 'in_progress' && !startTime) {
            startTime = Date.now();
            timerInterval = setInterval(updateElapsedTime, 1000);
            addLogEntry('Treniravimas pradėtas');
        }
        
        // Jei treniravimas baigtas arba sustabdytas, stabdome laikmatį
        if (data.status === 'completed' || data.status === 'failed' || data.status === 'stopped') {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            if (data.status === 'completed') {
                addLogEntry('Treniravimas sėkmingai baigtas!', 'success');
            } else if (data.status === 'failed') {
                addLogEntry('Treniravimas nepavyko: ' + (data.message || 'Nežinoma klaida'), 'error');
            } else {
                addLogEntry('Treniravimas nutrauktas vartotojo', 'warning');
            }
        }
    });
    
    // Apdorojame progreso atnaujinimus
    socket.on('training_progress', (data) => {
        console.log('Gautas progresas:', data);
        
        // Atnaujinama progreso juosta
        updateProgress(data.progress, data.current_epoch, data.total_epochs);
        
        // Įrašas į žurnalą kas 10% progreso arba kas 10 epochų
        if (data.current_epoch % 10 === 0 || data.progress % 10 === 0) {
            addLogEntry(`Progresas: ${data.progress}% (Epocha ${data.current_epoch}/${data.total_epochs})`);
        }
    });
    
    // Apdorojame žurnalo pranešimus
    socket.on('training_log', (data) => {
        console.log('Gautas žurnalo įrašas:', data);
        
        // Įrašas į žurnalą
        addLogEntry(data.message, data.type || 'info');
    });
    
    // Apdorojame atsijungimą
    socket.on('disconnect', () => {
        addLogEntry('Atsijungta nuo treniravimo serverio', 'warning');
    });
    
    // Pradėti treniravimą mygtuko paspaudimas
    startTrainingBtn.addEventListener('click', () => {
        if (confirm('Ar tikrai norite pradėti modelio treniravimą?')) {
            // Siunčiama užklausa į serverį pradėti treniravimą
            socket.emit('start_training', { training_id: trainingId });
            updateStatus('preparing');
            addLogEntry('Siunčiama komanda pradėti treniravimą...');
        }
    });
    
    // Tęsti treniravimą mygtuko paspaudimas
    resumeTrainingBtn.addEventListener('click', () => {
        if (confirm('Ar tikrai norite tęsti modelio treniravimą?')) {
            // Siunčiama užklausa į serverį tęsti treniravimą
            socket.emit('resume_training', { training_id: trainingId });
            updateStatus('preparing');
            addLogEntry('Siunčiama komanda tęsti treniravimą...');
        }
    });
    
    // Nutraukti treniravimą mygtuko paspaudimas
    stopTrainingBtn.addEventListener('click', () => {
        if (confirm('Ar tikrai norite nutraukti modelio treniravimą? Dabartinė pažanga bus prarasta.')) {
            // Siunčiama užklausa į serverį nutraukti treniravimą
            socket.emit('stop_training', { training_id: trainingId });
            addLogEntry('Siunčiama komanda nutraukti treniravimą...', 'warning');
        }
    });
    
    // Išvalyti žurnalą mygtuko paspaudimas
    clearLogBtn.addEventListener('click', () => {
        // Išvalomas žurnalas, paliekant tik pradinį įrašą
        while (logContainer.firstChild) {
            logContainer.removeChild(logContainer.firstChild);
        }
        
        // Pridedamas pradinis įrašas
        addLogEntry('Žurnalas išvalytas');
    });
    
    // Atsisiųsti žurnalą mygtuko paspaudimas
    downloadLogBtn.addEventListener('click', downloadLog);
    
    // Pradinė būsena
    updateStatus('not_started');
    
    // Inicializuojame grafikus kai puslapis užkrautas
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
    });
</script>
{% endblock %}