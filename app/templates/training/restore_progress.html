{% extends 'base.html' %}

{% block title %}Modelio atstatymo progresas{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Navigacija atgal -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.index') }}">Pradžia</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_weights') }}">Modeliai</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_weights_details', model_name=model.filename) }}">{{ model.name }}</a></li>
            <li class="breadcrumb-item active">Atstatymo progresas</li>
        </ol>
    </nav>

    <!-- Antraštė -->
    <div class="mb-4">
        <h1>Modelio atstatymo progresas</h1>
        <p class="text-muted">Stebėkite modelio atstatymo būseną</p>
    </div>

    <!-- Progreso kortelė -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Atstatymo būsena</h5>
        </div>
        <div class="card-body">
            <!-- Būsenos informacija -->
            <div class="mb-4 text-center">
                <div class="h2 mb-3" id="statusDisplay">
                    <div class="spinner-border text-primary me-2" role="status"></div>
                    <span id="statusText">Kraunama...</span>
                </div>
                <p class="text-muted" id="statusDescription">Ieškoma informacijos apie modelio atstatymo operaciją...</p>
            </div>

            <!-- Progreso juosta -->
            <div class="progress mb-4" style="height: 30px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
            </div>

            <!-- Žingsnių indikatorius -->
            <div class="mb-4">
                <div class="d-flex justify-content-between mb-1">
                    <span>Pradėta</span>
                    <span>Atkuriami svoriai</span>
                    <span>Atnaujinami meta duomenys</span>
                    <span>Baigta</span>
                </div>
                <div class="progress" style="height: 5px;">
                    <div id="step1" class="progress-bar bg-success" role="progressbar" style="width: 25%"></div>
                    <div id="step2" class="progress-bar bg-success d-none" role="progressbar" style="width: 25%"></div>
                    <div id="step3" class="progress-bar bg-success d-none" role="progressbar" style="width: 25%"></div>
                    <div id="step4" class="progress-bar bg-success d-none" role="progressbar" style="width: 25%"></div>
                </div>
            </div>

            <!-- Detalės -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Modelio informacija</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Modelio pavadinimas:</strong> {{ model.name }}</p>
                            <p><strong>Modelio ID:</strong> {{ model.id }}</p>
                            <p><strong>Tipas:</strong> {{ model.type }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Išsaugojimo informacija</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Išsaugojimo epocha:</strong> {{ checkpoint.epoch }}</p>
                            <p><strong>Išsaugojimo data:</strong> {{ checkpoint.timestamp }}</p>
                            <p>
                                <strong>Statusas:</strong> 
                                {% if checkpoint.is_best %}
                                <span class="badge bg-success">Geriausias</span>
                                {% else %}
                                <span class="badge bg-secondary">Standartinis</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logai -->
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">Atstatymo procesas</h6>
                </div>
                <div class="card-body">
                    <div id="logsContainer" class="bg-dark text-white p-3 rounded" style="min-height: 200px; font-family: monospace; overflow-y: auto;">
                        <!-- Čia bus atnaujinami operacijos logai -->
                        <div class="log-entry">[INFO] Inicijuojamas atstatymo procesas...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <button id="cancelBtn" class="btn btn-outline-danger" disabled>
                    <i class="fas fa-times me-2"></i>Nutraukti
                </button>
                <div>
                    <button id="refreshBtn" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-sync-alt me-2"></i>Atnaujinti
                    </button>
                    <a id="doneBtn" href="{{ url_for('model_training.model_weights_details', model_name=model.filename) }}" class="btn btn-primary d-none">
                        <i class="fas fa-check me-2"></i>Baigta
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Kintamieji
        const modelId = '{{ model.id }}';
        const checkpointId = '{{ checkpoint.checkpoint_id }}';
        let operationStatus = 'initializing';
        let pollingInterval = null;
        
        // Elementų nuorodos
        const statusText = document.getElementById('statusText');
        const statusDescription = document.getElementById('statusDescription');
        const progressBar = document.getElementById('progressBar');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const logsContainer = document.getElementById('logsContainer');
        const cancelBtn = document.getElementById('cancelBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const doneBtn = document.getElementById('doneBtn');
        
        // Funkcija progreso atnaujinimui
        function updateProgress(status, progress, message = null, log = null) {
            // Atnaujiname operacijos būseną
            operationStatus = status;
            
            // Atnaujiname progreso juostą
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            
            // Atnaujiname žingsnius
            if (progress >= 25) {
                step1.classList.add('bg-success');
            }
            if (progress >= 50) {
                step2.classList.remove('d-none');
                step2.classList.add('bg-success');
            }
            if (progress >= 75) {
                step3.classList.remove('d-none');
                step3.classList.add('bg-success');
            }
            if (progress >= 100) {
                step4.classList.remove('d-none');
                step4.classList.add('bg-success');
            }
            
            // Atnaujiname būsenos tekstą
            if (status === 'initializing') {
                statusText.textContent = 'Inicijuojama';
                statusDescription.textContent = 'Ruošiamasi modelio atstatymui...';
            } else if (status === 'loading_weights') {
                statusText.textContent = 'Atkuriami svoriai';
                statusDescription.textContent = 'Atkuriami modelio svoriai iš išsaugojimo...';
            } else if (status === 'updating_metadata') {
                statusText.textContent = 'Atnaujinami meta duomenys';
                statusDescription.textContent = 'Atnaujinama modelio meta informacija...';
            } else if (status === 'completed') {
                statusText.textContent = 'Baigta';
                statusDescription.textContent = 'Modelis sėkmingai atstatytas iš išsaugojimo!';
                doneBtn.classList.remove('d-none');
                cancelBtn.disabled = true;
                
                // Sustabdome apklausą
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            } else if (status === 'failed') {
                statusText.textContent = 'Klaida';
                statusDescription.textContent = message || 'Įvyko klaida atstatant modelį';
                cancelBtn.disabled = true;
                
                // Sustabdome apklausą
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }
            
            // Pridedame naują log įrašą, jei pateiktas
            if (log) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = log;
                logsContainer.appendChild(logEntry);
                
                // Automatiškai slenkame į apačią
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }
        
        // Funkcija būsenos gavimui
        function checkStatus() {
            fetch(`/model_training/api/restore_status/${modelId}/${checkpointId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const status = data.status;
                        const progress = data.progress;
                        const message = data.message;
                        const logs = data.logs || [];
                        
                        // Pridedame visus naujus log įrašus
                        logs.forEach(log => {
                            updateProgress(status, progress, message, log);
                        });
                        
                        // Atnaujiname bendrą progresą ir būseną
                        updateProgress(status, progress, message);
                    } else {
                        // Įvyko klaida gaunant būseną
                        updateProgress('failed', 0, data.message, `[ERROR] ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Klaida tikrinant atstatymo būseną:', error);
                    updateProgress('failed', 0, 'Nepavyko gauti atstatymo būsenos', `[ERROR] Klaida tikrinant būseną: ${error.message}`);
                });
        }
        
        // Funkcija atstatymo inicijavimui
        function initiateRestore() {
            fetch('/model_training/api/restore_checkpoint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_id: modelId,
                    checkpoint_id: checkpointId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atstatymas inicijuotas sėkmingai
                    updateProgress('initializing', 25, null, `[INFO] Atstatymas inicijuotas: ${data.message}`);
                    
                    // Pradedame stebėti būseną
                    pollingInterval = setInterval(checkStatus, 2000);
                } else {
                    // Įvyko klaida inicijuojant atstatymą
                    updateProgress('failed', 0, data.message, `[ERROR] Nepavyko inicijuoti atstatymo: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Klaida inicijuojant atstatymą:', error);
                updateProgress('failed', 0, 'Nepavyko inicijuoti atstatymo', `[ERROR] Klaida inicijuojant atstatymą: ${error.message}`);
            });
        }
        
        // Iškviečiame atstatymo inicijavimą
        initiateRestore();
        
        // Atnaujinimo mygtuko funkcionalumas
        refreshBtn.addEventListener('click', function() {
            checkStatus();
        });
        
        // Nutraukimo mygtuko funkcionalumas
        cancelBtn.addEventListener('click', function() {
            if (confirm('Ar tikrai norite nutraukti atstatymo operaciją? Modelio būsena gali likti nestabili.')) {
                fetch(`/model_training/api/cancel_restore/${modelId}/${checkpointId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Atstatymas nutrauktas sėkmingai
                        updateProgress('failed', 0, 'Atstatymas nutrauktas vartotojo', `[INFO] Atstatymas nutrauktas: ${data.message}`);
                        
                        // Sustabdome apklausą
                        if (pollingInterval) {
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                        }
                    } else {
                        // Įvyko klaida nutraukiant atstatymą
                        updateProgress('failed', 0, data.message, `[ERROR] Nepavyko nutraukti atstatymo: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Klaida nutraukiant atstatymą:', error);
                    updateProgress('failed', 0, 'Nepavyko nutraukti atstatymo', `[ERROR] Klaida nutraukiant atstatymą: ${error.message}`);
                });
            }
        });
    });
</script>
{% endblock %}
{% endblock %}