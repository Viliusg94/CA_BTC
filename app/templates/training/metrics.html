{% extends "base.html" %}

{% block title %}Modelio metrikos{% endblock %}

{% block styles %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    
    .metrics-summary {
        margin-bottom: 20px;
    }
    
    .metric-card {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 15px;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .metric-title {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .best-epoch {
        background-color: #d4edda;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-3">Modelio metrikos</h1>
            
            <!-- Modelio informacija -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ model_config.name|default('Modelis') }}</h5>
                    <span class="badge bg-primary">{{ model_config.type|default('UNKNOWN')|upper }}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Epochos:</strong> {{ model_config.parameters.epochs|default('N/A') }}</p>
                            <p><strong>Batch dydis:</strong> {{ model_config.parameters.batch_size|default('N/A') }}</p>
                            <p><strong>Mokymosi greitis:</strong> {{ model_config.parameters.learning_rate|default('N/A') }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Sluoksniai:</strong> {{ model_config.parameters.layers|default('N/A') }}</p>
                            <p><strong>Neuronai:</strong> {{ model_config.parameters.neurons|default('N/A') }}</p>
                            <p><strong>Sukurtas:</strong> {{ model_config.parameters.created_at|default('N/A') }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Treniravimo rezultatų santrauka -->
            {% if metrics and metrics|length > 0 %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Treniravimo rezultatų santrauka</h5>
                </div>
                <div class="card-body">
                    <div class="row metrics-summary">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="final-loss">{{ final_metrics.train_loss|default('N/A')|round(4) }}</div>
                                <div class="metric-title">Klaidos funkcija (Loss)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="final-val-loss">{{ final_metrics.val_loss|default('N/A')|round(4) }}</div>
                                <div class="metric-title">Validacijos klaida (Val Loss)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="final-accuracy">{{ (final_metrics.train_accuracy|default(0) * 100)|round(2) }}%</div>
                                <div class="metric-title">Tikslumas (Accuracy)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="final-val-accuracy">{{ (final_metrics.val_accuracy|default(0) * 100)|round(2) }}%</div>
                                <div class="metric-title">Validacijos tikslumas (Val Acc)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="metric-card {% if best_epoch == 'loss' %}best-epoch{% endif %}">
                                <div class="metric-title">Geriausia Epocha (pagal Loss)</div>
                                <div class="metric-value" id="best-loss-epoch">{{ best_loss_epoch|default('N/A') }}</div>
                                <div>Loss: {{ best_loss|default('N/A')|round(4) }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card {% if best_epoch == 'val_loss' %}best-epoch{% endif %}">
                                <div class="metric-title">Geriausia Epocha (pagal Val Loss)</div>
                                <div class="metric-value" id="best-val-loss-epoch">{{ best_val_loss_epoch|default('N/A') }}</div>
                                <div>Val Loss: {{ best_val_loss|default('N/A')|round(4) }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card {% if best_epoch == 'val_acc' %}best-epoch{% endif %}">
                                <div class="metric-title">Geriausia Epocha (pagal Val Acc)</div>
                                <div class="metric-value" id="best-val-acc-epoch">{{ best_val_acc_epoch|default('N/A') }}</div>
                                <div>Val Acc: {{ (best_val_acc|default(0) * 100)|round(2) }}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metrikų grafikai -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Mokymosi grafikai</h5>
                    <div>
                        <button id="save-charts-btn" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download me-1"></i>Atsisiųsti grafikus
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <canvas id="loss-chart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <canvas id="accuracy-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metrikų lentelė -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Metrikų lentelė</h5>
                    <div>
                        <a href="{{ url_for('model_training.analyze_metrics', training_id=training_id) }}" class="btn btn-sm btn-outline-info me-2">
                            <i class="fas fa-chart-line me-1"></i>Analizuoti metrikas
                        </a>
                        <button id="download-metrics-btn" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download me-1"></i>Atsisiųsti CSV
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if metrics and metrics|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Epocha</th>
                                    <th>Loss</th>
                                    <th>Val Loss</th>
                                    <th>Accuracy</th>
                                    <th>Val Accuracy</th>
                                    <th>Laikas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for epoch in metrics %}
                                <tr{% if best_val_acc_epoch is defined and epoch.epoch|string == best_val_acc_epoch|string %} class="table-success"{% endif %}>
                                    <td>{{ epoch.epoch }}</td>
                                    <td>{{ epoch.loss|round(4) }}</td>
                                    <td>{{ epoch.val_loss|round(4) }}</td>
                                    <td>{{ (epoch.accuracy * 100)|round(2) }}%</td>
                                    <td>{{ (epoch.val_accuracy * 100)|round(2) }}%</td>
                                    <td>{{ epoch.timestamp|default('') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        Nėra metrikų duomenų. Pirmiausia pradėkite modelio treniravimą.
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                Nėra metrikų duomenų. Pirmiausia pradėkite modelio treniravimą.
            </div>
            {% endif %}
            
            <!-- Grįžimo mygtukas -->
            <div class="mt-4">
                <a href="{{ url_for('model_training.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Grįžti į modelių sąrašą
                </a>
                <a href="{{ url_for('model_training.train_model', training_id=training_id) }}" class="btn btn-primary ms-2">
                    <i class="fas fa-play me-2"></i>Treniravimo puslapis
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js biblioteka -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js anotacijų plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
<!-- html2canvas bibliotekai grafikų išsaugojimui -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Patikriname, ar Chart.js biblioteka užkrauta
        if (typeof Chart === 'undefined') {
            console.error('Chart.js biblioteka neužkrauta!');
            return;
        }

        // Saugiai gauname duomenis iš serverio
        const serverData = {
            metrics: {{ metrics_json|default('[]')|safe }},
            bestLossEpoch: {{ best_loss_epoch|default('null')|safe }},
            bestValLossEpoch: {{ best_val_loss_epoch|default('null')|safe }},
            bestValAccEpoch: {{ best_val_acc_epoch|default('null')|safe }}
        };

        // Konvertuojame į masyvą
        const trainingData = Array.isArray(serverData.metrics) ? serverData.metrics : [];
        
        // Jei nėra duomenų, grįžtame
        if (!trainingData || trainingData.length === 0) {
            console.warn("Nėra treniravimo duomenų");
            return;
        }
        
        // Ekstrahuojame duomenis grafikams
        const epochs = trainingData.map(d => d.epoch || 0);
        const loss = trainingData.map(d => d.loss || 0);
        const valLoss = trainingData.map(d => d.val_loss || 0);
        const accuracy = trainingData.map(d => d.accuracy || 0);
        const valAccuracy = trainingData.map(d => d.val_accuracy || 0);
        
        // Inicializuojame geriausių epochų reikšmes su apsaugomis
        let bestLossEpoch = serverData.bestLossEpoch;
        if ((bestLossEpoch === null || bestLossEpoch === undefined) && loss.length > 0) {
            const minLoss = Math.min(...loss);
            bestLossEpoch = epochs[loss.indexOf(minLoss)];
        }
        
        let bestValLossEpoch = serverData.bestValLossEpoch;
        if ((bestValLossEpoch === null || bestValLossEpoch === undefined) && valLoss.length > 0) {
            const minValLoss = Math.min(...valLoss);
            bestValLossEpoch = epochs[valLoss.indexOf(minValLoss)];
        }
        
        let bestValAccEpoch = serverData.bestValAccEpoch;
        if ((bestValAccEpoch === null || bestValAccEpoch === undefined) && valAccuracy.length > 0) {
            const maxValAcc = Math.max(...valAccuracy);
            bestValAccEpoch = epochs[valAccuracy.indexOf(maxValAcc)];
        }
        
        // Įregistruojame anotacijų įskiepį, jeigu jis yra
        if (typeof ChartAnnotation !== 'undefined') {
            Chart.register(ChartAnnotation);
        } else {
            console.warn('ChartAnnotation nerastas. Anotacijos nebus rodomos.');
        }
        
        // Klaidos funkcijos (Loss) grafikas
        const lossChartCanvas = document.getElementById('loss-chart');
        const lossChart = new Chart(lossChartCanvas, {
            type: 'line',
            data: {
                labels: epochs,
                datasets: [{
                    label: 'Treniravimo klaida',
                    data: loss,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }, {
                    label: 'Validacijos klaida',
                    data: valLoss,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Klaidos funkcijos kitimas',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    annotation: {
                        annotations: {
                            bestLossLine: {
                                type: 'line',
                                xMin: bestLossEpoch,
                                xMax: bestLossEpoch,
                                borderColor: 'rgba(75, 192, 192, 0.7)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Geriausias Loss',
                                    enabled: true,
                                    position: 'top'
                                }
                            },
                            bestValLossLine: {
                                type: 'line',
                                xMin: bestValLossEpoch,
                                xMax: bestValLossEpoch,
                                borderColor: 'rgba(255, 99, 132, 0.7)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Geriausias Val Loss',
                                    enabled: true,
                                    position: 'bottom'
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epochos'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Klaidos reikšmė'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Tikslumo (Accuracy) grafikas
            const accuracyChartCanvas = document.getElementById('accuracy-chart');
            const accuracyChart = new Chart(accuracyChartCanvas, {
                type: 'line',
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'Treniravimo tikslumas',
                        data: accuracy,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }, {
                        label: 'Validacijos tikslumas',
                        data: valAccuracy,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tikslumo kitimas',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        annotation: {
                            annotations: {
                                bestAccLine: {
                                    type: 'line',
                                    xMin: bestValAccEpoch,
                                    xMax: bestValAccEpoch,
                                    borderColor: 'rgba(255, 159, 64, 0.7)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Geriausias Val Acc',
                                        enabled: true,
                                        position: 'top'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epochos'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Tikslumas'
                            },
                            min: 0,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // Grafikų atsiuntimo funkcionalumas
            document.getElementById('save-charts-btn').addEventListener('click', function() {
                try {
                    // Klaidos funkcijos grafikas
                    html2canvas(document.getElementById('loss-chart').parentNode).then(function(canvas) {
                        const link = document.createElement('a');
                        link.download = 'loss_chart.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                    
                    // Tikslumo grafikas - palaukiame, kad pirmasis būtų baigtas
                    setTimeout(function() {
                        html2canvas(document.getElementById('accuracy-chart').parentNode).then(function(canvas) {
                            const link = document.createElement('a');
                            link.download = 'accuracy_chart.png';
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        });
                    }, 1000);
                } catch (error) {
                    console.error('Klaida išsaugant grafikus:', error);
                    alert('Įvyko klaida išsaugant grafikus: ' + error.message);
                }
            });
            
            // CSV atsiuntimo funkcionalumas
            const downloadMetricsBtn = document.getElementById('download-metrics-btn');
            
            if (downloadMetricsBtn) {
                downloadMetricsBtn.addEventListener('click', function() {
                    try {
                        // Siuntimo URL
                        const downloadUrl = `/api/metrics/export/{{ training_id }}?include_changes=true`;
                        
                        // Sukuriame atsisiuntimo nuorodą
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = 'modelio_metrikos.csv';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch (error) {
                        console.error('Klaida eksportuojant CSV:', error);
                        alert('Įvyko klaida eksportuojant CSV: ' + error.message);
                    }
                });
            }
        } catch (error) {
            console.error('Klaida inicializuojant metrikų puslapį:', error);
            // Rodome klaidos pranešimą vartotojui
            const errorElement = document.createElement('div');
            errorElement.className = 'alert alert-danger mt-3';
            errorElement.innerHTML = '<strong>Klaida!</strong> Nepavyko užkrauti metrikų: ' + error.message;
            document.querySelector('.container').prepend(errorElement);
        }
    });
</script>
{% endblock %}