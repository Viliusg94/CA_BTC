{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block styles %}
<style>
    /* Metrikų kortelių stiliai */
    .metric-card {
        border-radius: 0.25rem;
        transition: all 0.3s;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .metric-title {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    /* Parametrų lentelės stiliai */
    .param-table th {
        width: 30%;
    }
    
    /* Grafikų stiliai */
    .metrics-chart {
        height: 300px;
        margin-bottom: 1.5rem;
    }
    
    /* Statusų spalvos */
    .status-badge.created {
        background-color: #6c757d;
    }
    
    .status-badge.saved {
        background-color: #28a745;
    }
    
    .status-badge.restored {
        background-color: #17a2b8;
    }
    
    .status-badge.error {
        background-color: #dc3545;
    }
    
    /* Progreso indikatoriaus stiliai */
    .progress-timeline {
        position: relative;
        margin-top: 30px;
    }
    
    .progress-point {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        position: absolute;
        background-color: #dee2e6;
        top: -10px;
        transform: translateX(-50%);
        z-index: 2;
    }
    
    .progress-point.active {
        background-color: #28a745;
    }
    
    .progress-point.current {
        background-color: #007bff;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px #007bff;
    }
    
    .progress-line {
        height: 3px;
        background-color: #dee2e6;
        position: relative;
        z-index: 1;
    }
    
    .progress-line-filled {
        height: 100%;
        background-color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Navigacija atgal -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.index') }}">Pradžia</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_weights') }}">Modeliai</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_weights_details', model_name=model.filename) }}">{{ model.name }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.model_checkpoints', model_id=model.id) }}">Išsaugojimai</a></li>
            <li class="breadcrumb-item active">Išsaugojimo detalės</li>
        </ol>
    </nav>

    <!-- Antraštė ir veiksmai -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Modelio išsaugojimo detalės</h1>
            <p class="text-muted">Išsami informacija apie modelio tarpinį išsaugojimą (checkpoint)</p>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('model_training.model_checkpoints', model_id=model.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Grįžti į išsaugojimų sąrašą
            </a>
            <a href="{{ url_for('model_training.continue_training', model_id=model.id, checkpoint_id=checkpoint.checkpoint_id) }}" class="btn btn-primary">
                <i class="fas fa-play me-2"></i>Tęsti treniravimą
            </a>
            <button id="restoreBtn" class="btn btn-warning">
                <i class="fas fa-undo me-2"></i>Atkurti modelį
            </button>
            <button id="deleteBtn" class="btn btn-outline-danger">
                <i class="fas fa-trash me-2"></i>Ištrinti
            </button>
        </div>
    </div>

    <!-- Pagrindinė informacija -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Pagrindinė informacija</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Išsaugojimo ID:</strong> <span class="text-monospace">{{ checkpoint.checkpoint_id[:8] }}...</span></p>
                            <p><strong>Modelis:</strong> {{ model.name }}</p>
                            <p><strong>Epocha:</strong> {{ checkpoint.epoch }}</p>
                            <p>
                                <strong>Būsena:</strong> 
                                <span class="badge status-badge {{ checkpoint.status }}">{{ checkpoint.status }}</span>
                                {% if checkpoint.is_best %}
                                <span class="badge bg-success">Geriausias</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Sukurtas:</strong> {{ checkpoint.created_at }}</p>
                            <p><strong>Atnaujintas:</strong> {{ checkpoint.updated_at }}</p>
                            <p><strong>Svorių failas:</strong> 
                                {% if checkpoint.weights_path %}
                                <span class="text-success"><i class="fas fa-check-circle"></i> Yra</span>
                                {% else %}
                                <span class="text-danger"><i class="fas fa-times-circle"></i> Nėra</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% if checkpoint.notes %}
                    <div class="mt-3">
                        <strong>Pastabos:</strong>
                        <div class="card">
                            <div class="card-body bg-light">
                                <p class="mb-0">{{ checkpoint.notes|nl2br }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Apmokymo metrikos</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="card metric-card bg-light h-100">
                                <div class="card-body text-center">
                                    <div class="metric-title">Loss</div>
                                    <div class="metric-value">{{ "%.6f"|format(checkpoint.metrics.loss or 0) }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card bg-light h-100">
                                <div class="card-body text-center">
                                    <div class="metric-title">Validation Loss</div>
                                    <div class="metric-value">{{ "%.6f"|format(checkpoint.metrics.val_loss or 0) }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card bg-light h-100">
                                <div class="card-body text-center">
                                    <div class="metric-title">Accuracy</div>
                                    <div class="metric-value">{{ "%.4f"|format(checkpoint.metrics.accuracy or 0) }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card bg-light h-100">
                                <div class="card-body text-center">
                                    <div class="metric-title">Validation Accuracy</div>
                                    <div class="metric-value">{{ "%.4f"|format(checkpoint.metrics.val_accuracy or 0) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Papildomos metrikos -->
                    {% if checkpoint.metrics|length > 4 %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Papildomos metrikos:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Metrika</th>
                                            <th>Reikšmė</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for key, value in checkpoint.metrics.items() %}
                                            {% if key not in ['loss', 'val_loss', 'accuracy', 'val_accuracy'] %}
                                            <tr>
                                                <td>{{ key }}</td>
                                                <td>{{ value }}</td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Apmokymo progreso vizualizacija -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">Apmokymo progresas</h5>
        </div>
        <div class="card-body">
            <!-- Progreso laiko juosta -->
            <div class="progress-timeline mb-4">
                <div class="progress-line">
                    <div class="progress-line-filled" style="width: {{ (checkpoint.epoch / (all_checkpoints[-1].epoch if all_checkpoints else 1)) * 100 }}%;"></div>
                </div>
                
                <!-- Progreso taškai -->
                {% for cp in all_checkpoints %}
                <div class="progress-point {{ 'active' if cp.epoch <= checkpoint.epoch else '' }} {{ 'current' if cp.checkpoint_id == checkpoint.checkpoint_id else '' }}"
                     style="left: {{ (cp.epoch / (all_checkpoints[-1].epoch if all_checkpoints else 1)) * 100 }}%;"
                     title="Epocha {{ cp.epoch }}"></div>
                {% endfor %}
            </div>
            
            <!-- Epochos progresas -->
            <div class="d-flex justify-content-between mb-4">
                <div>
                    <strong>Esama epocha:</strong> {{ checkpoint.epoch }}
                </div>
                {% if all_checkpoints %}
                <div>
                    <strong>Paskutinė epocha:</strong> {{ all_checkpoints[-1].epoch }}
                </div>
                <div>
                    <strong>Progresas:</strong> 
                    {{ (checkpoint.epoch / all_checkpoints[-1].epoch * 100)|int if all_checkpoints else 0 }}%
                </div>
                {% endif %}
            </div>
            
            <!-- Metrikų grafikas -->
            <div class="row">
                <div class="col-md-6">
                    <div id="lossChart" class="metrics-chart"></div>
                </div>
                <div class="col-md-6">
                    <div id="accuracyChart" class="metrics-chart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modelio parametrai -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">Modelio parametrai</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="table-responsive">
                        <table class="table table-striped param-table">
                            <thead>
                                <tr>
                                    <th>Parametras</th>
                                    <th>Reikšmė</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, value in checkpoint.parameters.items() %}
                                <tr>
                                    <td>{{ key }}</td>
                                    <td class="text-break">{{ value }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Architektūros informacija -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">Modelio architektūra</h6>
                        </div>
                        <div class="card-body">
                            {% if checkpoint.parameters.get('architecture') %}
                            <pre class="bg-light p-3 rounded"><code>{{ checkpoint.parameters.architecture }}</code></pre>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Modelio architektūros informacija nėra prieinama šiame išsaugojime.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Palyginimas su geriausiu išsaugojimu -->
    {% if best_checkpoint and best_checkpoint.checkpoint_id != checkpoint.checkpoint_id %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">Palyginimas su geriausiu išsaugojimu</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Dabartinis išsaugojimas (Epocha {{ checkpoint.epoch }})</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card metric-card bg-light">
                                        <div class="card-body text-center">
                                            <div class="metric-title">Validation Loss</div>
                                            <div class="metric-value">{{ "%.6f"|format(checkpoint.metrics.val_loss or 0) }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card metric-card bg-light">
                                        <div class="card-body text-center">
                                            <div class="metric-title">Validation Accuracy</div>
                                            <div class="metric-value">{{ "%.4f"|format(checkpoint.metrics.val_accuracy or 0) }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">Geriausias išsaugojimas (Epocha {{ best_checkpoint.epoch }})</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card metric-card bg-light">
                                        <div class="card-body text-center">
                                            <div class="metric-title">Validation Loss</div>
                                            <div class="metric-value">{{ "%.6f"|format(best_checkpoint.metrics.val_loss or 0) }}</div>
                                            <div class="text-muted mt-1">
                                                {% set diff = (checkpoint.metrics.val_loss or 0) - (best_checkpoint.metrics.val_loss or 0) %}
                                                <span class="{{ 'text-danger' if diff > 0 else 'text-success' }}">
                                                    {{ '+' if diff > 0 else '' }}{{ "%.6f"|format(diff) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card metric-card bg-light">
                                        <div class="card-body text-center">
                                            <div class="metric-title">Validation Accuracy</div>
                                            <div class="metric-value">{{ "%.4f"|format(best_checkpoint.metrics.val_accuracy or 0) }}</div>
                                            <div class="text-muted mt-1">
                                                {% set diff = (checkpoint.metrics.val_accuracy or 0) - (best_checkpoint.metrics.val_accuracy or 0) %}
                                                <span class="{{ 'text-success' if diff > 0 else 'text-danger' }}">
                                                    {{ '+' if diff > 0 else '' }}{{ "%.4f"|format(diff) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <a href="{{ url_for('model_training.checkpoint_details', model_id=model.id, checkpoint_id=best_checkpoint.checkpoint_id) }}" class="btn btn-outline-success">
                    <i class="fas fa-eye me-2"></i>Peržiūrėti geriausią išsaugojimą
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Duomenų paruošimas grafikams
        const checkpoints = [
            {% for cp in all_checkpoints %}
            {
                epoch: {{ cp.epoch }},
                loss: {{ cp.metrics.loss or 'null' }},
                val_loss: {{ cp.metrics.val_loss or 'null' }},
                accuracy: {{ cp.metrics.accuracy or 'null' }},
                val_accuracy: {{ cp.metrics.val_accuracy or 'null' }},
                is_best: {% if cp.is_best %}true{% else %}false{% endif %},
                is_current: {% if cp.checkpoint_id == checkpoint.checkpoint_id %}true{% else %}false{% endif %}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Pažymimos reikšmės dabartiniam išsaugojimui
        const currentEpoch = {{ checkpoint.epoch }};
        
        // Kuriame Loss grafiką
        if (document.getElementById('lossChart')) {
            const lossCtx = document.getElementById('lossChart').getContext('2d');
            const lossChart = new Chart(lossCtx, {
                type: 'line',
                data: {
                    labels: checkpoints.map(c => 'Epocha ' + c.epoch),
                    datasets: [{
                        label: 'Loss',
                        data: checkpoints.map(c => c.loss),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Validation Loss',
                        data: checkpoints.map(c => c.val_loss),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Loss metrikos per epochas'
                        },
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItems) {
                                    const idx = tooltipItems[0].dataIndex;
                                    let footer = '';
                                    
                                    if (checkpoints[idx].is_best) {
                                        footer += 'Geriausias išsaugojimas\n';
                                    }
                                    
                                    if (checkpoints[idx].is_current) {
                                        footer += 'Dabartinis išsaugojimas';
                                    }
                                    
                                    return footer;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Loss'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Epocha'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: function(context) {
                                const index = context.dataIndex;
                                const data = context.dataset.data;
                                
                                // Paryškinti tašką, jei tai dabartinis arba geriausias išsaugojimas
                                if (checkpoints[index].is_current || checkpoints[index].is_best) {
                                    return 8;
                                }
                                
                                return 3;
                            },
                            backgroundColor: function(context) {
                                const index = context.dataIndex;
                                
                                // Žalia spalva geriausiam išsaugojimui
                                if (checkpoints[index].is_best) {
                                    return 'rgb(40, 167, 69)';
                                }
                                
                                // Mėlyna spalva dabartiniam išsaugojimui
                                if (checkpoints[index].is_current) {
                                    return 'rgb(0, 123, 255)';
                                }
                                
                                return context.dataset.borderColor;
                            }
                        }
                    }
                });
        }
        
        // Kuriame Accuracy grafiką
        if (document.getElementById('accuracyChart')) {
            const accCtx = document.getElementById('accuracyChart').getContext('2d');
            const accChart = new Chart(accCtx, {
                type: 'line',
                data: {
                    labels: checkpoints.map(c => 'Epocha ' + c.epoch),
                    datasets: [{
                        label: 'Accuracy',
                        data: checkpoints.map(c => c.accuracy),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Validation Accuracy',
                        data: checkpoints.map(c => c.val_accuracy),
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Accuracy metrikos per epochas'
                        },
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItems) {
                                    const idx = tooltipItems[0].dataIndex;
                                    let footer = '';
                                    
                                    if (checkpoints[idx].is_best) {
                                        footer += 'Geriausias išsaugojimas\n';
                                    }
                                    
                                    if (checkpoints[idx].is_current) {
                                        footer += 'Dabartinis išsaugojimas';
                                    }
                                    
                                    return footer;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Accuracy'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Epocha'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: function(context) {
                                const index = context.dataIndex;
                                const data = context.dataset.data;
                                
                                // Paryškinti tašką, jei tai dabartinis arba geriausias išsaugojimas
                                if (checkpoints[index].is_current || checkpoints[index].is_best) {
                                    return 8;
                                }
                                
                                return 3;
                            },
                            backgroundColor: function(context) {
                                const index = context.dataIndex;
                                
                                // Žalia spalva geriausiam išsaugojimui
                                if (checkpoints[index].is_best) {
                                    return 'rgb(40, 167, 69)';
                                }
                                
                                // Mėlyna spalva dabartiniam išsaugojimui
                                if (checkpoints[index].is_current) {
                                    return 'rgb(0, 123, 255)';
                                }
                                
                                return context.dataset.borderColor;
                            }
                        }
                    }
                });
        }
        
        // Išsaugojimo atkūrimo funkcija
        document.getElementById('restoreBtn').addEventListener('click', function() {
            if (confirm('Ar tikrai norite atkurti modelį iš šio išsaugojimo? Modelio svoriai bus pakeisti.')) {
                fetch(`/model_training/api/checkpoint/{{ model.id }}/{{ checkpoint.checkpoint_id }}/restore`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Modelis sėkmingai atkurtas!');
                        window.location.href = "{{ url_for('model_training.model_weights_details', model_name=model.filename) }}";
                    } else {
                        alert('Klaida: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Klaida:', error);
                    alert('Įvyko klaida bandant atkurti modelį');
                });
            }
        });
        
        // Išsaugojimo ištrynimo funkcija
        document.getElementById('deleteBtn').addEventListener('click', function() {
            if (confirm('Ar tikrai norite ištrinti šį išsaugojimą? Šio veiksmo negalima atšaukti.')) {
                fetch('/model_training/api/delete_checkpoint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model_id: '{{ model.id }}',
                        checkpoint_id: '{{ checkpoint.checkpoint_id }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Išsaugojimas sėkmingai ištrintas!');
                        window.location.href = "{{ url_for('model_training.model_checkpoints', model_id=model.id) }}";
                    } else {
                        alert('Klaida: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Klaida:', error);
                    alert('Įvyko klaida bandant ištrinti išsaugojimą');
                });
            }
        });
    });
</script>
{% endblock %}
{% endblock %}