{% extends "base.html" %}

{% block title %}Apmokymo Būsena{% endblock %}

{% block content %}
<style>
    .progress {
        height: 25px;
        margin-bottom: 15px;
    }
    .metrics-table {
        font-size: 0.9rem;
    }
    
    /* Enhanced card styles */
    .training-card {
        transition: all 0.3s ease;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .training-card .card-header {
        font-weight: bold;
        border-bottom: 2px solid;
    }
    
    /* Different color schemes for training status */
    .training-card.active {
        border: 2px solid #28a745;
    }
    
    .training-card.active .card-header {
        background-color: #28a745;
        color: white;
        border-color: #1e7e34;
    }
    
    .training-card.idle {
        border: 2px solid #6c757d;
    }
    
    .training-card.idle .card-header {
        background-color: #6c757d;
        color: white;
        border-color: #5a6268;
    }
    
    .training-card.error {
        border: 2px solid #dc3545;
    }
    
    .training-card.error .card-header {
        background-color: #dc3545;
        color: white;
        border-color: #bd2130;
    }
    
    .training-card.completed {
        border: 2px solid #17a2b8;
    }
    
    .training-card.completed .card-header {
        background-color: #17a2b8;
        color: white;
        border-color: #138496;
    }
    
    /* Debug panel */
    #debug-panel {
        background-color: #343a40;
        color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        font-family: monospace;
        margin-bottom: 20px;
        max-height: 200px;
        overflow-y: auto;
    }
</style>

<h1 class="text-center mb-4">
    <i class="fas fa-tasks text-success"></i>
    Modelių Treniravimo Eiga
</h1>

<!-- Navigation -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-secondary me-2">
            <i class="fas fa-home"></i> Pagrindinis
        </a>
        <a href="/predict" class="btn btn-secondary me-2">
            <i class="fas fa-chart-line"></i> Prognozės
        </a>
        <a href="/models" class="btn btn-secondary me-2">
            <i class="fas fa-brain"></i> Modeliai
        </a>
        <a href="/training_status" class="btn btn-success">
            <i class="fas fa-tasks"></i> Apmokymas
        </a>
    </div>
</div>

<!-- Debug panel - will show errors if any -->
<div class="row mb-4" id="debug-container" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Debugging Information</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleDebugPanel()">Toggle</button>
            </div>
            <div class="card-body">
                <div id="debug-panel"></div>
            </div>
        </div>
    </div>
</div>

<!-- Training Status Cards -->
<div class="row mb-5" id="training-cards-container">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading training status...</p>
    </div>
</div>

<!-- Global Stop All Button -->
<div class="row mb-4" id="stop-all-container" style="display: none;">
    <div class="col-12 text-center">
        <button class="btn btn-danger" onclick="stopAllTraining()">
            <i class="fas fa-stop-circle"></i> Sustabdyti Visus Apmokymus (<span id="training-count">0</span>)
        </button>
    </div>
</div>

<!-- No models message -->
<div id="no-models-message" class="text-center py-5" style="display: none;">
    <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">Nėra prieinamų modelių</h4>
    <p class="text-muted">Sukurkite modelius Modelių puslapyje</p>
    <a href="/models" class="btn btn-primary mt-3">
        <i class="fas fa-brain"></i> Modelių Valdymas
    </a>
</div>

<!-- Modal for details -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalTitle">Modelio Detalės</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsModalBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Kraunama...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let refreshInterval;
let trainingData = {};
let debugMessages = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    refreshTrainingStatus();
    startAutoRefresh();
});

// Function to refresh training status
function refreshTrainingStatus() {
    console.log('Refreshing training status...');
    
    // Show loading indicator
    document.getElementById('training-cards-container').innerHTML = `
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading training status...</p>
        </div>
    `;
    
    fetch('/api/training_status')
        .then(response => response.json())
        .then(data => {
            console.log('Training status data:', data);
            addDebugMessage('Received training status: ' + JSON.stringify(data));
            
            if (data.success) {
                trainingData = data.all_status;
                updateTrainingCards(data.all_status, data.training_summary);
            } else {
                console.error('Failed to fetch training status:', data.error);
                showError('Nepavyko gauti treniravimo duomenų: ' + data.error);
                addDebugMessage('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching training status:', error);
            showError('Klaida gaunant treniravimo duomenis: ' + error.message);
            addDebugMessage('Fetch error: ' + error.message);
        });
}

// Function to update training cards
function updateTrainingCards(allStatus, trainingSummary) {
    const container = document.getElementById('training-cards-container');
    const stopAllContainer = document.getElementById('stop-all-container');
    const noModelsMessage = document.getElementById('no-models-message');
    const trainingCount = document.getElementById('training-count');
    
    if (!allStatus || Object.keys(allStatus).length === 0) {
        container.innerHTML = '';
        stopAllContainer.style.display = 'none';
        noModelsMessage.style.display = 'block';
        addDebugMessage('No status data available');
        return;
    }
    
    let hasActiveTraining = false;
    let cardsHtml = '';
    
    Object.keys(allStatus).forEach(modelType => {
        const status = allStatus[modelType];
        const progress = status.progress || {};
        const modelStatus = status.status || {};
        
        addDebugMessage(`Model ${modelType}: ${JSON.stringify(status)}`);
        
        // Determine card status
        let cardClass = 'idle';
        let statusText = 'Neaktyvus';
        let statusIcon = 'fas fa-pause';
        let progressValue = progress.progress || 0;
        let statusIndicator = 'status-idle';
        
        if (status.is_training) {
            cardClass = 'active';
            statusText = 'Treniruojama';
            statusIcon = 'fas fa-cog fa-spin';
            statusIndicator = 'status-active';
            hasActiveTraining = true;
        } else if (progress.status === 'completed' || progress.status === 'Completed') {
            cardClass = 'completed';
            statusText = 'Užbaigtas';
            statusIcon = 'fas fa-check';
            progressValue = 100;
            statusIndicator = 'status-completed';
        } else if (progress.status === 'error' || progress.status === 'Error' || progress.status === 'Klaida') {
            cardClass = 'error';
            statusText = 'Klaida';
            statusIcon = 'fas fa-exclamation-triangle';
            statusIndicator = 'status-error';
        }
        
        cardsHtml += `
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card training-card ${cardClass}" id="card-${modelType}">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="${statusIcon}"></i> ${modelType.toUpperCase()} Modelis
                            </h5>
                            <span class="status-indicator ${statusIndicator}"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col">
                                <strong>Būsena:</strong> ${statusText}
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col">
                                <strong>Progresas:</strong>
                                <div class="progress mt-2">
                                    <div class="progress-bar ${status.is_training ? 'progress-bar-striped progress-bar-animated' : ''}" 
                                         role="progressbar" 
                                         style="width: ${progressValue}%" 
                                         aria-valuenow="${progressValue}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        ${progressValue}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${progress.current_epoch ? `
                        <div class="row mb-3">
                            <div class="col">
                                <strong>Epocha:</strong> ${progress.current_epoch}/${progress.total_epochs || 'N/A'}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${progress.loss ? `
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>Loss:</strong> ${parseFloat(progress.loss).toFixed(4)}
                            </div>
                            <div class="col-6">
                                <strong>Val Loss:</strong> ${progress.val_loss ? parseFloat(progress.val_loss).toFixed(4) : 'N/A'}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="row">
                            <div class="col">
                                <button class="btn btn-outline-info btn-sm me-2" 
                                        onclick="showTrainingDetails('${modelType}')">
                                    <i class="fas fa-info-circle"></i> Detalės
                                </button>
                                
                                ${status.is_training ? `
                                <button class="btn btn-outline-danger btn-sm stop-training-btn" 
                                        onclick="stopTraining('${modelType}')">
                                    <i class="fas fa-stop"></i> Sustabdyti
                                </button>
                                ` : ''}
                                
                                ${progress.status === 'error' || progress.status === 'Error' || progress.status === 'Klaida' ? `
                                <button class="btn btn-outline-warning btn-sm" 
                                        onclick="resetTrainingStatus('${modelType}')">
                                    <i class="fas fa-redo"></i> Atstatyti
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = cardsHtml;
    
    if (trainingSummary && trainingSummary.training_models) {
        stopAllContainer.style.display = hasActiveTraining ? 'block' : 'none';
        if (trainingCount) trainingCount.textContent = trainingSummary.training_models;
    } else {
        stopAllContainer.style.display = 'none';
    }
    
    noModelsMessage.style.display = 'none';
}

// Function to stop training for a specific model
function stopTraining(modelType) {
    if (!confirm(`Ar tikrai norite sustabdyti ${modelType.toUpperCase()} modelio mokymą?`)) {
        return;
    }
    
    addDebugMessage(`Stopping training for ${modelType}`);
    
    fetch(`/stop_training/${modelType}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${modelType.toUpperCase()} modelio mokymas sustabdytas`);
            refreshTrainingStatus();
        } else {
            alert('Klaida sustabdant mokymą: ' + data.error);
            addDebugMessage(`Error stopping training: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error stopping training:', error);
        alert('Klaida sustabdant mokymą: ' + error.message);
        addDebugMessage(`Fetch error stopping training: ${error.message}`);
    });
}

// Function to reset training status
function resetTrainingStatus(modelType) {
    if (!confirm(`Ar tikrai norite atstatyti ${modelType.toUpperCase()} modelio būseną?`)) {
        return;
    }
    
    addDebugMessage(`Resetting training status for ${modelType}`);
    
    fetch(`/api/reset_training_status/${modelType}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${modelType.toUpperCase()} modelio būsena atstatyta`);
            refreshTrainingStatus();
        } else {
            alert('Klaida atstatant būseną: ' + data.error);
            addDebugMessage(`Error resetting training status: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error resetting training status:', error);
        alert('Klaida atstatant būseną: ' + error.message);
        addDebugMessage(`Fetch error resetting status: ${error.message}`);
    });
}

// Function to stop all training
function stopAllTraining() {
    if (!confirm('Ar tikrai norite sustabdyti visus aktyvius apmokymus?')) {
        return;
    }
    
    addDebugMessage('Stopping all training');
    
    fetch('/stop_all_training', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Visi apmokymai sustabdyti (${data.stopped_count})`);
            refreshTrainingStatus();
        } else {
            alert('Klaida sustabdant apmokymus: ' + data.error);
            addDebugMessage(`Error stopping all training: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error stopping all training:', error);
        alert('Klaida sustabdant apmokymus: ' + error.message);
        addDebugMessage(`Fetch error stopping all training: ${error.message}`);
    });
}

// Function to show training details
function showTrainingDetails(modelType) {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    document.getElementById('detailsModalTitle').textContent = `${modelType.toUpperCase()} Modelio Treniravimo Detalės`;
    document.getElementById('detailsModalBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Kraunama...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Fetch model details
    fetch(`/api/model_details/${modelType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('detailsModalBody').innerHTML = renderModelDetails(data.details);
            } else {
                document.getElementById('detailsModalBody').innerHTML = `
                    <div class="alert alert-danger">
                        Klaida gaunant modelio detales: ${data.error || 'Nežinoma klaida'}
                    </div>
                `;
                addDebugMessage(`Error getting model details: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error fetching model details:', error);
            document.getElementById('detailsModalBody').innerHTML = `
                <div class="alert alert-danger">
                    Klaida gaunant modelio detales: ${error.message || 'Nežinoma klaida'}
                </div>
            `;
            addDebugMessage(`Fetch error getting model details: ${error.message}`);
        });
}

// Function to render model details
function renderModelDetails(details) {
    if (!details) return '<div class="alert alert-warning">Nėra detalių</div>';
    
    return `
        <div class="row">
            <div class="col-md-6">
                <h6>Pagrindinė informacija</h6>
                <table class="table table-sm">
                    <tr><td><strong>Modelio tipas:</strong></td><td>${details.model_type}</td></tr>
                    <tr><td><strong>Būsena:</strong></td><td>${details.status}</td></tr>
                    <tr><td><strong>Paskutinis mokymas:</strong></td><td>${details.last_trained}</td></tr>
                    <tr><td><strong>Efektyvumas:</strong></td><td>${details.performance}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Konfigūracija</h6>
                <pre class="bg-light p-2 rounded">${JSON.stringify(details.config || {}, null, 2)}</pre>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h6>Dabartinis apmokymas</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>Būsena:</strong> ${details.current_training?.status || 'Nevykdomas'}</p>
                                <p><strong>Epocha:</strong> ${details.current_training?.current_epoch || 0}/${details.current_training?.total_epochs || 0}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Progresas:</strong> ${details.current_training?.progress || 0}%</p>
                                <p><strong>Likęs laikas:</strong> ${details.current_training?.time_remaining || 'N/A'}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Loss:</strong> ${details.current_training?.metrics?.loss || 'N/A'}</p>
                                <p><strong>Val Loss:</strong> ${details.current_training?.metrics?.val_loss || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Function to start auto-refresh
function startAutoRefresh() {
    refreshInterval = setInterval(refreshTrainingStatus, 10000); // Refresh every 10 seconds
}

// Function to stop auto-refresh
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// Function to show error message
function showError(message) {
    const container = document.getElementById('training-cards-container');
    container.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${message}
            </div>
        </div>
    `;
}

// Debug functions
function addDebugMessage(message) {
    const timestamp = new Date().toLocaleTimeString();
    debugMessages.push(`[${timestamp}] ${message}`);
    
    // Keep only last 50 messages
    if (debugMessages.length > 50) {
        debugMessages.shift();
    }
    
    // Update debug panel if visible
    const debugPanel = document.getElementById('debug-panel');
    if (debugPanel) {
        debugPanel.innerHTML = debugMessages.join('<br>');
        debugPanel.scrollTop = debugPanel.scrollHeight;
    }
    
    // Show debug container if there are messages
    if (debugMessages.length > 0) {
        document.getElementById('debug-container').style.display = 'block';
    }
}

function toggleDebugPanel() {
    const debugPanel = document.getElementById('debug-panel');
    debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
}

// Stop auto-refresh when user leaves the page
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}
