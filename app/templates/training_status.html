<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelio Mokymo Būsena | Bitcoin Prognozavimo Platforma</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Navigacija -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fab fa-bitcoin text-warning me-2"></i>Bitcoin Prognozavimo Platforma
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Pradžia</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/models"><i class="fas fa-chart-line me-1"></i>Modeliai</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/train"><i class="fas fa-cogs me-1"></i>Mokymas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/predict"><i class="fas fa-magic me-1"></i>Prognozė</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ensemble"><i class="fas fa-layer-group me-1"></i>Ansamblis</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Pagrindinis turinys -->
    <div class="container mt-5 pt-4">
        {% if not status %}
        <div class="alert alert-danger">
            <h4 class="alert-heading">Užduotis nerasta!</h4>
            <p>Nurodyto ID užduotis neegzistuoja arba buvo pašalinta.</p>
            <hr>
            <a href="/train" class="btn btn-primary">Grįžti į mokymo puslapį</a>
        </div>
        {% else %}
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Pradžia</a></li>
                        <li class="breadcrumb-item"><a href="/train">Mokymas</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Mokymo Būsena</li>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- Mokymo būsenos informacija -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            {{ status.model_type|upper }} Modelio Mokymo Būsena
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong>Užduoties ID:</strong>
                                    <span class="text-muted">{{ job_id }}</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Modelio tipas:</strong>
                                    <span class="text-muted">{{ status.model_type|upper }}</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Būsena:</strong>
                                    <span id="status-badge" class="badge bg-info">
                                        {{ status.status|default('Nežinoma')|capitalize }}
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <strong>Pradžios laikas:</strong>
                                    <span class="text-muted" id="start-time">
                                        {{ status.start_time|default('Nežinomas') }}
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <strong>Pabaigos laikas:</strong>
                                    <span class="text-muted" id="end-time">
                                        {{ status.end_time|default('-') }}
                                    </span>
                                </div>
                                {% if status.error %}
                                <div class="alert alert-danger">
                                    <strong>Klaida:</strong> {{ status.error }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong>Progresas:</strong>
                                    <div class="progress mt-2" style="height: 20px;">
                                        <div id="progress-bar" class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                                            role="progressbar" 
                                           
                                            aria-valuenow="{{ status.progress or 0 }}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                            {{ status.progress or 0 }}%
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3" id="epoch-container" {% if not status.current_epoch or not status.total_epochs %}style="display: none;"{% endif %}>
                                    <strong>Epochos:</strong>
                                    <span class="text-muted">
                                        <span id="current-epoch">{{ status.current_epoch or 0 }}</span> / 
                                        <span id="total-epochs">{{ status.total_epochs or 0 }}</span>
                                    </span>
                                </div>
                                
                                <div id="metrics-container">
                                {% if status.metrics %}
                                <div class="mb-3">
                                    <strong>Metrikos:</strong>
                                    <ul class="list-group mt-2">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            RMSE
                                            <span class="badge bg-primary rounded-pill" id="metric-rmse">{{ "%.2f"|format(status.metrics.rmse) }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            MAE
                                            <span class="badge bg-primary rounded-pill" id="metric-mae">{{ "%.2f"|format(status.metrics.mae) }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            MAPE
                                            <span class="badge bg-primary rounded-pill" id="metric-mape">{{ "%.2f"|format(status.metrics.mape) }}%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            R²
                                            <span class="badge bg-primary rounded-pill" id="metric-r2">{{ "%.4f"|format(status.metrics.r2) }}</span>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-md-6">
                                <a href="/train" class="btn btn-outline-primary">
                                    <i class="fas fa-arrow-left me-1"></i> Grįžti į mokymo puslapį
                                </a>
                            </div>
                            <div class="col-md-6 text-md-end" id="action-buttons">
                                <!-- Bus atnaujinta per JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mokymo grafikas, rodomas tik kai progresas >= 30% -->
        <div class="row" id="training-chart-container" style="display: none;">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Mokymo Progresas</h5>
                    </div>
                    <div class="card-body">
                        <div id="training-chart" style="height: 400px;">
                            <!-- Mokymo grafikas bus atvaizduojamas čia -->
                            <div id="chart-info-message" class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i> Mokymo grafikas bus atvaizduojamas, kai bus surinkta pakankamai duomenų.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Bitcoin Prognozavimo Platforma</h5>
                    <p class="text-muted">Magistro projektas, taikantis mašininio mokymosi metodus Bitcoin kainų prognozavimui.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0 text-muted">&copy; 2023. Visos teisės saugomos.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    
    <script>
        let trainingChart = null;
        let trainingLoss = [];
        let validationLoss = [];
        let epochs = [];
        let currentStatus = "";
        
        // Atnaujinti būsenos ženkliuką pagal statusą
        function updateStatusBadge(status) {
            const statusBadge = document.getElementById('status-badge');
            if (!statusBadge) return;
            
            statusBadge.className = 'badge';
            
            if (status === 'completed') {
                statusBadge.classList.add('bg-success');
                statusBadge.textContent = 'Baigta';
            } else if (status === 'failed') {
                statusBadge.classList.add('bg-danger');
                statusBadge.textContent = 'Klaida';
            } else if (status) {
                statusBadge.classList.add('bg-info');
                statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            } else {
                statusBadge.classList.add('bg-secondary');
                statusBadge.textContent = 'Nežinoma';
            }
        }
        
        // Atnaujinti mokymo būseną
        function updateTrainingStatus() {
            fetch(`/api/training_status/${encodeURIComponent("{{ job_id }}")}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Serverio klaida: ' + response.status);
                }
                return response.json();
            })
            .then(status => {
                if (!status) {
                    console.error('Negauti būsenos duomenys');
                    return;
                }
                
                // Atnaujinti progreso juostą
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    const progress = status.progress || 0;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress);
                }
                
                // Atnaujinti būsenos tekstą
                updateStatusBadge(status.status);
                
                // Sekame būsenos pasikeitimus
                if (currentStatus !== status.status) {
                    currentStatus = status.status;
                    updateActionButtons(status);
                }
                
                // Atnaujinti epochų informaciją jei yra
                if (status.current_epoch && status.total_epochs) {
                    const currentEpoch = document.getElementById('current-epoch');
                    const totalEpochs = document.getElementById('total-epochs');
                    const epochContainer = document.getElementById('epoch-container');
                    
                    if (currentEpoch && totalEpochs) {
                        currentEpoch.textContent = status.current_epoch;
                        totalEpochs.textContent = status.total_epochs;
                    }
                    
                    if (epochContainer) {
                        epochContainer.style.display = 'block';
                    }
                }
                
                // Atnaujinti laikus
                if (status.end_time) {
                    const endTime = document.getElementById('end-time');
                    if (endTime) {
                        endTime.textContent = status.end_time;
                    }
                }
                
                // Rodyti mokymo grafiką, kai progresas >= 30%
                if (status.progress && status.progress >= 30) {
                    const chartContainer = document.getElementById('training-chart-container');
                    const chartInfoMessage = document.getElementById('chart-info-message');
                    
                    if (chartContainer) {
                        chartContainer.style.display = 'block';
                    }
                    
                    if (chartInfoMessage && (status.status === 'training' || status.status === 'validating')) {
                        chartInfoMessage.style.display = 'none';
                    }
                    
                    // Imituojame mokymo duomenų atnaujinimą
                    if (status.current_epoch && !epochs.includes(status.current_epoch)) {
                        epochs.push(status.current_epoch);
                        trainingLoss.push(Math.random() * 0.1 + 0.05);
                        validationLoss.push(Math.random() * 0.15 + 0.1);
                        
                        if (document.getElementById('training-chart')) {
                            updateTrainingChart();
                        }
                    }
                }
                
                // Atnaujinti metrikos, jei yra
                if (status.metrics) {
                    updateMetrics(status.metrics);
                }
                
                // Jei mokymas dar vyksta, nustatyti kitą atnaujinimą
                if (status.status !== 'completed' && status.status !== 'failed') {
                    setTimeout(updateTrainingStatus, 2000);
                }
            })
            .catch(error => {
                console.error('Klaida gaunant mokymo būsenos duomenis:', error);
                setTimeout(updateTrainingStatus, 5000);
            });
        }

        // Atnaujinti veiksmo mygtukus pagal būseną
        function updateActionButtons(status) {
            const actionButtons = document.getElementById('action-buttons');
            if (!actionButtons) return;
            
            // Išvalyti esamą turinį
            actionButtons.innerHTML = '';
            
            // Pridėti mygtukus pagal statusą
            if (status.status === 'completed') {
                const modelBtn = document.createElement('a');
                modelBtn.href = '/model/' + status.model_type;
                modelBtn.className = 'btn btn-success';
                modelBtn.innerHTML = '<i class="fas fa-chart-line me-1"></i> Peržiūrėti modelį';
                actionButtons.appendChild(modelBtn);
                
                const predictBtn = document.createElement('a');
                predictBtn.href = '/predict?model=' + status.model_type;
                predictBtn.className = 'btn btn-primary ms-2';
                predictBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Prognozuoti';
                actionButtons.appendChild(predictBtn);
            } else if (status.status === 'failed') {
                const retryBtn = document.createElement('a');
                retryBtn.href = '/train?model=' + status.model_type;
                retryBtn.className = 'btn btn-warning';
                retryBtn.innerHTML = '<i class="fas fa-redo me-1"></i> Bandyti iš naujo';
                actionButtons.appendChild(retryBtn);
            }
        }
        
        // Atnaujinti metrikų informaciją
        function updateMetrics(metrics) {
            const metricsContainer = document.getElementById('metrics-container');
            if (!metricsContainer) return;
            
            if (metricsContainer.children.length === 0) {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `
                    <strong>Metrikos:</strong>
                    <ul class="list-group mt-2">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            RMSE
                            <span class="badge bg-primary rounded-pill" id="metric-rmse">${metrics.rmse.toFixed(2)}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            MAE
                            <span class="badge bg-primary rounded-pill" id="metric-mae">${metrics.mae.toFixed(2)}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            MAPE
                            <span class="badge bg-primary rounded-pill" id="metric-mape">${metrics.mape.toFixed(2)}%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            R²
                            <span class="badge bg-primary rounded-pill" id="metric-r2">${metrics.r2.toFixed(4)}</span>
                        </li>
                    </ul>
                `;
                metricsContainer.appendChild(div);
            } else {
                const rmseElement = document.getElementById('metric-rmse');
                const maeElement = document.getElementById('metric-mae');
                const mapeElement = document.getElementById('metric-mape');
                const r2Element = document.getElementById('metric-r2');
                
                if (rmseElement) rmseElement.textContent = metrics.rmse.toFixed(2);
                if (maeElement) maeElement.textContent = metrics.mae.toFixed(2);
                if (mapeElement) mapeElement.textContent = metrics.mape.toFixed(2) + '%';
                if (r2Element) r2Element.textContent = metrics.r2.toFixed(4);
            }
        }
        
        // Atnaujinti mokymo grafiką
        function updateTrainingChart() {
            const chartElement = document.getElementById('training-chart');
            if (!chartElement) return;
            
            const data = [
                {
                    x: epochs,
                    y: trainingLoss,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Mokymo klaida',
                    line: {color: '#1f77b4'}
                },
                {
                    x: epochs,
                    y: validationLoss,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Validacijos klaida',
                    line: {color: '#ff7f0e'}
                }
            ];
            
            const layout = {
                title: 'Mokymo procesas',
                xaxis: {title: 'Epocha'},
                yaxis: {title: 'Klaida'},
                template: 'plotly_white'
            };
            
            try {
                if (trainingChart === null) {
                    Plotly.newPlot('training-chart', data, layout);
                    trainingChart = true;
                } else {
                    Plotly.react('training-chart', data, layout);
                }
            } catch (error) {
                console.error('Klaida atnaujinant grafiką:', error);
            }
        }
        
        // Inicializavimas puslapiui užsikrovus
        document.addEventListener('DOMContentLoaded', function() {
            // Nustatom pradinę būseną
            currentStatus = "{{ status.status|default('unknown') }}";
            
            // Atnaujinti pradinę būsenos ženkliuko išvaizdą
            updateStatusBadge("{{ status.status|default('') }}");
            
            // Atnaujinti pradinius veiksmo mygtukus
            updateActionButtons({
                status: "{{ status.status|default('') }}",
                model_type: "{{ status.model_type|default('') }}"
            });
            
            // Pradėti atnaujinimą, jei būsena nėra unknown
            if (currentStatus !== 'unknown') {
                updateTrainingStatus();
            }
        });
    </script>
</body>
</html>