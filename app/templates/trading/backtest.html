{% extends "base.html" %}

{% block title %}Trading Strategy Backtester{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4 mb-4">
        <i class="fas fa-chart-line text-primary"></i> Trading Strategy Backtester
    </h1>
    
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="m-0 font-weight-bold text-primary">Configure Backtest</h5>
                </div>
                <div class="card-body">
                    <form id="backtest-form">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="strategy-select" class="form-label">Strategy</label>
                                    <select class="form-select" id="strategy-select" name="strategy_type" required>
                                        <option value="" selected disabled>Select a strategy...</option>
                                        {% for strategy in strategies %}
                                        <option value="{{ strategy }}">{{ strategy|capitalize }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="start-date" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="start-date" name="start_date" required>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="end-date" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="end-date" name="end_date" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="initial-balance" class="form-label">Initial Balance (USD)</label>
                                    <input type="number" class="form-control" id="initial-balance" name="initial_balance" value="10000" step="100" min="1000">
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="fee-rate" class="form-label">Trading Fee Rate (%)</label>
                                    <input type="number" class="form-control" id="fee-rate" name="fee_rate" value="0.1" step="0.01" min="0" max="5">
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="interval-select" class="form-label">Data Interval</label>
                                    <select class="form-select" id="interval-select" name="interval">
                                        <option value="15m">15 Minutes</option>
                                        <option value="1h">1 Hour</option>
                                        <option value="4h">4 Hours</option>
                                        <option value="1d" selected>1 Day</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion" id="strategyParamsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingStrategyParams">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStrategyParams" aria-expanded="true" aria-controls="collapseStrategyParams">
                                        Strategy Parameters
                                    </button>
                                </h2>
                                <div id="collapseStrategyParams" class="accordion-collapse collapse show" aria-labelledby="headingStrategyParams">
                                    <div class="accordion-body">
                                        <div id="strategy-params-container">
                                            <p class="text-muted">Select a strategy to configure parameters</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button type="submit" class="btn btn-primary" id="run-backtest-btn">
                                <i class="fas fa-play-circle"></i> Run Backtest
                            </button>
                            <button type="button" class="btn btn-secondary" id="reset-form-btn">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="backtest-results" class="row mb-4" style="display: none;">
        <div class="col">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0 font-weight-bold text-primary">Backtest Results</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="save-backtest-btn">
                            <i class="fas fa-save"></i> Save Results
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="download-csv-btn">
                            <i class="fas fa-download"></i> Download CSV
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Final Balance</h5>
                                    <h3 id="final-balance">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Total Return</h5>
                                    <h3 id="total-return">0.00%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Win Rate</h5>
                                    <h3 id="win-rate">0.00%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Max Drawdown</h5>
                                    <h3 id="max-drawdown">0.00%</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col">
                            <div class="mb-3">
                                <label class="form-label"><i class="fas fa-chart-area"></i> Equity Curve</label>
                                <div class="chart-container">
                                    <canvas id="equity-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="mb-3">
                                <label class="form-label"><i class="fas fa-list"></i> Trades</label>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="trades-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Action</th>
                                                <th>Price</th>
                                                <th>Amount</th>
                                                <th>Value</th>
                                                <th>Fees</th>
                                                <th>Profit/Loss</th>
                                            </tr>
                                        </thead>
                                        <tbody id="trades-body">
                                            <!-- Trades will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><i class="fas fa-chart-pie"></i> Profit Distribution</label>
                                <div class="chart-container">
                                    <canvas id="profit-distribution-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><i class="fas fa-chart-bar"></i> Monthly Performance</label>
                                <div class="chart-container">
                                    <canvas id="monthly-performance-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center" style="display: none !important; z-index: 9999;">
    <div class="card p-4 text-center">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 id="loading-message">Running backtest...</h5>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set default dates for the backtest (last 6 months)
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(today.getMonth() - 6);
    
    document.getElementById('end-date').value = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = sixMonthsAgo.toISOString().split('T')[0];

    // Initialize event listeners
    initEventListeners();
});

function initEventListeners() {
    // Strategy selection changes parameter form
    const strategySelect = document.getElementById('strategy-select');
    if (strategySelect) {
        strategySelect.addEventListener('change', function() {
            const strategy = this.value;
            loadStrategyParameters(strategy);
        });
    }
    
    // Form submission runs backtest
    const backtestForm = document.getElementById('backtest-form');
    if (backtestForm) {
        backtestForm.addEventListener('submit', function(e) {
            e.preventDefault();
            runBacktest();
        });
    }
    
    // Reset form button
    const resetFormBtn = document.getElementById('reset-form-btn');
    if (resetFormBtn) {
        resetFormBtn.addEventListener('click', function() {
            backtestForm.reset();
            
            const today = new Date();
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(today.getMonth() - 6);
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = sixMonthsAgo.toISOString().split('T')[0];
            
            document.getElementById('strategy-params-container').innerHTML = 
                '<p class="text-muted">Select a strategy to configure parameters</p>';
            
            hideResults();
        });
    }
    
    // Save backtest button
    const saveBacktestBtn = document.getElementById('save-backtest-btn');
    if (saveBacktestBtn) {
        saveBacktestBtn.addEventListener('click', function() {
            saveBacktest();
        });
    }
    
    // Download CSV button
    const downloadCsvBtn = document.getElementById('download-csv-btn');
    if (downloadCsvBtn) {
        downloadCsvBtn.addEventListener('click', function() {
            downloadTradesCsv();
        });
    }
}

// Load strategy parameters based on selected strategy
function loadStrategyParameters(strategy) {
    const container = document.getElementById('strategy-params-container');
    container.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading parameters...</p>';
    
    // Define parameter forms for each strategy type
    const paramForms = {
        'moving_average': `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="short-period" class="form-label">Short Period</label>
                        <input type="number" class="form-control" id="short-period" name="parameters[short_period]" value="10" min="2" max="50">
                        <div class="form-text">Number of periods for short moving average</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="long-period" class="form-label">Long Period</label>
                        <input type="number" class="form-control" id="long-period" name="parameters[long_period]" value="30" min="5" max="200">
                        <div class="form-text">Number of periods for long moving average</div>
                    </div>
                </div>
            </div>
        `,
        'prediction_based': `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="threshold-percent" class="form-label">Threshold Percent</label>
                        <input type="number" class="form-control" id="threshold-percent" name="parameters[threshold_percent]" value="1.0" step="0.1" min="0.1" max="10">
                        <div class="form-text">Minimum price change percentage for trade signals</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="max-holding-days" class="form-label">Max Holding Days</label>
                        <input type="number" class="form-control" id="max-holding-days" name="parameters[max_holding_days]" value="3" min="1" max="30">
                        <div class="form-text">Maximum number of days to hold a position</div>
                    </div>
                </div>
            </div>
        `,
        'ensemble': `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Ensemble strategy combines multiple strategies with weights.
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Moving Average Weight</label>
                        <input type="range" class="form-range" id="ma-weight" name="parameters[ma_weight]" value="0.5" min="0" max="1" step="0.1">
                        <div class="d-flex justify-content-between">
                            <span>0.0</span>
                            <span id="ma-weight-value">0.5</span>
                            <span>1.0</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Prediction Based Weight</label>
                        <input type="range" class="form-range" id="pred-weight" name="parameters[pred_weight]" value="0.5" min="0" max="1" step="0.1">
                        <div class="d-flex justify-content-between">
                            <span>0.0</span>
                            <span id="pred-weight-value">0.5</span>
                            <span>1.0</span>
                        </div>
                    </div>
                </div>
            </div>
        `
    };
    
    // Default parameters for all strategies
    const defaultParams = `
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="stop-loss" class="form-label">Stop Loss (%)</label>
                    <input type="number" class="form-control" id="stop-loss" name="parameters[stop_loss]" value="5" step="0.5" min="1" max="20">
                    <div class="form-text">Percentage loss to trigger stop loss</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="take-profit" class="form-label">Take Profit (%)</label>
                    <input type="number" class="form-control" id="take-profit" name="parameters[take_profit]" value="10" step="0.5" min="1" max="50">
                    <div class="form-text">Percentage gain to trigger take profit</div>
                </div>
            </div>
        </div>
    `;
    
    // Display the appropriate parameter form based on strategy type
    if (strategy in paramForms) {
        container.innerHTML = paramForms[strategy] + defaultParams;
        
        // Add event listeners for range sliders
        if (strategy === 'ensemble') {
            const maWeight = document.getElementById('ma-weight');
            const predWeight = document.getElementById('pred-weight');
            const maWeightValue = document.getElementById('ma-weight-value');
            const predWeightValue = document.getElementById('pred-weight-value');
            
            maWeight.addEventListener('input', function() {
                maWeightValue.textContent = this.value;
            });
            
            predWeight.addEventListener('input', function() {
                predWeightValue.textContent = this.value;
            });
        }
    } else {
        container.innerHTML = defaultParams;
    }
}

// Run backtest with form data
function runBacktest() {
    // Show loading overlay
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('loading-message').textContent = 'Running backtest...';
    
    // Get form data
    const form = document.getElementById('backtest-form');
    const formData = new FormData(form);
    
    // Convert form data to JSON
    const jsonData = {};
    formData.forEach((value, key) => {
        // Handle nested parameters
        if (key.startsWith('parameters[') && key.endsWith(']')) {
            if (!jsonData.parameters) {
                jsonData.parameters = {};
            }
            
            // Extract parameter name from parameters[name]
            const paramName = key.substring(11, key.length - 1);
            jsonData.parameters[paramName] = value;
        } else {
            jsonData[key] = value;
        }
    });
    
    // Convert string values to appropriate types
    if (jsonData.initial_balance) {
        jsonData.initial_balance = parseFloat(jsonData.initial_balance);
    }
    
    if (jsonData.fee_rate) {
        jsonData.fee_rate = parseFloat(jsonData.fee_rate) / 100; // Convert from percent to decimal
    }
    
    if (jsonData.parameters) {
        for (const key in jsonData.parameters) {
            const value = jsonData.parameters[key];
            if (!isNaN(parseFloat(value))) {
                // Convert numeric values to numbers
                jsonData.parameters[key] = parseFloat(value);
                
                // Convert percentages to decimals
                if (key === 'stop_loss' || key === 'take_profit') {
                    jsonData.parameters[key] = jsonData.parameters[key] / 100;
                }
            }
        }
    }
    
    // Call backtest API
    fetch('/trading/backtest', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading overlay
        document.getElementById('loading-overlay').style.display = 'none';
        
        if (data.success) {
            // Store backtest results
            window.backtestResult = data;
            
            // Display results
            displayBacktestResults(data.backtest_result);
        } else {
            // Show error message
            alert('Backtest Error: ' + data.error);
        }
    })
    .catch(error => {
        // Hide loading overlay
        document.getElementById('loading-overlay').style.display = 'none';
        
        // Show error message
        console.error('Error running backtest:', error);
        alert('Error running backtest: ' + error.message);
    });
}

// Display backtest results
function displayBacktestResults(result) {
    // Show results container
    document.getElementById('backtest-results').style.display = 'block';
    
    // Update summary metrics
    document.getElementById('final-balance').textContent = '$' + result.final_balance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    document.getElementById('total-return').textContent = result.total_return_percent.toFixed(2) + '%';
    document.getElementById('win-rate').textContent = result.win_rate_percent.toFixed(2) + '%';
    document.getElementById('max-drawdown').textContent = result.max_drawdown_percent.toFixed(2) + '%';
    
    // Apply color to total return based on profit/loss
    const totalReturnElement = document.getElementById('total-return');
    if (result.total_return_percent >= 0) {
        totalReturnElement.parentElement.classList.remove('bg-danger');
        totalReturnElement.parentElement.classList.add('bg-success');
    } else {
        totalReturnElement.parentElement.classList.remove('bg-success');
        totalReturnElement.parentElement.classList.add('bg-danger');
    }
    
    // Scroll to results
    document.getElementById('backtest-results').scrollIntoView({ behavior: 'smooth' });
    
    // Create equity chart
    createEquityChart(result);
    
    // Populate trades table
    populateTradesTable(result);
    
    // Create profit distribution chart
    createProfitDistributionChart(result);
    
    // Create monthly performance chart
    createMonthlyPerformanceChart(result);
}

// Create equity curve chart
function createEquityChart(result) {
    const ctx = document.getElementById('equity-chart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (window.equityChart) {
        window.equityChart.destroy();
    }
    
    // Get portfolio values and prices from result
    const portfolioValues = result.portfolio_values;
    const prices = result.prices;
    
    // Create labels (indices or dates if available)
    const labels = Array.from({ length: portfolioValues.length }, (_, i) => i);
    
    // Create chart
    window.equityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Portfolio Value',
                    data: portfolioValues,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0.1
                },
                {
                    label: 'Bitcoin Price (Scaled)',
                    data: prices.map(price => price * (portfolioValues[0] / prices[0])), // Scale to match portfolio value
                    borderColor: 'rgb(128, 128, 128)',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Portfolio Value vs Bitcoin Price'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Value (USD)'
                    },
                    beginAtZero: false
                }
            }
        }
    });
}

// Populate trades table
function populateTradesTable(result) {
    const tableBody = document.getElementById('trades-body');
    tableBody.innerHTML = '';
    
    // Get trades from result
    const trades = result.trades || [];
    
    if (trades.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No trades were executed</td></tr>';
        return;
    }
    
    // Add each trade to the table
    trades.forEach(trade => {
        const row = document.createElement('tr');
        
        // Format date
        const date = new Date(trade.timestamp);
        const dateStr = date.toLocaleString();
        
        // Format action
        const action = trade.action;
        const actionClass = action === 'BUY' ? 'text-success' : 'text-danger';
        
        // Calculate value
        const value = trade.price * trade.amount;
        
        // Format profit/loss
        const profitClass = trade.profit >= 0 ? 'text-success' : 'text-danger';
        const profitSign = trade.profit >= 0 ? '+' : '';
        
        // Create row cells
        row.innerHTML = `
            <td>${dateStr}</td>
            <td class="${actionClass}">${action}</td>
            <td>$${trade.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td>${trade.amount.toFixed(8)} BTC</td>
            <td>$${value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td>$${trade.fees.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="${profitClass}">${profitSign}$${trade.profit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        `;
        
        tableBody.appendChild(row);
    });
}

// Create profit distribution chart
function createProfitDistributionChart(result) {
    const ctx = document.getElementById('profit-distribution-chart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (window.profitDistributionChart) {
        window.profitDistributionChart.destroy();
    }
    
    // Get trades from result
    const trades = result.trades || [];
    
    if (trades.length === 0) {
        return;
    }
    
    // Calculate profit distribution
    const profitBins = {
        'Very Negative (< -5%)': 0,
        'Negative (-5% to -1%)': 0,
        'Slightly Negative (-1% to 0%)': 0,
        'Slightly Positive (0% to 1%)': 0,
        'Positive (1% to 5%)': 0,
        'Very Positive (> 5%)': 0
    };
    
    trades.forEach(trade => {
        // Skip trades with zero profit (like initial buys)
        if (trade.profit === 0) return;
        
        // Calculate profit percentage relative to trade value
        const tradeValue = trade.price * trade.amount;
        const profitPercent = trade.profit / tradeValue * 100;
        
        if (profitPercent < -5) {
            profitBins['Very Negative (< -5%)']++;
        } else if (profitPercent < -1) {
            profitBins['Negative (-5% to -1%)']++;
        } else if (profitPercent < 0) {
            profitBins['Slightly Negative (-1% to 0%)']++;
        } else if (profitPercent < 1) {
            profitBins['Slightly Positive (0% to 1%)']++;
        } else if (profitPercent < 5) {
            profitBins['Positive (1% to 5%)']++;
        } else {
            profitBins['Very Positive (> 5%)']++;
        }
    });
    
    // Create chart
    window.profitDistributionChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(profitBins),
            datasets: [{
                data: Object.values(profitBins),
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(153, 102, 255)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Profit Distribution by Trade'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const percentage = Math.round(value / trades.length * 100);
                            return `${label}: ${value} trades (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Create monthly performance chart
function createMonthlyPerformanceChart(result) {
    const ctx = document.getElementById('monthly-performance-chart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (window.monthlyPerformanceChart) {
        window.monthlyPerformanceChart.destroy();
    }
    
    // Get trades from result
    const trades = result.trades || [];
    
    if (trades.length === 0) {
        return;
    }
    
    // Organize trades by month
    const monthlyProfits = {};
    
    trades.forEach(trade => {
        if (trade.profit === 0) return;
        
        const date = new Date(trade.timestamp);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const monthLabel = date.toLocaleString('default', { month: 'short', year: 'numeric' });
        
        if (!monthlyProfits[monthKey]) {
            monthlyProfits[monthKey] = {
                label: monthLabel,
                profit: 0
            };
        }
        
        monthlyProfits[monthKey].profit += trade.profit;
    });
    
    // Sort months chronologically
    const sortedMonthKeys = Object.keys(monthlyProfits).sort();
    const labels = sortedMonthKeys.map(key => monthlyProfits[key].label);
    const profits = sortedMonthKeys.map(key => monthlyProfits[key].profit);
    
    // Create chart
    window.monthlyPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Profit/Loss',
                data: profits,
                backgroundColor: profits.map(profit => profit >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                borderColor: profits.map(profit => profit >= 0 ? 'rgb(75, 192, 192)' : 'rgb(255, 99, 132)'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Monthly Performance'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.raw || 0;
                            return `${label}: ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Profit/Loss (USD)'
                    }
                }
            }
        }
    });
}

// Hide results section
function hideResults() {
    document.getElementById('backtest-results').style.display = 'none';
    
    // Destroy charts
    if (window.equityChart) {
        window.equityChart.destroy();
    }
    
    if (window.profitDistributionChart) {
        window.profitDistributionChart.destroy();
    }
    
    if (window.monthlyPerformanceChart) {
        window.monthlyPerformanceChart.destroy();
    }
    
    // Clear trades table
    document.getElementById('trades-body').innerHTML = '';
}

// Save backtest results
function saveBacktest() {
    if (!window.backtestResult) {
        alert('No backtest results to save');
        return;
    }
    
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('loading-message').textContent = 'Saving backtest results...';
    
    fetch('/trading/save_backtest', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(window.backtestResult)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading-overlay').style.display = 'none';
        
        if (data.success) {
            alert('Backtest results saved successfully');
        } else {
            alert('Error saving backtest results: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loading-overlay').style.display = 'none';
        console.error('Error saving backtest results:', error);
        alert('Error saving backtest results: ' + error.message);
    });
}

// Download trades as CSV
function downloadTradesCsv() {
    if (!window.backtestResult || !window.backtestResult.backtest_result || !window.backtestResult.backtest_result.trades) {
        alert('No trade data to download');
        return;
    }
    
    const trades = window.backtestResult.backtest_result.trades;
    
    // Create CSV content
    let csvContent = 'data:text/csv;charset=utf-8,';
    csvContent += 'Date,Action,Price,Amount,Value,Fees,Profit/Loss\n';
    
    trades.forEach(trade => {
        const date = new Date(trade.timestamp);
        const dateStr = date.toISOString();
        const action = trade.action;
        const price = trade.price;
        const amount = trade.amount;
        const value = price * amount;
        const fees = trade.fees;
        const profit = trade.profit;
        
        csvContent += `${dateStr},${action},${price},${amount},${value},${fees},${profit}\n`;
    });
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', 'backtest_trades.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}
