{% extends "base.html" %}

{% block title %}Bitcoin žvakių grafikas{% endblock %}

{% block styles %}
<style>
    #candlestick-container {
        min-height: 500px;
        width: 100%;
        border: 1px solid #e0e0e0;
        margin-bottom: 20px;
        padding: 15px;
        position: relative;
    }
    
    #candlestick-chart {
        width: 100%;
        height: 500px;
    }
    
    .price-info {
        display: flex;
        flex-wrap: wrap;
        margin-top: 15px;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }
    
    .price-item {
        margin-right: 20px;
        display: flex;
        align-items: center;
    }
    
    .price-marker {
        width: 12px;
        height: 12px;
        display: inline-block;
        margin-right: 5px;
        border-radius: 2px;
    }
    
    .open-marker { background-color: #22c55e; }
    .high-marker { background-color: #3b82f6; }
    .low-marker { background-color: #ef4444; }
    .close-marker { background-color: #8b5cf6; }
    
    /* Pridėti stiliai tooltip */
    .custom-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        pointer-events: none;
        z-index: 100;
        display: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        font-size: 14px;
        min-width: 180px;
    }
    
    .custom-tooltip .title {
        font-weight: bold;
        margin-bottom: 5px;
        border-bottom: 1px solid rgba(255,255,255,0.3);
        padding-bottom: 5px;
    }
    
    .custom-tooltip .value-row {
        display: flex;
        justify-content: space-between;
        margin: 3px 0;
    }
    
    .custom-tooltip .value-marker {
        width: 8px;
        height: 8px;
        display: inline-block;
        margin-right: 5px;
        border-radius: 50%;
    }
    
    .crosshair-v {
        position: absolute;
        top: 0;
        width: 1px;
        height: 100%;
        background-color: rgba(100, 100, 100, 0.3);
        display: none;
        pointer-events: none;
        z-index: 90;
    }
    
    .crosshair-h {
        position: absolute;
        left: 0;
        width: 100%;
        height: 1px;
        background-color: rgba(100, 100, 100, 0.3);
        display: none;
        pointer-events: none;
        z-index: 90;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Bitcoin kainų žvakių grafikas</h1>
    
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="form-group">
                <label for="timeframe">Laiko periodas</label>
                <select id="timeframe" class="form-control">
                    <option value="1d">1 diena</option>
                    <option value="1w">1 savaitė</option>
                    <option value="1m" selected>1 mėnuo</option>
                    <option value="3m">3 mėnesiai</option>
                    <option value="6m">6 mėnesiai</option>
                    <option value="1y">1 metai</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="interval">Intervalas</label>
                <select id="interval" class="form-control">
                    <option value="1h">1 valanda</option>
                    <option value="4h">4 valandos</option>
                    <option value="1d" selected>1 diena</option>
                    <option value="1w">1 savaitė</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>&nbsp;</label>
                <button id="update-chart" class="btn btn-primary form-control">Atnaujinti grafiką</button>
            </div>
        </div>
    </div>
    
    <div id="candlestick-container">
        <!-- Pridedame crosshair elementus -->
        <div class="crosshair-v"></div>
        <div class="crosshair-h"></div>
        <canvas id="candlestick-chart"></canvas>
        <!-- Pridedame custom tooltip -->
        <div class="custom-tooltip">
            <div class="title">2023-01-01</div>
            <div class="value-row">
                <div><span class="value-marker open-marker"></span> Atidaryta:</div>
                <div id="tooltip-open">$0</div>
            </div>
            <div class="value-row">
                <div><span class="value-marker high-marker"></span> Aukščiausia:</div>
                <div id="tooltip-high">$0</div>
            </div>
            <div class="value-row">
                <div><span class="value-marker low-marker"></span> Žemiausia:</div>
                <div id="tooltip-low">$0</div>
            </div>
            <div class="value-row">
                <div><span class="value-marker close-marker"></span> Uždaryta:</div>
                <div id="tooltip-close">$0</div>
            </div>
            <div class="value-row mt-2">
                <div>Pokytis:</div>
                <div id="tooltip-change">0%</div>
            </div>
        </div>
    </div>
    
    <!-- Pridėta legenda su reikšmėmis -->
    <div class="price-info">
        <div class="price-item">
            <span class="price-marker open-marker"></span>
            <span>Atidaryta: <span id="current-open">-</span></span>
        </div>
        <div class="price-item">
            <span class="price-marker high-marker"></span>
            <span>Aukščiausia: <span id="current-high">-</span></span>
        </div>
        <div class="price-item">
            <span class="price-marker low-marker"></span>
            <span>Žemiausia: <span id="current-low">-</span></span>
        </div>
        <div class="price-item">
            <span class="price-marker close-marker"></span>
            <span>Uždaryta: <span id="current-close">-</span></span>
        </div>
        <div class="price-item">
            <span>Laikotarpis: <span id="current-date">-</span></span>
        </div>
    </div>
    
    <div id="chart-loading" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Kraunama...</span>
        </div>
        <p>Kraunami duomenys...</p>
    </div>
    
    <div id="chart-error" class="alert alert-danger" style="display: none;">
        Klaida kraunant duomenis. Bandykite vėliau.
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Pridedame Chart.js biblioteką -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Žvakių grafiko priedas Chart.js bibliotekai -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
<!-- Zoom ir Pan funkcionalumas -->
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let candlestickChart = null;
    let chartData = [];
    const container = document.getElementById('candlestick-container');
    const tooltip = container.querySelector('.custom-tooltip');
    const crosshairV = container.querySelector('.crosshair-v');
    const crosshairH = container.querySelector('.crosshair-h');
    
    function updateChart() {
        const timeframe = document.getElementById('timeframe').value;
        const interval = document.getElementById('interval').value;
        
        // Rodyti kraunama indikatorių
        document.getElementById('chart-loading').style.display = 'block';
        document.getElementById('chart-error').style.display = 'none';
        
        // Atnaujinti laiko vienetus pagal pasirinktą periodą
        let timeUnit = 'day';
        if (timeframe === '1d') {
            timeUnit = 'hour';
        } else if (timeframe === '1w') {
            timeUnit = 'day';
        } else if (timeframe === '1m') {
            timeUnit = 'day';
        } else if (timeframe === '3m' || timeframe === '6m') {
            timeUnit = 'week';
        } else if (timeframe === '1y') {
            timeUnit = 'month';
        }
        
        // API URL endpoint
        const apiUrl = `/trading/api/candlestick_data?timeframe=${timeframe}&interval=${interval}`;
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Serverio klaida: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Paslėpti kraunama indikatorių
                document.getElementById('chart-loading').style.display = 'none';
                
                // Patikrinti ar turime duomenų
                if (!data || data.length === 0 || data.error) {
                    let errorMsg = "Nėra duomenų pasirinktam periodui";
                    if (data && data.error) {
                        errorMsg = `API klaida: ${data.error}`;
                    }
                    document.getElementById('chart-error').textContent = errorMsg;
                    document.getElementById('chart-error').style.display = 'block';
                    return;
                }
                
                // Išsaugoti duomenis globaliam kintamajam
                chartData = data;
                
                // Rodyti naujausios žvakės informaciją legendoje
                const lastCandle = data[data.length - 1];
                updatePriceInfo(lastCandle);
                
                // Parengti duomenis finansiniam grafikui
                const ohlc = data.map(d => {
                    return {
                        x: new Date(d.time).getTime(),
                        o: d.open,
                        h: d.high,
                        l: d.low,
                        c: d.close
                    };
                });
                
                // Sunaikinti esamą grafiką, jei jis jau egzistuoja
                if (candlestickChart) {
                    candlestickChart.destroy();
                }
                
                // Nustatyti optimaliausią dydį pagal duomenų kiekį
                const ticksCount = Math.min(data.length, timeframe === '1d' ? 24 : 12);
                
                // Sukurti grafiką
                const ctx = document.getElementById('candlestick-chart').getContext('2d');
                candlestickChart = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: 'Bitcoin kaina',
                            data: ohlc,
                            color: {
                                up: 'rgba(34, 197, 94, 1)',    // Žalia
                                down: 'rgba(239, 68, 68, 1)',  // Raudona
                                unchanged: 'rgba(156, 163, 175, 1)'  // Pilka
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            tooltip: {
                                enabled: false,  // Išjungiame standartinį tooltip
                            },
                            zoom: {
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'x',
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'x',
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: timeUnit,
                                    displayFormats: {
                                        hour: 'HH:mm',
                                        day: 'MMM d',
                                        week: 'MMM d',
                                        month: 'MMM yyyy'
                                    }
                                },
                                ticks: {
                                    maxTicksLimit: ticksCount,
                                    source: 'auto'
                                },
                                grid: {
                                    display: true,
                                    drawBorder: true,
                                    drawOnChartArea: true
                                }
                            },
                            y: {
                                position: 'right',
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
                
                setupChartInteractivity();
            })
            .catch(error => {
                console.error('Klaida gaunant duomenis:', error);
                document.getElementById('chart-loading').style.display = 'none';
                document.getElementById('chart-error').textContent = 'Klaida gaunant duomenis: ' + error.message;
                document.getElementById('chart-error').style.display = 'block';
            });
    }
    
    // Funkcija, kuri atnaujina kainos informaciją legendoje
    function updatePriceInfo(candle) {
        document.getElementById('current-open').textContent = `$${candle.open.toLocaleString()}`;
        document.getElementById('current-high').textContent = `$${candle.high.toLocaleString()}`;
        document.getElementById('current-low').textContent = `$${candle.low.toLocaleString()}`;
        document.getElementById('current-close').textContent = `$${candle.close.toLocaleString()}`;
        document.getElementById('current-date').textContent = new Date(candle.time).toLocaleDateString();
    }
    
    // Funkcija, kuri nustato interaktyvumą grafikui
    function setupChartInteractivity() {
        const canvas = document.getElementById('candlestick-chart');
        const canvasRect = canvas.getBoundingClientRect();
        
        // Pridėti mouse move event listener
        canvas.addEventListener('mousemove', function(e) {
            if (!candlestickChart) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Atnaujinti crosshair poziciją
            crosshairV.style.left = x + 'px';
            crosshairV.style.display = 'block';
            
            crosshairH.style.top = y + 'px';
            crosshairH.style.display = 'block';
            
            // Gauti duomenų tašką pagal pelės poziciją
            const points = candlestickChart.getElementsAtEventForMode(e, 'nearest', { intersect: false }, true);
            
            if (points.length) {
                const point = points[0];
                const dataIndex = point.index;
                const datasetIndex = point.datasetIndex;
                const ohlc = candlestickChart.data.datasets[datasetIndex].data[dataIndex];
                const candle = chartData[dataIndex];
                
                // Atnaujinti legendą su aktyvios žvakės duomenimis
                updatePriceInfo(candle);
                
                // Atnaujinti tooltip
                tooltip.querySelector('.title').textContent = new Date(candle.time).toLocaleString();
                document.getElementById('tooltip-open').textContent = '$' + candle.open.toLocaleString();
                document.getElementById('tooltip-high').textContent = '$' + candle.high.toLocaleString();
                document.getElementById('tooltip-low').textContent = '$' + candle.low.toLocaleString();
                document.getElementById('tooltip-close').textContent = '$' + candle.close.toLocaleString();
                
                // Apskaičiuoti procentinį pokytį
                const changePercent = ((candle.close - candle.open) / candle.open * 100).toFixed(2);
                const changeEl = document.getElementById('tooltip-change');
                changeEl.textContent = changePercent + '%';
                changeEl.style.color = changePercent >= 0 ? '#22c55e' : '#ef4444';
                
                // Pozicionuoti tooltip
                tooltip.style.display = 'block';
                tooltip.style.left = (x + 20) + 'px';
                tooltip.style.top = (y - 100) + 'px';
                
                // Užtikrinti, kad tooltip neišeina už lango ribų
                const tooltipRect = tooltip.getBoundingClientRect();
                if (tooltipRect.right > window.innerWidth) {
                    tooltip.style.left = (x - tooltipRect.width - 10) + 'px';
                }
                if (tooltipRect.bottom > rect.bottom) {
                    tooltip.style.top = (y - tooltipRect.height - 20) + 'px';
                }
            }
        });
        
        // Paslėpti crosshair ir tooltip, kai pelė išeina iš grafiko
        canvas.addEventListener('mouseleave', function() {
            crosshairV.style.display = 'none';
            crosshairH.style.display = 'none';
            tooltip.style.display = 'none';
            
            // Atstatyti paskutinę žvakę legendoje
            if (chartData.length > 0) {
                const lastCandle = chartData[chartData.length - 1];
                updatePriceInfo(lastCandle);
            }
        });
        
        // Pridėti mygtukus, kad būtų galima atstatyti zoom
        const resetZoomButton = document.createElement('button');
        resetZoomButton.textContent = 'Atstatyti mastelį';
        resetZoomButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary', 'position-absolute');
        resetZoomButton.style.top = '10px';
        resetZoomButton.style.right = '10px';
        resetZoomButton.style.zIndex = '95';
        resetZoomButton.style.display = 'none';
        
        resetZoomButton.addEventListener('click', function() {
            candlestickChart.resetZoom();
            resetZoomButton.style.display = 'none';
        });
        
        container.appendChild(resetZoomButton);
        
        // Pridėti event listener zoom įvykiui
        candlestickChart.options.plugins.zoom.zoom.onZoom = function() {
            resetZoomButton.style.display = 'block';
        };
    }
    
    // Atnaujinti grafiką pagal mygtuko paspaudimą
    document.getElementById('update-chart').addEventListener('click', updateChart);
    
    // Iš karto užkrauti grafiką kai puslapis užsikrauna
    updateChart();
});
</script>
{% endblock %}