{% extends "base.html" %}

{% block title %}Prekybos simuliacija{% endblock %}

{% block styles %}
<style>
    /* Simuliacijos formos stilius */
    .simulation-form {
        margin-bottom: 20px;
    }
    
    /* Grafikų konteinerio stilius */
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }
    
    /* Statistikos kortelės stilius */
    .stat-card {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 15px;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .stat-title {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    /* Pirkimo (buy) ir pardavimo (sell) stilius lentelėje */
    .buy-action {
        color: #28a745;
        font-weight: bold;
    }
    
    .sell-action {
        color: #dc3545;
        font-weight: bold;
    }
    
    /* Pelno ir nuostolio stilius */
    .profit {
        color: #28a745;
    }
    
    .loss {
        color: #dc3545;
    }
    
    /* Simuliacijos progreso juostos stilius */
    .simulation-progress {
        margin-top: 20px;
        margin-bottom: 20px;
        height: 25px;
    }
    
    /* Paslėpti elementai pradinėje būsenoje */
    .simulation-results {
        display: none;
    }
    
    /* Lentelės filtro stilius */
    .table-filter {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-3">Prekybos strategijos simuliacija</h1>
            
            <!-- Simuliacijos parametrų forma -->
            <div class="card mb-4 simulation-form">
                <div class="card-header">
                    <h5 class="mb-0">Simuliacijos parametrai</h5>
                </div>
                <div class="card-body">
                    <form id="simulation-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="model_id" class="form-label">Modelis:</label>
                                    <select class="form-select" id="model_id" name="model_id" required>
                                        <option value="">Pasirinkite modelį</option>
                                        {% for model in models %}
                                        <option value="{{ model.id }}">{{ model.name }} ({{ model.type }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">Pradžios data:</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">Pabaigos data:</label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" required>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="initial_capital" class="form-label">Pradinis kapitalas ($):</label>
                                    <input type="number" class="form-control" id="initial_capital" name="initial_capital" value="10000" min="100" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="risk_level" class="form-label">Rizikos lygis (%):</label>
                                    <select class="form-select" id="risk_level" name="risk_level">
                                        <option value="1">Labai žemas (1%)</option>
                                        <option value="2">Žemas (2%)</option>
                                        <option value="5" selected>Vidutinis (5%)</option>
                                        <option value="10">Aukštas (10%)</option>
                                        <option value="20">Labai aukštas (20%)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="fee_percent" class="form-label">Komisiniai mokesčiai (%):</label>
                                    <input type="number" class="form-control" id="fee_percent" name="fee_percent" value="0.1" min="0" max="5" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="trading_strategy" class="form-label">Prekybos strategija:</label>
                            <select class="form-select" id="trading_strategy" name="trading_strategy">
                                <option value="simple">Paprastoji (remiantis modelio prognozėmis)</option>
                                <option value="ma_crossover">Slankiųjų vidurkių kirtimasis</option>
                                <option value="rsi">RSI indikatorius</option>
                                <option value="macd">MACD indikatorius</option>
                                <option value="bollinger">Bollinger juostos</option>
                                <option value="combined">Kombinuota strategija</option>
                            </select>
                        </div>
                        
                        <!-- Strategijų specifiniai parametrai -->
                        <div id="strategy-params" class="mt-3">
                            <!-- Simple strategy params -->
                            <div id="simple-params" class="strategy-params">
                                <div class="mb-3">
                                    <label for="threshold" class="form-label">Prognozių slenkstis (%):</label>
                                    <input type="number" class="form-control" id="threshold" name="threshold" value="2" min="0.1" max="10" step="0.1">
                                    <div class="form-text">Būtinas kainų pokytis, kuriam esant bus priimami sprendimai.</div>
                                </div>
                            </div>
                            
                            <!-- MA Crossover strategy params -->
                            <div id="ma_crossover-params" class="strategy-params" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="short_window" class="form-label">Trumpasis langas (dienos):</label>
                                            <input type="number" class="form-control" id="short_window" name="short_window" value="10" min="2" max="50">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="long_window" class="form-label">Ilgasis langas (dienos):</label>
                                            <input type="number" class="form-control" id="long_window" name="long_window" value="50" min="5" max="200">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RSI strategy params -->
                            <div id="rsi-params" class="strategy-params" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="rsi_period" class="form-label">RSI periodas:</label>
                                            <input type="number" class="form-control" id="rsi_period" name="rsi_period" value="14" min="5" max="50">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="rsi_oversold" class="form-label">Išparduota (oversold):</label>
                                            <input type="number" class="form-control" id="rsi_oversold" name="rsi_oversold" value="30" min="10" max="40">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="rsi_overbought" class="form-label">Perpirkta (overbought):</label>
                                            <input type="number" class="form-control" id="rsi_overbought" name="rsi_overbought" value="70" min="60" max="90">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Kiti strategijų parametrai... -->
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="submit" class="btn btn-primary" id="start-simulation-btn">
                                <i class="fas fa-play me-2"></i>Pradėti simuliaciją
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="reset-form-btn">
                                <i class="fas fa-undo me-2"></i>Atstatyti parametrus
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Simuliacijos progreso indikatorius -->
            <div id="simulation-progress" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Simuliacijos progresas</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress simulation-progress">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <p id="progress-status" class="text-center mt-2">Pasiruošimas simuliacijai...</p>
                    </div>
                </div>
            </div>
            
            <!-- Simuliacijos rezultatai -->
            <div id="simulation-results" class="simulation-results">
                <!-- Pagrindiniai statistikos rodikliai -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Simuliacijos rezultatai</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="final-balance">$0</div>
                                    <div class="stat-title">Galutinis balansas</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="total-return">0%</div>
                                    <div class="stat-title">Bendroji grąža</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="sharpe-ratio">0.00</div>
                                    <div class="stat-title">Sharpe koeficientas</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="max-drawdown">0%</div>
                                    <div class="stat-title">Maksimalus kritimas</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="win-rate">0%</div>
                                    <div class="stat-title">Sėkmingų sandorių %</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="profit-factor">0.00</div>
                                    <div class="stat-title">Pelno faktorius</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="total-trades">0</div>
                                    <div class="stat-title">Iš viso sandorių</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value" id="avg-trade">$0</div>
                                    <div class="stat-title">Vidutinis sandorio pelnas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Balanso istorijos grafikas -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Kapitalo dinamika</h5>
                        <div>
                            <button id="download-chart-btn" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download me-1"></i>Atsisiųsti grafiką
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="balance-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Kainų ir sandorių grafikas -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Kainų ir sandorių istorija</h5>
                        <div>
                            <button id="toggle-indicators-btn" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-chart-line me-1"></i>Rodyti indikatorius
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="price-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Sandorių istorijos lentelė -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Sandorių istorija</h5>
                        <div>
                            <button id="download-trades-btn" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download me-1"></i>Atsisiųsti CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Lentelės filtrai -->
                        <div class="table-filter mb-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text">Filtruoti:</span>
                                        <select class="form-select" id="trade-filter">
                                            <option value="all">Visi sandoriai</option>
                                            <option value="buy">Tik pirkimai</option>
                                            <option value="sell">Tik pardavimai</option>
                                            <option value="profit">Tik pelningi</option>
                                            <option value="loss">Tik nuostolingi</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text">Nuo:</span>
                                        <input type="date" class="form-control" id="trade-filter-from">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text">Iki:</span>
                                        <input type="date" class="form-control" id="trade-filter-to">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="trades-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Data</th>
                                        <th>Veiksmas</th>
                                        <th>Kaina</th>
                                        <th>Kiekis</th>
                                        <th>Vertė</th>
                                        <th>Komisiniai</th>
                                        <th>Pelnas/Nuostolis</th>
                                        <th>Balansas</th>
                                    </tr>
                                </thead>
                                <tbody id="trades-table-body">
                                    <!-- Čia bus įterpiami sandorių duomenys -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Saugojimo ir palyginimo mygtukai -->
                <div class="d-flex justify-content-between mb-4">
                    <div>
                        <button id="save-simulation-btn" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>Išsaugoti simuliacijos rezultatus
                        </button>
                    </div>
                    <div>
                        <button id="compare-simulation-btn" class="btn btn-info">
                            <i class="fas fa-balance-scale me-2"></i>Palyginti su kitomis simuliacijomis
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Grįžimo mygtukas -->
            <div class="mt-4">
                <a href="{{ url_for('trading.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Grįžti į prekybos sistemos pradžią
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js biblioteka -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js anotacijų įskiepis -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<!-- Duomenų lentelės -->
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Strategijos parametrų atvaizdavimo valdymas
        const strategySelect = document.getElementById('trading_strategy');
        
        // Funkcija strategijos parametrų rodymui/slėpimui
        function updateStrategyParams() {
            // Paslepiame visus strategijų parametrus
            document.querySelectorAll('.strategy-params').forEach(element => {
                element.style.display = 'none';
            });
            
            // Rodome tik pasirinktos strategijos parametrus
            const selectedStrategy = strategySelect.value;
            const selectedParams = document.getElementById(`${selectedStrategy}-params`);
            
            if (selectedParams) {
                selectedParams.style.display = 'block';
            }
        }
        
        // Inicializuojame parametrų rodymą
        updateStrategyParams();
        
        // Atnaujina parametrus keičiant strategiją
        strategySelect.addEventListener('change', updateStrategyParams);
        
        // Formos atstatymo mygtukas
        document.getElementById('reset-form-btn').addEventListener('click', function() {
            document.getElementById('simulation-form').reset();
            updateStrategyParams();
        });
        
        // Nustato pradines datas (paskutinis mėnuo)
        function setDefaultDates() {
            const today = new Date();
            const endDate = today.toISOString().split('T')[0]; // Šiandienos data YYYY-MM-DD formatu
            
            // Nustatome pradžios datą prieš 30 dienų
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 30);
            const startDateStr = startDate.toISOString().split('T')[0];
            
            document.getElementById('start_date').value = startDateStr;
            document.getElementById('end_date').value = endDate;
        }
        
        // Nustato pradines datas
        setDefaultDates();
        
        // Simuliacijos pradžios tvarkymas
        document.getElementById('simulation-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Paslėpti formą ir rodyti progreso juostą
            document.querySelector('.simulation-form').style.display = 'none';
            document.getElementById('simulation-progress').style.display = 'block';
            
            // Surenkame formos duomenis
            const formData = new FormData(this);
            const simulationParams = {};
            
            // Konvertuojame formData į objektą
            for (const [key, value] of formData.entries()) {
                simulationParams[key] = value;
            }
            
            // Pridedame strategijos specifinius parametrus
            const selectedStrategy = strategySelect.value;
            const specificParams = {};
            
            if (selectedStrategy === 'simple') {
                specificParams.threshold = parseFloat(document.getElementById('threshold').value);
            } else if (selectedStrategy === 'ma_crossover') {
                specificParams.short_window = parseInt(document.getElementById('short_window').value);
                specificParams.long_window = parseInt(document.getElementById('long_window').value);
            } else if (selectedStrategy === 'rsi') {
                specificParams.rsi_period = parseInt(document.getElementById('rsi_period').value);
                specificParams.rsi_oversold = parseInt(document.getElementById('rsi_oversold').value);
                specificParams.rsi_overbought = parseInt(document.getElementById('rsi_overbought').value);
            }
            
            simulationParams.strategy_params = specificParams;
            
            // Pradedame simuliaciją
            startSimulation(simulationParams);
        });
        
        // Simuliacijos vykdymo funkcija
        function startSimulation(params) {
            // Išvalome senus rezultatus
            document.getElementById('trades-table-body').innerHTML = '';
            
            // Simuliuojame progresą
            let progress = 0;
            const progressBar = document.getElementById('progress-bar');
            const progressStatus = document.getElementById('progress-status');
            
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress > 100) {
                    clearInterval(progressInterval);
                    return;
                }
                
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
                
                if (progress < 30) {
                    progressStatus.textContent = "Kraunami istoriniai duomenys...";
                } else if (progress < 60) {
                    progressStatus.textContent = "Vykdoma prekybos simuliacija...";
                } else if (progress < 90) {
                    progressStatus.textContent = "Analizuojami rezultatai...";
                } else {
                    progressStatus.textContent = "Baigiama simuliacija...";
                }
                
                // Kai simuliacija baigta
                if (progress === 100) {
                    // Parodome rezultatus
                    setTimeout(() => {
                        document.getElementById('simulation-progress').style.display = 'none';
                        document.getElementById('simulation-results').style.display = 'block';
                        
                        // Užkrauname rezultatus (realiai būtų gaunami iš serverio)
                        loadSimulationResults();
                    }, 500);
                }
            }, 100);
            
            // Čia būtų API iškvietimas simuliacijos vykdymui
            // fetch('/api/trading/simulate', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //     },
            //     body: JSON.stringify(params),
            // })
            // .then(response => response.json())
            // .then(data => {
            //     // Parodome rezultatus
            //     document.getElementById('simulation-progress').style.display = 'none';
            //     document.getElementById('simulation-results').style.display = 'block';
            //     
            //     // Užkrauname gautus rezultatus
            //     displaySimulationResults(data);
            // })
            // .catch(error => {
            //     console.error('Klaida vykdant simuliaciją:', error);
            //     progressStatus.textContent = "Klaida vykdant simuliaciją: " + error;
            //     progressStatus.classList.add('text-danger');
            // });
        }
        
        // Rezultatų atvaizdavimo funkcija (demo duomenys)
        function loadSimulationResults() {
            // Demo duomenys
            const results = {
                final_balance: 14253.78,
                initial_capital: 10000,
                total_return: 42.54,
                sharpe_ratio: 1.85,
                max_drawdown: 12.3,
                win_rate: 62.5,
                profit_factor: 2.1,
                total_trades: 48,
                avg_trade: 88.62,
                balance_history: [],
                price_history: [],
                trades: []
            };
            
            // Generuojame balanso istorijos duomenis
            const startDate = new Date(document.getElementById('start_date').value);
            const endDate = new Date(document.getElementById('end_date').value);
            const dayDiff = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            let balance = 10000;
            
            for (let i = 0; i <= dayDiff; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                // Simuliuojame balanso pakitimą
                if (i > 0) {
                    // Random walk su tendencija augti
                    const change = (Math.random() - 0.45) * 300;
                    balance += change;
                    if (balance < 8000) balance = 8000 + Math.random() * 500; // Ribojame maksimalų kritimą
                }
                
                results.balance_history.push({
                    date: currentDate.toISOString().split('T')[0],
                    balance: balance
                });
                
                // Generuojame BTC kainų istoriją
                const price = 40000 + Math.sin(i * 0.1) * 8000 + (Math.random() - 0.5) * 2000;
                results.price_history.push({
                    date: currentDate.toISOString().split('T')[0],
                    price: price
                });
            }
            
            // Generuojame prekybos sandorius
            let cumulativeBalance = 10000;
            
            for (let i = 1; i <= 48; i++) {
                const tradeDate = new Date(startDate);
                tradeDate.setDate(startDate.getDate() + Math.floor(Math.random() * dayDiff));
                
                const action = Math.random() > 0.5 ? 'buy' : 'sell';
                const price = 40000 + (Math.random() - 0.5) * 5000;
                const amount = (0.001 + Math.random() * 0.01).toFixed(5);
                const value = price * amount;
                const fee = value * 0.001;
                
                // 62.5% tikimybė pelningo sandorio
                const isProfit = Math.random() < 0.625;
                const pnl = isProfit ? 
                    (Math.random() * 500 + 50) : 
                    -(Math.random() * 200 + 20);
                
                cumulativeBalance += pnl - fee;
                
                results.trades.push({
                    id: i,
                    date: tradeDate.toISOString().split('T')[0],
                    action: action,
                    price: price.toFixed(2),
                    amount: amount,
                    value: value.toFixed(2),
                    fee: fee.toFixed(2),
                    pnl: pnl.toFixed(2),
                    balance: cumulativeBalance.toFixed(2)
                });
            }
            
            // Rūšiuojame sandorius pagal datą
            results.trades.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Rodome rezultatus
            displaySimulationResults(results);
        }
        
        // Rezultatų atvaizdavimo funkcija
        function displaySimulationResults(results) {
            // Atnaujiname statistikos korteles
            document.getElementById('final-balance').textContent = `$${results.final_balance.toFixed(2)}`;
            document.getElementById('total-return').textContent = `${results.total_return.toFixed(2)}%`;
            document.getElementById('sharpe-ratio').textContent = results.sharpe_ratio.toFixed(2);
            document.getElementById('max-drawdown').textContent = `${results.max_drawdown.toFixed(2)}%`;
            document.getElementById('win-rate').textContent = `${results.win_rate.toFixed(2)}%`;
            document.getElementById('profit-factor').textContent = results.profit_factor.toFixed(2);
            document.getElementById('total-trades').textContent = results.total_trades;
            document.getElementById('avg-trade').textContent = `$${results.avg_trade.toFixed(2)}`;
            
            // Spalviname rodiklius pagal reikšmes
            if (results.total_return > 0) {
                document.getElementById('total-return').classList.add('profit');
            } else {
                document.getElementById('total-return').classList.add('loss');
            }
            
            // Piešiame balanso grafiką
            const balanceChartCanvas = document.getElementById('balance-chart');
            
            // Paruošiame duomenis grafikui
            const dates = results.balance_history.map(entry => entry.date);
            const balances = results.balance_history.map(entry => entry.balance);
            
            // Baseline (pradinis kapitalas)
            const baseline = Array(dates.length).fill(results.initial_capital);
            
            // Nubrėžiame grafiką
            new Chart(balanceChartCanvas, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Portfelio vertė',
                            data: balances,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            fill: true
                        },
                        {
                            label: 'Pradinis kapitalas',
                            data: baseline,
                            borderColor: 'rgba(75, 192, 192, 0.5)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Portfelio vertės dinamika',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            },
                            type: 'time',
                            time: {
                                parser: 'yyyy-MM-dd',
                                unit: 'day',
                                tooltipFormat: 'yyyy-MM-dd',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Portfelio vertė ($)'
                            },
                            min: Math.min(...balances) * 0.95
                        }
                    }
                }
            });
            
            // Piešiame kainų ir sandorių grafiką
            const priceChartCanvas = document.getElementById('price-chart');
            
            // Paruošiame duomenis grafikui
            const priceDates = results.price_history.map(entry => entry.date);
            const prices = results.price_history.map(entry => entry.price);
            
            // Paruošiame anotacijas sandoriams
            const annotations = {};
            
            results.trades.forEach((trade, index) => {
                annotations[`trade${index}`] = {
                    type: 'point',
                    xValue: trade.date,
                    yValue: parseFloat(trade.price),
                    backgroundColor: trade.action === 'buy' ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)',
                    borderColor: trade.action === 'buy' ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)',
                    radius: 6
                };
            });
            
            // Nubrėžiame grafiką
            new Chart(priceChartCanvas, {
                type: 'line',
                data: {
                    labels: priceDates,
                    datasets: [
                        {
                            label: 'BTC kaina',
                            data: prices,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'BTC kaina ir sandoriai',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            },
                            type: 'time',
                            time: {
                                parser: 'yyyy-MM-dd',
                                unit: 'day',
                                tooltipFormat: 'yyyy-MM-dd',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Kaina ($)'
                            },
                            min: Math.min(...prices) * 0.95,
                            max: Math.max(...prices) * 1.05
                        }
                    }
                }
            });
            
            // Užpildome sandorių lentelę
            const tableBody = document.getElementById('trades-table-body');
            tableBody.innerHTML = '';
            
            results.trades.forEach(trade => {
                const row = document.createElement('tr');
                
                // Nustatome eilutės klasę pagal pelną/nuostolį
                if (parseFloat(trade.pnl) > 0) {
                    row.classList.add('table-success');
                } else if (parseFloat(trade.pnl) < 0) {
                    row.classList.add('table-danger');
                }
                
                row.innerHTML = `
                    <td>${trade.id}</td>
                    <td>${trade.date}</td>
                    <td class="${trade.action === 'buy' ? 'buy-action' : 'sell-action'}">${trade.action === 'buy' ? 'Pirkimas' : 'Pardavimas'}</td>
                    <td>$${parseFloat(trade.price).toFixed(2)}</td>
                    <td>${trade.amount}</td>
                    <td>$${parseFloat(trade.value).toFixed(2)}</td>
                    <td>$${parseFloat(trade.fee).toFixed(2)}</td>
                    <td class="${parseFloat(trade.pnl) >= 0 ? 'profit' : 'loss'}">$${parseFloat(trade.pnl).toFixed(2)}</td>
                    <td>$${parseFloat(trade.balance).toFixed(2)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Sandorių filtravimo funkcionalumas
            document.getElementById('trade-filter').addEventListener('change', function() {
                filterTrades();
            });
            
            document.getElementById('trade-filter-from').addEventListener('change', function() {
                filterTrades();
            });
            
            document.getElementById('trade-filter-to').addEventListener('change', function() {
                filterTrades();
            });
            
            // Inicializuojame DataTable
            if (typeof SimpleDatatables !== 'undefined') {
                new SimpleDatatables('#trades-table');
            }
            
            // Nustatome "Išsaugoti" mygtuko veikimą
            document.getElementById('save-simulation-btn').addEventListener('click', function() {
                alert('Simuliacijos rezultatai išsaugoti!');
            });
            
            // Nustatome "Palyginti" mygtuko veikimą
            document.getElementById('compare-simulation-btn').addEventListener('click', function() {
                window.location.href = '/trading/compare';
            });
        }
        
        // Sandorių filtravimo funkcija
        function filterTrades() {
            const filterType = document.getElementById('trade-filter').value;
            const filterFrom = document.getElementById('trade-filter-from').value;
            const filterTo = document.getElementById('trade-filter-to').value;
            
            const rows = document.querySelectorAll('#trades-table-body tr');
            
            rows.forEach(row => {
                let showRow = true;
                const action = row.querySelector('td:nth-child(3)').textContent;
                const date = row.querySelector('td:nth-child(2)').textContent;
                const pnl = parseFloat(row.querySelector('td:nth-child(8)').textContent.replace('$', ''));
                
                // Filtravimas pagal tipą
                if (filterType === 'buy' && action !== 'Pirkimas') showRow = false;
                if (filterType === 'sell' && action !== 'Pardavimas') showRow = false;
                if (filterType === 'profit' && pnl <= 0) showRow = false;
                if (filterType === 'loss' && pnl >= 0) showRow = false;
                
                // Filtravimas pagal datą
                if (filterFrom && date < filterFrom) showRow = false;
                if (filterTo && date > filterTo) showRow = false;
                
                // Rodome arba slepiame eilutę
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // Grafikų atsiuntimo funkcija
        document.getElementById('download-chart-btn').addEventListener('click', function() {
            alert('Grafikas išsaugotas!');
            // Realiam projekte čia būtų canvas->image konvertavimas ir atsiuntimas
        });
        
        // Indikatorių rodymo/slėpimo funkcija
        document.getElementById('toggle-indicators-btn').addEventListener('click', function() {
            alert('Indikatorių rodymas bus įgyvendintas vėliau');
        });
        
        // CSV atsiuntimo funkcija
        document.getElementById('download-trades-btn').addEventListener('click', function() {
            // Sukuriame CSV turinį
            let csvContent = "ID,Data,Veiksmas,Kaina,Kiekis,Vertė,Komisiniai,Pelnas/Nuostolis,Balansas\n";
            
            const rows = document.querySelectorAll('#trades-table-body tr');
            rows.forEach(row => {
                // Tik rodomos eilutės
                if (row.style.display !== 'none') {
                    const cells = row.querySelectorAll('td');
                    let rowData = [];
                    
                    cells.forEach(cell => {
                        // Nuimame $ ženklus ir formatavimą
                        let value = cell.textContent.replace('$', '').trim();
                        rowData.push(value);
                    });
                    
                    csvContent += rowData.join(',') + '\n';
                }
            });
            
            // Sukuriame atsiunčiamą failą
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'prekybos_sandoriai.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });
</script>
{% endblock %}