<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Kainų Analizė - Pagrindinis</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <!-- Chart.js biblioteka grafikams -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome ikonėlėms -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        .chart-container {
            position: relative;
            height: 400px !important;
            width: 100% !important;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        #candlestick-chart {
            width: 100% !important;
            height: 400px !important;
            max-width: 100% !important;
            max-height: 400px !important;
        }
        
        .price-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats-card {
            transition: transform 0.3s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <script>
    // Initialize global variables safely
    window.priceHistory = {"dates":[], "prices":[], "close":[], "volumes":[]};
    window.predictions = {values: [], dates: []};
    
    // Load data via AJAX to avoid JSON serialization issues
    document.addEventListener('DOMContentLoaded', function() {
        // Load live Bitcoin stats first
        fetchLiveBitcoinStats();
        // Also update the main price display
        fetchLiveBitcoinPrice();
        
        // Load price history data - use correct endpoint with current data
        fetch('/api/price_history?days=30')
            .then(response => response.json())
            .then(data => {
                if (data && data.status === 'success') {
                    window.priceHistory = data.data;
                    console.log("priceHistory loaded successfully:", window.priceHistory);
                    
                    // Trigger chart update if bitcoin-charts.js is loaded
                    if (typeof updateCharts === 'function') {
                        updateCharts();
                    }
                    
                    // Update stats
                    updateStats();
                }
            })
            .catch(error => {
                console.error("Error loading price history:", error);
                // Fallback to calculating from historical data
                updateStats();
            });
            
        // Load predictions data - use correct endpoint
        fetch('/api/predictions')
            .then(response => response.json())
            .then(data => {
                if (data && data.status === 'success') {
                    window.predictions = data.data;
                    console.log("predictions loaded successfully:", window.predictions);
                    
                    // Trigger chart update if bitcoin-charts.js is loaded
                    if (typeof updateCharts === 'function') {
                        updateCharts();
                    }
                }
            })
            .catch(error => {
                console.error("Error loading predictions:", error);
            });
    });
    
    // Fetch live Bitcoin statistics from Binance API
    function fetchLiveBitcoinStats() {
        // Fetch 24hr ticker statistics from Binance
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT')
            .then(response => response.json())
            .then(data => {
                if (data && data.symbol === 'BTCUSDT') {
                    // Update DOM elements with live data
                    const high24h = parseFloat(data.highPrice);
                    const low24h = parseFloat(data.lowPrice);
                    const volume24h = parseFloat(data.volume);
                    const currentPrice = parseFloat(data.lastPrice);
                    
                    // Estimate market cap (Bitcoin circulating supply is approximately 19.7M)
                    const btcSupply = 19700000;
                    const marketCap = currentPrice * btcSupply;
                    
                    // Update DOM elements with proper formatting
                    document.getElementById('high-24h').textContent = '$' + high24h.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    document.getElementById('low-24h').textContent = '$' + low24h.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    document.getElementById('volume-24h').textContent = volume24h.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }) + ' BTC';
                    document.getElementById('market-cap').textContent = '$' + (marketCap / 1000000000).toLocaleString('en-US', {
                        minimumFractionDigits: 1,
                        maximumFractionDigits: 1
                    }) + 'B';
                    
                    console.log('Live stats updated:', {
                        high24h: high24h,
                        low24h: low24h,
                        volume24h: volume24h,
                        currentPrice: currentPrice,
                        marketCap: marketCap
                    });
                }
            })
            .catch(error => {
                console.error("Error fetching live Bitcoin stats:", error);
                // Fallback to historical data calculation
                updateStats();
            });
    }
    
    // Fetch live Bitcoin price from Binance API (same as predict.html)
    function fetchLiveBitcoinPrice() {
        // Fetch 24hr ticker statistics from Binance
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT')
            .then(response => response.json())
            .then(data => {
                if (data && data.symbol === 'BTCUSDT') {
                    const currentPrice = parseFloat(data.lastPrice);
                    const priceChange = parseFloat(data.priceChange);
                    const priceChangePercent = parseFloat(data.priceChangePercent);
                    
                    // Update the main price display in the hero card
                    const mainPriceElements = document.querySelectorAll('.live-btc-price, #current-btc-price');
                    mainPriceElements.forEach(element => {
                        element.textContent = '$' + currentPrice.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    });
                    
                    // Update the main hero card price display
                    const heroPrice = document.querySelector('.display-4');
                    if (heroPrice) {
                        heroPrice.textContent = '$' + currentPrice.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                    
                    // Update timestamp
                    const timestampElement = document.getElementById('last-updated');
                    if (timestampElement) {
                        timestampElement.textContent = new Date().toLocaleTimeString('lt-LT');
                    }
                    
                    // Update price change in hero card
                    const heroCard = document.querySelector('.price-card .card-body');
                    if (heroCard) {
                        // Remove existing price change
                        const existingChange = heroCard.querySelector('.live-price-change');
                        if (existingChange) {
                            existingChange.remove();
                        }
                        
                        // Add new price change display
                        const changeElement = document.createElement('h5');
                        changeElement.className = 'live-price-change mt-2';
                        
                        if (priceChangePercent > 0) {
                            changeElement.innerHTML = `<span class="text-success"><i class="fas fa-arrow-up"></i> +$${priceChange.toFixed(2)} (+${priceChangePercent.toFixed(2)}%)</span>`;
                        } else if (priceChangePercent < 0) {
                            changeElement.innerHTML = `<span class="text-danger"><i class="fas fa-arrow-down"></i> $${priceChange.toFixed(2)} (${priceChangePercent.toFixed(2)}%)</span>`;
                        } else {
                            changeElement.innerHTML = `<span class="text-light"><i class="fas fa-minus"></i> $0.00 (0.00%)</span>`;
                        }
                        
                        // Insert after the main price
                        const heroTitle = heroCard.querySelector('.display-4');
                        if (heroTitle && heroTitle.parentNode) {
                            heroTitle.parentNode.insertBefore(changeElement, heroTitle.nextSibling);
                        }
                    }
                    
                    console.log('Live Bitcoin price updated on index:', currentPrice);
                }
            })
            .catch(error => {
                console.error("Error fetching live Bitcoin price:", error);
                // Show error message in main price display
                const heroPrice = document.querySelector('.display-4');
                if (heroPrice) {
                    heroPrice.textContent = 'Klaida kraunant kainą';
                }
            });
    }
    
    // Auto-refresh price every 30 seconds (same as predict.html)
    setInterval(fetchLiveBitcoinPrice, 30000);
    
    function updateStats() {
        // Update stats from price history data
        if (window.priceHistory && window.priceHistory.dates && window.priceHistory.dates.length > 0) {
            const prices = window.priceHistory.prices || window.priceHistory.close || [];
            const volumes = window.priceHistory.volumes || [];
            const highs = window.priceHistory.high || [];
            const lows = window.priceHistory.low || [];
            
            if (prices.length > 0) {
                // Calculate 24h stats (using last 24 hours of data or available data)
                const dataPoints = Math.min(24, prices.length); // Use last 24 hours or all available data
                
                // Get recent data for 24h calculations
                const recentPrices = prices.slice(-dataPoints);
                const recentVolumes = volumes.slice(-dataPoints);
                const recentHighs = highs.slice(-dataPoints);
                const recentLows = lows.slice(-dataPoints);
                
                // Calculate statistics
                const high24h = recentHighs.length > 0 ? Math.max(...recentHighs) : Math.max(...recentPrices);
                const low24h = recentLows.length > 0 ? Math.min(...recentLows) : Math.min(...recentPrices);
                const volume24h = recentVolumes.length > 0 ? recentVolumes.reduce((sum, vol) => sum + vol, 0) : 0;
                const currentPrice = prices[prices.length - 1];
                
                // Estimate market cap (Bitcoin circulating supply is approximately 19.7M)
                const btcSupply = 19700000; // Approximate circulating supply
                const marketCap = currentPrice * btcSupply;
                
                // Update DOM elements with proper formatting
                document.getElementById('high-24h').textContent = '$' + high24h.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                document.getElementById('low-24h').textContent = '$' + low24h.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                document.getElementById('volume-24h').textContent = volume24h.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
                document.getElementById('market-cap').textContent = '$' + (marketCap / 1000000000).toLocaleString('en-US', {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                }) + 'B';
                
                console.log('Stats updated:', {
                    high24h: high24h,
                    low24h: low24h,
                    volume24h: volume24h,
                    marketCap: marketCap
                });
            }
        } else {
            // Show loading or N/A
            document.getElementById('high-24h').textContent = 'Kraunama...';
            document.getElementById('low-24h').textContent = 'Kraunama...';
            document.getElementById('volume-24h').textContent = 'Kraunama...';
            document.getElementById('market-cap').textContent = 'Kraunama...';
        }
    }
    </script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Bitcoin Predictor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">Pradžia</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.path == '/models' %}active{% endif %}" href="/models">Modeliai</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.path == '/predict' %}active{% endif %}" href="/predict">Prognozės</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.path == '/training_status' %}active{% endif %}" href="/training_status">Apmokymo būsena</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <h1 class="text-center mb-4">
            <i class="fab fa-bitcoin text-warning"></i>
            Bitcoin Kainų Analizė ir Prognozavimas
        </h1>
          <!-- Navigation -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <a href="/" class="btn btn-dark me-2">
                    <i class="fas fa-home"></i> Pagrindinis
                </a>
                <a href="/predict" class="btn btn-primary me-2">
                    <i class="fas fa-chart-line"></i> Prognozės
                </a>
                <a href="/models" class="btn btn-info me-2">
                    <i class="fas fa-brain"></i> Modeliai
                </a>
                <a href="/history" class="btn btn-secondary me-2">
                    <i class="fas fa-history"></i> Istorija
                </a>
                <a href="/training_status" class="btn btn-success">
                    <i class="fas fa-tasks"></i> Apmokymas
                </a>
            </div>
        </div>

        <!-- Current Price Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card price-card shadow">
                    <div class="card-body text-center">
                        <h2 class="card-title">
                            <i class="fab fa-bitcoin"></i> Dabartinė Bitcoin Kaina
                        </h2>
                        <h1 class="display-4 fw-bold">
                            Kraunama...
                        </h1>
                        
                        <small class="text-light opacity-75">
                            Atnaujinta: <span id="last-updated">Kraunama...</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bitcoin Historical Price Chart (Main Chart) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h5 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-candlestick"></i> 
                            Bitcoin Istorinės Kainos Grafikas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="candlestick-chart"></canvas>
                        </div>
                        <div id="candlestickError" class="alert alert-warning mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card shadow border-left-primary">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    24h Apimtis
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="volume-24h">
                                    Kraunama...
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-chart-bar fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card stats-card shadow border-left-success">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    24h Aukšč.
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="high-24h">
                                    Kraunama...
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-arrow-up fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card stats-card shadow border-left-danger">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                    24h Žem.
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="low-24h">
                                    Kraunama...
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-arrow-down fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card stats-card shadow border-left-warning">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Rinkos kap.
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="market-cap">
                                    Kraunama...
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-coins fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h5 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-rocket"></i> Greiti Veiksmai
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <a href="/predict" class="btn btn-outline-primary btn-lg w-100">
                                    <i class="fas fa-crystal-ball d-block mb-2"></i>
                                    Generuoti Prognozes
                                </a>
                                <small class="text-muted d-block mt-2">
                                    Naudokite LSTM modelius Bitcoin kainų prognozavimui
                                </small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <a href="/models" class="btn btn-outline-info btn-lg w-100">
                                    <i class="fas fa-cogs d-block mb-2"></i>
                                    Valdyti Modelius
                                </a>
                                <small class="text-muted d-block mt-2">
                                    Treniruokite ir konfigūruokite AI modelius
                                </small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <a href="/history" class="btn btn-outline-secondary btn-lg w-100">
                                    <i class="fas fa-archive d-block mb-2"></i>
                                    Peržiūrėti Istoriją
                                </a>
                                <small class="text-muted d-block mt-2">
                                    Analizuokite modelių veikimo istoriją
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <i class="fas fa-chart-line"></i> 
                    Bitcoin Kainų Analizės Sistema | 
                    Realaus laiko duomenys iš Binance API
                </p>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Include the same bitcoin-charts.js file -->
    <script src="{{ url_for('static', filename='js/bitcoin-charts.js') }}"></script>
    
    <!-- Additional script for stats -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Stats will be updated by the main script above
        // Initial display
        updateStats();
    });
    </script>
</body>
</html>