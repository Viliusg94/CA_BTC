{% extends 'base.html' %}

{% block title %}Modelio vizualizacija{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/vis-network/dist/vis-network.min.css">
<style>
    #model-container {
        width: 100%;
        height: 600px;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
    }
    
    .model-info-card {
        margin-bottom: 20px;
    }
    
    .layer-info {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .controls {
        margin-bottom: 15px;
    }
    
    .zoom-buttons {
        display: inline-block;
        margin-right: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="my-4">Modelio vizualizacija</h1>
    
    <!-- Modelio pasirinkimas -->
    <div class="card model-info-card">
        <div class="card-header">
            <h5 class="card-title mb-0">Pasirinkite modelį</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <select id="model-select" class="form-select">
                        <option value="">Pasirinkite modelį...</option>
                        {% for model in models %}
                        <option value="{{ model.id }}">{{ model.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <button id="load-model-btn" class="btn btn-primary">Užkrauti modelį</button>
                    <a href="{{ url_for('models.model_comparison') }}" class="btn btn-success">Palyginti modelius</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Vizualizacijos kontrolės -->
    <div class="card model-info-card" id="viz-controls" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">Vizualizacijos kontrolės</h5>
        </div>
        <div class="card-body">
            <div class="controls">
                <div class="zoom-buttons">
                    <button id="zoom-in" class="btn btn-sm btn-outline-primary"><i class="fas fa-search-plus"></i> Priartinti</button>
                    <button id="zoom-out" class="btn btn-sm btn-outline-primary"><i class="fas fa-search-minus"></i> Atitolinti</button>
                    <button id="reset-zoom" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync"></i> Atstatyti</button>
                </div>
                
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="show-weights" value="true">
                    <label class="form-check-label" for="show-weights">Rodyti svorius</label>
                </div>
                
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="show-bias" value="true">
                    <label class="form-check-label" for="show-bias">Rodyti poslinkį (bias)</label>
                </div>
                
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="show-layer-names" value="true" checked>
                    <label class="form-check-label" for="show-layer-names">Rodyti sluoksnių pavadinimus</label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modelio vizualizacija -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0" id="model-title">Modelio struktūra</h5>
                </div>
                <div class="card-body">
                    <div id="model-container"></div>
                </div>
            </div>
        </div>
        
        <!-- Sluoksnio informacija -->
        <div class="col-md-4">
            <div class="card" id="layer-info-card" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0" id="layer-title">Sluoksnio informacija</h5>
                </div>
                <div class="card-body">
                    <div class="layer-info" id="layer-info">
                        <p class="text-muted">Pasirinkite sluoksnį, kad matytumėte jo informaciją.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modelio santrauka -->
    <div class="card mt-4" id="model-summary-card" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">Modelio santrauka</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Sluoksnis</th>
                            <th>Tipas</th>
                            <th>Forma</th>
                            <th>Parametrų skaičius</th>
                        </tr>
                    </thead>
                    <tbody id="model-summary-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vis-network/dist/vis-network.min.js"></script>
<script src="{{ url_for('static', filename='js/model_visualization.js') }}"></script>
<script>
// Modelio vizualizacijos JavaScript kodas

// Globalūs kintamieji
let network = null;
let data = null;
let currentModel = null;
let zoomLevel = 1;

// Inicializuojame puslapį kai jis užkraunamas
document.addEventListener('DOMContentLoaded', function() {
    // Modelio pasirinkimo mygtukas
    const loadModelBtn = document.getElementById('load-model-btn');
    loadModelBtn.addEventListener('click', loadSelectedModel);
    
    // Kontrolių mygtukų įvykiai
    document.getElementById('zoom-in').addEventListener('click', zoomIn);
    document.getElementById('zoom-out').addEventListener('click', zoomOut);
    document.getElementById('reset-zoom').addEventListener('click', resetZoom);
    
    // Kontrolių pakeitimai
    document.getElementById('show-weights').addEventListener('change', updateVisualization);
    document.getElementById('show-bias').addEventListener('change', updateVisualization);
    document.getElementById('show-layer-names').addEventListener('change', updateVisualization);
});

// Užkrauna pasirinktą modelį
function loadSelectedModel() {
    const modelSelect = document.getElementById('model-select');
    const modelId = modelSelect.value;
    
    if (!modelId) {
        alert('Prašome pasirinkti modelį');
        return;
    }
    
    // Rodome užkrovimo animaciją
    document.getElementById('model-container').innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Kraunama...</span></div><p class="mt-2">Kraunamas modelis...</p></div>';
    
    // Gauname modelio struktūrą per API
    fetch(`/api/models/${modelId}/structure`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Klaida gaunant modelio struktūrą');
            }
            return response.json();
        })
        .then(modelData => {
            // Išsaugome modelio duomenis
            currentModel = modelData;
            
            // Rodome kontroles
            document.getElementById('viz-controls').style.display = 'block';
            document.getElementById('layer-info-card').style.display = 'block';
            document.getElementById('model-summary-card').style.display = 'block';
            
            // Atnaujiname modelio pavadinimą
            document.getElementById('model-title').textContent = `Modelio struktūra: ${modelData.name}`;
            
            // Sukuriame vizualizaciją
            createModelVisualization(modelData);
            
            // Užpildome modelio santrauką
            populateModelSummary(modelData);
        })
        .catch(error => {
            console.error('Klaida:', error);
            document.getElementById('model-container').innerHTML = `<div class="alert alert-danger">Klaida kraunant modelį: ${error.message}</div>`;
        });
}

// Sukuria modelio vizualizaciją
function createModelVisualization(modelData) {
    // Paruošiame duomenis vizualizacijai
    data = prepareVisualizationData(modelData);
    
    // Naudojame vis.js Network biblioteką
    const container = document.getElementById('model-container');
    
    // Nustatome vizualizacijos nustatymus
    const options = {
        layout: {
            hierarchical: {
                direction: 'LR', // iš kairės į dešinę
                sortMethod: 'directed',
                levelSeparation: 150,
                nodeSpacing: 120
            }
        },
        nodes: {
            shape: 'box',
            margin: 10,
            font: {
                size: 14
            }
        },
        edges: {
            arrows: {
                to: { enabled: true, scaleFactor: 0.5 }
            },
            smooth: { type: 'cubicBezier', forceDirection: 'horizontal' }
        },
        physics: {
            enabled: false
        },
        interaction: {
            dragNodes: true,
            dragView: true,
            zoomView: true,
            hover: true,
            tooltipDelay: 200
        }
    };
    
    // Sukuriame tinklą
    network = new vis.Network(container, data, options);
    
    // Pridedame įvykius
    network.on('click', function(params) {
        if (params.nodes.length) {
            // Parodome informaciją apie pasirinktą sluoksnį
            showLayerInfo(params.nodes[0]);
        }
    });
}

// Paruošia duomenis vizualizacijai
function prepareVisualizationData(modelData) {
    const showLayerNames = document.getElementById('show-layer-names').checked;
    
    // Sukuriame mazgus kiekvienam sluoksniui
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();
    
    let nodeId = 1;
    const nodeMap = {}; // žemėlapis layer_name -> node_id
    
    // Pridedame įvesties sluoksnį
    nodes.add({
        id: nodeId,
        label: showLayerNames ? 'Įvestis' : '',
        title: 'Įvesties sluoksnis',
        shape: 'ellipse',
        color: {
            background: '#6BAED6',
            border: '#2171B5',
            highlight: { background: '#4292C6', border: '#084594' }
        }
    });
    
    nodeMap['input'] = nodeId;
    nodeId++;
    
    // Pridedame likusius sluoksnius
    modelData.layers.forEach(layer => {
        // Spalvos pagal sluoksnio tipą
        let color = { background: '#FDAE6B', border: '#E6550D' }; // numatytasis
        
        if (layer.type.includes('Conv')) {
            color = { background: '#A1D99B', border: '#31A354' }; // žalias konvoliuciniams
        } else if (layer.type.includes('Dense')) {
            color = { background: '#FDAE6B', border: '#E6550D' }; // oranžinis dense
        } else if (layer.type.includes('Pool')) {
            color = { background: '#9ECAE1', border: '#3182BD' }; // mėlynas pooling
        } else if (layer.type.includes('Dropout')) {
            color = { background: '#BCBDDC', border: '#756BB1' }; // violetinis dropout
        }
        
        // Sukuriame sluoksnio aprašymą
        let layerText = layer.type;
        if (showLayerNames && layer.name) {
            layerText = `${layer.name}\n(${layer.type})`;
        }
        
        // Pridedame mazgą
        nodes.add({
            id: nodeId,
            label: layerText,
            title: `${layer.name} (${layer.type})\nForma: ${layer.output_shape}\nParametrai: ${layer.params}`,
            shape: 'box',
            color: color,
            layer: layer // išsaugome visą sluoksnio informaciją
        });
        
        nodeMap[layer.name] = nodeId;
        nodeId++;
    });
    
    // Pridedame išvesties sluoksnį, jei jis neaprašytas
    if (!modelData.layers.some(l => l.name === 'output')) {
        nodes.add({
            id: nodeId,
            label: showLayerNames ? 'Išvestis' : '',
            title: 'Išvesties sluoksnis',
            shape: 'ellipse',
            color: {
                background: '#F7B6D2',
                border: '#CE1256',
                highlight: { background: '#DB7093', border: '#CE1256' }
            }
        });
        
        nodeMap['output'] = nodeId;
        nodeId++;
    }
    
    // Sukuriame ryšius tarp sluoksnių
    let previousNodeId = nodeMap['input'];
    
    modelData.layers.forEach(layer => {
        const currentNodeId = nodeMap[layer.name];
        
        // Sukuriame briauną tarp ankstesnio ir dabartinio sluoksnio
        edges.add({
            from: previousNodeId,
            to: currentNodeId,
            arrows: 'to'
        });
        
        previousNodeId = currentNodeId;
    });
    
    // Jei yra išvesties sluoksnis, sukuriame briauną į jį
    if (nodeMap['output'] && !modelData.layers.some(l => l.name === 'output')) {
        edges.add({
            from: previousNodeId,
            to: nodeMap['output'],
            arrows: 'to'
        });
    }
    
    return { nodes, edges };
}

// Parodo informaciją apie pasirinktą sluoksnį
function showLayerInfo(nodeId) {
    const node = data.nodes.get(nodeId);
    const layerInfoCard = document.getElementById('layer-info-card');
    const layerInfo = document.getElementById('layer-info');
    const layerTitle = document.getElementById('layer-title');
    
    layerInfoCard.style.display = 'block';
    
    if (!node.layer) {
        if (nodeId === 1) {
            layerTitle.textContent = 'Įvesties sluoksnis';
            layerInfo.innerHTML = `
                <div class="alert alert-info">
                    Įvesties sluoksnis priima pradinius duomenis.
                </div>
            `;
        } else {
            layerTitle.textContent = 'Išvesties sluoksnis';
            layerInfo.innerHTML = `
                <div class="alert alert-info">
                    Išvesties sluoksnis grąžina modelio rezultatus.
                </div>
            `;
        }
        return;
    }
    
    const layer = node.layer;
    layerTitle.textContent = `Sluoksnis: ${layer.name}`;
    
    // Sukuriame sluoksnio informacijos HTML
    let infoHTML = `
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <tr>
                    <th>Tipas:</th>
                    <td>${layer.type}</td>
                </tr>
                <tr>
                    <th>Forma:</th>
                    <td>${layer.output_shape}</td>
                </tr>
                <tr>
                    <th>Parametrų skaičius:</th>
                    <td>${layer.params}</td>
                </tr>
    `;
    
    // Pridedame daugiau informacijos, jei ji yra
    if (layer.activation) {
        infoHTML += `
                <tr>
                    <th>Aktyvacijos funkcija:</th>
                    <td>${layer.activation}</td>
                </tr>
        `;
    }
    
    if (layer.units) {
        infoHTML += `
                <tr>
                    <th>Vienetų skaičius:</th>
                    <td>${layer.units}</td>
                </tr>
        `;
    }
    
    if (layer.filters) {
        infoHTML += `
                <tr>
                    <th>Filtrų skaičius:</th>
                    <td>${layer.filters}</td>
                </tr>
        `;
    }
    
    if (layer.kernel_size) {
        infoHTML += `
                <tr>
                    <th>Branduolio dydis:</th>
                    <td>${layer.kernel_size}</td>
                </tr>
        `;
    }
    
    if (layer.strides) {
        infoHTML += `
                <tr>
                    <th>Žingsniai:</th>
                    <td>${layer.strides}</td>
                </tr>
        `;
    }
    
    if (layer.rate) {
        infoHTML += `
                <tr>
                    <th>Išmetimo koeficientas:</th>
                    <td>${layer.rate}</td>
                </tr>
        `;
    }
    
    infoHTML += `
            </table>
        </div>
    `;
    
    layerInfo.innerHTML = infoHTML;
}

// Užpildo modelio santraukos lentelę
function populateModelSummary(modelData) {
    const summaryBody = document.getElementById('model-summary-body');
    summaryBody.innerHTML = '';
    
    // Pridedame eilutę įvesties sluoksniui
    const inputRow = document.createElement('tr');
    inputRow.innerHTML = `
        <td>Įvestis</td>
        <td>InputLayer</td>
        <td>${modelData.input_shape || '?'}</td>
        <td>0</td>
    `;
    summaryBody.appendChild(inputRow);
    
    // Pridedame eilutes visiems sluoksniams
    let totalParams = 0;
    modelData.layers.forEach(layer => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${layer.name}</td>
            <td>${layer.type}</td>
            <td>${layer.output_shape}</td>
            <td>${layer.params}</td>
        `;
        summaryBody.appendChild(row);
        
        totalParams += parseInt(layer.params);
    });
    
    // Pridedame bendrą parametrų skaičių
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="3" class="text-end fw-bold">Bendras parametrų skaičius:</td>
        <td class="fw-bold">${totalParams}</td>
    `;
    summaryBody.appendChild(totalRow);
}

// Atnaujina vizualizaciją pagal kontroles
function updateVisualization() {
    if (!currentModel) return;
    
    // Sukuriame naują vizualizaciją su atnaujintais parametrais
    createModelVisualization(currentModel);
}

// Priartina vizualizaciją
function zoomIn() {
    if (network) {
        zoomLevel *= 1.2;
        network.moveTo({
            scale: zoomLevel,
            animation: true
        });
    }
}

// Atitolina vizualizaciją
function zoomOut() {
    if (network) {
        zoomLevel /= 1.2;
        network.moveTo({
            scale: zoomLevel,
            animation: true
        });
    }
}

// Atstatoma pradinį mastelį
function resetZoom() {
    if (network) {
        zoomLevel = 1;
        network.fit({
            animation: true
        });
    }
}
</script>
{% endblock %}